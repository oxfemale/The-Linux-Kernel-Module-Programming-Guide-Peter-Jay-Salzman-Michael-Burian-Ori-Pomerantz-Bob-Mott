<!DOCTYPE html>
<!-- saved from url=(0034)https://sysprog21.github.io/lkmpg/ -->
<html lang="en-US" xml:lang="en-US" data-acxscriptallow="true"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <title>The Linux Kernel Module Programming Guide</title> 
 
<meta content="TeX4ht (https://tug.org/tex4ht/)" name="generator"> 
<meta content="width=device-width,initial-scale=1" name="viewport"> 
<link href="./The Linux Kernel Module Programming Guide_files/lkmpg-for-ht.css" rel="stylesheet" type="text/css"> 
<meta content="lkmpg-for-ht.tex" name="src"> 
</head><body>
   <div class="maketitle">
                                                                  

                                                                  
                                                                  

                                                                  

<h2 class="titleHead">The Linux Kernel Module Programming Guide</h2>
<div class="author"><span class="ecrm-1200">Peter Jay Salzman, Michael Burian, Ori Pomerantz, Bob Mottram, Jim Huang</span></div><br>
<div class="date"><span class="ecrm-1200">August 11, 2021</span></div>
                                                                  

                                                                  
   </div>
   <div class="tableofcontents">
   &nbsp;<span class="sectionToc">0.1 <a href="https://sysprog21.github.io/lkmpg/#introduction" id="QQ2-1-1">Introduction</a></span>
<br>   &nbsp;&nbsp;<span class="subsectionToc">0.1.1 <a href="https://sysprog21.github.io/lkmpg/#authorship" id="QQ2-1-2">Authorship</a></span>
<br>   &nbsp;&nbsp;<span class="subsectionToc">0.1.2 <a href="https://sysprog21.github.io/lkmpg/#acknowledgements" id="QQ2-1-3">Acknowledgements</a></span>
<br>   &nbsp;&nbsp;<span class="subsectionToc">0.1.3 <a href="https://sysprog21.github.io/lkmpg/#what-is-a-kernel-module" id="QQ2-1-4">What Is A Kernel Module?</a></span>
<br>   &nbsp;&nbsp;<span class="subsectionToc">0.1.4 <a href="https://sysprog21.github.io/lkmpg/#kernel-module-package" id="QQ2-1-5">Kernel module package</a></span>
<br>   &nbsp;&nbsp;<span class="subsectionToc">0.1.5 <a href="https://sysprog21.github.io/lkmpg/#what-modules-are-in-my-kernel" id="QQ2-1-6">What Modules are in my Kernel?</a></span>
<br>   &nbsp;&nbsp;<span class="subsectionToc">0.1.6 <a href="https://sysprog21.github.io/lkmpg/#do-i-need-to-download-and-compile-the-kernel" id="QQ2-1-7">Do I need to download and compile the kernel?</a></span>
<br>   &nbsp;&nbsp;<span class="subsectionToc">0.1.7 <a href="https://sysprog21.github.io/lkmpg/#before-we-begin" id="QQ2-1-8">Before We Begin</a></span>
<br>   &nbsp;<span class="sectionToc">0.2 <a href="https://sysprog21.github.io/lkmpg/#headers" id="QQ2-1-9">Headers</a></span>
<br>   &nbsp;<span class="sectionToc">0.3 <a href="https://sysprog21.github.io/lkmpg/#examples" id="QQ2-1-10">Examples</a></span>
<br>   &nbsp;<span class="sectionToc">0.4 <a href="https://sysprog21.github.io/lkmpg/#hello-world" id="QQ2-1-11">Hello World</a></span>
<br>   &nbsp;&nbsp;<span class="subsectionToc">0.4.1 <a href="https://sysprog21.github.io/lkmpg/#the-simplest-module" id="QQ2-1-12">The Simplest Module</a></span>
<br>   &nbsp;&nbsp;<span class="subsectionToc">0.4.2 <a href="https://sysprog21.github.io/lkmpg/#hello-and-goodbye" id="QQ2-1-13">Hello and Goodbye</a></span>
<br>   &nbsp;&nbsp;<span class="subsectionToc">0.4.3 <a href="https://sysprog21.github.io/lkmpg/#the-init-and-exit-macros" id="QQ2-1-14">The __init and __exit Macros</a></span>
<br>   &nbsp;&nbsp;<span class="subsectionToc">0.4.4 <a href="https://sysprog21.github.io/lkmpg/#licensing-and-module-documentation" id="QQ2-1-15">Licensing and Module Documentation</a></span>
<br>   &nbsp;&nbsp;<span class="subsectionToc">0.4.5 <a href="https://sysprog21.github.io/lkmpg/#passing-command-line-arguments-to-a-module" id="QQ2-1-16">Passing Command Line Arguments to a Module</a></span>
<br>   &nbsp;&nbsp;<span class="subsectionToc">0.4.6 <a href="https://sysprog21.github.io/lkmpg/#modules-spanning-multiple-files" id="QQ2-1-17">Modules Spanning Multiple Files</a></span>
<br>   &nbsp;&nbsp;<span class="subsectionToc">0.4.7 <a href="https://sysprog21.github.io/lkmpg/#building-modules-for-a-precompiled-kernel" id="QQ2-1-18">Building modules for a precompiled kernel</a></span>
<br>   &nbsp;<span class="sectionToc">0.5 <a href="https://sysprog21.github.io/lkmpg/#preliminaries" id="QQ2-1-19">Preliminaries</a></span>
<br>   &nbsp;&nbsp;<span class="subsectionToc">0.5.1 <a href="https://sysprog21.github.io/lkmpg/#how-modules-begin-and-end" id="QQ2-1-20">How modules begin and end</a></span>
<br>   &nbsp;&nbsp;<span class="subsectionToc">0.5.2 <a href="https://sysprog21.github.io/lkmpg/#functions-available-to-modules" id="QQ2-1-21">Functions available to modules</a></span>
<br>   &nbsp;&nbsp;<span class="subsectionToc">0.5.3 <a href="https://sysprog21.github.io/lkmpg/#user-space-vs-kernel-space" id="QQ2-1-22">User Space vs Kernel Space</a></span>
<br>   &nbsp;&nbsp;<span class="subsectionToc">0.5.4 <a href="https://sysprog21.github.io/lkmpg/#name-space" id="QQ2-1-23">Name Space</a></span>
<br>   &nbsp;&nbsp;<span class="subsectionToc">0.5.5 <a href="https://sysprog21.github.io/lkmpg/#code-space" id="QQ2-1-24">Code space</a></span>
<br>   &nbsp;&nbsp;<span class="subsectionToc">0.5.6 <a href="https://sysprog21.github.io/lkmpg/#device-drivers" id="QQ2-1-25">Device Drivers</a></span>
<br>   &nbsp;<span class="sectionToc">0.6 <a href="https://sysprog21.github.io/lkmpg/#character-device-drivers" id="QQ2-1-26">Character Device drivers</a></span>
<br>   &nbsp;&nbsp;<span class="subsectionToc">0.6.1 <a href="https://sysprog21.github.io/lkmpg/#the-fileoperations-structure" id="QQ2-1-27">The file_operations Structure</a></span>
<br>   &nbsp;&nbsp;<span class="subsectionToc">0.6.2 <a href="https://sysprog21.github.io/lkmpg/#the-file-structure" id="QQ2-1-28">The file structure</a></span>
<br>   &nbsp;&nbsp;<span class="subsectionToc">0.6.3 <a href="https://sysprog21.github.io/lkmpg/#registering-a-device" id="QQ2-1-29">Registering A Device</a></span>
<br>   &nbsp;&nbsp;<span class="subsectionToc">0.6.4 <a href="https://sysprog21.github.io/lkmpg/#unregistering-a-device" id="QQ2-1-30">Unregistering A Device</a></span>
<br>   &nbsp;&nbsp;<span class="subsectionToc">0.6.5 <a href="https://sysprog21.github.io/lkmpg/#chardevc" id="QQ2-1-31">chardev.c</a></span>
<br>   &nbsp;&nbsp;<span class="subsectionToc">0.6.6 <a href="https://sysprog21.github.io/lkmpg/#writing-modules-for-multiple-kernel-versions" id="QQ2-1-32">Writing Modules for Multiple Kernel Versions</a></span>
<br>   &nbsp;<span class="sectionToc">0.7 <a href="https://sysprog21.github.io/lkmpg/#the-proc-file-system" id="QQ2-1-33">The /proc File System</a></span>
<br>   &nbsp;&nbsp;<span class="subsectionToc">0.7.1 <a href="https://sysprog21.github.io/lkmpg/#the-procops-structure" id="QQ2-1-34">The proc_ops Structure</a></span>
<br>   &nbsp;&nbsp;<span class="subsectionToc">0.7.2 <a href="https://sysprog21.github.io/lkmpg/#read-and-write-a-proc-file" id="QQ2-1-35">Read and Write a /proc File</a></span>
<br>   &nbsp;&nbsp;<span class="subsectionToc">0.7.3 <a href="https://sysprog21.github.io/lkmpg/#manage-proc-file-with-standard-filesystem" id="QQ2-1-36">Manage /proc file with standard filesystem</a></span>
<br>   &nbsp;&nbsp;<span class="subsectionToc">0.7.4 <a href="https://sysprog21.github.io/lkmpg/#manage-proc-file-with-seqfile" id="QQ2-1-37">Manage /proc file with seq_file</a></span>
<br>   &nbsp;<span class="sectionToc">0.8 <a href="https://sysprog21.github.io/lkmpg/#sysfs-interacting-with-your-module" id="QQ2-1-39">sysfs: Interacting with your module</a></span>
<br>   &nbsp;<span class="sectionToc">0.9 <a href="https://sysprog21.github.io/lkmpg/#talking-to-device-files" id="QQ2-1-40">Talking To Device Files</a></span>
<br>   &nbsp;<span class="sectionToc">0.10 <a href="https://sysprog21.github.io/lkmpg/#system-calls" id="QQ2-1-41">System Calls</a></span>
<br>   &nbsp;<span class="sectionToc">0.11 <a href="https://sysprog21.github.io/lkmpg/#blocking-processes-and-threads" id="QQ2-1-42">Blocking Processes and threads</a></span>
                                                                  

                                                                  
<br>   &nbsp;&nbsp;<span class="subsectionToc">0.11.1 <a href="https://sysprog21.github.io/lkmpg/#sleep" id="QQ2-1-43">Sleep</a></span>
<br>   &nbsp;&nbsp;<span class="subsectionToc">0.11.2 <a href="https://sysprog21.github.io/lkmpg/#completions" id="QQ2-1-44">Completions</a></span>
<br>   &nbsp;<span class="sectionToc">0.12 <a href="https://sysprog21.github.io/lkmpg/#avoiding-collisions-and-deadlocks" id="QQ2-1-45">Avoiding Collisions and Deadlocks</a></span>
<br>   &nbsp;&nbsp;<span class="subsectionToc">0.12.1 <a href="https://sysprog21.github.io/lkmpg/#mutex" id="QQ2-1-46">Mutex</a></span>
<br>   &nbsp;&nbsp;<span class="subsectionToc">0.12.2 <a href="https://sysprog21.github.io/lkmpg/#spinlocks" id="QQ2-1-47">Spinlocks</a></span>
<br>   &nbsp;&nbsp;<span class="subsectionToc">0.12.3 <a href="https://sysprog21.github.io/lkmpg/#read-and-write-locks" id="QQ2-1-48">Read and write locks</a></span>
<br>   &nbsp;&nbsp;<span class="subsectionToc">0.12.4 <a href="https://sysprog21.github.io/lkmpg/#atomic-operations" id="QQ2-1-49">Atomic operations</a></span>
<br>   &nbsp;<span class="sectionToc">0.13 <a href="https://sysprog21.github.io/lkmpg/#replacing-print-macros" id="QQ2-1-50">Replacing Print Macros</a></span>
<br>   &nbsp;&nbsp;<span class="subsectionToc">0.13.1 <a href="https://sysprog21.github.io/lkmpg/#replacement" id="QQ2-1-51">Replacement</a></span>
<br>   &nbsp;&nbsp;<span class="subsectionToc">0.13.2 <a href="https://sysprog21.github.io/lkmpg/#flashing-keyboard-leds" id="QQ2-1-52">Flashing keyboard LEDs</a></span>
<br>   &nbsp;<span class="sectionToc">0.14 <a href="https://sysprog21.github.io/lkmpg/#scheduling-tasks" id="QQ2-1-53">Scheduling Tasks</a></span>
<br>   &nbsp;&nbsp;<span class="subsectionToc">0.14.1 <a href="https://sysprog21.github.io/lkmpg/#tasklets" id="QQ2-1-54">Tasklets</a></span>
<br>   &nbsp;&nbsp;<span class="subsectionToc">0.14.2 <a href="https://sysprog21.github.io/lkmpg/#work-queues" id="QQ2-1-55">Work queues</a></span>
<br>   &nbsp;<span class="sectionToc">0.15 <a href="https://sysprog21.github.io/lkmpg/#interrupt-handlers" id="QQ2-1-56">Interrupt Handlers</a></span>
<br>   &nbsp;&nbsp;<span class="subsectionToc">0.15.1 <a href="https://sysprog21.github.io/lkmpg/#interrupt-handlers1" id="QQ2-1-57">Interrupt Handlers</a></span>
<br>   &nbsp;&nbsp;<span class="subsectionToc">0.15.2 <a href="https://sysprog21.github.io/lkmpg/#detecting-button-presses" id="QQ2-1-58">Detecting button presses</a></span>
<br>   &nbsp;&nbsp;<span class="subsectionToc">0.15.3 <a href="https://sysprog21.github.io/lkmpg/#bottom-half" id="QQ2-1-59">Bottom Half</a></span>
<br>   &nbsp;<span class="sectionToc">0.16 <a href="https://sysprog21.github.io/lkmpg/#crypto" id="QQ2-1-60">Crypto</a></span>
<br>   &nbsp;&nbsp;<span class="subsectionToc">0.16.1 <a href="https://sysprog21.github.io/lkmpg/#hash-functions" id="QQ2-1-61">Hash functions</a></span>
<br>   &nbsp;&nbsp;<span class="subsectionToc">0.16.2 <a href="https://sysprog21.github.io/lkmpg/#symmetric-key-encryption" id="QQ2-1-62">Symmetric key encryption</a></span>
<br>   &nbsp;<span class="sectionToc">0.17 <a href="https://sysprog21.github.io/lkmpg/#standardizing-the-interfaces-the-device-model" id="QQ2-1-63">Standardizing the interfaces: The Device Model</a></span>
<br>   &nbsp;<span class="sectionToc">0.18 <a href="https://sysprog21.github.io/lkmpg/#optimizations" id="QQ2-1-64">Optimizations</a></span>
<br>   &nbsp;&nbsp;<span class="subsectionToc">0.18.1 <a href="https://sysprog21.github.io/lkmpg/#likely-and-unlikely-conditions" id="QQ2-1-65">Likely and Unlikely conditions</a></span>
<br>   &nbsp;<span class="sectionToc">0.19 <a href="https://sysprog21.github.io/lkmpg/#common-pitfalls" id="QQ2-1-66">Common Pitfalls</a></span>
<br>   &nbsp;&nbsp;<span class="subsectionToc">0.19.1 <a href="https://sysprog21.github.io/lkmpg/#using-standard-libraries" id="QQ2-1-67">Using standard libraries</a></span>
<br>   &nbsp;&nbsp;<span class="subsectionToc">0.19.2 <a href="https://sysprog21.github.io/lkmpg/#disabling-interrupts" id="QQ2-1-68">Disabling interrupts</a></span>
<br>   &nbsp;<span class="sectionToc">0.20 <a href="https://sysprog21.github.io/lkmpg/#where-to-go-from-here" id="QQ2-1-69">Where To Go From Here?</a></span>
   </div>
   <h3 class="sectionHead" id="introduction"><span class="titlemark">0.1   </span> <a id="x1-10000.1"></a>Introduction</h3>
<!-- l. 53 --><p class="noindent">The Linux Kernel Module Programming Guide is a free book; you may reproduce
and/or modify it under the terms of the <a href="https://opensource.org/licenses/OSL-3.0">Open Software License</a>, version
3.0.
</p><!-- l. 55 --><p class="indent">   This book is distributed in the hope it will be useful, but without any warranty,
without even the implied warranty of merchantability or fitness for a particular
purpose.
</p><!-- l. 57 --><p class="indent">   The author encourages wide distribution of this book for personal or commercial
use, provided the above copyright notice remains intact and the method adheres to
the provisions of the <a href="https://opensource.org/licenses/OSL-3.0">Open Software License</a>. In summary, you may copy and
distribute this book free of charge or for a profit. No explicit permission is required
from the author for reproduction of this book in any medium, physical or
electronic.
</p><!-- l. 60 --><p class="indent">   Derivative works and translations of this document must be placed under the
Open Software License, and the original copyright notice must remain intact. If you
have contributed new material to this book, you must make the material and source
code available for your revisions. Please make revisions and updates available directly
                                                                  

                                                                  
to the document maintainer, Jim Huang &lt;jserv@ccns.ncku.edu.tw&gt;. This will allow
for the merging of updates and provide consistent revisions to the Linux
community.
</p><!-- l. 65 --><p class="indent">   If you publish or distribute this book commercially, donations, royalties, and/or
printed copies are greatly appreciated by the author and the <a href="https://tldp.org/">Linux Documentation
Project</a> (LDP). Contributing in this way shows your support for free software and
the LDP. If you have questions or comments, please contact the address
above.
</p><!-- l. 68 --><p class="noindent">
</p>
   <h4 class="subsectionHead" id="authorship"><span class="titlemark">0.1.1   </span> <a id="x1-20000.1.1"></a>Authorship</h4>
<!-- l. 71 --><p class="noindent">The Linux Kernel Module Programming Guide was originally written for the 2.2
kernels by Ori Pomerantz. Eventually, Ori no longer had time to maintain the
document. After all, the Linux kernel is a fast moving target. Peter Jay Salzman took
over maintenance and updated it for the 2.4 kernels. Eventually, Peter no longer had
time to follow developments with the 2.6 kernel, so Michael Burian became a
co-maintainer to update the document for the 2.6 kernels. Bob Mottram updated the
examples for 3.8+ kernels. Jim Huang upgraded to recent kernel versions (v5.x) and
revised LaTeX&nbsp;scripts.
</p><!-- l. 79 --><p class="noindent">
</p>
   <h4 class="subsectionHead" id="acknowledgements"><span class="titlemark">0.1.2   </span> <a id="x1-30000.1.2"></a>Acknowledgements</h4>
<!-- l. 82 --><p class="noindent">The following people have contributed corrections or good suggestions: Ignacio
Martin, David Porter, Daniele Paolo Scarpazza, Dimo Velev, Francois Audeon, Horst
Schirmeier, and Roman Lakeev.
</p><!-- l. 84 --><p class="noindent">
</p>
   <h4 class="subsectionHead" id="what-is-a-kernel-module"><span class="titlemark">0.1.3   </span> <a id="x1-40000.1.3"></a>What Is A Kernel Module?</h4>
<!-- l. 87 --><p class="noindent">So, you want to write a kernel module. You know C, you have written a few normal
programs to run as processes, and now you want to get to where the real action is, to
where a single wild pointer can wipe out your file system and a core dump means a
reboot.
</p><!-- l. 90 --><p class="indent">   What exactly is a kernel module? Modules are pieces of code that can be loaded
and unloaded into the kernel upon demand. They extend the functionality of the
kernel without the need to reboot the system. For example, one type of module is the
device driver, which allows the kernel to access hardware connected to the system.
Without modules, we would have to build monolithic kernels and add new
functionality directly into the kernel image. Besides having larger kernels, this has
the disadvantage of requiring us to rebuild and reboot the kernel every time we want
                                                                  

                                                                  
new functionality.
</p><!-- l. 97 --><p class="noindent">
</p>
   <h4 class="subsectionHead" id="kernel-module-package"><span class="titlemark">0.1.4   </span> <a id="x1-50000.1.4"></a>Kernel module package</h4>
<!-- l. 100 --><p class="noindent">Linux distributions provide the commands
<code> <span class="ectt-1000">modprobe</span>
</code>, <code>  <span class="ectt-1000">insmod</span>
</code> and <code>  <span class="ectt-1000">depmod</span>
</code> within a package.
</p><!-- l. 102 --><p class="indent">   On Ubuntu/Debian: 
</p>
   <pre class="fancyvrb" id="fancyvrb1"><a id="x1-5006r1"></a><span class="ecrm-0500">1</span><span class="ectt-1000">sudo&nbsp;apt-get&nbsp;install&nbsp;build-essential&nbsp;kmod</span></pre>
<!-- l. 107 --><p class="indent">   On Arch Linux: 
</p>
   <pre class="fancyvrb" id="fancyvrb2"><a id="x1-5009r1"></a><span class="ecrm-0500">1</span><span class="ectt-1000">sudo&nbsp;pacman&nbsp;-S&nbsp;gcc&nbsp;kmod</span></pre>
<!-- l. 112 --><p class="noindent">
</p>
   <h4 class="subsectionHead" id="what-modules-are-in-my-kernel"><span class="titlemark">0.1.5   </span> <a id="x1-60000.1.5"></a>What Modules are in my Kernel?</h4>
<!-- l. 115 --><p class="noindent">To discover what modules are already loaded within your current kernel use the command
<code> <span class="ectt-1000">lsmod</span>
</code>. 
</p>
   <pre class="fancyvrb" id="fancyvrb3"><a id="x1-6004r1"></a><span class="ecrm-0500">1</span><span class="ectt-1000">sudo&nbsp;lsmod</span></pre>
<!-- l. 120 --><p class="indent">   Modules are stored within the file /proc/modules, so you can also see them with: 
</p>
   <pre class="fancyvrb" id="fancyvrb4"><a id="x1-6007r1"></a><span class="ecrm-0500">1</span><span class="ectt-1000">sudo&nbsp;cat&nbsp;/proc/modules</span></pre>
<!-- l. 125 --><p class="indent">   This can be a long list, and you might prefer to search for something particular.
To search for the <span class="obeylines-h"><span class="verb"><span class="ectt-1000">fat</span></span></span> module: 
                                                                  

                                                                  
</p>
   <pre class="fancyvrb" id="fancyvrb5"><a id="x1-6010r1"></a><span class="ecrm-0500">1</span><span class="ectt-1000">sudo&nbsp;lsmod&nbsp;|&nbsp;grep&nbsp;fat</span></pre>
<!-- l. 131 --><p class="noindent">
</p>
   <h4 class="subsectionHead" id="do-i-need-to-download-and-compile-the-kernel"><span class="titlemark">0.1.6   </span> <a id="x1-70000.1.6"></a>Do I need to download and compile the kernel?</h4>
<!-- l. 133 --><p class="noindent">For the purposes of following this guide you don’t necessarily need to do that.
However, it would be wise to run the examples within a test distribution running
on a virtual machine in order to avoid any possibility of messing up your
system.
</p><!-- l. 136 --><p class="noindent">
</p>
   <h4 class="subsectionHead" id="before-we-begin"><span class="titlemark">0.1.7   </span> <a id="x1-80000.1.7"></a>Before We Begin</h4>
<!-- l. 138 --><p class="noindent">Before we delve into code, there are a few issues we need to cover. Everyone’s system
is different and everyone has their own groove. Getting your first "hello world"
program to compile and load correctly can sometimes be a trick. Rest assured, after
you get over the initial hurdle of doing it for the first time, it will be smooth sailing
thereafter.
</p><!-- l. 143 --><p class="indent">
     </p><ol class="enumerate1">
<li class="enumerate" id="x1-8002x1">Modversioning. A module compiled for one kernel will not load if you boot
     a different kernel unless you enable <code>  <span class="ectt-1000">CONFIG_MODVERSIONS</span>
     </code> in the kernel. We will not go into module versioning until later in this
     guide. Until we cover modversions, the examples in the guide may not
     work if you are running a kernel with modversioning turned on. However,
     most stock Linux distribution kernels come with it turned on. If you are
     having trouble loading the modules because of versioning errors, compile
     a kernel with modversioning turned off.
     </li>
<li class="enumerate" id="x1-8005x2">
     <!-- l. 151 --><p class="noindent">Using X Window System. <a id="x1-80042"></a>It is highly recommended that you extract,
     compile and load all the examples this guide discusses. It is also highly
     recommended you do this from a console. You should not be working on
     this stuff in X Window System.
                                                                  

                                                                  
     </p><!-- l. 157 --><p class="noindent">Modules can not print to the screen like <code>  <span class="ectt-1000">printf()</span>
     </code> can, but they can log information and warnings, which ends up being
     printed on your screen, but only on a console. If you <code>  <span class="ectt-1000">insmod</span>
     </code> a module from an xterm, the information and warnings will be logged, but
     only to your systemd journal. You will not see it unless you look through
     your <code>  <span class="ectt-1000">journalctl</span>
     </code>. See <a href="https://sysprog21.github.io/lkmpg/#hello-world">0.4<!-- tex4ht:ref: sec:helloworld  --></a> for details. To have immediate access to this information, do all
     your work from the console.</p></li></ol>
<!-- l. 164 --><p class="noindent">
</p>
   <h3 class="sectionHead" id="headers"><span class="titlemark">0.2   </span> <a id="x1-90000.2"></a>Headers</h3>
<!-- l. 166 --><p class="noindent">Before you can build anything you’ll need to install the header files for your
kernel.
</p><!-- l. 168 --><p class="indent">   On Ubuntu/Debian: 
</p>
   <pre class="fancyvrb" id="fancyvrb6"><a id="x1-9004r1"></a><span class="ecrm-0500">1</span><span class="ectt-1000">sudo&nbsp;apt-get&nbsp;update</span> 
<a id="x1-9006r2"></a><span class="ecrm-0500">2</span><span class="ectt-1000">apt-cache&nbsp;search&nbsp;linux-headers-</span><span id="textcolor1"><span class="tctt-1000">`</span></span><span class="ectt-1000">uname&nbsp;-r</span><span id="textcolor2"><span class="tctt-1000">`</span></span></pre>
<!-- l. 174 --><p class="indent">   On Arch Linux: 
</p>
   <pre class="fancyvrb" id="fancyvrb7"><a id="x1-9009r1"></a><span class="ecrm-0500">1</span><span class="ectt-1000">sudo&nbsp;pacman&nbsp;-S&nbsp;linux-libre-headers</span></pre>
<!-- l. 179 --><p class="indent">   This will tell you what kernel header files are available. Then for example: 
</p>
   <pre class="fancyvrb" id="fancyvrb8"><a id="x1-9012r1"></a><span class="ecrm-0500">1</span><span class="ectt-1000">sudo&nbsp;apt-get&nbsp;install&nbsp;kmod&nbsp;linux-headers-5.4.0-80-generic</span></pre>
<!-- l. 185 --><p class="noindent">
</p>
   <h3 class="sectionHead" id="examples"><span class="titlemark">0.3   </span> <a id="x1-100000.3"></a>Examples</h3>
<!-- l. 187 --><p class="noindent">All the examples from this document are available within the <span class="obeylines-h"><span class="verb"><span class="ectt-1000">examples</span></span></span>
subdirectory.
</p><!-- l. 189 --><p class="indent">   If there are any compile errors then you might have a more recent kernel version
or need to install the corresponding kernel header files.
                                                                  

                                                                  
</p><!-- l. 191 --><p class="noindent">
</p>
   <h3 class="sectionHead" id="hello-world"><span class="titlemark">0.4   </span> <a id="x1-110000.4"></a>Hello World</h3>
<!-- l. 193 --><p class="noindent">
</p>
   <h4 class="subsectionHead" id="the-simplest-module"><span class="titlemark">0.4.1   </span> <a id="x1-120000.4.1"></a>The Simplest Module</h4>
<!-- l. 195 --><p class="noindent">Most people learning programming start out with some sort of "<span class="ecti-1000">hello world</span>"
example. I don’t know what happens to people who break with this tradition, but I
think it is safer not to find out. We will start with a series of hello world
programs that demonstrate the different aspects of the basics of writing a kernel
module.
</p><!-- l. 199 --><p class="indent">   Here is the simplest module possible.
</p><!-- l. 201 --><p class="indent">   Make a test directory: 
</p>
   <pre class="fancyvrb" id="fancyvrb9"><a id="x1-12004r1"></a><span class="ecrm-0500">1</span><span class="ectt-1000">mkdir&nbsp;-p&nbsp;~/develop/kernel/hello-1</span> 
<a id="x1-12006r2"></a><span class="ecrm-0500">2</span><span class="ectt-1000">cd&nbsp;~/develop/kernel/hello-1</span></pre>
<!-- l. 207 --><p class="indent">   Paste this into you favorite editor and save it as <span class="obeylines-h"><span class="verb"><span class="ectt-1000">hello-1.c</span></span></span>:
</p><!-- l. 1 --><p class="indent">
</p>
   <pre class="fancyvrb" id="fancyvrb10"><a id="x1-12008r1"></a><span class="ecrm-0500">1</span><span id="textcolor3"><span class="ectt-0800">/*</span></span> 
<a id="x1-12010r2"></a><span class="ecrm-0500">2</span><span id="textcolor4"><span class="ectt-0800">&nbsp;*&nbsp;hello-1.c&nbsp;-&nbsp;The&nbsp;simplest&nbsp;kernel&nbsp;module.</span></span> 
<a id="x1-12012r3"></a><span class="ecrm-0500">3</span><span id="textcolor5"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-12014r4"></a><span class="ecrm-0500">4</span><span id="textcolor6"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor7"><span class="ectt-0800">&lt;linux/kernel.h&gt;&nbsp;/*&nbsp;Needed&nbsp;for&nbsp;KERN_INFO&nbsp;*/</span></span> 
<a id="x1-12016r5"></a><span class="ecrm-0500">5</span><span id="textcolor8"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor9"><span class="ectt-0800">&lt;linux/module.h&gt;&nbsp;/*&nbsp;Needed&nbsp;by&nbsp;all&nbsp;modules&nbsp;*/</span></span> 
<a id="x1-12018r6"></a><span class="ecrm-0500">6</span> 
<a id="x1-12020r7"></a><span class="ecrm-0500">7</span><span id="textcolor10"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;init_module(</span><span id="textcolor11"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-12022r8"></a><span class="ecrm-0500">8</span><span class="ectt-0800">{</span> 
<a id="x1-12024r9"></a><span class="ecrm-0500">9</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor12"><span class="ectt-0800">"Hello&nbsp;world&nbsp;1.</span></span><span id="textcolor13"><span class="ectt-0800">\n</span></span><span id="textcolor14"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-12026r10"></a><span class="ecrm-0500">10</span> 
<a id="x1-12028r11"></a><span class="ecrm-0500">11</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor15"><span class="ectt-0800">/*&nbsp;A&nbsp;non&nbsp;0&nbsp;return&nbsp;means&nbsp;init_module&nbsp;failed;&nbsp;module&nbsp;can</span><span class="tctt-0800">'</span><span class="ectt-0800">t&nbsp;be&nbsp;loaded.&nbsp;*/</span></span> 
<a id="x1-12030r12"></a><span class="ecrm-0500">12</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor16"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;0;</span> 
<a id="x1-12032r13"></a><span class="ecrm-0500">13</span><span class="ectt-0800">}</span> 
<a id="x1-12034r14"></a><span class="ecrm-0500">14</span> 
<a id="x1-12036r15"></a><span class="ecrm-0500">15</span><span id="textcolor17"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;cleanup_module(</span><span id="textcolor18"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-12038r16"></a><span class="ecrm-0500">16</span><span class="ectt-0800">{</span> 
<a id="x1-12040r17"></a><span class="ecrm-0500">17</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor19"><span class="ectt-0800">"Goodbye&nbsp;world&nbsp;1.</span></span><span id="textcolor20"><span class="ectt-0800">\n</span></span><span id="textcolor21"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-12042r18"></a><span class="ecrm-0500">18</span><span class="ectt-0800">}</span> 
<a id="x1-12044r19"></a><span class="ecrm-0500">19</span> 
<a id="x1-12046r20"></a><span class="ecrm-0500">20</span><span class="ectt-0800">MODULE_LICENSE(</span><span id="textcolor22"><span class="ectt-0800">"GPL"</span></span><span class="ectt-0800">);</span></pre>
<!-- l. 211 --><p class="indent">   Now you will need a <span class="obeylines-h"><span class="verb"><span class="ectt-1000">Makefile</span></span></span>. If you copy and paste this, change the indentation
to use <span class="ecti-1000">tabs</span>, not spaces.
</p><!-- l. 1 --><p class="indent">
</p>
   <pre class="fancyvrb" id="fancyvrb11"><a id="x1-12055r1"></a><span class="ecrm-0500">1</span><span class="ectt-0800">obj-m&nbsp;+=&nbsp;hello-1.o</span> 
<a id="x1-12057r2"></a><span class="ecrm-0500">2</span> 
<a id="x1-12059r3"></a><span class="ecrm-0500">3</span><span class="ectt-0800">all:</span> 
<a id="x1-12061r4"></a><span class="ecrm-0500">4</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;make&nbsp;-C&nbsp;/lib/modules/</span><span class="colorbox" id="colorbox23"><span class="ectt-0800">$</span></span><span class="ectt-0800">(shell&nbsp;uname&nbsp;-r)/build&nbsp;M=</span><span class="colorbox" id="colorbox24"><span class="ectt-0800">$</span></span><span class="ectt-0800">(PWD)&nbsp;modules</span> 
<a id="x1-12063r5"></a><span class="ecrm-0500">5</span> 
<a id="x1-12065r6"></a><span class="ecrm-0500">6</span><span class="ectt-0800">clean:</span> 
<a id="x1-12067r7"></a><span class="ecrm-0500">7</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;make&nbsp;-C&nbsp;/lib/modules/</span><span class="colorbox" id="colorbox25"><span class="ectt-0800">$</span></span><span class="ectt-0800">(shell&nbsp;uname&nbsp;-r)/build&nbsp;M=</span><span class="colorbox" id="colorbox26"><span class="ectt-0800">$</span></span><span class="ectt-0800">(PWD)&nbsp;clean</span></pre>
<!-- l. 223 --><p class="indent">   And finally just: 
</p>
   <pre class="fancyvrb" id="fancyvrb12"><a id="x1-12070r1"></a><span class="ecrm-0500">1</span><span class="ectt-1000">make</span></pre>
<!-- l. 228 --><p class="indent">   If all goes smoothly you should then find that you have a compiled <span class="obeylines-h"><span class="verb"><span class="ectt-1000">hello-1.ko</span></span></span>
module. You can find info on it with the command: 
</p>
   <pre class="fancyvrb" id="fancyvrb13"><a id="x1-12073r1"></a><span class="ecrm-0500">1</span><span class="ectt-1000">sudo&nbsp;modinfo&nbsp;hello-1.ko</span></pre>
<!-- l. 234 --><p class="indent">   At this point the command: 
                                                                  

                                                                  
</p>
   <pre class="fancyvrb" id="fancyvrb14"><a id="x1-12076r1"></a><span class="ecrm-0500">1</span><span class="ectt-1000">sudo&nbsp;lsmod&nbsp;|&nbsp;grep&nbsp;hello</span></pre>
<!-- l. 239 --><p class="indent">   should return nothing. You can try loading your shiny new module with: 
</p>
   <pre class="fancyvrb" id="fancyvrb15"><a id="x1-12079r1"></a><span class="ecrm-0500">1</span><span class="ectt-1000">sudo&nbsp;insmod&nbsp;hello-1.ko</span></pre>
<!-- l. 245 --><p class="indent">   The dash character will get converted to an underscore, so when you again try: 
</p>
   <pre class="fancyvrb" id="fancyvrb16"><a id="x1-12082r1"></a><span class="ecrm-0500">1</span><span class="ectt-1000">sudo&nbsp;lsmod&nbsp;|&nbsp;grep&nbsp;hello</span></pre>
<!-- l. 250 --><p class="indent">   you should now see your loaded module. It can be removed again with: 
</p>
   <pre class="fancyvrb" id="fancyvrb17"><a id="x1-12085r1"></a><span class="ecrm-0500">1</span><span class="ectt-1000">sudo&nbsp;rmmod&nbsp;hello_1</span></pre>
<!-- l. 255 --><p class="indent">   Notice that the dash was replaced by an underscore. To see what just happened in
the logs: 
</p>
   <pre class="fancyvrb" id="fancyvrb18"><a id="x1-12088r1"></a><span class="ecrm-0500">1</span><span class="ectt-1000">journalctl&nbsp;--since&nbsp;</span><span id="textcolor27"><span class="ectt-1000">"1&nbsp;hour&nbsp;ago"</span></span><span class="ectt-1000">&nbsp;|&nbsp;grep&nbsp;kernel</span></pre>
<!-- l. 261 --><p class="indent">   You now know the basics of creating, compiling, installing and removing modules.
Now for more of a description of how this module works.
</p><!-- l. 264 --><p class="indent">   Kernel modules must have at least two functions: a "start" (initialization) function
called <code>  <span class="ectt-1000">init_module()</span>
</code> which is called when the module is <code>  <span class="ectt-1000">insmod</span>
</code>ed into the kernel, and an "end" (cleanup) function called
<code> <span class="ectt-1000">cleanup_module()</span>
</code> which is called just before it is removed from the kernel. Actually, things have
changed starting with kernel 2.3.13. You can now use whatever name you like for the
start and end functions of a module, and you will learn how to do this in Section
<a href="https://sysprog21.github.io/lkmpg/#hello-and-goodbye">0.4.2<!-- tex4ht:ref: hello_n_goodbye  --></a>. In fact, the new method is the preferred method. However, many people still
use <code>  <span class="ectt-1000">init_module()</span>
</code> and <code>  <span class="ectt-1000">cleanup_module()</span>
</code> for their start and end functions.
</p><!-- l. 271 --><p class="indent">   Typically, <code>  <span class="ectt-1000">init_module()</span>
</code> either registers a handler for something with the kernel, or it replaces one of the kernel
                                                                  

                                                                  
functions with its own code (usually code to do something and then call the original function).
The <code>  <span class="ectt-1000">cleanup_module()</span>
</code> function is supposed to undo whatever
<code> <span class="ectt-1000">init_module()</span>
</code> did, so the module can be unloaded safely.
</p><!-- l. 274 --><p class="indent">   Lastly, every kernel module needs to include <span class="obeylines-h"><span class="verb"><span class="ectt-1000">&lt;linux/module.h&gt;</span></span></span>. We
needed to include <span class="obeylines-h"><span class="verb"><span class="ectt-1000">&lt;linux/kernel.h&gt;</span></span></span> only for the macro expansion for the
<code> <span class="ectt-1000">pr_alert()</span>
</code> log level, which you’ll learn about in Section <a href="https://sysprog21.github.io/lkmpg/#x1-121002">2<!-- tex4ht:ref: sec:printk  --></a>.
</p><!-- l. 278 --><p class="indent">
     </p><ol class="enumerate1">
<li class="enumerate" id="x1-12099x1">A point about coding style. Another thing which may not be immediately
     obvious  to  anyone  getting  started  with  kernel  programming  is  that
     indentation within your code should be using <span class="ecbx-1000">tabs </span>and <span class="ecbx-1000">not spaces</span>. It is
     one of the coding conventions of the kernel. You may not like it, but you’ll
     need to get used to it if you ever submit a patch upstream.
     </li>
<li class="enumerate" id="x1-12101x2">Introducing print macros. <a id="x1-121002"></a>In the beginning there was <code>  <span class="ectt-1000">printk</span>
     </code>, usually followed by a priority such as <code>  <span class="ectt-1000">KERN_INFO</span>
     </code> or <code>  <span class="ectt-1000">KERN_DEBUG</span>
     </code>. More recently this can also be expressed in abbreviated form using a set of
     print macros, such as <code>  <span class="ectt-1000">pr_info</span>
     </code> and <code>  <span class="ectt-1000">pr_debug</span>
     </code>. This just saves some mindless keyboard bashing and looks a bit neater.
     They can be found within <a href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/printk.h">include/linux/printk.h</a>. Take time to read through
     the available priority macros.
     </li>
<li class="enumerate" id="x1-12108x3">
     <!-- l. 292 --><p class="noindent">About Compiling. Kernel modules need to be compiled a bit differently
     from  regular  userspace  apps.  Former  kernel  versions  required  us  to
     care much about these settings, which are usually stored in Makefiles.
     Although hierarchically organized, many redundant settings accumulated
     in sublevel Makefiles and made them large and rather difficult to maintain.
                                                                  

                                                                  
     Fortunately, there is a new way of doing these things, called kbuild, and
     the build process for external loadable modules is now fully integrated into
     the standard kernel build mechanism. To learn more on how to compile
     modules which are not part of the official kernel (such as all the examples
     you will find in this guide), see file <a href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/tree/Documentation/kbuild/modules.rst">Documentation/kbuild/modules.rst</a>.
     </p><!-- l. 299 --><p class="noindent">Additional  details  about  Makefiles  for  kernel  modules  are  available  in
     <a href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/tree/Documentation/kbuild/makefiles.rst">Documentation/kbuild/makefiles.rst</a>. Be sure to read this and the related
     files before starting to hack Makefiles. It will probably save you lots of
     work.
     </p><!-- l. 301 --><p class="noindent">
         </p><blockquote class="quote">
         <!-- l. 302 --><p class="noindent">Here is another exercise for the reader. See that comment above
         the return statement in <code>  <span class="ectt-1000">init_module()</span>
         </code>? Change the return value to something negative, recompile and
         load the module again. What happens?</p></blockquote>
     </li></ol>
<!-- l. 309 --><p class="noindent">
</p>
   <h4 class="subsectionHead" id="hello-and-goodbye"><span class="titlemark">0.4.2   </span> <a id="x1-130000.4.2"></a>Hello and Goodbye</h4>
<!-- l. 311 --><p class="noindent">In early kernel versions you had to use the
<code> <span class="ectt-1000">init_module</span>
</code> and <code>  <span class="ectt-1000">cleanup_module</span>
</code> functions, as in the first hello world example, but these days you can name those anything you
want by using the <code>  <span class="ectt-1000">module_init</span>
</code> and <code>  <span class="ectt-1000">module_exit</span>
</code> macros. These macros are defined in <a href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/init.h">include/linux/init.h</a>. The only requirement is
that your init and cleanup functions must be defined before calling the those
macros, otherwise you’ll get compilation errors. Here is an example of this
technique:
</p><!-- l. 1 --><p class="indent">
</p>
   <pre class="fancyvrb" id="fancyvrb19"><a id="x1-13006r1"></a><span class="ecrm-0500">1</span><span id="textcolor28"><span class="ectt-0800">/*</span></span> 
<a id="x1-13008r2"></a><span class="ecrm-0500">2</span><span id="textcolor29"><span class="ectt-0800">&nbsp;*&nbsp;hello-2.c&nbsp;-&nbsp;Demonstrating&nbsp;the&nbsp;module_init()&nbsp;and&nbsp;module_exit()&nbsp;macros.</span></span> 
<a id="x1-13010r3"></a><span class="ecrm-0500">3</span><span id="textcolor30"><span class="ectt-0800">&nbsp;*&nbsp;This&nbsp;is&nbsp;preferred&nbsp;over&nbsp;using&nbsp;init_module()&nbsp;and&nbsp;cleanup_module().</span></span> 
<a id="x1-13012r4"></a><span class="ecrm-0500">4</span><span id="textcolor31"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-13014r5"></a><span class="ecrm-0500">5</span><span id="textcolor32"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor33"><span class="ectt-0800">&lt;linux/init.h&gt;&nbsp;&nbsp;&nbsp;/*&nbsp;Needed&nbsp;for&nbsp;the&nbsp;macros&nbsp;*/</span></span> 
<a id="x1-13016r6"></a><span class="ecrm-0500">6</span><span id="textcolor34"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor35"><span class="ectt-0800">&lt;linux/kernel.h&gt;&nbsp;/*&nbsp;Needed&nbsp;for&nbsp;KERN_INFO&nbsp;*/</span></span> 
<a id="x1-13018r7"></a><span class="ecrm-0500">7</span><span id="textcolor36"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor37"><span class="ectt-0800">&lt;linux/module.h&gt;&nbsp;/*&nbsp;Needed&nbsp;by&nbsp;all&nbsp;modules&nbsp;*/</span></span> 
<a id="x1-13020r8"></a><span class="ecrm-0500">8</span> 
<a id="x1-13022r9"></a><span class="ecrm-0500">9</span><span id="textcolor38"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor39"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;__init&nbsp;hello_2_init(</span><span id="textcolor40"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-13024r10"></a><span class="ecrm-0500">10</span><span class="ectt-0800">{</span> 
<a id="x1-13026r11"></a><span class="ecrm-0500">11</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor41"><span class="ectt-0800">"Hello,&nbsp;world&nbsp;2</span></span><span id="textcolor42"><span class="ectt-0800">\n</span></span><span id="textcolor43"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-13028r12"></a><span class="ecrm-0500">12</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor44"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;0;</span> 
<a id="x1-13030r13"></a><span class="ecrm-0500">13</span><span class="ectt-0800">}</span> 
<a id="x1-13032r14"></a><span class="ecrm-0500">14</span> 
<a id="x1-13034r15"></a><span class="ecrm-0500">15</span><span id="textcolor45"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor46"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;__exit&nbsp;hello_2_exit(</span><span id="textcolor47"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-13036r16"></a><span class="ecrm-0500">16</span><span class="ectt-0800">{</span> 
<a id="x1-13038r17"></a><span class="ecrm-0500">17</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor48"><span class="ectt-0800">"Goodbye,&nbsp;world&nbsp;2</span></span><span id="textcolor49"><span class="ectt-0800">\n</span></span><span id="textcolor50"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-13040r18"></a><span class="ecrm-0500">18</span><span class="ectt-0800">}</span> 
<a id="x1-13042r19"></a><span class="ecrm-0500">19</span> 
<a id="x1-13044r20"></a><span class="ecrm-0500">20</span><span class="ectt-0800">module_init(hello_2_init);</span> 
<a id="x1-13046r21"></a><span class="ecrm-0500">21</span><span class="ectt-0800">module_exit(hello_2_exit);</span> 
<a id="x1-13048r22"></a><span class="ecrm-0500">22</span> 
<a id="x1-13050r23"></a><span class="ecrm-0500">23</span><span class="ectt-0800">MODULE_LICENSE(</span><span id="textcolor51"><span class="ectt-0800">"GPL"</span></span><span class="ectt-0800">);</span></pre>
<!-- l. 318 --><p class="indent">   So now we have two real kernel modules under our belt. Adding another module
is as simple as this:
</p><!-- l. 1 --><p class="indent">
</p>
   <pre class="fancyvrb" id="fancyvrb20"><a id="x1-13060r1"></a><span class="ecrm-0500">1</span><span class="ectt-0800">obj-m&nbsp;+=&nbsp;hello-1.o</span> 
<a id="x1-13062r2"></a><span class="ecrm-0500">2</span><span class="ectt-0800">obj-m&nbsp;+=&nbsp;hello-2.o</span> 
<a id="x1-13064r3"></a><span class="ecrm-0500">3</span> 
<a id="x1-13066r4"></a><span class="ecrm-0500">4</span><span class="ectt-0800">all:</span> 
<a id="x1-13068r5"></a><span class="ecrm-0500">5</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;make&nbsp;-C&nbsp;/lib/modules/</span><span class="colorbox" id="colorbox52"><span class="ectt-0800">$</span></span><span class="ectt-0800">(shell&nbsp;uname&nbsp;-r)/build&nbsp;M=</span><span class="colorbox" id="colorbox53"><span class="ectt-0800">$</span></span><span class="ectt-0800">(PWD)&nbsp;modules</span> 
<a id="x1-13070r6"></a><span class="ecrm-0500">6</span> 
<a id="x1-13072r7"></a><span class="ecrm-0500">7</span><span class="ectt-0800">clean:</span> 
<a id="x1-13074r8"></a><span class="ecrm-0500">8</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;make&nbsp;-C&nbsp;/lib/modules/</span><span class="colorbox" id="colorbox54"><span class="ectt-0800">$</span></span><span class="ectt-0800">(shell&nbsp;uname&nbsp;-r)/build&nbsp;M=</span><span class="colorbox" id="colorbox55"><span class="ectt-0800">$</span></span><span class="ectt-0800">(PWD)&nbsp;clean</span></pre>
                                                                  

                                                                  
<!-- l. 331 --><p class="indent">   Now have a look at <a href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/char/Makefile">drivers/char/Makefile</a> for a real world example. As you can
see, some things get hardwired into the kernel (<span class="obeylines-h"><span class="verb"><span class="ectt-1000">obj-y</span></span></span>) but where are all those <span class="obeylines-h"><span class="verb"><span class="ectt-1000">obj-m</span></span></span>
gone? Those familiar with shell scripts will easily be able to spot them. For those not,
the <span class="obeylines-h"><span class="verb"><span class="ectt-1000">obj-$(CONFIG_FOO)</span></span></span> entries you see everywhere expand into <span class="obeylines-h"><span class="verb"><span class="ectt-1000">obj-y</span></span></span> or <span class="obeylines-h"><span class="verb"><span class="ectt-1000">obj-m</span></span></span>,
depending on whether the <span class="obeylines-h"><span class="verb"><span class="ectt-1000">CONFIG_FOO</span></span></span> variable has been set to y or m. While we are
at it, those were exactly the kind of variables that you have set in the <span class="obeylines-h"><span class="verb"><span class="ectt-1000">.config</span></span></span> file in
the top-level directory of Linux kernel source tree, the last time when you said
<code> <span class="ectt-1000">make&nbsp;menuconfig</span>
</code> or something like that.
</p><!-- l. 337 --><p class="noindent">
</p>
   <h4 class="subsectionHead" id="the-init-and-exit-macros"><span class="titlemark">0.4.3   </span> <a id="x1-140000.4.3"></a>The __init and __exit Macros</h4>
<!-- l. 339 --><p class="noindent">This demonstrates a feature of kernel 2.2 and later. Notice the
change in the definitions of the init and cleanup functions. The
<code> <span class="ectt-1000">__init</span>
</code> macro causes the init function to be discarded and its memory freed once the init
function finishes for built-in drivers, but not loadable modules. If you think about
when the init function is invoked, this makes perfect sense.
</p><!-- l. 344 --><p class="indent">   There is also an <code>  <span class="ectt-1000">__initdata</span>
</code> which works similarly to <code>  <span class="ectt-1000">__init</span>
</code> but for init variables rather than functions.
</p><!-- l. 346 --><p class="indent">   The <code>  <span class="ectt-1000">__exit</span>
</code> macro causes the omission of the function when the module is built into the kernel, and
like <code>  <span class="ectt-1000">__init</span>
</code>, has no effect for loadable modules. Again, if you consider when the cleanup function
runs, this makes complete sense; built-in drivers do not need a cleanup function,
while loadable modules do.
</p><!-- l. 349 --><p class="indent">   These macros are defined in <a href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/init.h">include/linux/init.h</a> and serve to free up kernel
memory. When you boot your kernel and see something like Freeing unused kernel
memory: 236k freed, this is precisely what the kernel is freeing.
</p><!-- l. 1 --><p class="indent">
</p>
   <pre class="fancyvrb" id="fancyvrb21"><a id="x1-14007r1"></a><span class="ecrm-0500">1</span><span id="textcolor56"><span class="ectt-0800">/*</span></span> 
<a id="x1-14009r2"></a><span class="ecrm-0500">2</span><span id="textcolor57"><span class="ectt-0800">&nbsp;*&nbsp;hello-3.c&nbsp;-&nbsp;Illustrating&nbsp;the&nbsp;__init,&nbsp;__initdata&nbsp;and&nbsp;__exit&nbsp;macros.</span></span> 
<a id="x1-14011r3"></a><span class="ecrm-0500">3</span><span id="textcolor58"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-14013r4"></a><span class="ecrm-0500">4</span><span id="textcolor59"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor60"><span class="ectt-0800">&lt;linux/init.h&gt;&nbsp;&nbsp;&nbsp;/*&nbsp;Needed&nbsp;for&nbsp;the&nbsp;macros&nbsp;*/</span></span> 
<a id="x1-14015r5"></a><span class="ecrm-0500">5</span><span id="textcolor61"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor62"><span class="ectt-0800">&lt;linux/kernel.h&gt;&nbsp;/*&nbsp;Needed&nbsp;for&nbsp;KERN_INFO&nbsp;*/</span></span> 
<a id="x1-14017r6"></a><span class="ecrm-0500">6</span><span id="textcolor63"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor64"><span class="ectt-0800">&lt;linux/module.h&gt;&nbsp;/*&nbsp;Needed&nbsp;by&nbsp;all&nbsp;modules&nbsp;*/</span></span> 
<a id="x1-14019r7"></a><span class="ecrm-0500">7</span> 
<a id="x1-14021r8"></a><span class="ecrm-0500">8</span><span id="textcolor65"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor66"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;hello3_data&nbsp;__initdata&nbsp;=&nbsp;3;</span> 
<a id="x1-14023r9"></a><span class="ecrm-0500">9</span> 
<a id="x1-14025r10"></a><span class="ecrm-0500">10</span><span id="textcolor67"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor68"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;__init&nbsp;hello_3_init(</span><span id="textcolor69"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-14027r11"></a><span class="ecrm-0500">11</span><span class="ectt-0800">{</span> 
<a id="x1-14029r12"></a><span class="ecrm-0500">12</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor70"><span class="ectt-0800">"Hello,&nbsp;world&nbsp;%d</span></span><span id="textcolor71"><span class="ectt-0800">\n</span></span><span id="textcolor72"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;hello3_data);</span> 
<a id="x1-14031r13"></a><span class="ecrm-0500">13</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor73"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;0;</span> 
<a id="x1-14033r14"></a><span class="ecrm-0500">14</span><span class="ectt-0800">}</span> 
<a id="x1-14035r15"></a><span class="ecrm-0500">15</span> 
<a id="x1-14037r16"></a><span class="ecrm-0500">16</span><span id="textcolor74"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor75"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;__exit&nbsp;hello_3_exit(</span><span id="textcolor76"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-14039r17"></a><span class="ecrm-0500">17</span><span class="ectt-0800">{</span> 
<a id="x1-14041r18"></a><span class="ecrm-0500">18</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor77"><span class="ectt-0800">"Goodbye,&nbsp;world&nbsp;3</span></span><span id="textcolor78"><span class="ectt-0800">\n</span></span><span id="textcolor79"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-14043r19"></a><span class="ecrm-0500">19</span><span class="ectt-0800">}</span> 
<a id="x1-14045r20"></a><span class="ecrm-0500">20</span> 
<a id="x1-14047r21"></a><span class="ecrm-0500">21</span><span class="ectt-0800">module_init(hello_3_init);</span> 
<a id="x1-14049r22"></a><span class="ecrm-0500">22</span><span class="ectt-0800">module_exit(hello_3_exit);</span> 
<a id="x1-14051r23"></a><span class="ecrm-0500">23</span> 
<a id="x1-14053r24"></a><span class="ecrm-0500">24</span><span class="ectt-0800">MODULE_LICENSE(</span><span id="textcolor80"><span class="ectt-0800">"GPL"</span></span><span class="ectt-0800">);</span></pre>
<!-- l. 354 --><p class="noindent">
</p>
   <h4 class="subsectionHead" id="licensing-and-module-documentation"><span class="titlemark">0.4.4   </span> <a id="x1-150000.4.4"></a>Licensing and Module Documentation</h4>
<!-- l. 356 --><p class="noindent">Honestly, who loads or even cares about proprietary modules? If you do then you
might have seen something like this:
                                                                  

                                                                  
</p>
   <pre class="verbatim" id="verbatim-1">$&nbsp;sudo&nbsp;insmod&nbsp;xxxxxx.ko
loading&nbsp;out-of-tree&nbsp;module&nbsp;taints&nbsp;kernel.
module&nbsp;license&nbsp;'unspecified'&nbsp;taints&nbsp;kernel.
</pre>
<!-- l. 362 --><p class="nopar">
</p><!-- l. 364 --><p class="indent">   You can use a few macros to indicate the license for your module. Some examples
are "GPL", "GPL v2", "GPL and additional rights", "Dual BSD/GPL", "Dual
MIT/GPL", "Dual MPL/GPL" and "Proprietary". They are defined within
<a href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/module.h">include/linux/module.h</a>.
</p><!-- l. 368 --><p class="indent">   To reference what license you’re using a macro is available called
<code> <span class="ectt-1000">MODULE_LICENSE</span>
</code>. This and a few other macros describing the module are illustrated in the below
example.
</p><!-- l. 1 --><p class="indent">
</p>
   <pre class="fancyvrb" id="fancyvrb22"><a id="x1-15003r1"></a><span class="ecrm-0500">1</span><span id="textcolor81"><span class="ectt-0800">/*</span></span> 
<a id="x1-15005r2"></a><span class="ecrm-0500">2</span><span id="textcolor82"><span class="ectt-0800">&nbsp;*&nbsp;hello-4.c&nbsp;-&nbsp;Demonstrates&nbsp;module&nbsp;documentation.</span></span> 
<a id="x1-15007r3"></a><span class="ecrm-0500">3</span><span id="textcolor83"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-15009r4"></a><span class="ecrm-0500">4</span><span id="textcolor84"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor85"><span class="ectt-0800">&lt;linux/init.h&gt;&nbsp;&nbsp;&nbsp;/*&nbsp;Needed&nbsp;for&nbsp;the&nbsp;macros&nbsp;*/</span></span> 
<a id="x1-15011r5"></a><span class="ecrm-0500">5</span><span id="textcolor86"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor87"><span class="ectt-0800">&lt;linux/kernel.h&gt;&nbsp;/*&nbsp;Needed&nbsp;for&nbsp;KERN_INFO&nbsp;*/</span></span> 
<a id="x1-15013r6"></a><span class="ecrm-0500">6</span><span id="textcolor88"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor89"><span class="ectt-0800">&lt;linux/module.h&gt;&nbsp;/*&nbsp;Needed&nbsp;by&nbsp;all&nbsp;modules&nbsp;*/</span></span> 
<a id="x1-15015r7"></a><span class="ecrm-0500">7</span> 
<a id="x1-15017r8"></a><span class="ecrm-0500">8</span><span class="ectt-0800">MODULE_LICENSE(</span><span id="textcolor90"><span class="ectt-0800">"GPL"</span></span><span class="ectt-0800">);</span> 
<a id="x1-15019r9"></a><span class="ecrm-0500">9</span><span class="ectt-0800">MODULE_AUTHOR(</span><span id="textcolor91"><span class="ectt-0800">"LKMPG"</span></span><span class="ectt-0800">);</span> 
<a id="x1-15021r10"></a><span class="ecrm-0500">10</span><span class="ectt-0800">MODULE_DESCRIPTION(</span><span id="textcolor92"><span class="ectt-0800">"A&nbsp;sample&nbsp;driver"</span></span><span class="ectt-0800">);</span> 
<a id="x1-15023r11"></a><span class="ecrm-0500">11</span><span class="ectt-0800">MODULE_SUPPORTED_DEVICE(</span><span id="textcolor93"><span class="ectt-0800">"testdevice"</span></span><span class="ectt-0800">);</span> 
<a id="x1-15025r12"></a><span class="ecrm-0500">12</span> 
<a id="x1-15027r13"></a><span class="ecrm-0500">13</span><span id="textcolor94"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor95"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;__init&nbsp;init_hello_4(</span><span id="textcolor96"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-15029r14"></a><span class="ecrm-0500">14</span><span class="ectt-0800">{</span> 
<a id="x1-15031r15"></a><span class="ecrm-0500">15</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor97"><span class="ectt-0800">"Hello,&nbsp;world&nbsp;4</span></span><span id="textcolor98"><span class="ectt-0800">\n</span></span><span id="textcolor99"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-15033r16"></a><span class="ecrm-0500">16</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor100"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;0;</span> 
<a id="x1-15035r17"></a><span class="ecrm-0500">17</span><span class="ectt-0800">}</span> 
<a id="x1-15037r18"></a><span class="ecrm-0500">18</span> 
<a id="x1-15039r19"></a><span class="ecrm-0500">19</span><span id="textcolor101"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor102"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;__exit&nbsp;cleanup_hello_4(</span><span id="textcolor103"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-15041r20"></a><span class="ecrm-0500">20</span><span class="ectt-0800">{</span> 
<a id="x1-15043r21"></a><span class="ecrm-0500">21</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor104"><span class="ectt-0800">"Goodbye,&nbsp;world&nbsp;4</span></span><span id="textcolor105"><span class="ectt-0800">\n</span></span><span id="textcolor106"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-15045r22"></a><span class="ecrm-0500">22</span><span class="ectt-0800">}</span> 
<a id="x1-15047r23"></a><span class="ecrm-0500">23</span> 
<a id="x1-15049r24"></a><span class="ecrm-0500">24</span><span class="ectt-0800">module_init(init_hello_4);</span> 
<a id="x1-15051r25"></a><span class="ecrm-0500">25</span><span class="ectt-0800">module_exit(cleanup_hello_4);</span></pre>
<!-- l. 373 --><p class="noindent">
</p>
   <h4 class="subsectionHead" id="passing-command-line-arguments-to-a-module"><span class="titlemark">0.4.5   </span> <a id="x1-160000.4.5"></a>Passing Command Line Arguments to a Module</h4>
<!-- l. 375 --><p class="noindent">Modules can take command line arguments, but not with the argc/argv you might be
used to.
</p><!-- l. 377 --><p class="indent">   To allow arguments to be passed to your module, declare the variables that will
take the values of the command line arguments as global and then use the
<code> <span class="ectt-1000">module_param()</span>
</code> macro, (defined in <a href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/moduleparam.h">include/linux/moduleparam.h</a>) to set the mechanism up. At runtime,
<code> <span class="ectt-1000">insmod</span>
</code> will fill the variables with any command line arguments that are given, like
<code> <span class="ectt-1000">insmod&nbsp;mymodule.ko&nbsp;myvariable=5</span>
</code>. The variable declarations and macros should be placed at the beginning of the
module for clarity. The example code should clear up my admittedly lousy
explanation.
</p><!-- l. 382 --><p class="indent">   The <code>  <span class="ectt-1000">module_param()</span>
</code> macro takes 3 arguments: the name of the variable, its type and
permissions for the corresponding file in sysfs. Integer types can be signed
as usual or unsigned. If you’d like to use arrays of integers or strings see
<code> <span class="ectt-1000">module_param_array()</span>
</code> and <code>  <span class="ectt-1000">module_param_string()</span>
</code>.
</p><!-- l. 1 --><p class="indent">
                                                                  

                                                                  
</p>
   <pre class="fancyvrb" id="fancyvrb23"><a id="x1-16010r1"></a><span class="ecrm-0500">1</span><span id="textcolor107"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;myint&nbsp;=&nbsp;3;</span> 
<a id="x1-16012r2"></a><span class="ecrm-0500">2</span><span class="ectt-0800">module_param(myint,&nbsp;</span><span id="textcolor108"><span class="ectt-0800">int</span></span><span class="ectt-0800">,&nbsp;0);</span></pre>
<!-- l. 390 --><p class="indent">   Arrays are supported too, but things are a bit different now than they were in the
olden days. To keep track of the number of parameters you need to pass a pointer to
a count variable as third parameter. At your option, you could also ignore the count and
pass <code>  <span class="ectt-1000">NULL</span>
</code> instead. We show both possibilities here:
</p><!-- l. 1 --><p class="indent">
</p>
   <pre class="fancyvrb" id="fancyvrb24"><a id="x1-16021r1"></a><span class="ecrm-0500">1</span><span id="textcolor109"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;myintarray[2];</span> 
<a id="x1-16023r2"></a><span class="ecrm-0500">2</span><span class="ectt-0800">module_param_array(myintarray,&nbsp;</span><span id="textcolor110"><span class="ectt-0800">int</span></span><span class="ectt-0800">,&nbsp;NULL,&nbsp;0);&nbsp;</span><span id="textcolor111"><span class="ectt-0800">/*&nbsp;not&nbsp;interested&nbsp;in&nbsp;count&nbsp;*/</span></span> 
<a id="x1-16025r3"></a><span class="ecrm-0500">3</span> 
<a id="x1-16027r4"></a><span class="ecrm-0500">4</span><span id="textcolor112"><span class="ectt-0800">short</span></span><span class="ectt-0800">&nbsp;myshortarray[4];</span> 
<a id="x1-16029r5"></a><span class="ecrm-0500">5</span><span id="textcolor113"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;count;</span> 
<a id="x1-16031r6"></a><span class="ecrm-0500">6</span><span class="ectt-0800">module_param_array(myshortarray,&nbsp;</span><span id="textcolor114"><span class="ectt-0800">short</span></span><span class="ectt-0800">,&nbsp;&amp;count,&nbsp;0);&nbsp;</span><span id="textcolor115"><span class="ectt-0800">/*&nbsp;put&nbsp;count&nbsp;into&nbsp;"count"&nbsp;variable&nbsp;*/</span></span></pre>
<!-- l. 403 --><p class="indent">   A good use for this is to have the module variable’s default values set, like an port
or IO address. If the variables contain the default values, then perform autodetection
(explained elsewhere). Otherwise, keep the current value. This will be made clear
later on.
</p><!-- l. 407 --><p class="indent">   Lastly, there is a macro function, <code>  <span class="ectt-1000">MODULE_PARM_DESC()</span>
</code>, that is used to document arguments that the module can take. It takes two
parameters: a variable name and a free form string describing that variable.
</p><!-- l. 1 --><p class="indent">
</p>
   <pre class="fancyvrb" id="fancyvrb25"><a id="x1-16034r1"></a><span class="ecrm-0500">1</span><span id="textcolor116"><span class="ectt-0800">/*</span></span> 
<a id="x1-16036r2"></a><span class="ecrm-0500">2</span><span id="textcolor117"><span class="ectt-0800">&nbsp;*&nbsp;hello-5.c&nbsp;-&nbsp;Demonstrates&nbsp;command&nbsp;line&nbsp;argument&nbsp;passing&nbsp;to&nbsp;a&nbsp;module.</span></span> 
<a id="x1-16038r3"></a><span class="ecrm-0500">3</span><span id="textcolor118"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-16040r4"></a><span class="ecrm-0500">4</span><span id="textcolor119"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor120"><span class="ectt-0800">&lt;linux/init.h&gt;</span></span> 
<a id="x1-16042r5"></a><span class="ecrm-0500">5</span><span id="textcolor121"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor122"><span class="ectt-0800">&lt;linux/kernel.h&gt;</span></span> 
<a id="x1-16044r6"></a><span class="ecrm-0500">6</span><span id="textcolor123"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor124"><span class="ectt-0800">&lt;linux/module.h&gt;</span></span> 
<a id="x1-16046r7"></a><span class="ecrm-0500">7</span><span id="textcolor125"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor126"><span class="ectt-0800">&lt;linux/moduleparam.h&gt;</span></span> 
<a id="x1-16048r8"></a><span class="ecrm-0500">8</span><span id="textcolor127"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor128"><span class="ectt-0800">&lt;linux/stat.h&gt;</span></span> 
<a id="x1-16050r9"></a><span class="ecrm-0500">9</span> 
<a id="x1-16052r10"></a><span class="ecrm-0500">10</span><span class="ectt-0800">MODULE_LICENSE(</span><span id="textcolor129"><span class="ectt-0800">"GPL"</span></span><span class="ectt-0800">);</span> 
<a id="x1-16054r11"></a><span class="ecrm-0500">11</span> 
<a id="x1-16056r12"></a><span class="ecrm-0500">12</span><span id="textcolor130"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor131"><span class="ectt-0800">short</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor132"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;myshort&nbsp;=&nbsp;1;</span> 
<a id="x1-16058r13"></a><span class="ecrm-0500">13</span><span id="textcolor133"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor134"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;myint&nbsp;=&nbsp;420;</span> 
<a id="x1-16060r14"></a><span class="ecrm-0500">14</span><span id="textcolor135"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor136"><span class="ectt-0800">long</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor137"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;mylong&nbsp;=&nbsp;9999;</span> 
<a id="x1-16062r15"></a><span class="ecrm-0500">15</span><span id="textcolor138"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor139"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;*mystring&nbsp;=&nbsp;</span><span id="textcolor140"><span class="ectt-0800">"blah"</span></span><span class="ectt-0800">;</span> 
<a id="x1-16064r16"></a><span class="ecrm-0500">16</span><span id="textcolor141"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor142"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;myintArray[2]&nbsp;=&nbsp;{420,&nbsp;420};</span> 
<a id="x1-16066r17"></a><span class="ecrm-0500">17</span><span id="textcolor143"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor144"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;arr_argc&nbsp;=&nbsp;0;</span> 
<a id="x1-16068r18"></a><span class="ecrm-0500">18</span> 
<a id="x1-16070r19"></a><span class="ecrm-0500">19</span><span id="textcolor145"><span class="ectt-0800">/*&nbsp;module_param(foo,&nbsp;int,&nbsp;0000)</span></span> 
<a id="x1-16072r20"></a><span class="ecrm-0500">20</span><span id="textcolor146"><span class="ectt-0800">&nbsp;*&nbsp;The&nbsp;first&nbsp;param&nbsp;is&nbsp;the&nbsp;parameters&nbsp;name.</span></span> 
<a id="x1-16074r21"></a><span class="ecrm-0500">21</span><span id="textcolor147"><span class="ectt-0800">&nbsp;*&nbsp;The&nbsp;second&nbsp;param&nbsp;is&nbsp;its&nbsp;data&nbsp;type.</span></span> 
<a id="x1-16076r22"></a><span class="ecrm-0500">22</span><span id="textcolor148"><span class="ectt-0800">&nbsp;*&nbsp;The&nbsp;final&nbsp;argument&nbsp;is&nbsp;the&nbsp;permissions&nbsp;bits,</span></span> 
<a id="x1-16078r23"></a><span class="ecrm-0500">23</span><span id="textcolor149"><span class="ectt-0800">&nbsp;*&nbsp;for&nbsp;exposing&nbsp;parameters&nbsp;in&nbsp;sysfs&nbsp;(if&nbsp;non-zero)&nbsp;at&nbsp;a&nbsp;later&nbsp;stage.</span></span> 
<a id="x1-16080r24"></a><span class="ecrm-0500">24</span><span id="textcolor150"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-16082r25"></a><span class="ecrm-0500">25</span><span class="ectt-0800">module_param(myshort,&nbsp;</span><span id="textcolor151"><span class="ectt-0800">short</span></span><span class="ectt-0800">,&nbsp;S_IRUSR&nbsp;|&nbsp;S_IWUSR&nbsp;|&nbsp;S_IRGRP&nbsp;|&nbsp;S_IWGRP);</span> 
<a id="x1-16084r26"></a><span class="ecrm-0500">26</span><span class="ectt-0800">MODULE_PARM_DESC(myshort,&nbsp;</span><span id="textcolor152"><span class="ectt-0800">"A&nbsp;short&nbsp;integer"</span></span><span class="ectt-0800">);</span> 
<a id="x1-16086r27"></a><span class="ecrm-0500">27</span><span class="ectt-0800">module_param(myint,&nbsp;</span><span id="textcolor153"><span class="ectt-0800">int</span></span><span class="ectt-0800">,&nbsp;S_IRUSR&nbsp;|&nbsp;S_IWUSR&nbsp;|&nbsp;S_IRGRP&nbsp;|&nbsp;S_IROTH);</span> 
<a id="x1-16088r28"></a><span class="ecrm-0500">28</span><span class="ectt-0800">MODULE_PARM_DESC(myint,&nbsp;</span><span id="textcolor154"><span class="ectt-0800">"An&nbsp;integer"</span></span><span class="ectt-0800">);</span> 
<a id="x1-16090r29"></a><span class="ecrm-0500">29</span><span class="ectt-0800">module_param(mylong,&nbsp;</span><span id="textcolor155"><span class="ectt-0800">long</span></span><span class="ectt-0800">,&nbsp;S_IRUSR);</span> 
<a id="x1-16092r30"></a><span class="ecrm-0500">30</span><span class="ectt-0800">MODULE_PARM_DESC(mylong,&nbsp;</span><span id="textcolor156"><span class="ectt-0800">"A&nbsp;long&nbsp;integer"</span></span><span class="ectt-0800">);</span> 
<a id="x1-16094r31"></a><span class="ecrm-0500">31</span><span class="ectt-0800">module_param(mystring,&nbsp;charp,&nbsp;0000);</span> 
<a id="x1-16096r32"></a><span class="ecrm-0500">32</span><span class="ectt-0800">MODULE_PARM_DESC(mystring,&nbsp;</span><span id="textcolor157"><span class="ectt-0800">"A&nbsp;character&nbsp;string"</span></span><span class="ectt-0800">);</span> 
<a id="x1-16098r33"></a><span class="ecrm-0500">33</span> 
<a id="x1-16100r34"></a><span class="ecrm-0500">34</span><span id="textcolor158"><span class="ectt-0800">/*&nbsp;module_param_array(name,&nbsp;type,&nbsp;num,&nbsp;perm);</span></span> 
<a id="x1-16102r35"></a><span class="ecrm-0500">35</span><span id="textcolor159"><span class="ectt-0800">&nbsp;*&nbsp;The&nbsp;first&nbsp;param&nbsp;is&nbsp;the&nbsp;parameter</span><span class="tctt-0800">'</span><span class="ectt-0800">s&nbsp;(in&nbsp;this&nbsp;case&nbsp;the&nbsp;array</span><span class="tctt-0800">'</span><span class="ectt-0800">s)&nbsp;name.</span></span> 
<a id="x1-16104r36"></a><span class="ecrm-0500">36</span><span id="textcolor160"><span class="ectt-0800">&nbsp;*&nbsp;The&nbsp;second&nbsp;param&nbsp;is&nbsp;the&nbsp;data&nbsp;type&nbsp;of&nbsp;the&nbsp;elements&nbsp;of&nbsp;the&nbsp;array.</span></span> 
<a id="x1-16106r37"></a><span class="ecrm-0500">37</span><span id="textcolor161"><span class="ectt-0800">&nbsp;*&nbsp;The&nbsp;third&nbsp;argument&nbsp;is&nbsp;a&nbsp;pointer&nbsp;to&nbsp;the&nbsp;variable&nbsp;that&nbsp;will&nbsp;store&nbsp;the&nbsp;number.</span></span> 
<a id="x1-16108r38"></a><span class="ecrm-0500">38</span><span id="textcolor162"><span class="ectt-0800">&nbsp;*&nbsp;of&nbsp;elements&nbsp;of&nbsp;the&nbsp;array&nbsp;initialized&nbsp;by&nbsp;the&nbsp;user&nbsp;at&nbsp;module&nbsp;loading&nbsp;time.</span></span> 
<a id="x1-16110r39"></a><span class="ecrm-0500">39</span><span id="textcolor163"><span class="ectt-0800">&nbsp;*&nbsp;The&nbsp;fourth&nbsp;argument&nbsp;is&nbsp;the&nbsp;permission&nbsp;bits.</span></span> 
<a id="x1-16112r40"></a><span class="ecrm-0500">40</span><span id="textcolor164"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-16114r41"></a><span class="ecrm-0500">41</span><span class="ectt-0800">module_param_array(myintArray,&nbsp;</span><span id="textcolor165"><span class="ectt-0800">int</span></span><span class="ectt-0800">,&nbsp;&amp;arr_argc,&nbsp;0000);</span> 
<a id="x1-16116r42"></a><span class="ecrm-0500">42</span><span class="ectt-0800">MODULE_PARM_DESC(myintArray,&nbsp;</span><span id="textcolor166"><span class="ectt-0800">"An&nbsp;array&nbsp;of&nbsp;integers"</span></span><span class="ectt-0800">);</span> 
<a id="x1-16118r43"></a><span class="ecrm-0500">43</span> 
<a id="x1-16120r44"></a><span class="ecrm-0500">44</span><span id="textcolor167"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor168"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;__init&nbsp;hello_5_init(</span><span id="textcolor169"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-16122r45"></a><span class="ecrm-0500">45</span><span class="ectt-0800">{</span> 
<a id="x1-16124r46"></a><span class="ecrm-0500">46</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor170"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;i;</span> 
<a id="x1-16126r47"></a><span class="ecrm-0500">47</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor171"><span class="ectt-0800">"Hello,&nbsp;world&nbsp;5</span></span><span id="textcolor172"><span class="ectt-0800">\n</span></span><span id="textcolor173"><span class="ectt-0800">=============</span></span><span id="textcolor174"><span class="ectt-0800">\n</span></span><span id="textcolor175"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-16128r48"></a><span class="ecrm-0500">48</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor176"><span class="ectt-0800">"myshort&nbsp;is&nbsp;a&nbsp;short&nbsp;integer:&nbsp;%hd</span></span><span id="textcolor177"><span class="ectt-0800">\n</span></span><span id="textcolor178"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;myshort);</span> 
<a id="x1-16130r49"></a><span class="ecrm-0500">49</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor179"><span class="ectt-0800">"myint&nbsp;is&nbsp;an&nbsp;integer:&nbsp;%d</span></span><span id="textcolor180"><span class="ectt-0800">\n</span></span><span id="textcolor181"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;myint);</span> 
<a id="x1-16132r50"></a><span class="ecrm-0500">50</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor182"><span class="ectt-0800">"mylong&nbsp;is&nbsp;a&nbsp;long&nbsp;integer:&nbsp;%ld</span></span><span id="textcolor183"><span class="ectt-0800">\n</span></span><span id="textcolor184"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;mylong);</span> 
<a id="x1-16134r51"></a><span class="ecrm-0500">51</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor185"><span class="ectt-0800">"mystring&nbsp;is&nbsp;a&nbsp;string:&nbsp;%s</span></span><span id="textcolor186"><span class="ectt-0800">\n</span></span><span id="textcolor187"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;mystring);</span> 
<a id="x1-16136r52"></a><span class="ecrm-0500">52</span> 
<a id="x1-16138r53"></a><span class="ecrm-0500">53</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor188"><span class="ectt-0800">for</span></span><span class="ectt-0800">&nbsp;(i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;(</span><span id="textcolor189"><span class="ectt-0800">sizeof</span></span><span class="ectt-0800">&nbsp;myintArray&nbsp;/&nbsp;</span><span id="textcolor190"><span class="ectt-0800">sizeof</span></span><span class="ectt-0800">(</span><span id="textcolor191"><span class="ectt-0800">int</span></span><span class="ectt-0800">));&nbsp;i++)</span> 
<a id="x1-16140r54"></a><span class="ecrm-0500">54</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor192"><span class="ectt-0800">"myintArray[%d]&nbsp;=&nbsp;%d</span></span><span id="textcolor193"><span class="ectt-0800">\n</span></span><span id="textcolor194"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;i,&nbsp;myintArray[i]);</span> 
<a id="x1-16142r55"></a><span class="ecrm-0500">55</span> 
<a id="x1-16144r56"></a><span class="ecrm-0500">56</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor195"><span class="ectt-0800">"got&nbsp;%d&nbsp;arguments&nbsp;for&nbsp;myintArray.</span></span><span id="textcolor196"><span class="ectt-0800">\n</span></span><span id="textcolor197"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;arr_argc);</span> 
<a id="x1-16146r57"></a><span class="ecrm-0500">57</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor198"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;0;</span> 
<a id="x1-16148r58"></a><span class="ecrm-0500">58</span><span class="ectt-0800">}</span> 
<a id="x1-16150r59"></a><span class="ecrm-0500">59</span> 
<a id="x1-16152r60"></a><span class="ecrm-0500">60</span><span id="textcolor199"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor200"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;__exit&nbsp;hello_5_exit(</span><span id="textcolor201"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-16154r61"></a><span class="ecrm-0500">61</span><span class="ectt-0800">{</span> 
<a id="x1-16156r62"></a><span class="ecrm-0500">62</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor202"><span class="ectt-0800">"Goodbye,&nbsp;world&nbsp;5</span></span><span id="textcolor203"><span class="ectt-0800">\n</span></span><span id="textcolor204"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-16158r63"></a><span class="ecrm-0500">63</span><span class="ectt-0800">}</span> 
<a id="x1-16160r64"></a><span class="ecrm-0500">64</span> 
<a id="x1-16162r65"></a><span class="ecrm-0500">65</span><span class="ectt-0800">module_init(hello_5_init);</span> 
<a id="x1-16164r66"></a><span class="ecrm-0500">66</span><span class="ectt-0800">module_exit(hello_5_exit);</span></pre>
<!-- l. 412 --><p class="indent">   I would recommend playing around with this code: 
</p>
   <pre class="fancyvrb" id="fancyvrb26"><a id="x1-16192r1"></a><span class="ecrm-0500">1</span><span class="colorbox" id="colorbox205"><span class="ectt-0800">$</span></span><span class="ectt-0800">&nbsp;sudo&nbsp;insmod&nbsp;hello-5.ko&nbsp;mystring=</span><span id="textcolor206"><span class="ectt-0800">"bebop"</span></span><span class="ectt-0800">&nbsp;myintArray=-1</span> 
<a id="x1-16194r2"></a><span class="ecrm-0500">2</span><span class="ectt-0800">myshort&nbsp;is&nbsp;a&nbsp;</span><span id="textcolor207"><span class="ectt-0800">short</span></span><span class="ectt-0800">&nbsp;integer:&nbsp;1</span> 
<a id="x1-16196r3"></a><span class="ecrm-0500">3</span><span class="ectt-0800">myint&nbsp;is&nbsp;an&nbsp;integer:&nbsp;420</span> 
<a id="x1-16198r4"></a><span class="ecrm-0500">4</span><span class="ectt-0800">mylong&nbsp;is&nbsp;a&nbsp;</span><span id="textcolor208"><span class="ectt-0800">long</span></span><span class="ectt-0800">&nbsp;integer:&nbsp;9999</span> 
<a id="x1-16200r5"></a><span class="ecrm-0500">5</span><span class="ectt-0800">mystring&nbsp;is&nbsp;a&nbsp;string:&nbsp;bebop</span> 
<a id="x1-16202r6"></a><span class="ecrm-0500">6</span><span class="ectt-0800">myintArray[0]&nbsp;=&nbsp;-1</span> 
<a id="x1-16204r7"></a><span class="ecrm-0500">7</span><span class="ectt-0800">myintArray[1]&nbsp;=&nbsp;420</span> 
<a id="x1-16206r8"></a><span class="ecrm-0500">8</span><span class="ectt-0800">got&nbsp;1&nbsp;arguments&nbsp;</span><span id="textcolor209"><span class="ectt-0800">for</span></span><span class="ectt-0800">&nbsp;myintArray.</span> 
<a id="x1-16208r9"></a><span class="ecrm-0500">9</span> 
<a id="x1-16210r10"></a><span class="ecrm-0500">10</span><span class="colorbox" id="colorbox210"><span class="ectt-0800">$</span></span><span class="ectt-0800">&nbsp;sudo&nbsp;rmmod&nbsp;hello-5</span> 
<a id="x1-16212r11"></a><span class="ecrm-0500">11</span><span class="ectt-0800">Goodbye,&nbsp;world&nbsp;5</span> 
<a id="x1-16214r12"></a><span class="ecrm-0500">12</span> 
<a id="x1-16216r13"></a><span class="ecrm-0500">13</span><span class="colorbox" id="colorbox211"><span class="ectt-0800">$</span></span><span class="ectt-0800">&nbsp;sudo&nbsp;insmod&nbsp;hello-5.ko&nbsp;mystring=</span><span id="textcolor212"><span class="ectt-0800">"supercalifragilisticexpialidocious"</span></span><span class="ectt-0800">&nbsp;myintArray=-1,-1</span> 
<a id="x1-16218r14"></a><span class="ecrm-0500">14</span><span class="ectt-0800">myshort&nbsp;is&nbsp;a&nbsp;</span><span id="textcolor213"><span class="ectt-0800">short</span></span><span class="ectt-0800">&nbsp;integer:&nbsp;1</span> 
<a id="x1-16220r15"></a><span class="ecrm-0500">15</span><span class="ectt-0800">myint&nbsp;is&nbsp;an&nbsp;integer:&nbsp;420</span> 
<a id="x1-16222r16"></a><span class="ecrm-0500">16</span><span class="ectt-0800">mylong&nbsp;is&nbsp;a&nbsp;</span><span id="textcolor214"><span class="ectt-0800">long</span></span><span class="ectt-0800">&nbsp;integer:&nbsp;9999</span> 
<a id="x1-16224r17"></a><span class="ecrm-0500">17</span><span class="ectt-0800">mystring&nbsp;is&nbsp;a&nbsp;string:&nbsp;supercalifragilisticexpialidocious</span> 
<a id="x1-16226r18"></a><span class="ecrm-0500">18</span><span class="ectt-0800">myintArray[0]&nbsp;=&nbsp;-1</span> 
<a id="x1-16228r19"></a><span class="ecrm-0500">19</span><span class="ectt-0800">myintArray[1]&nbsp;=&nbsp;-1</span> 
<a id="x1-16230r20"></a><span class="ecrm-0500">20</span><span class="ectt-0800">got&nbsp;2&nbsp;arguments&nbsp;</span><span id="textcolor215"><span class="ectt-0800">for</span></span><span class="ectt-0800">&nbsp;myintArray.</span> 
<a id="x1-16232r21"></a><span class="ecrm-0500">21</span> 
<a id="x1-16234r22"></a><span class="ecrm-0500">22</span><span class="colorbox" id="colorbox216"><span class="ectt-0800">$</span></span><span class="ectt-0800">&nbsp;sudo&nbsp;rmmod&nbsp;hello-5</span> 
<a id="x1-16236r23"></a><span class="ecrm-0500">23</span><span class="ectt-0800">Goodbye,&nbsp;world&nbsp;5</span> 
<a id="x1-16238r24"></a><span class="ecrm-0500">24</span> 
<a id="x1-16240r25"></a><span class="ecrm-0500">25</span><span class="colorbox" id="colorbox217"><span class="ectt-0800">$</span></span><span class="ectt-0800">&nbsp;sudo&nbsp;insmod&nbsp;hello-5.ko&nbsp;mylong=hello</span> 
<a id="x1-16242r26"></a><span class="ecrm-0500">26</span><span class="ectt-0800">hello-5.o:&nbsp;invalid&nbsp;argument&nbsp;syntax&nbsp;</span><span id="textcolor218"><span class="ectt-0800">for</span></span><span class="ectt-0800">&nbsp;mylong:&nbsp;</span><span id="textcolor219"><span class="tctt-0800">'</span><span class="ectt-0800">h</span><span class="tctt-0800">'</span></span></pre>
<!-- l. 442 --><p class="noindent">
</p>
   <h4 class="subsectionHead" id="modules-spanning-multiple-files"><span class="titlemark">0.4.6   </span> <a id="x1-170000.4.6"></a>Modules Spanning Multiple Files</h4>
<!-- l. 444 --><p class="noindent">Sometimes it makes sense to divide a kernel module between several source
files.
</p><!-- l. 446 --><p class="indent">   Here is an example of such a kernel module. 
</p>
   <pre class="fancyvrb" id="fancyvrb27"><a id="x1-17002r1"></a><span class="ecrm-0500">1</span><span id="textcolor220"><span class="ectt-0800">/*</span></span> 
<a id="x1-17004r2"></a><span class="ecrm-0500">2</span><span id="textcolor221"><span class="ectt-0800">&nbsp;*&nbsp;start.c&nbsp;-&nbsp;Illustration&nbsp;of&nbsp;multi&nbsp;filed&nbsp;modules</span></span> 
<a id="x1-17006r3"></a><span class="ecrm-0500">3</span><span id="textcolor222"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-17008r4"></a><span class="ecrm-0500">4</span> 
<a id="x1-17010r5"></a><span class="ecrm-0500">5</span><span id="textcolor223"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor224"><span class="ectt-0800">&lt;linux/kernel.h&gt;&nbsp;/*&nbsp;We&nbsp;are&nbsp;doing&nbsp;kernel&nbsp;work&nbsp;*/</span></span> 
<a id="x1-17012r6"></a><span class="ecrm-0500">6</span><span id="textcolor225"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor226"><span class="ectt-0800">&lt;linux/module.h&gt;&nbsp;/*&nbsp;Specifically,&nbsp;a&nbsp;module&nbsp;*/</span></span> 
<a id="x1-17014r7"></a><span class="ecrm-0500">7</span> 
<a id="x1-17016r8"></a><span class="ecrm-0500">8</span><span id="textcolor227"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;init_module(</span><span id="textcolor228"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-17018r9"></a><span class="ecrm-0500">9</span><span class="ectt-0800">{</span> 
<a id="x1-17020r10"></a><span class="ecrm-0500">10</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor229"><span class="ectt-0800">"Hello,&nbsp;world&nbsp;-&nbsp;this&nbsp;is&nbsp;the&nbsp;kernel&nbsp;speaking</span></span><span id="textcolor230"><span class="ectt-0800">\n</span></span><span id="textcolor231"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-17022r11"></a><span class="ecrm-0500">11</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor232"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;0;</span> 
<a id="x1-17024r12"></a><span class="ecrm-0500">12</span><span class="ectt-0800">}</span> 
<a id="x1-17026r13"></a><span class="ecrm-0500">13</span> 
<a id="x1-17028r14"></a><span class="ecrm-0500">14</span><span class="ectt-0800">MODULE_LICENSE(</span><span id="textcolor233"><span class="ectt-0800">"GPL"</span></span><span class="ectt-0800">);</span></pre>
<!-- l. 449 --><p class="indent">   The next file: 
</p>
   <pre class="fancyvrb" id="fancyvrb28"><a id="x1-17030r1"></a><span class="ecrm-0500">1</span><span id="textcolor234"><span class="ectt-0800">/*</span></span> 
<a id="x1-17032r2"></a><span class="ecrm-0500">2</span><span id="textcolor235"><span class="ectt-0800">&nbsp;*&nbsp;stop.c&nbsp;-&nbsp;Illustration&nbsp;of&nbsp;multi&nbsp;filed&nbsp;modules</span></span> 
<a id="x1-17034r3"></a><span class="ecrm-0500">3</span><span id="textcolor236"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-17036r4"></a><span class="ecrm-0500">4</span> 
<a id="x1-17038r5"></a><span class="ecrm-0500">5</span><span id="textcolor237"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor238"><span class="ectt-0800">&lt;linux/kernel.h&gt;&nbsp;/*&nbsp;We&nbsp;are&nbsp;doing&nbsp;kernel&nbsp;work&nbsp;*/</span></span> 
<a id="x1-17040r6"></a><span class="ecrm-0500">6</span><span id="textcolor239"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor240"><span class="ectt-0800">&lt;linux/module.h&gt;&nbsp;/*&nbsp;Specifically,&nbsp;a&nbsp;module&nbsp;&nbsp;*/</span></span> 
<a id="x1-17042r7"></a><span class="ecrm-0500">7</span> 
<a id="x1-17044r8"></a><span class="ecrm-0500">8</span><span id="textcolor241"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;cleanup_module()</span> 
<a id="x1-17046r9"></a><span class="ecrm-0500">9</span><span class="ectt-0800">{</span> 
<a id="x1-17048r10"></a><span class="ecrm-0500">10</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor242"><span class="ectt-0800">"Short&nbsp;is&nbsp;the&nbsp;life&nbsp;of&nbsp;a&nbsp;kernel&nbsp;module</span></span><span id="textcolor243"><span class="ectt-0800">\n</span></span><span id="textcolor244"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-17050r11"></a><span class="ecrm-0500">11</span><span class="ectt-0800">}</span> 
<a id="x1-17052r12"></a><span class="ecrm-0500">12</span> 
<a id="x1-17054r13"></a><span class="ecrm-0500">13</span><span class="ectt-0800">MODULE_LICENSE(</span><span id="textcolor245"><span class="ectt-0800">"GPL"</span></span><span class="ectt-0800">);</span></pre>
<!-- l. 452 --><p class="indent">   And finally, the makefile:
</p><!-- l. 1 --><p class="indent">
</p>
   <pre class="fancyvrb" id="fancyvrb29"><a id="x1-17069r1"></a><span class="ecrm-0500">1</span><span class="ectt-0800">obj-m&nbsp;+=&nbsp;hello-1.o</span> 
<a id="x1-17071r2"></a><span class="ecrm-0500">2</span><span class="ectt-0800">obj-m&nbsp;+=&nbsp;hello-2.o</span> 
<a id="x1-17073r3"></a><span class="ecrm-0500">3</span><span class="ectt-0800">obj-m&nbsp;+=&nbsp;hello-3.o</span> 
<a id="x1-17075r4"></a><span class="ecrm-0500">4</span><span class="ectt-0800">obj-m&nbsp;+=&nbsp;hello-4.o</span> 
<a id="x1-17077r5"></a><span class="ecrm-0500">5</span><span class="ectt-0800">obj-m&nbsp;+=&nbsp;hello-5.o</span> 
<a id="x1-17079r6"></a><span class="ecrm-0500">6</span><span class="ectt-0800">obj-m&nbsp;+=&nbsp;startstop.o</span> 
<a id="x1-17081r7"></a><span class="ecrm-0500">7</span><span class="ectt-0800">startstop-objs&nbsp;:=&nbsp;start.o&nbsp;stop.o</span> 
<a id="x1-17083r8"></a><span class="ecrm-0500">8</span> 
<a id="x1-17085r9"></a><span class="ecrm-0500">9</span><span class="ectt-0800">all:</span> 
<a id="x1-17087r10"></a><span class="ecrm-0500">10</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;make&nbsp;-C&nbsp;/lib/modules/</span><span class="colorbox" id="colorbox246"><span class="ectt-0800">$</span></span><span class="ectt-0800">(shell&nbsp;uname&nbsp;-r)/build&nbsp;M=</span><span class="colorbox" id="colorbox247"><span class="ectt-0800">$</span></span><span class="ectt-0800">(PWD)&nbsp;modules</span> 
<a id="x1-17089r11"></a><span class="ecrm-0500">11</span> 
<a id="x1-17091r12"></a><span class="ecrm-0500">12</span><span class="ectt-0800">clean:</span> 
<a id="x1-17093r13"></a><span class="ecrm-0500">13</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;make&nbsp;-C&nbsp;/lib/modules/</span><span class="colorbox" id="colorbox248"><span class="ectt-0800">$</span></span><span class="ectt-0800">(shell&nbsp;uname&nbsp;-r)/build&nbsp;M=</span><span class="colorbox" id="colorbox249"><span class="ectt-0800">$</span></span><span class="ectt-0800">(PWD)&nbsp;clean</span></pre>
                                                                  

                                                                  
<!-- l. 470 --><p class="indent">   This is the complete makefile for all the examples we have seen so far. The first
five lines are nothing special, but for the last example we will need two lines.
First we invent an object name for our combined module, second we tell
<code> <span class="ectt-1000">make</span>
</code> what object files are part of that module.
</p><!-- l. 474 --><p class="noindent">
</p>
   <h4 class="subsectionHead" id="building-modules-for-a-precompiled-kernel"><span class="titlemark">0.4.7   </span> <a id="x1-180000.4.7"></a>Building modules for a precompiled kernel</h4>
<!-- l. 476 --><p class="noindent">Obviously, we strongly suggest you to recompile your kernel, so that you can enable
a number of useful debugging features, such as forced module unloading
(<code>  <span class="ectt-1000">MODULE_FORCE_UNLOAD</span>
</code>): when this option is enabled, you can force the kernel to unload a module even when it believes
it is unsafe, via a <code>  <span class="ectt-1000">sudo&nbsp;rmmod&nbsp;-f&nbsp;module</span>
</code> command. This option can save you a lot of time and a number of reboots during
the development of a module. If you do not want to recompile your kernel then you
should consider running the examples within a test distribution on a virtual machine.
If you mess anything up then you can easily reboot or restore the virtual machine
(VM).
</p><!-- l. 481 --><p class="indent">   There are a number of cases in which you may want to load your module into a
precompiled running kernel, such as the ones shipped with common Linux
distributions, or a kernel you have compiled in the past. In certain circumstances you
could require to compile and insert a module into a running kernel which you are not
allowed to recompile, or on a machine that you prefer not to reboot. If you
can’t think of a case that will force you to use modules for a precompiled
kernel you might want to skip this and treat the rest of this chapter as a big
footnote.
</p><!-- l. 485 --><p class="indent">   Now, if you just install a kernel source tree, use it to compile your kernel module
and you try to insert your module into the kernel, in most cases you would obtain an
error as follows:
                                                                  

                                                                  
</p>
   <pre class="verbatim" id="verbatim-2">insmod:&nbsp;error&nbsp;inserting&nbsp;'poet_atkm.ko':&nbsp;-1&nbsp;Invalid&nbsp;module&nbsp;format
</pre>
<!-- l. 489 --><p class="nopar">
</p><!-- l. 491 --><p class="indent">   Less cryptical information are logged to the systemd journal:
                                                                  

                                                                  
</p>
   <pre class="verbatim" id="verbatim-3">Jun&nbsp;&nbsp;4&nbsp;22:07:54&nbsp;localhost&nbsp;kernel:&nbsp;poet_atkm:&nbsp;version&nbsp;magic&nbsp;'2.6.5-1.358custom&nbsp;686
REGPARM&nbsp;4KSTACKS&nbsp;gcc-3.3'&nbsp;should&nbsp;be&nbsp;'2.6.5-1.358&nbsp;686&nbsp;REGPARM&nbsp;4KSTACKS&nbsp;gcc-3.3'
</pre>
<!-- l. 496 --><p class="nopar">
</p><!-- l. 498 --><p class="indent">   In other words, your kernel refuses to accept your module because version strings
(more precisely, version magics) do not match. Incidentally, version magics are stored in
the module object in the form of a static string, starting with vermagic:. Version data
are inserted in your module when it is linked against the <span class="obeylines-h"><span class="verb"><span class="ectt-1000">init/vermagic.o</span></span></span> file. To
inspect version magics and other strings stored in a given module, issue the command
<code> <span class="ectt-1000">modinfo&nbsp;module.ko</span>
</code>:
                                                                  

                                                                  
</p>
   <pre class="verbatim" id="verbatim-4">$&nbsp;modinfo&nbsp;hello-4.ko
description:&nbsp;&nbsp;&nbsp;&nbsp;A&nbsp;sample&nbsp;driver
author:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LKMPG
license:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GPL
srcversion:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;B2AA7FBFCC2C39AED665382
depends:
retpoline:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Y
name:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hello_4
vermagic:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.4.0-70-generic&nbsp;SMP&nbsp;mod_unload&nbsp;modversions
</pre>
<!-- l. 513 --><p class="nopar">
</p><!-- l. 515 --><p class="indent">   To overcome this problem we could resort to the <span class="ecbx-1000">–force-vermagic </span>option, but
this solution is potentially unsafe, and unquestionably inacceptable in production
modules. Consequently, we want to compile our module in an environment which was
identical to the one in which our precompiled kernel was built. How to do this, is the
subject of the remainder of this chapter.
</p><!-- l. 519 --><p class="indent">   First of all, make sure that a kernel source tree is available, having exactly the same
version as your current kernel. Then, find the configuration file which was used to
compile your precompiled kernel. Usually, this is available in your current <span class="obeylines-h"><span class="verb"><span class="ectt-1000">boot</span></span></span> directory,
under a name like <span class="obeylines-h"><span class="verb"><span class="ectt-1000">config-5.14.x</span></span></span>. You may just want to copy it to your kernel source
tree: <code>  <span class="ectt-1000">cp&nbsp;/boot/config-</span><span id="textcolor250"><span class="tctt-1000">`</span></span><span class="ectt-1000">uname&nbsp;-r</span><span id="textcolor251"><span class="tctt-1000">`</span></span><span class="ectt-1000">&nbsp;.config</span>
</code>.
</p><!-- l. 524 --><p class="indent">   Let’s focus again on the previous error message: a closer look at the version magic
strings suggests that, even with two configuration files which are exactly the same, a
slight difference in the version magic could be possible, and it is sufficient to
prevent insertion of the module into the kernel. That slight difference, namely
the custom string which appears in the module’s version magic and not in
the kernel’s one, is due to a modification with respect to the original, in
the makefile that some distribution include. Then, examine your <span class="obeylines-h"><span class="verb"><span class="ectt-1000">Makefile</span></span></span>,
and make sure that the specified version information matches exactly the
one used for your current kernel. For example, you makefile could start as
follows:
                                                                  

                                                                  
</p>
   <pre class="verbatim" id="verbatim-5">VERSION&nbsp;=&nbsp;5
PATCHLEVEL&nbsp;=&nbsp;14
SUBLEVEL&nbsp;=&nbsp;0
EXTRAVERSION&nbsp;=&nbsp;-rc2
</pre>
<!-- l. 534 --><p class="nopar">
</p><!-- l. 536 --><p class="indent">   In this case, you need to restore the value of symbol <span class="ecbx-1000">EXTRAVERSION </span>to
<span class="ecbx-1000">-rc2</span>. We suggest to keep a backup copy of the makefile used to compile your kernel
available in <span class="obeylines-h"><span class="verb"><span class="ectt-1000">/lib/modules/5.14.0-rc2/build</span></span></span>. A simple command as following
should suffice. 
</p>
   <pre class="fancyvrb" id="fancyvrb30"><a id="x1-18007r1"></a><span class="ecrm-0500">1</span><span class="ectt-1000">cp&nbsp;/lib/modules/</span><span id="textcolor252"><span class="tctt-1000">`</span></span><span class="ectt-1000">uname&nbsp;-r</span><span id="textcolor253"><span class="tctt-1000">`</span></span><span class="ectt-1000">/build/Makefile&nbsp;linux-</span><span id="textcolor254"><span class="tctt-1000">`</span></span><span class="ectt-1000">uname&nbsp;-r</span><span id="textcolor255"><span class="tctt-1000">`</span></span></pre>
<!-- l. 542 --><p class="noindent">Here <code>  <span class="ectt-1000">linux-</span><span id="textcolor256"><span class="tctt-1000">`</span></span><span class="ectt-1000">uname&nbsp;-r</span><span id="textcolor257"><span class="tctt-1000">`</span></span>
</code> is the Linux kernel source you are attempting to build.
</p><!-- l. 544 --><p class="indent">   Now, please run <code>  <span class="ectt-1000">make</span>
</code> to update configuration and version headers and objects:
                                                                  

                                                                  
</p>
   <pre class="verbatim" id="verbatim-6">$&nbsp;make
CHK&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;include/linux/version.h
UPD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;include/linux/version.h
SYMLINK&nbsp;include/asm&nbsp;-&gt;&nbsp;include/asm-i386
SPLIT&nbsp;&nbsp;&nbsp;include/linux/autoconf.h&nbsp;-&gt;&nbsp;include/config/*
HOSTCC&nbsp;&nbsp;scripts/basic/fixdep
HOSTCC&nbsp;&nbsp;scripts/basic/split-include
HOSTCC&nbsp;&nbsp;scripts/basic/docproc
HOSTCC&nbsp;&nbsp;scripts/conmakehash
HOSTCC&nbsp;&nbsp;scripts/kallsyms
CC&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scripts/empty.o
</pre>
<!-- l. 558 --><p class="nopar">
</p><!-- l. 560 --><p class="indent">   If you do not desire to actually compile the kernel, you can interrupt the build
process (CTRL-C) just after the SPLIT line, because at that time, the files you need
will be are ready. Now you can turn back to the directory of your module and
compile it: It will be built exactly according to your current kernel settings, and it
will load into it without any errors.
</p><!-- l. 563 --><p class="noindent">
</p>
   <h3 class="sectionHead" id="preliminaries"><span class="titlemark">0.5   </span> <a id="x1-190000.5"></a>Preliminaries</h3>
<!-- l. 564 --><p class="noindent">
</p>
   <h4 class="subsectionHead" id="how-modules-begin-and-end"><span class="titlemark">0.5.1   </span> <a id="x1-200000.5.1"></a>How modules begin and end</h4>
<!-- l. 566 --><p class="noindent">A program usually begins with a <code>  <span class="ectt-1000">main()</span>
</code> function, executes a bunch of instructions and terminates upon completion of those
instructions. Kernel modules work a bit differently. A module always begin with either
the <code>  <span class="ectt-1000">init_module</span>
</code> or the function you specify with <code>  <span class="ectt-1000">module_init</span>
</code> call. This is the entry function for modules; it tells the kernel what functionality the
module provides and sets up the kernel to run the module’s functions when they
are needed. Once it does this, entry function returns and the module does
nothing until the kernel wants to do something with the code that the module
provides.
</p><!-- l. 571 --><p class="indent">   All modules end by calling either <code>  <span class="ectt-1000">cleanup_module</span>
</code> or the function you specify with the <code>  <span class="ectt-1000">module_exit</span>
                                                                  

                                                                  
</code> call. This is the exit function for modules; it undoes whatever entry function did. It
unregisters the functionality that the entry function registered.
</p><!-- l. 575 --><p class="indent">   Every module must have an entry function and an exit function. Since there’s
more than one way to specify entry and exit functions, I will try my best to use the
terms “entry function” and “exit function”, but if I slip and simply refer to them as
<code> <span class="ectt-1000">init_module</span>
</code> and <code>  <span class="ectt-1000">cleanup_module</span>
</code>, I think you will know what I mean.
</p><!-- l. 578 --><p class="noindent">
</p>
   <h4 class="subsectionHead" id="functions-available-to-modules"><span class="titlemark">0.5.2   </span> <a id="x1-210000.5.2"></a>Functions available to modules</h4>
<!-- l. 580 --><p class="noindent">Programmers use functions they do not define all the time. A prime example of this
is <code>  <span class="ectt-1000">printf()</span>
</code>. You use these library functions which are provided by the standard C
library, libc. The definitions for these functions do not actually enter
your program until the linking stage, which insures that the code (for
<code> <span class="ectt-1000">printf()</span>
</code> for example) is available, and fixes the call instruction to point to that
code.
</p><!-- l. 585 --><p class="indent">   Kernel modules are different here, too. In the hello world
example, you might have noticed that we used a function,
<code> <span class="ectt-1000">pr_info()</span>
</code> but did not include a standard I/O library. That is because modules are object files whose symbols
get resolved upon <code>  <span class="ectt-1000">insmod</span>
</code>’ing. The definition for the symbols comes from the kernel itself; the only
external functions you can use are the ones provided by the kernel. If you’re
curious about what symbols have been exported by your kernel, take a look at
<span class="obeylines-h"><span class="verb"><span class="ectt-1000">/proc/kallsyms</span></span></span>.
</p><!-- l. 590 --><p class="indent">   One point to keep in mind is the difference between library functions and system
calls. Library functions are higher level, run completely in user space and
provide a more convenient interface for the programmer to the functions
that do the real work — system calls. System calls run in kernel mode on
the user’s behalf and are provided by the kernel itself. The library function
<code> <span class="ectt-1000">printf()</span>
</code> may look like a very general printing function, but all it really does is format the
data into strings and write the string data using the low-level system call
<code> <span class="ectt-1000">write()</span>
</code>, which then sends the data to standard output.
</p><!-- l. 594 --><p class="indent">   Would you like to see what system calls are made by
<code> <span class="ectt-1000">printf()</span>
</code>? It is easy! Compile the following program:
</p><!-- l. 1 --><p class="indent">
</p>
                                                                  

                                                                  
   <pre class="fancyvrb" id="fancyvrb31"><a id="x1-21016r1"></a><span class="ecrm-0500">1</span><span id="textcolor258"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor259"><span class="ectt-0800">&lt;stdio.h&gt;</span></span> 
<a id="x1-21018r2"></a><span class="ecrm-0500">2</span> 
<a id="x1-21020r3"></a><span class="ecrm-0500">3</span><span id="textcolor260"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;main(</span><span id="textcolor261"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-21022r4"></a><span class="ecrm-0500">4</span><span class="ectt-0800">{</span> 
<a id="x1-21024r5"></a><span class="ecrm-0500">5</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;printf(</span><span id="textcolor262"><span class="ectt-0800">"hello"</span></span><span class="ectt-0800">);</span> 
<a id="x1-21026r6"></a><span class="ecrm-0500">6</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor263"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;0;</span> 
<a id="x1-21028r7"></a><span class="ecrm-0500">7</span><span class="ectt-0800">}</span></pre>
<!-- l. 608 --><p class="indent">   with <code>  <span class="ectt-1000">gcc&nbsp;-Wall&nbsp;-o&nbsp;hello&nbsp;hello.c</span>
</code>. Run the exectable with <code>  <span class="ectt-1000">strace&nbsp;./hello</span>
</code>. Are you impressed? Every line you see corresponds to a system call. <a href="https://strace.io/">strace</a> is a
handy program that gives you details about what system calls a program is
making, including which call is made, what its arguments are and what it
returns. It is an invaluable tool for figuring out things like what files a program
is trying to access. Towards the end, you will see a line which looks like
<code> <span class="ectt-1000">write(1,&nbsp;</span><span id="textcolor264"><span class="ectt-1000">"hello"</span></span><span class="ectt-1000">,&nbsp;5hello)</span>
</code>. There it is. The face behind the <code>  <span class="ectt-1000">printf()</span>
</code> mask. You may not be familiar with write, since most people use library functions for file
I/O (like <code>  <span class="ectt-1000">fopen</span>
</code>, <code>  <span class="ectt-1000">fputs</span>
</code>, <code>  <span class="ectt-1000">fclose</span>
</code>). If that is the case, try looking at man 2 write. The 2nd man section is devoted to system
calls (like <code>  <span class="ectt-1000">kill()</span>
</code> and <code>  <span class="ectt-1000">read()</span>
</code>). The 3rd man section is devoted to library calls, which you would probably be more familiar
with (like <code>  <span class="ectt-1000">cosh()</span>
</code> and <code>  <span class="ectt-1000">random()</span>
</code>).
</p><!-- l. 622 --><p class="indent">   You can even write modules to replace the kernel’s system calls, which we will do
shortly. Crackers often make use of this sort of thing for backdoors or trojans, but
you can write your own modules to do more benign things, like have the kernel
write Tee hee, that tickles! everytime someone tries to delete a file on your
system.
</p><!-- l. 625 --><p class="noindent">
</p>
   <h4 class="subsectionHead" id="user-space-vs-kernel-space"><span class="titlemark">0.5.3   </span> <a id="x1-220000.5.3"></a>User Space vs Kernel Space</h4>
<!-- l. 627 --><p class="noindent">A kernel is all about access to resources, whether the resource in question happens to
be a video card, a hard drive or even memory. Programs often compete for the same
resource. As I just saved this document, updatedb started updating the locate
database. My vim session and updatedb are both using the hard drive concurrently.
The kernel needs to keep things orderly, and not give users access to resources
whenever they feel like it. To this end, a CPU can run in different modes. Each mode
gives a different level of freedom to do what you want on the system. The Intel 80386
architecture had 4 of these modes, which were called rings. Unix uses only
two rings; the highest ring (ring 0, also known as “supervisor mode” where
everything is allowed to happen) and the lowest ring, which is called “user
mode”.
</p><!-- l. 635 --><p class="indent">   Recall the discussion about library functions vs system calls. Typically, you use a
library function in user mode. The library function calls one or more system calls,
and these system calls execute on the library function’s behalf, but do so in
                                                                  

                                                                  
supervisor mode since they are part of the kernel itself. Once the system call
completes its task, it returns and execution gets transfered back to user
mode.
</p><!-- l. 640 --><p class="noindent">
</p>
   <h4 class="subsectionHead" id="name-space"><span class="titlemark">0.5.4   </span> <a id="x1-230000.5.4"></a>Name Space</h4>
<!-- l. 642 --><p class="noindent">When you write a small C program, you use variables which are convenient and make
sense to the reader. If, on the other hand, you are writing routines which will be part
of a bigger problem, any global variables you have are part of a community of other
peoples’ global variables; some of the variable names can clash. When a program has
lots of global variables which aren’t meaningful enough to be distinguished, you get
namespace pollution. In large projects, effort must be made to remember reserved
names, and to find ways to develop a scheme for naming unique variable names and
symbols.
</p><!-- l. 647 --><p class="indent">   When writing kernel code, even the smallest module will be linked against the
entire kernel, so this is definitely an issue. The best way to deal with this is to declare
all your variables as static and to use a well-defined prefix for your symbols. By
convention, all kernel prefixes are lowercase. If you do not want to declare everything
as static, another option is to declare a symbol table and register it with a kernel. We
will get to this later.
</p><!-- l. 652 --><p class="indent">   The file <span class="obeylines-h"><span class="verb"><span class="ectt-1000">/proc/kallsyms</span></span></span> holds all the symbols that the kernel knows about and
which are therefore accessible to your modules since they share the kernel’s
codespace.
</p><!-- l. 654 --><p class="noindent">
</p>
   <h4 class="subsectionHead" id="code-space"><span class="titlemark">0.5.5   </span> <a id="x1-240000.5.5"></a>Code space</h4>
<!-- l. 656 --><p class="noindent">Memory management is a very complicated subject and the majority of O’Reilly’s
<a href="https://www.oreilly.com/library/view/understanding-the-linux/0596005652/">Understanding The Linux Kernel</a> exclusively covers memory management!
We are not setting out to be experts on memory managements, but we do
need to know a couple of facts to even begin worrying about writing real
modules.
</p><!-- l. 659 --><p class="indent">   If you have not thought about what a segfault really means, you may be surprised
to hear that pointers do not actually point to memory locations. Not real
ones, anyway. When a process is created, the kernel sets aside a portion of
real physical memory and hands it to the process to use for its executing
code, variables, stack, heap and other things which a computer scientist
would know about. This memory begins with 0x00000000 and extends up to
whatever it needs to be. Since the memory space for any two processes do not
overlap, every process that can access a memory address, say 0xbffff978, would
be accessing a different location in real physical memory! The processes
would be accessing an index named 0xbffff978 which points to some kind of
                                                                  

                                                                  
offset into the region of memory set aside for that particular process. For
the most part, a process like our Hello, World program can’t access the
space of another process, although there are ways which we will talk about
later.
</p><!-- l. 666 --><p class="indent">   The kernel has its own space of memory as well. Since a module is code which
can be dynamically inserted and removed in the kernel (as opposed to a
semi-autonomous object), it shares the kernel’s codespace rather than having its own.
Therefore, if your module segfaults, the kernel segfaults. And if you start writing
over data because of an off-by-one error, then you’re trampling on kernel
data (or code). This is even worse than it sounds, so try your best to be
careful.
</p><!-- l. 671 --><p class="indent">   By the way, I would like to point out that the above discussion is true for any
operating system which uses a monolithic kernel. This is not quite the same thing as
<span class="ecti-1000">"building all your modules into the kernel"</span>, although the idea is the same. There are
things called microkernels which have modules which get their own codespace. The
<a href="https://www.gnu.org/software/hurd/">GNU Hurd</a> and the <a href="https://fuchsia.dev/fuchsia-src/concepts/kernel">Zircon kernel</a> of Google Fuchsia are two examples of a
microkernel.
</p><!-- l. 676 --><p class="noindent">
</p>
   <h4 class="subsectionHead" id="device-drivers"><span class="titlemark">0.5.6   </span> <a id="x1-250000.5.6"></a>Device Drivers</h4>
<!-- l. 678 --><p class="noindent">One class of module is the device driver, which provides functionality for hardware
like a serial port. On Unix, each piece of hardware is represented by a file located in
/dev named a device file which provides the means to communicate with the
hardware. The device driver provides the communication on behalf of a
user program. So the es1370.ko sound card device driver might connect the
/dev/sound device file to the Ensoniq IS1370 sound card. A userspace program like
mp3blaster can use /dev/sound without ever knowing what kind of sound card is
installed.
</p><!-- l. 684 --><p class="indent">   Let’s look at some device files. Here are device files which represent the first three
partitions on the primary master IDE hard drive:
                                                                  

                                                                  
</p>
   <pre class="verbatim" id="verbatim-7">$&nbsp;ls&nbsp;-l&nbsp;/dev/hda[1-3]
brw-rw----&nbsp;&nbsp;1&nbsp;root&nbsp;&nbsp;disk&nbsp;&nbsp;3,&nbsp;1&nbsp;Jul&nbsp;&nbsp;5&nbsp;&nbsp;2000&nbsp;/dev/hda1
brw-rw----&nbsp;&nbsp;1&nbsp;root&nbsp;&nbsp;disk&nbsp;&nbsp;3,&nbsp;2&nbsp;Jul&nbsp;&nbsp;5&nbsp;&nbsp;2000&nbsp;/dev/hda2
brw-rw----&nbsp;&nbsp;1&nbsp;root&nbsp;&nbsp;disk&nbsp;&nbsp;3,&nbsp;3&nbsp;Jul&nbsp;&nbsp;5&nbsp;&nbsp;2000&nbsp;/dev/hda3
</pre>
<!-- l. 693 --><p class="nopar">
</p><!-- l. 695 --><p class="indent">   Notice the column of numbers separated by a comma. The first number is called
the device’s major number. The second number is the minor number. The major
number tells you which driver is used to access the hardware. Each driver is assigned
a unique major number; all device files with the same major number are controlled
by the same driver. All the above major numbers are 3, because they’re all controlled
by the same driver.
</p><!-- l. 701 --><p class="indent">   The minor number is used by the driver to distinguish between the various
hardware it controls. Returning to the example above, although all three devices are
handled by the same driver they have unique minor numbers because the driver sees
them as being different pieces of hardware.
</p><!-- l. 704 --><p class="indent">   Devices are divided into two types: character devices and block devices. The
difference is that block devices have a buffer for requests, so they can choose the best
order in which to respond to the requests. This is important in the case of storage
devices, where it is faster to read or write sectors which are close to each
other, rather than those which are further apart. Another difference is that
block devices can only accept input and return output in blocks (whose size
can vary according to the device), whereas character devices are allowed
to use as many or as few bytes as they like. Most devices in the world are
character, because they don’t need this type of buffering, and they don’t
operate with a fixed block size. You can tell whether a device file is for a block
device or a character device by looking at the first character in the output of
<code> <span class="ectt-1000">ls&nbsp;-l</span>
</code>. If it is ‘b’ then it is a block device, and if it is ‘c’ then it is a character device. The
devices you see above are block devices. Here are some character devices (the serial
ports):
                                                                  

                                                                  
</p>
   <pre class="verbatim" id="verbatim-8">crw-rw----&nbsp;&nbsp;1&nbsp;root&nbsp;&nbsp;dial&nbsp;4,&nbsp;64&nbsp;Feb&nbsp;18&nbsp;23:34&nbsp;/dev/ttyS0
crw-r-----&nbsp;&nbsp;1&nbsp;root&nbsp;&nbsp;dial&nbsp;4,&nbsp;65&nbsp;Nov&nbsp;17&nbsp;10:26&nbsp;/dev/ttyS1
crw-rw----&nbsp;&nbsp;1&nbsp;root&nbsp;&nbsp;dial&nbsp;4,&nbsp;66&nbsp;Jul&nbsp;&nbsp;5&nbsp;&nbsp;2000&nbsp;/dev/ttyS2
crw-rw----&nbsp;&nbsp;1&nbsp;root&nbsp;&nbsp;dial&nbsp;4,&nbsp;67&nbsp;Jul&nbsp;&nbsp;5&nbsp;&nbsp;2000&nbsp;/dev/ttyS3
</pre>
<!-- l. 718 --><p class="nopar">
</p><!-- l. 720 --><p class="indent">   If you want to see which major numbers have been assigned, you can look at
<a href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/tree/Documentation/admin-guide/devices.txt">Documentation/admin-guide/devices.txt</a>.
</p><!-- l. 722 --><p class="indent">   When the system was installed, all of those device files were created by the
<code> <span class="ectt-1000">mknod</span>
</code> command. To create a new char device named <span class="obeylines-h"><span class="verb"><span class="ectt-1000">coffee</span></span></span> with major/minor number 12 and 2,
simply do <code>  <span class="ectt-1000">mknod&nbsp;/dev/coffee&nbsp;c&nbsp;12&nbsp;2</span>
</code>. You do not have to put your device files into <span class="obeylines-h"><span class="verb"><span class="ectt-1000">/dev</span></span></span>, but it is done by convention.
Linus put his device files in <span class="obeylines-h"><span class="verb"><span class="ectt-1000">/dev</span></span></span>, and so should you. However, when creating a
device file for testing purposes, it is probably OK to place it in your working
directory where you compile the kernel module. Just be sure to put it in the right
place when you’re done writing the device driver.
</p><!-- l. 729 --><p class="indent">   I would like to make a few last points which are implicit from the above
discussion, but I would like to make them explicit just in case. When a device file is
accessed, the kernel uses the major number of the file to determine which driver
should be used to handle the access. This means that the kernel doesn’t really need
to use or even know about the minor number. The driver itself is the only thing that
cares about the minor number. It uses the minor number to distinguish between
different pieces of hardware.
</p><!-- l. 735 --><p class="indent">   By the way, when I say <span class="ecti-1000">"hardware"</span>, I mean something a bit more abstract
than a PCI card that you can hold in your hand. Look at these two device
files:
                                                                  

                                                                  
</p>
   <pre class="verbatim" id="verbatim-9">$&nbsp;ls&nbsp;-l&nbsp;/dev/sda&nbsp;/dev/sdb
brw-rw----&nbsp;1&nbsp;root&nbsp;disk&nbsp;8,&nbsp;&nbsp;0&nbsp;Jan&nbsp;&nbsp;3&nbsp;09:02&nbsp;/dev/sda
brw-rw----&nbsp;1&nbsp;root&nbsp;disk&nbsp;8,&nbsp;16&nbsp;Jan&nbsp;&nbsp;3&nbsp;09:02&nbsp;/dev/sdb
</pre>
<!-- l. 742 --><p class="nopar">
</p><!-- l. 744 --><p class="indent">   By now you can look at these two device files and know instantly that they are
block devices and are handled by same driver (block major 8). Sometimes two device
files with the same major but different minor number can actually represent the same
piece of physical hardware. So just be aware that the word “hardware” in our
discussion can mean something very abstract.
</p><!-- l. 748 --><p class="noindent">
</p>
   <h3 class="sectionHead" id="character-device-drivers"><span class="titlemark">0.6   </span> <a id="x1-260000.6"></a>Character Device drivers</h3>
<!-- l. 750 --><p class="noindent">
</p>
   <h4 class="subsectionHead" id="the-fileoperations-structure"><span class="titlemark">0.6.1   </span> <a id="x1-270000.6.1"></a>The file_operations Structure</h4>
<!-- l. 752 --><p class="noindent">The <code>  <span class="ectt-1000">file_operations</span>
</code> structure is defined in <a href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/fs.h">include/linux/fs.h</a>, and holds pointers to functions defined by
the driver that perform various operations on the device. Each field of the structure
corresponds to the address of some function defined by the driver to handle a
requested operation.
</p><!-- l. 755 --><p class="indent">   For example, every character driver needs to define a function that reads from the
device. The <code>  <span class="ectt-1000">file_operations</span>
</code> structure holds the address of the module’s function that performs that operation.
Here is what the definition looks like for kernel 5.4:
</p><!-- l. 1 --><p class="indent">
</p>
   <pre class="fancyvrb" id="fancyvrb32"><a id="x1-27042r1"></a><span class="ecrm-0500">1</span><span id="textcolor265"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file_operations&nbsp;{</span> 
<a id="x1-27044r2"></a><span class="ecrm-0500">2</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor266"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;module&nbsp;*owner;</span> 
<a id="x1-27046r3"></a><span class="ecrm-0500">3</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;loff_t&nbsp;(*llseek)&nbsp;(</span><span id="textcolor267"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*,&nbsp;loff_t,&nbsp;</span><span id="textcolor268"><span class="ectt-0800">int</span></span><span class="ectt-0800">);</span> 
<a id="x1-27048r4"></a><span class="ecrm-0500">4</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor269"><span class="ectt-0800">ssize_t</span></span><span class="ectt-0800">&nbsp;(*read)&nbsp;(</span><span id="textcolor270"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*,&nbsp;</span><span id="textcolor271"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;__user&nbsp;*,&nbsp;</span><span id="textcolor272"><span class="ectt-0800">size_t</span></span><span class="ectt-0800">,&nbsp;loff_t&nbsp;*);</span> 
<a id="x1-27050r5"></a><span class="ecrm-0500">5</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor273"><span class="ectt-0800">ssize_t</span></span><span class="ectt-0800">&nbsp;(*write)&nbsp;(</span><span id="textcolor274"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*,&nbsp;</span><span id="textcolor275"><span class="ectt-0800">const</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor276"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;__user&nbsp;*,&nbsp;</span><span id="textcolor277"><span class="ectt-0800">size_t</span></span><span class="ectt-0800">,&nbsp;loff_t&nbsp;*);</span> 
<a id="x1-27052r6"></a><span class="ecrm-0500">6</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor278"><span class="ectt-0800">ssize_t</span></span><span class="ectt-0800">&nbsp;(*read_iter)&nbsp;(</span><span id="textcolor279"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;kiocb&nbsp;*,&nbsp;</span><span id="textcolor280"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;iov_iter&nbsp;*);</span> 
<a id="x1-27054r7"></a><span class="ecrm-0500">7</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor281"><span class="ectt-0800">ssize_t</span></span><span class="ectt-0800">&nbsp;(*write_iter)&nbsp;(</span><span id="textcolor282"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;kiocb&nbsp;*,&nbsp;</span><span id="textcolor283"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;iov_iter&nbsp;*);</span> 
<a id="x1-27056r8"></a><span class="ecrm-0500">8</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor284"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;(*iopoll)(</span><span id="textcolor285"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;kiocb&nbsp;*kiocb,&nbsp;</span><span id="textcolor286"><span class="ectt-0800">bool</span></span><span class="ectt-0800">&nbsp;spin);</span> 
<a id="x1-27058r9"></a><span class="ecrm-0500">9</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor287"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;(*iterate)&nbsp;(</span><span id="textcolor288"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*,&nbsp;</span><span id="textcolor289"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;dir_context&nbsp;*);</span> 
<a id="x1-27060r10"></a><span class="ecrm-0500">10</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor290"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;(*iterate_shared)&nbsp;(</span><span id="textcolor291"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*,&nbsp;</span><span id="textcolor292"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;dir_context&nbsp;*);</span> 
<a id="x1-27062r11"></a><span class="ecrm-0500">11</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;__poll_t&nbsp;(*poll)&nbsp;(</span><span id="textcolor293"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*,&nbsp;</span><span id="textcolor294"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;poll_table_struct&nbsp;*);</span> 
<a id="x1-27064r12"></a><span class="ecrm-0500">12</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor295"><span class="ectt-0800">long</span></span><span class="ectt-0800">&nbsp;(*unlocked_ioctl)&nbsp;(</span><span id="textcolor296"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*,&nbsp;</span><span id="textcolor297"><span class="ectt-0800">unsigned</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor298"><span class="ectt-0800">int</span></span><span class="ectt-0800">,&nbsp;</span><span id="textcolor299"><span class="ectt-0800">unsigned</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor300"><span class="ectt-0800">long</span></span><span class="ectt-0800">);</span> 
<a id="x1-27066r13"></a><span class="ecrm-0500">13</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor301"><span class="ectt-0800">long</span></span><span class="ectt-0800">&nbsp;(*compat_ioctl)&nbsp;(</span><span id="textcolor302"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*,&nbsp;</span><span id="textcolor303"><span class="ectt-0800">unsigned</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor304"><span class="ectt-0800">int</span></span><span class="ectt-0800">,&nbsp;</span><span id="textcolor305"><span class="ectt-0800">unsigned</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor306"><span class="ectt-0800">long</span></span><span class="ectt-0800">);</span> 
<a id="x1-27068r14"></a><span class="ecrm-0500">14</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor307"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;(*mmap)&nbsp;(</span><span id="textcolor308"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*,&nbsp;</span><span id="textcolor309"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;vm_area_struct&nbsp;*);</span> 
<a id="x1-27070r15"></a><span class="ecrm-0500">15</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor310"><span class="ectt-0800">unsigned</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor311"><span class="ectt-0800">long</span></span><span class="ectt-0800">&nbsp;mmap_supported_flags;</span> 
<a id="x1-27072r16"></a><span class="ecrm-0500">16</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor312"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;(*open)&nbsp;(</span><span id="textcolor313"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;inode&nbsp;*,&nbsp;</span><span id="textcolor314"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*);</span> 
<a id="x1-27074r17"></a><span class="ecrm-0500">17</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor315"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;(*flush)&nbsp;(</span><span id="textcolor316"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*,&nbsp;fl_owner_t&nbsp;id);</span> 
<a id="x1-27076r18"></a><span class="ecrm-0500">18</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor317"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;(*release)&nbsp;(</span><span id="textcolor318"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;inode&nbsp;*,&nbsp;</span><span id="textcolor319"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*);</span> 
<a id="x1-27078r19"></a><span class="ecrm-0500">19</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor320"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;(*fsync)&nbsp;(</span><span id="textcolor321"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*,&nbsp;loff_t,&nbsp;loff_t,&nbsp;</span><span id="textcolor322"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;datasync);</span> 
<a id="x1-27080r20"></a><span class="ecrm-0500">20</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor323"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;(*fasync)&nbsp;(</span><span id="textcolor324"><span class="ectt-0800">int</span></span><span class="ectt-0800">,&nbsp;</span><span id="textcolor325"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*,&nbsp;</span><span id="textcolor326"><span class="ectt-0800">int</span></span><span class="ectt-0800">);</span> 
<a id="x1-27082r21"></a><span class="ecrm-0500">21</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor327"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;(*lock)&nbsp;(</span><span id="textcolor328"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*,&nbsp;</span><span id="textcolor329"><span class="ectt-0800">int</span></span><span class="ectt-0800">,&nbsp;</span><span id="textcolor330"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file_lock&nbsp;*);</span> 
<a id="x1-27084r22"></a><span class="ecrm-0500">22</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor331"><span class="ectt-0800">ssize_t</span></span><span class="ectt-0800">&nbsp;(*sendpage)&nbsp;(</span><span id="textcolor332"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*,&nbsp;</span><span id="textcolor333"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;page&nbsp;*,&nbsp;</span><span id="textcolor334"><span class="ectt-0800">int</span></span><span class="ectt-0800">,&nbsp;</span><span id="textcolor335"><span class="ectt-0800">size_t</span></span><span class="ectt-0800">,&nbsp;loff_t&nbsp;*,&nbsp;</span><span id="textcolor336"><span class="ectt-0800">int</span></span><span class="ectt-0800">);</span> 
<a id="x1-27086r23"></a><span class="ecrm-0500">23</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor337"><span class="ectt-0800">unsigned</span></span><span class="ectt-0800">&nbsp;long&nbsp;(*get_unmapped_area)(</span><span id="textcolor338"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*,&nbsp;</span><span id="textcolor339"><span class="ectt-0800">unsigned</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor340"><span class="ectt-0800">long</span></span><span class="ectt-0800">,&nbsp;</span><span id="textcolor341"><span class="ectt-0800">unsigned</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor342"><span class="ectt-0800">long</span></span><span class="ectt-0800">,&nbsp;</span><span id="textcolor343"><span class="ectt-0800">unsigned</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor344"><span class="ectt-0800">long</span></span><span class="ectt-0800">,&nbsp;</span><span id="textcolor345"><span class="ectt-0800">unsigned</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor346"><span class="ectt-0800">long</span></span><span class="ectt-0800">);</span> 
<a id="x1-27088r24"></a><span class="ecrm-0500">24</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor347"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;(*check_flags)(</span><span id="textcolor348"><span class="ectt-0800">int</span></span><span class="ectt-0800">);</span> 
<a id="x1-27090r25"></a><span class="ecrm-0500">25</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor349"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;(*flock)&nbsp;(</span><span id="textcolor350"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*,&nbsp;</span><span id="textcolor351"><span class="ectt-0800">int</span></span><span class="ectt-0800">,&nbsp;</span><span id="textcolor352"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file_lock&nbsp;*);</span> 
<a id="x1-27092r26"></a><span class="ecrm-0500">26</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor353"><span class="ectt-0800">ssize_t</span></span><span class="ectt-0800">&nbsp;(*splice_write)(</span><span id="textcolor354"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;pipe_inode_info&nbsp;*,&nbsp;</span><span id="textcolor355"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*,&nbsp;loff_t&nbsp;*,&nbsp;</span><span id="textcolor356"><span class="ectt-0800">size_t</span></span><span class="ectt-0800">,&nbsp;</span><span id="textcolor357"><span class="ectt-0800">unsigned</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor358"><span class="ectt-0800">int</span></span><span class="ectt-0800">);</span> 
<a id="x1-27094r27"></a><span class="ecrm-0500">27</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor359"><span class="ectt-0800">ssize_t</span></span><span class="ectt-0800">&nbsp;(*splice_read)(</span><span id="textcolor360"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*,&nbsp;loff_t&nbsp;*,&nbsp;</span><span id="textcolor361"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;pipe_inode_info&nbsp;*,&nbsp;</span><span id="textcolor362"><span class="ectt-0800">size_t</span></span><span class="ectt-0800">,&nbsp;</span><span id="textcolor363"><span class="ectt-0800">unsigned</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor364"><span class="ectt-0800">int</span></span><span class="ectt-0800">);</span> 
<a id="x1-27096r28"></a><span class="ecrm-0500">28</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor365"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;(*setlease)(</span><span id="textcolor366"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*,&nbsp;</span><span id="textcolor367"><span class="ectt-0800">long</span></span><span class="ectt-0800">,&nbsp;</span><span id="textcolor368"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file_lock&nbsp;**,&nbsp;</span><span id="textcolor369"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;**);</span> 
<a id="x1-27098r29"></a><span class="ecrm-0500">29</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor370"><span class="ectt-0800">long</span></span><span class="ectt-0800">&nbsp;(*fallocate)(</span><span id="textcolor371"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*file,&nbsp;</span><span id="textcolor372"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;mode,&nbsp;loff_t&nbsp;offset,</span> 
<a id="x1-27100r30"></a><span class="ecrm-0500">30</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;loff_t&nbsp;len);</span> 
<a id="x1-27102r31"></a><span class="ecrm-0500">31</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor373"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;(*show_fdinfo)(</span><span id="textcolor374"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;seq_file&nbsp;*m,&nbsp;</span><span id="textcolor375"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*f);</span> 
<a id="x1-27104r32"></a><span class="ecrm-0500">32</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor376"><span class="ectt-0800">ssize_t</span></span><span class="ectt-0800">&nbsp;(*copy_file_range)(</span><span id="textcolor377"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*,&nbsp;loff_t,&nbsp;</span><span id="textcolor378"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*,</span> 
<a id="x1-27106r33"></a><span class="ecrm-0500">33</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;loff_t,&nbsp;</span><span id="textcolor379"><span class="ectt-0800">size_t</span></span><span class="ectt-0800">,&nbsp;</span><span id="textcolor380"><span class="ectt-0800">unsigned</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor381"><span class="ectt-0800">int</span></span><span class="ectt-0800">);</span> 
<a id="x1-27108r34"></a><span class="ecrm-0500">34</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;loff_t&nbsp;(*remap_file_range)(</span><span id="textcolor382"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*file_in,&nbsp;loff_t&nbsp;pos_in,</span> 
<a id="x1-27110r35"></a><span class="ecrm-0500">35</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor383"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*file_out,&nbsp;loff_t&nbsp;pos_out,</span> 
<a id="x1-27112r36"></a><span class="ecrm-0500">36</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;loff_t&nbsp;len,&nbsp;</span><span id="textcolor384"><span class="ectt-0800">unsigned</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor385"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;remap_flags);</span> 
<a id="x1-27114r37"></a><span class="ecrm-0500">37</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor386"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;(*fadvise)(</span><span id="textcolor387"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*,&nbsp;loff_t,&nbsp;loff_t,&nbsp;</span><span id="textcolor388"><span class="ectt-0800">int</span></span><span class="ectt-0800">);</span> 
<a id="x1-27116r38"></a><span class="ecrm-0500">38</span><span class="ectt-0800">}&nbsp;__randomize_layout;</span></pre>
<!-- l. 800 --><p class="indent">   Some operations are not implemented by a driver. For example, a driver that handles
a video card will not need to read from a directory structure. The corresponding entries
in the <code>  <span class="ectt-1000">file_operations</span>
</code> structure should be set to <code>  <span class="ectt-1000">NULL</span>
</code>.
</p><!-- l. 804 --><p class="indent">   There is a gcc extension that makes assigning to this structure more convenient.
You will see it in modern drivers, and may catch you by surprise. This is what the
new way of assigning to the structure looks like:
</p><!-- l. 1 --><p class="indent">
                                                                  

                                                                  
</p>
   <pre class="fancyvrb" id="fancyvrb33"><a id="x1-27126r1"></a><span class="ecrm-0500">1</span><span id="textcolor389"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file_operations&nbsp;fops&nbsp;=&nbsp;{</span> 
<a id="x1-27128r2"></a><span class="ecrm-0500">2</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;read:&nbsp;device_read,</span> 
<a id="x1-27130r3"></a><span class="ecrm-0500">3</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;write:&nbsp;device_write,</span> 
<a id="x1-27132r4"></a><span class="ecrm-0500">4</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;open:&nbsp;device_open,</span> 
<a id="x1-27134r5"></a><span class="ecrm-0500">5</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;release:&nbsp;device_release</span> 
<a id="x1-27136r6"></a><span class="ecrm-0500">6</span><span class="ectt-0800">};</span></pre>
<!-- l. 817 --><p class="indent">   However, there is also a C99 way of assigning to elements of a structure,
<a href="https://gcc.gnu.org/onlinedocs/gcc/Designated-Inits.html">designated initializers</a>, and this is definitely preferred over using the GNU extension.
You should use this syntax in case someone wants to port your driver. It will help
with compatibility:
</p><!-- l. 1 --><p class="indent">
</p>
   <pre class="fancyvrb" id="fancyvrb34"><a id="x1-27144r1"></a><span class="ecrm-0500">1</span><span id="textcolor390"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file_operations&nbsp;fops&nbsp;=&nbsp;{</span> 
<a id="x1-27146r2"></a><span class="ecrm-0500">2</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.read&nbsp;=&nbsp;device_read,</span> 
<a id="x1-27148r3"></a><span class="ecrm-0500">3</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.write&nbsp;=&nbsp;device_write,</span> 
<a id="x1-27150r4"></a><span class="ecrm-0500">4</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.open&nbsp;=&nbsp;device_open,</span> 
<a id="x1-27152r5"></a><span class="ecrm-0500">5</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.release&nbsp;=&nbsp;device_release</span> 
<a id="x1-27154r6"></a><span class="ecrm-0500">6</span><span class="ectt-0800">};</span></pre>
<!-- l. 830 --><p class="indent">   The meaning is clear, and you should be aware that any member of
the structure which you do not explicitly assign will be initialized to
<code> <span class="ectt-1000">NULL</span>
</code> by gcc.
</p><!-- l. 832 --><p class="indent">   An instance of <code>  <span id="textcolor391"><span class="ectt-1000">struct</span></span><span class="ectt-1000">&nbsp;file_operations</span>
</code> containing pointers to functions that are used to implement
<code> <span class="ectt-1000">read</span>
</code>, <code>  <span class="ectt-1000">write</span>
</code>, <code>  <span class="ectt-1000">open</span>
</code>, … system calls is commonly named <code>  <span class="ectt-1000">fops</span>
</code>.
</p><!-- l. 834 --><p class="indent">   Sin Linux v5.6, the <code>  <span class="ectt-1000">proc_ops</span>
</code> structure was introduced to replace the use of the
<code> <span class="ectt-1000">file_operations</span>
</code> structure when registering proc handlers.
</p><!-- l. 836 --><p class="noindent">
</p>
   <h4 class="subsectionHead" id="the-file-structure"><span class="titlemark">0.6.2   </span> <a id="x1-280000.6.2"></a>The file structure</h4>
<!-- l. 839 --><p class="noindent">Each device is represented in the kernel by a file structure, which is defined
in <a href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/fs.h">include/linux/fs.h</a>. Be aware that a file is a kernel level structure and
never appears in a user space program. It is not the same thing as a
<code> <span id="textcolor392"><span class="ectt-1000">FILE</span></span>
</code>, which is defined by glibc and would never appear in a kernel space function. Also,
its name is a bit misleading; it represents an abstract open ‘file’, not a file on a disk,
which is represented by a structure named inode.
</p><!-- l. 844 --><p class="indent">   An instance of struct file is commonly named filp. You’ll also see it refered to as
struct file file. Resist the temptation.
</p><!-- l. 847 --><p class="indent">   Go ahead and look at the definition of file. Most of the entries you see, like struct
dentry are not used by device drivers, and you can ignore them. This is because
drivers do not fill file directly; they only use structures contained in file which are
created elsewhere.
                                                                  

                                                                  
</p><!-- l. 851 --><p class="noindent">
</p>
   <h4 class="subsectionHead" id="registering-a-device"><span class="titlemark">0.6.3   </span> <a id="x1-290000.6.3"></a>Registering A Device</h4>
<!-- l. 853 --><p class="noindent">As discussed earlier, char devices are accessed through device files, usually located in
/dev. This is by convention. When writing a driver, it is OK to put the
device file in your current directory. Just make sure you place it in <span class="obeylines-h"><span class="verb"><span class="ectt-1000">/dev</span></span></span> for a
production driver. The major number tells you which driver handles which
device file. The minor number is used only by the driver itself to differentiate
which device it is operating on, just in case the driver handles more than one
device.
</p><!-- l. 859 --><p class="indent">   Adding a driver to your system means registering it with the kernel. This is synonymous
with assigning it a major number during the module’s initialization. You do this by
using the <code>  <span class="ectt-1000">register_chrdev</span>
</code> function, defined by <a href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/fs.h">include/linux/fs.h</a>.
</p><!-- l. 1 --><p class="indent">
</p>
   <pre class="fancyvrb" id="fancyvrb35"><a id="x1-29004r1"></a><span class="ecrm-0500">1</span><span id="textcolor393"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;register_chrdev(</span><span id="textcolor394"><span class="ectt-0800">unsigned</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor395"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;major,&nbsp;</span><span id="textcolor396"><span class="ectt-0800">const</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor397"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;*name,&nbsp;</span><span id="textcolor398"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file_operations&nbsp;*fops);</span></pre>
<!-- l. 867 --><p class="indent">   where unsigned int major is the major number you want to request,
<code> <span id="textcolor399"><span class="ectt-1000">const</span></span><span class="ectt-1000">&nbsp;</span><span id="textcolor400"><span class="ectt-1000">char</span></span><span class="ectt-1000">&nbsp;*name</span>
</code> is the name of the device as it will appear in <span class="obeylines-h"><span class="verb"><span class="ectt-1000">/proc/devices</span></span></span> and
<code> <span id="textcolor401"><span class="ectt-1000">struct</span></span><span class="ectt-1000">&nbsp;file_operations&nbsp;*fops</span>
</code> is a pointer to the <code>  <span class="ectt-1000">file_operations</span>
</code> table for your driver. A negative return value means the
registration failed. Note that we didn’t pass the minor number to
<code> <span class="ectt-1000">register_chrdev</span>
</code>. That is because the kernel doesn’t care about the minor number; only our driver
uses it.
</p><!-- l. 871 --><p class="indent">   Now the question is, how do you get a major number without hijacking
one that’s already in use? The easiest way would be to look through
<a href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/tree/Documentation/admin-guide/devices.txt">Documentation/admin-guide/devices.txt</a> and pick an unused one. That is a bad way
of doing things because you will never be sure if the number you picked will be
assigned later. The answer is that you can ask the kernel to assign you a dynamic
major number.
</p><!-- l. 876 --><p class="indent">   If you pass a major number of 0 to <code>  <span class="ectt-1000">register_chrdev</span>
</code>, the return value will be the dynamically allocated major number. The
downside is that you can not make a device file in advance, since you do not
know what the major number will be. There are a couple of ways to do
this. First, the driver itself can print the newly assigned number and we
can make the device file by hand. Second, the newly registered device will
have an entry in <span class="obeylines-h"><span class="verb"><span class="ectt-1000">/proc/devices</span></span></span>, and we can either make the device file by
hand or write a shell script to read the file in and make the device file. The
third method is we can have our driver make the the device file using the
<code> <span class="ectt-1000">device_create</span>
</code> function after a successful registration and
<code> <span class="ectt-1000">device_destroy</span>
                                                                  

                                                                  
</code> during the call to <code>  <span class="ectt-1000">cleanup_module</span>
</code>.
</p><!-- l. 883 --><p class="noindent">
</p>
   <h4 class="subsectionHead" id="unregistering-a-device"><span class="titlemark">0.6.4   </span> <a id="x1-300000.6.4"></a>Unregistering A Device</h4>
<!-- l. 885 --><p class="noindent">We can not allow the kernel module to be
<code> <span class="ectt-1000">rmmod</span>
</code>’ed whenever root feels like it. If the device file is opened by a process and then we
remove the kernel module, using the file would cause a call to the memory location
where the appropriate function (read/write) used to be. If we are lucky, no
other code was loaded there, and we’ll get an ugly error message. If we are
unlucky, another kernel module was loaded into the same location, which
means a jump into the middle of another function within the kernel. The
results of this would be impossible to predict, but they can not be very
positive.
</p><!-- l. 891 --><p class="indent">   Normally, when you do not want to allow something, you return an error code
(a negative number) from the function which is supposed to do it. With
<code> <span class="ectt-1000">cleanup_module</span>
</code> that’s impossible because it is a void function. However, there is a counter which
keeps track of how many processes are using your module. You can see what its value
is by looking at the 3rd field of <span class="obeylines-h"><span class="verb"><span class="ectt-1000">/proc/modules</span></span></span>. If this number isn’t zero,
<code> <span class="ectt-1000">rmmod</span>
</code> will fail. Note that you do not have to check the counter from within
<code> <span class="ectt-1000">cleanup_module</span>
</code> because the check will be performed for you by the system call
<code> <span class="ectt-1000">sys_delete_module</span>
</code>, defined in <a href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/syscalls.h">include/linux/syscalls.h</a>. You should not use this counter directly, but
there are functions defined in <a href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/module.h">include/linux/module.h</a> which let you increase,
decrease and display this counter:
</p>
     <ul class="itemize1">
     <li class="itemize"><code>  <span class="ectt-1000">try_module_get(THIS_MODULE)</span>
     </code>: Increment the use count.
     </li>
     <li class="itemize"><code>  <span class="ectt-1000">module_put(THIS_MODULE)</span>
     </code>: Decrement the use count.</li></ul>
                                                                  

                                                                  
<!-- l. 904 --><p class="indent">   It is important to keep the counter accurate; if you ever do lose track of the
correct usage count, you will never be able to unload the module; it’s now reboot
time, boys and girls. This is bound to happen to you sooner or later during a
module’s development.
</p><!-- l. 907 --><p class="noindent">
</p>
   <h4 class="subsectionHead" id="chardevc"><span class="titlemark">0.6.5   </span> <a id="x1-310000.6.5"></a>chardev.c</h4>
<!-- l. 909 --><p class="noindent">The next code sample creates a char driver named chardev. You can cat its device
file.
</p><!-- l. 1 --><p class="indent">
</p>
   <pre class="fancyvrb" id="fancyvrb36"><a id="x1-31003r1"></a><span class="ecrm-0500">1</span><span class="ectt-1000">cat&nbsp;/proc/devices</span></pre>
<!-- l. 916 --><p class="indent">   (or open the file with a program) and the driver will put the number of times the
device file has been read from into the file. We do not support writing to the file (like
<code> <span class="ectt-1000">echo&nbsp;</span><span id="textcolor402"><span class="ectt-1000">"hi"</span></span><span class="ectt-1000">&nbsp;&gt;&nbsp;/dev/hello</span>
</code>), but catch these attempts and tell the user that the operation is not supported.
Don’t worry if you don’t see what we do with the data we read into the buffer; we
don’t do much with it. We simply read in the data and print a message
acknowledging that we received it.
</p><!-- l. 1 --><p class="indent">
</p>
   <pre class="fancyvrb" id="fancyvrb37"><a id="x1-31006r1"></a><span class="ecrm-0500">1</span><span id="textcolor403"><span class="ectt-0800">/*</span></span> 
<a id="x1-31008r2"></a><span class="ecrm-0500">2</span><span id="textcolor404"><span class="ectt-0800">&nbsp;*&nbsp;chardev.c:&nbsp;Creates&nbsp;a&nbsp;read-only&nbsp;char&nbsp;device&nbsp;that&nbsp;says&nbsp;how&nbsp;many&nbsp;times</span></span> 
<a id="x1-31010r3"></a><span class="ecrm-0500">3</span><span id="textcolor405"><span class="ectt-0800">&nbsp;*&nbsp;you&nbsp;have&nbsp;read&nbsp;from&nbsp;the&nbsp;dev&nbsp;file</span></span> 
<a id="x1-31012r4"></a><span class="ecrm-0500">4</span><span id="textcolor406"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-31014r5"></a><span class="ecrm-0500">5</span> 
<a id="x1-31016r6"></a><span class="ecrm-0500">6</span><span id="textcolor407"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor408"><span class="ectt-0800">&lt;linux/cdev.h&gt;</span></span> 
<a id="x1-31018r7"></a><span class="ecrm-0500">7</span><span id="textcolor409"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor410"><span class="ectt-0800">&lt;linux/delay.h&gt;</span></span> 
<a id="x1-31020r8"></a><span class="ecrm-0500">8</span><span id="textcolor411"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor412"><span class="ectt-0800">&lt;linux/device.h&gt;</span></span> 
<a id="x1-31022r9"></a><span class="ecrm-0500">9</span><span id="textcolor413"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor414"><span class="ectt-0800">&lt;linux/fs.h&gt;</span></span> 
<a id="x1-31024r10"></a><span class="ecrm-0500">10</span><span id="textcolor415"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor416"><span class="ectt-0800">&lt;linux/init.h&gt;</span></span> 
<a id="x1-31026r11"></a><span class="ecrm-0500">11</span><span id="textcolor417"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor418"><span class="ectt-0800">&lt;linux/irq.h&gt;</span></span> 
<a id="x1-31028r12"></a><span class="ecrm-0500">12</span><span id="textcolor419"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor420"><span class="ectt-0800">&lt;linux/kernel.h&gt;</span></span> 
<a id="x1-31030r13"></a><span class="ecrm-0500">13</span><span id="textcolor421"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor422"><span class="ectt-0800">&lt;linux/module.h&gt;</span></span> 
<a id="x1-31032r14"></a><span class="ecrm-0500">14</span><span id="textcolor423"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor424"><span class="ectt-0800">&lt;linux/poll.h&gt;</span></span> 
<a id="x1-31034r15"></a><span class="ecrm-0500">15</span> 
<a id="x1-31036r16"></a><span class="ecrm-0500">16</span><span id="textcolor425"><span class="ectt-0800">/*&nbsp;&nbsp;Prototypes&nbsp;-&nbsp;this&nbsp;would&nbsp;normally&nbsp;go&nbsp;in&nbsp;a&nbsp;.h&nbsp;file&nbsp;*/</span></span> 
<a id="x1-31038r17"></a><span class="ecrm-0500">17</span><span id="textcolor426"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor427"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;device_open(</span><span id="textcolor428"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;inode&nbsp;*,&nbsp;</span><span id="textcolor429"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*);</span> 
<a id="x1-31040r18"></a><span class="ecrm-0500">18</span><span id="textcolor430"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor431"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;device_release(</span><span id="textcolor432"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;inode&nbsp;*,&nbsp;</span><span id="textcolor433"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*);</span> 
<a id="x1-31042r19"></a><span class="ecrm-0500">19</span><span id="textcolor434"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor435"><span class="ectt-0800">ssize_t</span></span><span class="ectt-0800">&nbsp;device_read(</span><span id="textcolor436"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*,&nbsp;</span><span id="textcolor437"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;*,&nbsp;</span><span id="textcolor438"><span class="ectt-0800">size_t</span></span><span class="ectt-0800">,&nbsp;loff_t&nbsp;*);</span> 
<a id="x1-31044r20"></a><span class="ecrm-0500">20</span><span id="textcolor439"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor440"><span class="ectt-0800">ssize_t</span></span><span class="ectt-0800">&nbsp;device_write(</span><span id="textcolor441"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*,&nbsp;</span><span id="textcolor442"><span class="ectt-0800">const</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor443"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;*,&nbsp;</span><span id="textcolor444"><span class="ectt-0800">size_t</span></span><span class="ectt-0800">,&nbsp;loff_t&nbsp;*);</span> 
<a id="x1-31046r21"></a><span class="ecrm-0500">21</span> 
<a id="x1-31048r22"></a><span class="ecrm-0500">22</span><span id="textcolor445"><span class="ectt-0800">#define&nbsp;SUCCESS&nbsp;0</span></span> 
<a id="x1-31050r23"></a><span class="ecrm-0500">23</span><span id="textcolor446"><span class="ectt-0800">#define&nbsp;DEVICE_NAME&nbsp;"chardev"&nbsp;</span></span><span id="textcolor447"><span class="ectt-0800">/*&nbsp;Dev&nbsp;name&nbsp;as&nbsp;it&nbsp;appears&nbsp;in&nbsp;/proc/devices&nbsp;&nbsp;&nbsp;*/</span></span> 
<a id="x1-31052r24"></a><span class="ecrm-0500">24</span><span id="textcolor448"><span class="ectt-0800">#define&nbsp;BUF_LEN&nbsp;80&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span id="textcolor449"><span class="ectt-0800">/*&nbsp;Max&nbsp;length&nbsp;of&nbsp;the&nbsp;message&nbsp;from&nbsp;the&nbsp;device&nbsp;*/</span></span> 
<a id="x1-31054r25"></a><span class="ecrm-0500">25</span> 
<a id="x1-31056r26"></a><span class="ecrm-0500">26</span><span id="textcolor450"><span class="ectt-0800">/*&nbsp;Global&nbsp;variables&nbsp;are&nbsp;declared&nbsp;as&nbsp;static,&nbsp;so&nbsp;are&nbsp;global&nbsp;within&nbsp;the&nbsp;file.&nbsp;*/</span></span> 
<a id="x1-31058r27"></a><span class="ecrm-0500">27</span> 
<a id="x1-31060r28"></a><span class="ecrm-0500">28</span><span id="textcolor451"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor452"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;major;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor453"><span class="ectt-0800">/*&nbsp;major&nbsp;number&nbsp;assigned&nbsp;to&nbsp;our&nbsp;device&nbsp;driver&nbsp;*/</span></span> 
<a id="x1-31062r29"></a><span class="ecrm-0500">29</span><span id="textcolor454"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor455"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;open_device_cnt&nbsp;=&nbsp;0;&nbsp;</span><span id="textcolor456"><span class="ectt-0800">/*&nbsp;Is&nbsp;device&nbsp;open?</span></span> 
<a id="x1-31064r30"></a><span class="ecrm-0500">30</span><span id="textcolor457"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Used&nbsp;to&nbsp;prevent&nbsp;multiple&nbsp;access&nbsp;to&nbsp;device&nbsp;*/</span></span> 
<a id="x1-31066r31"></a><span class="ecrm-0500">31</span><span id="textcolor458"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor459"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;msg[BUF_LEN];&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor460"><span class="ectt-0800">/*&nbsp;The&nbsp;msg&nbsp;the&nbsp;device&nbsp;will&nbsp;give&nbsp;when&nbsp;asked&nbsp;*/</span></span> 
<a id="x1-31068r32"></a><span class="ecrm-0500">32</span><span id="textcolor461"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor462"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;*msg_ptr;</span> 
<a id="x1-31070r33"></a><span class="ecrm-0500">33</span> 
<a id="x1-31072r34"></a><span class="ecrm-0500">34</span><span id="textcolor463"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor464"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;class&nbsp;*cls;</span> 
<a id="x1-31074r35"></a><span class="ecrm-0500">35</span> 
<a id="x1-31076r36"></a><span class="ecrm-0500">36</span><span id="textcolor465"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor466"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file_operations&nbsp;chardev_fops&nbsp;=&nbsp;{</span> 
<a id="x1-31078r37"></a><span class="ecrm-0500">37</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.read&nbsp;=&nbsp;device_read,</span> 
<a id="x1-31080r38"></a><span class="ecrm-0500">38</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.write&nbsp;=&nbsp;device_write,</span> 
<a id="x1-31082r39"></a><span class="ecrm-0500">39</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.open&nbsp;=&nbsp;device_open,</span> 
<a id="x1-31084r40"></a><span class="ecrm-0500">40</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.release&nbsp;=&nbsp;device_release,</span> 
<a id="x1-31086r41"></a><span class="ecrm-0500">41</span><span class="ectt-0800">};</span> 
<a id="x1-31088r42"></a><span class="ecrm-0500">42</span> 
<a id="x1-31090r43"></a><span class="ecrm-0500">43</span><span id="textcolor467"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor468"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;__init&nbsp;chardev_init(</span><span id="textcolor469"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-31092r44"></a><span class="ecrm-0500">44</span><span class="ectt-0800">{</span> 
<a id="x1-31094r45"></a><span class="ecrm-0500">45</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;major&nbsp;=&nbsp;register_chrdev(0,&nbsp;DEVICE_NAME,&nbsp;&amp;chardev_fops);</span> 
<a id="x1-31096r46"></a><span class="ecrm-0500">46</span> 
<a id="x1-31098r47"></a><span class="ecrm-0500">47</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor470"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(major&nbsp;&lt;&nbsp;0)&nbsp;{</span> 
<a id="x1-31100r48"></a><span class="ecrm-0500">48</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pr_alert(</span><span id="textcolor471"><span class="ectt-0800">"Registering&nbsp;char&nbsp;device&nbsp;failed&nbsp;with&nbsp;%d</span></span><span id="textcolor472"><span class="ectt-0800">\n</span></span><span id="textcolor473"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;major);</span> 
<a id="x1-31102r49"></a><span class="ecrm-0500">49</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor474"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;major;</span> 
<a id="x1-31104r50"></a><span class="ecrm-0500">50</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-31106r51"></a><span class="ecrm-0500">51</span> 
<a id="x1-31108r52"></a><span class="ecrm-0500">52</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor475"><span class="ectt-0800">"I&nbsp;was&nbsp;assigned&nbsp;major&nbsp;number&nbsp;%d.</span></span><span id="textcolor476"><span class="ectt-0800">\n</span></span><span id="textcolor477"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;major);</span> 
<a id="x1-31110r53"></a><span class="ecrm-0500">53</span> 
<a id="x1-31112r54"></a><span class="ecrm-0500">54</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;cls&nbsp;=&nbsp;class_create(THIS_MODULE,&nbsp;DEVICE_NAME);</span> 
<a id="x1-31114r55"></a><span class="ecrm-0500">55</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;device_create(cls,&nbsp;NULL,&nbsp;MKDEV(major,&nbsp;0),&nbsp;NULL,&nbsp;DEVICE_NAME);</span> 
<a id="x1-31116r56"></a><span class="ecrm-0500">56</span> 
<a id="x1-31118r57"></a><span class="ecrm-0500">57</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor478"><span class="ectt-0800">"Device&nbsp;created&nbsp;on&nbsp;/dev/%s</span></span><span id="textcolor479"><span class="ectt-0800">\n</span></span><span id="textcolor480"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;DEVICE_NAME);</span> 
<a id="x1-31120r58"></a><span class="ecrm-0500">58</span> 
<a id="x1-31122r59"></a><span class="ecrm-0500">59</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor481"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;SUCCESS;</span> 
<a id="x1-31124r60"></a><span class="ecrm-0500">60</span><span class="ectt-0800">}</span> 
<a id="x1-31126r61"></a><span class="ecrm-0500">61</span> 
<a id="x1-31128r62"></a><span class="ecrm-0500">62</span><span id="textcolor482"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor483"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;__exit&nbsp;chardev_exit(</span><span id="textcolor484"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-31130r63"></a><span class="ecrm-0500">63</span><span class="ectt-0800">{</span> 
<a id="x1-31132r64"></a><span class="ecrm-0500">64</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;device_destroy(cls,&nbsp;MKDEV(major,&nbsp;0));</span> 
<a id="x1-31134r65"></a><span class="ecrm-0500">65</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;class_destroy(cls);</span> 
<a id="x1-31136r66"></a><span class="ecrm-0500">66</span> 
<a id="x1-31138r67"></a><span class="ecrm-0500">67</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor485"><span class="ectt-0800">/*&nbsp;Unregister&nbsp;the&nbsp;device&nbsp;*/</span></span> 
<a id="x1-31140r68"></a><span class="ecrm-0500">68</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;unregister_chrdev(major,&nbsp;DEVICE_NAME);</span> 
<a id="x1-31142r69"></a><span class="ecrm-0500">69</span><span class="ectt-0800">}</span> 
<a id="x1-31144r70"></a><span class="ecrm-0500">70</span> 
<a id="x1-31146r71"></a><span class="ecrm-0500">71</span><span id="textcolor486"><span class="ectt-0800">/*&nbsp;Methods&nbsp;*/</span></span> 
<a id="x1-31148r72"></a><span class="ecrm-0500">72</span> 
<a id="x1-31150r73"></a><span class="ecrm-0500">73</span><span id="textcolor487"><span class="ectt-0800">/*&nbsp;Called&nbsp;when&nbsp;a&nbsp;process&nbsp;tries&nbsp;to&nbsp;open&nbsp;the&nbsp;device&nbsp;file,&nbsp;like</span></span> 
<a id="x1-31152r74"></a><span class="ecrm-0500">74</span><span id="textcolor488"><span class="ectt-0800">&nbsp;*&nbsp;"sudo&nbsp;cat&nbsp;/dev/chardev"</span></span> 
<a id="x1-31154r75"></a><span class="ecrm-0500">75</span><span id="textcolor489"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-31156r76"></a><span class="ecrm-0500">76</span><span id="textcolor490"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor491"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;device_open(</span><span id="textcolor492"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;inode&nbsp;*inode,&nbsp;</span><span id="textcolor493"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*file)</span> 
<a id="x1-31158r77"></a><span class="ecrm-0500">77</span><span class="ectt-0800">{</span> 
<a id="x1-31160r78"></a><span class="ecrm-0500">78</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor494"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor495"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;counter&nbsp;=&nbsp;0;</span> 
<a id="x1-31162r79"></a><span class="ecrm-0500">79</span> 
<a id="x1-31164r80"></a><span class="ecrm-0500">80</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor496"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(open_device_cnt)</span> 
<a id="x1-31166r81"></a><span class="ecrm-0500">81</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor497"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;-EBUSY;</span> 
<a id="x1-31168r82"></a><span class="ecrm-0500">82</span> 
<a id="x1-31170r83"></a><span class="ecrm-0500">83</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;open_device_cnt++;</span> 
<a id="x1-31172r84"></a><span class="ecrm-0500">84</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;sprintf(msg,&nbsp;</span><span id="textcolor498"><span class="ectt-0800">"I&nbsp;already&nbsp;told&nbsp;you&nbsp;%d&nbsp;times&nbsp;Hello&nbsp;world!</span></span><span id="textcolor499"><span class="ectt-0800">\n</span></span><span id="textcolor500"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;counter++);</span> 
<a id="x1-31174r85"></a><span class="ecrm-0500">85</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;msg_ptr&nbsp;=&nbsp;msg;</span> 
<a id="x1-31176r86"></a><span class="ecrm-0500">86</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;try_module_get(THIS_MODULE);</span> 
<a id="x1-31178r87"></a><span class="ecrm-0500">87</span> 
<a id="x1-31180r88"></a><span class="ecrm-0500">88</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor501"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;SUCCESS;</span> 
<a id="x1-31182r89"></a><span class="ecrm-0500">89</span><span class="ectt-0800">}</span> 
<a id="x1-31184r90"></a><span class="ecrm-0500">90</span> 
<a id="x1-31186r91"></a><span class="ecrm-0500">91</span><span id="textcolor502"><span class="ectt-0800">/*&nbsp;Called&nbsp;when&nbsp;a&nbsp;process&nbsp;closes&nbsp;the&nbsp;device&nbsp;file.&nbsp;*/</span></span> 
<a id="x1-31188r92"></a><span class="ecrm-0500">92</span><span id="textcolor503"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor504"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;device_release(</span><span id="textcolor505"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;inode&nbsp;*inode,&nbsp;</span><span id="textcolor506"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*file)</span> 
<a id="x1-31190r93"></a><span class="ecrm-0500">93</span><span class="ectt-0800">{</span> 
<a id="x1-31192r94"></a><span class="ecrm-0500">94</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;open_device_cnt--;&nbsp;</span><span id="textcolor507"><span class="ectt-0800">/*&nbsp;We</span><span class="tctt-0800">'</span><span class="ectt-0800">re&nbsp;now&nbsp;ready&nbsp;for&nbsp;our&nbsp;next&nbsp;caller&nbsp;*/</span></span> 
<a id="x1-31194r95"></a><span class="ecrm-0500">95</span> 
<a id="x1-31196r96"></a><span class="ecrm-0500">96</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor508"><span class="ectt-0800">/*&nbsp;Decrement&nbsp;the&nbsp;usage&nbsp;count,&nbsp;or&nbsp;else&nbsp;once&nbsp;you&nbsp;opened&nbsp;the&nbsp;file,&nbsp;you&nbsp;will</span></span> 
<a id="x1-31198r97"></a><span class="ecrm-0500">97</span><span id="textcolor509"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;never&nbsp;get&nbsp;get&nbsp;rid&nbsp;of&nbsp;the&nbsp;module.</span></span> 
<a id="x1-31200r98"></a><span class="ecrm-0500">98</span><span id="textcolor510"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span></span> 
<a id="x1-31202r99"></a><span class="ecrm-0500">99</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;module_put(THIS_MODULE);</span> 
<a id="x1-31204r100"></a><span class="ecrm-0500">100</span> 
<a id="x1-31206r101"></a><span class="ecrm-0500">101</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor511"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;SUCCESS;</span> 
<a id="x1-31208r102"></a><span class="ecrm-0500">102</span><span class="ectt-0800">}</span> 
<a id="x1-31210r103"></a><span class="ecrm-0500">103</span> 
<a id="x1-31212r104"></a><span class="ecrm-0500">104</span><span id="textcolor512"><span class="ectt-0800">/*&nbsp;Called&nbsp;when&nbsp;a&nbsp;process,&nbsp;which&nbsp;already&nbsp;opened&nbsp;the&nbsp;dev&nbsp;file,&nbsp;attempts&nbsp;to</span></span> 
<a id="x1-31214r105"></a><span class="ecrm-0500">105</span><span id="textcolor513"><span class="ectt-0800">&nbsp;*&nbsp;read&nbsp;from&nbsp;it.</span></span> 
<a id="x1-31216r106"></a><span class="ecrm-0500">106</span><span id="textcolor514"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-31218r107"></a><span class="ecrm-0500">107</span><span id="textcolor515"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor516"><span class="ectt-0800">ssize_t</span></span><span class="ectt-0800">&nbsp;device_read(</span><span id="textcolor517"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*filp,&nbsp;</span><span id="textcolor518"><span class="ectt-0800">/*&nbsp;see&nbsp;include/linux/fs.h&nbsp;&nbsp;&nbsp;*/</span></span> 
<a id="x1-31220r108"></a><span class="ecrm-0500">108</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor519"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;*buffer,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor520"><span class="ectt-0800">/*&nbsp;buffer&nbsp;to&nbsp;fill&nbsp;with&nbsp;data&nbsp;*/</span></span> 
<a id="x1-31222r109"></a><span class="ecrm-0500">109</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor521"><span class="ectt-0800">size_t</span></span><span class="ectt-0800">&nbsp;length,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor522"><span class="ectt-0800">/*&nbsp;length&nbsp;of&nbsp;the&nbsp;buffer&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span></span> 
<a id="x1-31224r110"></a><span class="ecrm-0500">110</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;loff_t&nbsp;*offset)</span> 
<a id="x1-31226r111"></a><span class="ecrm-0500">111</span><span class="ectt-0800">{</span> 
<a id="x1-31228r112"></a><span class="ecrm-0500">112</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor523"><span class="ectt-0800">/*&nbsp;Number&nbsp;of&nbsp;bytes&nbsp;actually&nbsp;written&nbsp;to&nbsp;the&nbsp;buffer&nbsp;*/</span></span> 
<a id="x1-31230r113"></a><span class="ecrm-0500">113</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor524"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;bytes_read&nbsp;=&nbsp;0;</span> 
<a id="x1-31232r114"></a><span class="ecrm-0500">114</span> 
<a id="x1-31234r115"></a><span class="ecrm-0500">115</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor525"><span class="ectt-0800">/*&nbsp;If&nbsp;we&nbsp;are&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;message,&nbsp;return&nbsp;0&nbsp;signifying&nbsp;end&nbsp;of&nbsp;file.&nbsp;*/</span></span> 
<a id="x1-31236r116"></a><span class="ecrm-0500">116</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor526"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(*msg_ptr&nbsp;==&nbsp;0)</span> 
<a id="x1-31238r117"></a><span class="ecrm-0500">117</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor527"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;0;</span> 
<a id="x1-31240r118"></a><span class="ecrm-0500">118</span> 
<a id="x1-31242r119"></a><span class="ecrm-0500">119</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor528"><span class="ectt-0800">/*&nbsp;Actually&nbsp;put&nbsp;the&nbsp;data&nbsp;into&nbsp;the&nbsp;buffer&nbsp;*/</span></span> 
<a id="x1-31244r120"></a><span class="ecrm-0500">120</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor529"><span class="ectt-0800">while</span></span><span class="ectt-0800">&nbsp;(length&nbsp;&amp;&amp;&nbsp;*msg_ptr)&nbsp;{</span> 
<a id="x1-31246r121"></a><span class="ecrm-0500">121</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor530"><span class="ectt-0800">/*&nbsp;The&nbsp;buffer&nbsp;is&nbsp;in&nbsp;the&nbsp;user&nbsp;data&nbsp;segment,&nbsp;not&nbsp;the&nbsp;kernel</span></span> 
<a id="x1-31248r122"></a><span class="ecrm-0500">122</span><span id="textcolor531"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;segment&nbsp;so&nbsp;"*"&nbsp;assignment&nbsp;won</span><span class="tctt-0800">'</span><span class="ectt-0800">t&nbsp;work.&nbsp;&nbsp;We&nbsp;have&nbsp;to&nbsp;use</span></span> 
<a id="x1-31250r123"></a><span class="ecrm-0500">123</span><span id="textcolor532"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;put_user&nbsp;which&nbsp;copies&nbsp;data&nbsp;from&nbsp;the&nbsp;kernel&nbsp;data&nbsp;segment&nbsp;to</span></span> 
<a id="x1-31252r124"></a><span class="ecrm-0500">124</span><span id="textcolor533"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;the&nbsp;user&nbsp;data&nbsp;segment.</span></span> 
<a id="x1-31254r125"></a><span class="ecrm-0500">125</span><span id="textcolor534"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span></span> 
<a id="x1-31256r126"></a><span class="ecrm-0500">126</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;put_user(*(msg_ptr++),&nbsp;buffer++);</span> 
<a id="x1-31258r127"></a><span class="ecrm-0500">127</span> 
<a id="x1-31260r128"></a><span class="ecrm-0500">128</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;length--;</span> 
<a id="x1-31262r129"></a><span class="ecrm-0500">129</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bytes_read++;</span> 
<a id="x1-31264r130"></a><span class="ecrm-0500">130</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-31266r131"></a><span class="ecrm-0500">131</span> 
<a id="x1-31268r132"></a><span class="ecrm-0500">132</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor535"><span class="ectt-0800">/*&nbsp;Most&nbsp;read&nbsp;functions&nbsp;return&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;put&nbsp;into&nbsp;the&nbsp;buffer.&nbsp;*/</span></span> 
<a id="x1-31270r133"></a><span class="ecrm-0500">133</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor536"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;bytes_read;</span> 
<a id="x1-31272r134"></a><span class="ecrm-0500">134</span><span class="ectt-0800">}</span> 
<a id="x1-31274r135"></a><span class="ecrm-0500">135</span> 
<a id="x1-31276r136"></a><span class="ecrm-0500">136</span><span id="textcolor537"><span class="ectt-0800">/*&nbsp;Called&nbsp;when&nbsp;a&nbsp;process&nbsp;writes&nbsp;to&nbsp;dev&nbsp;file:&nbsp;echo&nbsp;"hi"&nbsp;&gt;&nbsp;/dev/hello&nbsp;*/</span></span> 
<a id="x1-31278r137"></a><span class="ecrm-0500">137</span><span id="textcolor538"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor539"><span class="ectt-0800">ssize_t</span></span><span class="ectt-0800">&nbsp;device_write(</span><span id="textcolor540"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*filp,</span> 
<a id="x1-31280r138"></a><span class="ecrm-0500">138</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor541"><span class="ectt-0800">const</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor542"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;*buff,</span> 
<a id="x1-31282r139"></a><span class="ecrm-0500">139</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor543"><span class="ectt-0800">size_t</span></span><span class="ectt-0800">&nbsp;len,</span> 
<a id="x1-31284r140"></a><span class="ecrm-0500">140</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;loff_t&nbsp;*off)</span> 
<a id="x1-31286r141"></a><span class="ecrm-0500">141</span><span class="ectt-0800">{</span> 
<a id="x1-31288r142"></a><span class="ecrm-0500">142</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_alert(</span><span id="textcolor544"><span class="ectt-0800">"Sorry,&nbsp;this&nbsp;operation&nbsp;is&nbsp;not&nbsp;supported.</span></span><span id="textcolor545"><span class="ectt-0800">\n</span></span><span id="textcolor546"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-31290r143"></a><span class="ecrm-0500">143</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor547"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;-EINVAL;</span> 
<a id="x1-31292r144"></a><span class="ecrm-0500">144</span><span class="ectt-0800">}</span> 
<a id="x1-31294r145"></a><span class="ecrm-0500">145</span> 
<a id="x1-31296r146"></a><span class="ecrm-0500">146</span><span class="ectt-0800">module_init(chardev_init);</span> 
<a id="x1-31298r147"></a><span class="ecrm-0500">147</span><span class="ectt-0800">module_exit(chardev_exit);</span> 
<a id="x1-31300r148"></a><span class="ecrm-0500">148</span> 
<a id="x1-31302r149"></a><span class="ecrm-0500">149</span><span class="ectt-0800">MODULE_LICENSE(</span><span id="textcolor548"><span class="ectt-0800">"GPL"</span></span><span class="ectt-0800">);</span></pre>
<!-- l. 923 --><p class="noindent">
</p>
   <h4 class="subsectionHead" id="writing-modules-for-multiple-kernel-versions"><span class="titlemark">0.6.6   </span> <a id="x1-320000.6.6"></a>Writing Modules for Multiple Kernel Versions</h4>
<!-- l. 925 --><p class="noindent">The system calls, which are the major interface the kernel shows to the processes,
generally stay the same across versions. A new system call may be added, but
usually the old ones will behave exactly like they used to. This is necessary for
backward compatibility – a new kernel version is not supposed to break regular
processes. In most cases, the device files will also remain the same. On the other
hand, the internal interfaces within the kernel can and do change between
versions.
</p><!-- l. 930 --><p class="indent">   There are differences between different kernel versions, and if you want
to support multiple kernel versions, you will find yourself having to code
conditional compilation directives. The way to do this to compare the macro
<code> <span class="ectt-1000">LINUX_VERSION_CODE</span>
</code> to the macro <code>  <span class="ectt-1000">KERNEL_VERSION</span>
</code>. In version <span class="obeylines-h"><span class="verb"><span class="ectt-1000">a.b.c</span></span></span> of the kernel, the value of this macro would be <img alt="216a+ 28b+ c  " class="math" src="./The Linux Kernel Module Programming Guide_files/lkmpg-for-ht0x.svg">.
                                                                  

                                                                  
</p><!-- l. 934 --><p class="noindent">
</p>
   <h3 class="sectionHead" id="the-proc-file-system"><span class="titlemark">0.7   </span> <a id="x1-330000.7"></a>The /proc File System</h3>
<!-- l. 936 --><p class="noindent">In Linux, there is an additional mechanism for the kernel and kernel modules to send
information to processes — the <span class="obeylines-h"><span class="verb"><span class="ectt-1000">/proc</span></span></span> file system. Originally designed to allow easy
access to information about processes (hence the name), it is now used by every bit
of the kernel which has something interesting to report, such as <span class="obeylines-h"><span class="verb"><span class="ectt-1000">/proc/modules</span></span></span>
which provides the list of modules and <span class="obeylines-h"><span class="verb"><span class="ectt-1000">/proc/meminfo</span></span></span> which stats memory usage
statistics.
</p><!-- l. 939 --><p class="indent">   The method to use the proc file system is very similar to the one used with device
drivers — a structure is created with all the information needed for the <span class="obeylines-h"><span class="verb"><span class="ectt-1000">/proc</span></span></span> file,
including pointers to any handler functions (in our case there is only one, the
one called when somebody attempts to read from the <span class="obeylines-h"><span class="verb"><span class="ectt-1000">/proc</span></span></span> file). Then,
<code> <span class="ectt-1000">init_module</span>
</code> registers the structure with the kernel and
<code> <span class="ectt-1000">cleanup_module</span>
</code> unregisters it.
</p><!-- l. 942 --><p class="indent">   Normal file systems are located on a disk, rather than just in memory (which is
where <span class="obeylines-h"><span class="verb"><span class="ectt-1000">/proc</span></span></span> is), and in that case the inode number is a pointer to a disk
location where the file’s index-node (inode for short) is located. The inode
contains information about the file, for example the file’s permissions, together
with a pointer to the disk location or locations where the file’s data can be
found.
</p><!-- l. 945 --><p class="indent">   Because we don’t get called when the file is opened or closed, there’s nowhere for
us to put <code>  <span class="ectt-1000">try_module_get</span>
</code> and <code>  <span class="ectt-1000">try_module_put</span>
</code> in this module, and if the file is opened and then the module is removed, there’s no
way to avoid the consequences.
</p><!-- l. 947 --><p class="indent">   Here a simple example showing how to use a <span class="obeylines-h"><span class="verb"><span class="ectt-1000">/proc</span></span></span> file. This is the HelloWorld for
the <span class="obeylines-h"><span class="verb"><span class="ectt-1000">/proc</span></span></span> filesystem. There are three parts: create the file <span class="obeylines-h"><span class="verb"><span class="ectt-1000">/proc/helloworld</span></span></span> in the
function <code>  <span class="ectt-1000">init_module</span>
</code>, return a value (and a buffer) when the file <span class="obeylines-h"><span class="verb"><span class="ectt-1000">/proc/helloworld</span></span></span> is read in the callback
function <code>  <span class="ectt-1000">procfile_read</span>
</code>, and delete the file <span class="obeylines-h"><span class="verb"><span class="ectt-1000">/proc/helloworld</span></span></span> in the function
<code> <span class="ectt-1000">cleanup_module</span>
</code>.
</p><!-- l. 951 --><p class="indent">   The <span class="obeylines-h"><span class="verb"><span class="ectt-1000">/proc/helloworld</span></span></span> is created when the module is loaded with the function
<code> <span class="ectt-1000">proc_create</span>
</code>. The return value is a <code>  <span id="textcolor549"><span class="ectt-1000">struct</span></span><span class="ectt-1000">&nbsp;proc_dir_entry</span>
</code>, and it will be used to configure the file <span class="obeylines-h"><span class="verb"><span class="ectt-1000">/proc/helloworld</span></span></span> (for example, the owner
of this file). A null return value means that the creation has failed.
</p><!-- l. 955 --><p class="indent">   Each time, everytime the file <span class="obeylines-h"><span class="verb"><span class="ectt-1000">/proc/helloworld</span></span></span> is read, the function
<code> <span class="ectt-1000">procfile_read</span>
</code> is called. Two parameters of this function are very important: the buffer
(the second parameter) and the offset (the fourth one). The content of the
buffer will be returned to the application which read it (for example the
                                                                  

                                                                  
<code> <span class="ectt-1000">cat</span>
</code> command). The offset is the current position in the file. If the return value of the
function is not null, then this function is called again. So be careful with this
function, if it never returns zero, the read function is called endlessly.
                                                                  

                                                                  
</p>
   <pre class="verbatim" id="verbatim-10">$&nbsp;cat&nbsp;/proc/helloworld
HelloWorld!
</pre>
<!-- l. 965 --><p class="nopar">
</p><!-- l. 1 --><p class="indent">
</p>
   <pre class="fancyvrb" id="fancyvrb38"><a id="x1-33013r1"></a><span class="ecrm-0500">1</span><span id="textcolor550"><span class="ectt-0800">/*</span></span> 
<a id="x1-33015r2"></a><span class="ecrm-0500">2</span><span id="textcolor551"><span class="ectt-0800">&nbsp;*&nbsp;procfs1.c</span></span> 
<a id="x1-33017r3"></a><span class="ecrm-0500">3</span><span id="textcolor552"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-33019r4"></a><span class="ecrm-0500">4</span> 
<a id="x1-33021r5"></a><span class="ecrm-0500">5</span><span id="textcolor553"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor554"><span class="ectt-0800">&lt;linux/kernel.h&gt;</span></span> 
<a id="x1-33023r6"></a><span class="ecrm-0500">6</span><span id="textcolor555"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor556"><span class="ectt-0800">&lt;linux/module.h&gt;</span></span> 
<a id="x1-33025r7"></a><span class="ecrm-0500">7</span><span id="textcolor557"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor558"><span class="ectt-0800">&lt;linux/proc_fs.h&gt;</span></span> 
<a id="x1-33027r8"></a><span class="ecrm-0500">8</span><span id="textcolor559"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor560"><span class="ectt-0800">&lt;linux/uaccess.h&gt;</span></span> 
<a id="x1-33029r9"></a><span class="ecrm-0500">9</span><span id="textcolor561"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor562"><span class="ectt-0800">&lt;linux/version.h&gt;</span></span> 
<a id="x1-33031r10"></a><span class="ecrm-0500">10</span> 
<a id="x1-33033r11"></a><span class="ecrm-0500">11</span><span id="textcolor563"><span class="ectt-0800">#if&nbsp;LINUX_VERSION_CODE&nbsp;&gt;=&nbsp;KERNEL_VERSION(5,&nbsp;6,&nbsp;0)</span></span> 
<a id="x1-33035r12"></a><span class="ecrm-0500">12</span><span id="textcolor564"><span class="ectt-0800">#define&nbsp;HAVE_PROC_OPS</span></span> 
<a id="x1-33037r13"></a><span class="ecrm-0500">13</span><span id="textcolor565"><span class="ectt-0800">#endif</span></span> 
<a id="x1-33039r14"></a><span class="ecrm-0500">14</span> 
<a id="x1-33041r15"></a><span class="ecrm-0500">15</span><span id="textcolor566"><span class="ectt-0800">#define&nbsp;procfs_name&nbsp;"helloworld"</span></span> 
<a id="x1-33043r16"></a><span class="ecrm-0500">16</span> 
<a id="x1-33045r17"></a><span class="ecrm-0500">17</span><span id="textcolor567"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;proc_dir_entry&nbsp;*Our_Proc_File;</span> 
<a id="x1-33047r18"></a><span class="ecrm-0500">18</span> 
<a id="x1-33049r19"></a><span class="ecrm-0500">19</span> 
<a id="x1-33051r20"></a><span class="ecrm-0500">20</span><span id="textcolor568"><span class="ectt-0800">ssize_t</span></span><span class="ectt-0800">&nbsp;procfile_read(</span><span id="textcolor569"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*filePointer,</span> 
<a id="x1-33053r21"></a><span class="ecrm-0500">21</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor570"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;*buffer,</span> 
<a id="x1-33055r22"></a><span class="ecrm-0500">22</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor571"><span class="ectt-0800">size_t</span></span><span class="ectt-0800">&nbsp;buffer_length,</span> 
<a id="x1-33057r23"></a><span class="ecrm-0500">23</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;loff_t&nbsp;*offset)</span> 
<a id="x1-33059r24"></a><span class="ecrm-0500">24</span><span class="ectt-0800">{</span> 
<a id="x1-33061r25"></a><span class="ecrm-0500">25</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor572"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;s[13]&nbsp;=&nbsp;</span><span id="textcolor573"><span class="ectt-0800">"HelloWorld!</span></span><span id="textcolor574"><span class="ectt-0800">\n</span></span><span id="textcolor575"><span class="ectt-0800">"</span></span><span class="ectt-0800">;</span> 
<a id="x1-33063r26"></a><span class="ecrm-0500">26</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor576"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;len&nbsp;=&nbsp;</span><span id="textcolor577"><span class="ectt-0800">sizeof</span></span><span class="ectt-0800">(s);</span> 
<a id="x1-33065r27"></a><span class="ecrm-0500">27</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor578"><span class="ectt-0800">ssize_t</span></span><span class="ectt-0800">&nbsp;ret&nbsp;=&nbsp;len;</span> 
<a id="x1-33067r28"></a><span class="ecrm-0500">28</span> 
<a id="x1-33069r29"></a><span class="ecrm-0500">29</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor579"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(*offset&nbsp;&gt;=&nbsp;len&nbsp;||&nbsp;copy_to_user(buffer,&nbsp;s,&nbsp;len))&nbsp;{</span> 
<a id="x1-33071r30"></a><span class="ecrm-0500">30</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor580"><span class="ectt-0800">"copy_to_user&nbsp;failed</span></span><span id="textcolor581"><span class="ectt-0800">\n</span></span><span id="textcolor582"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-33073r31"></a><span class="ecrm-0500">31</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret&nbsp;=&nbsp;0;</span> 
<a id="x1-33075r32"></a><span class="ecrm-0500">32</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;</span><span id="textcolor583"><span class="ectt-0800">else</span></span><span class="ectt-0800">&nbsp;{</span> 
<a id="x1-33077r33"></a><span class="ecrm-0500">33</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor584"><span class="ectt-0800">"procfile&nbsp;read&nbsp;%s</span></span><span id="textcolor585"><span class="ectt-0800">\n</span></span><span id="textcolor586"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;filePointer-&gt;f_path.dentry-&gt;d_name.name);</span> 
<a id="x1-33079r34"></a><span class="ecrm-0500">34</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*offset&nbsp;+=&nbsp;len;</span> 
<a id="x1-33081r35"></a><span class="ecrm-0500">35</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-33083r36"></a><span class="ecrm-0500">36</span> 
<a id="x1-33085r37"></a><span class="ecrm-0500">37</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor587"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;ret;</span> 
<a id="x1-33087r38"></a><span class="ecrm-0500">38</span><span class="ectt-0800">}</span> 
<a id="x1-33089r39"></a><span class="ecrm-0500">39</span> 
<a id="x1-33091r40"></a><span class="ecrm-0500">40</span><span id="textcolor588"><span class="ectt-0800">#ifdef&nbsp;HAVE_PROC_OPS</span></span> 
<a id="x1-33093r41"></a><span class="ecrm-0500">41</span><span id="textcolor589"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor590"><span class="ectt-0800">const</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor591"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;proc_ops&nbsp;proc_file_fops&nbsp;=&nbsp;{</span> 
<a id="x1-33095r42"></a><span class="ecrm-0500">42</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.proc_read&nbsp;=&nbsp;procfile_read,</span> 
<a id="x1-33097r43"></a><span class="ecrm-0500">43</span><span class="ectt-0800">};</span> 
<a id="x1-33099r44"></a><span class="ecrm-0500">44</span><span id="textcolor592"><span class="ectt-0800">#else</span></span> 
<a id="x1-33101r45"></a><span class="ecrm-0500">45</span><span id="textcolor593"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor594"><span class="ectt-0800">const</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor595"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file_operations&nbsp;proc_file_fops&nbsp;=&nbsp;{</span> 
<a id="x1-33103r46"></a><span class="ecrm-0500">46</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.read&nbsp;=&nbsp;procfile_read,</span> 
<a id="x1-33105r47"></a><span class="ecrm-0500">47</span><span class="ectt-0800">};</span> 
<a id="x1-33107r48"></a><span class="ecrm-0500">48</span><span id="textcolor596"><span class="ectt-0800">#endif</span></span> 
<a id="x1-33109r49"></a><span class="ecrm-0500">49</span> 
<a id="x1-33111r50"></a><span class="ecrm-0500">50</span><span id="textcolor597"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor598"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;__init&nbsp;procfs1_init(</span><span id="textcolor599"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-33113r51"></a><span class="ecrm-0500">51</span><span class="ectt-0800">{</span> 
<a id="x1-33115r52"></a><span class="ecrm-0500">52</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;Our_Proc_File&nbsp;=&nbsp;proc_create(procfs_name,&nbsp;0644,&nbsp;NULL,&nbsp;&amp;proc_file_fops);</span> 
<a id="x1-33117r53"></a><span class="ecrm-0500">53</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor600"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(NULL&nbsp;==&nbsp;Our_Proc_File)&nbsp;{</span> 
<a id="x1-33119r54"></a><span class="ecrm-0500">54</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;proc_remove(Our_Proc_File);</span> 
<a id="x1-33121r55"></a><span class="ecrm-0500">55</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pr_alert(</span><span id="textcolor601"><span class="ectt-0800">"Error:Could&nbsp;not&nbsp;initialize&nbsp;/proc/%s</span></span><span id="textcolor602"><span class="ectt-0800">\n</span></span><span id="textcolor603"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;procfs_name);</span> 
<a id="x1-33123r56"></a><span class="ecrm-0500">56</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor604"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;-ENOMEM;</span> 
<a id="x1-33125r57"></a><span class="ecrm-0500">57</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-33127r58"></a><span class="ecrm-0500">58</span> 
<a id="x1-33129r59"></a><span class="ecrm-0500">59</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor605"><span class="ectt-0800">"/proc/%s&nbsp;created</span></span><span id="textcolor606"><span class="ectt-0800">\n</span></span><span id="textcolor607"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;procfs_name);</span> 
<a id="x1-33131r60"></a><span class="ecrm-0500">60</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor608"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;0;</span> 
<a id="x1-33133r61"></a><span class="ecrm-0500">61</span><span class="ectt-0800">}</span> 
<a id="x1-33135r62"></a><span class="ecrm-0500">62</span> 
<a id="x1-33137r63"></a><span class="ecrm-0500">63</span><span id="textcolor609"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor610"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;__exit&nbsp;procfs1_exit(</span><span id="textcolor611"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-33139r64"></a><span class="ecrm-0500">64</span><span class="ectt-0800">{</span> 
<a id="x1-33141r65"></a><span class="ecrm-0500">65</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;proc_remove(Our_Proc_File);</span> 
<a id="x1-33143r66"></a><span class="ecrm-0500">66</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor612"><span class="ectt-0800">"/proc/%s&nbsp;removed</span></span><span id="textcolor613"><span class="ectt-0800">\n</span></span><span id="textcolor614"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;procfs_name);</span> 
<a id="x1-33145r67"></a><span class="ecrm-0500">67</span><span class="ectt-0800">}</span> 
<a id="x1-33147r68"></a><span class="ecrm-0500">68</span> 
<a id="x1-33149r69"></a><span class="ecrm-0500">69</span><span class="ectt-0800">module_init(procfs1_init);</span> 
<a id="x1-33151r70"></a><span class="ecrm-0500">70</span><span class="ectt-0800">module_exit(procfs1_exit);</span> 
<a id="x1-33153r71"></a><span class="ecrm-0500">71</span> 
<a id="x1-33155r72"></a><span class="ecrm-0500">72</span><span class="ectt-0800">MODULE_LICENSE(</span><span id="textcolor615"><span class="ectt-0800">"GPL"</span></span><span class="ectt-0800">);</span></pre>
<!-- l. 969 --><p class="noindent">
</p>
   <h4 class="subsectionHead" id="the-procops-structure"><span class="titlemark">0.7.1   </span> <a id="x1-340000.7.1"></a>The proc_ops Structure</h4>
<!-- l. 971 --><p class="noindent">The <code>  <span class="ectt-1000">proc_ops</span>
</code> structure is defined in <a href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/proc_fs.h">include/linux/proc_fs.h</a> in Linux v5.6+. In older kernels, it
used <code>  <span class="ectt-1000">file_operations</span>
</code> for custom hooks in <span class="obeylines-h"><span class="verb"><span class="ectt-1000">/proc</span></span></span> file system, but it contains some
members that are unnecessary in VFS, and every time VFS expands
<code> <span class="ectt-1000">file_operations</span>
</code> set, <span class="obeylines-h"><span class="verb"><span class="ectt-1000">/proc</span></span></span> code comes bloated. On the other hand, not only the space,
but also some operations were saved by this structure to improve its
performance. For example, the file which never disappears in <span class="obeylines-h"><span class="verb"><span class="ectt-1000">/proc</span></span></span> can set the
<code> <span class="ectt-1000">proc_flag</span>
</code> as <code>  <span class="ectt-1000">PROC_ENTRY_PERMANENT</span>
</code> to save 2 atomic ops, 1 allocation, 1 free in per open/read/close sequence.
</p><!-- l. 976 --><p class="noindent">
</p>
   <h4 class="subsectionHead" id="read-and-write-a-proc-file"><span class="titlemark">0.7.2   </span> <a id="x1-350000.7.2"></a>Read and Write a /proc File</h4>
<!-- l. 978 --><p class="noindent">We have seen a very simple example for a /proc file where we only read
the file /proc/helloworld. It is also possible to write in a /proc file. It
works the same way as read, a function is called when the /proc file
is written. But there is a little difference with read, data comes from
user, so you have to import data from user space to kernel space (with
<code> <span class="ectt-1000">copy_from_user</span>
</code> or <code>  <span class="ectt-1000">get_user</span>
</code>)
</p><!-- l. 983 --><p class="indent">   The reason for <code>  <span class="ectt-1000">copy_from_user</span>
</code> or <code>  <span class="ectt-1000">get_user</span>
</code> is that Linux memory (on Intel architecture, it may be different under some
                                                                  

                                                                  
other processors) is segmented. This means that a pointer, by itself, does
not reference a unique location in memory, only a location in a memory
segment, and you need to know which memory segment it is to be able to use
it. There is one memory segment for the kernel, and one for each of the
processes.
</p><!-- l. 987 --><p class="indent">   The only memory segment accessible to a process is its own, so when
writing regular programs to run as processes, there is no need to worry about
segments. When you write a kernel module, normally you want to access
the kernel memory segment, which is handled automatically by the system.
However, when the content of a memory buffer needs to be passed between
the currently running process and the kernel, the kernel function receives
a pointer to the memory buffer which is in the process segment. The
<code> <span class="ectt-1000">put_user</span>
</code> and <code>  <span class="ectt-1000">get_user</span>
</code> macros allow you to access that memory. These functions handle
only one character, you can handle several characters with
<code> <span class="ectt-1000">copy_to_user</span>
</code> and <code>  <span class="ectt-1000">copy_from_user</span>
</code>. As the buffer (in read or write function) is in kernel space, for write function you
need to import data because it comes from user space, but not for the read function
because data is already in kernel space.
</p><!-- l. 1 --><p class="indent">
</p>
   <pre class="fancyvrb" id="fancyvrb39"><a id="x1-35010r1"></a><span class="ecrm-0500">1</span><span id="textcolor616"><span class="ectt-0800">/*</span></span> 
<a id="x1-35012r2"></a><span class="ecrm-0500">2</span><span id="textcolor617"><span class="ectt-0800">&nbsp;*&nbsp;procfs2.c&nbsp;-&nbsp;&nbsp;create&nbsp;a&nbsp;"file"&nbsp;in&nbsp;/proc</span></span> 
<a id="x1-35014r3"></a><span class="ecrm-0500">3</span><span id="textcolor618"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-35016r4"></a><span class="ecrm-0500">4</span> 
<a id="x1-35018r5"></a><span class="ecrm-0500">5</span><span id="textcolor619"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor620"><span class="ectt-0800">&lt;linux/kernel.h&gt;&nbsp;&nbsp;/*&nbsp;We</span><span class="tctt-0800">'</span><span class="ectt-0800">re&nbsp;doing&nbsp;kernel&nbsp;work&nbsp;*/</span></span> 
<a id="x1-35020r6"></a><span class="ecrm-0500">6</span><span id="textcolor621"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor622"><span class="ectt-0800">&lt;linux/module.h&gt;&nbsp;&nbsp;/*&nbsp;Specifically,&nbsp;a&nbsp;module&nbsp;*/</span></span> 
<a id="x1-35022r7"></a><span class="ecrm-0500">7</span><span id="textcolor623"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor624"><span class="ectt-0800">&lt;linux/proc_fs.h&gt;&nbsp;/*&nbsp;Necessary&nbsp;because&nbsp;we&nbsp;use&nbsp;the&nbsp;proc&nbsp;fs&nbsp;*/</span></span> 
<a id="x1-35024r8"></a><span class="ecrm-0500">8</span><span id="textcolor625"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor626"><span class="ectt-0800">&lt;linux/uaccess.h&gt;&nbsp;/*&nbsp;for&nbsp;copy_from_user&nbsp;*/</span></span> 
<a id="x1-35026r9"></a><span class="ecrm-0500">9</span><span id="textcolor627"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor628"><span class="ectt-0800">&lt;linux/version.h&gt;</span></span> 
<a id="x1-35028r10"></a><span class="ecrm-0500">10</span> 
<a id="x1-35030r11"></a><span class="ecrm-0500">11</span><span id="textcolor629"><span class="ectt-0800">#if&nbsp;LINUX_VERSION_CODE&nbsp;&gt;=&nbsp;KERNEL_VERSION(5,&nbsp;6,&nbsp;0)</span></span> 
<a id="x1-35032r12"></a><span class="ecrm-0500">12</span><span id="textcolor630"><span class="ectt-0800">#define&nbsp;HAVE_PROC_OPS</span></span> 
<a id="x1-35034r13"></a><span class="ecrm-0500">13</span><span id="textcolor631"><span class="ectt-0800">#endif</span></span> 
<a id="x1-35036r14"></a><span class="ecrm-0500">14</span> 
<a id="x1-35038r15"></a><span class="ecrm-0500">15</span><span id="textcolor632"><span class="ectt-0800">#define&nbsp;PROCFS_MAX_SIZE&nbsp;1024</span></span> 
<a id="x1-35040r16"></a><span class="ecrm-0500">16</span><span id="textcolor633"><span class="ectt-0800">#define&nbsp;PROCFS_NAME&nbsp;"buffer1k"</span></span> 
<a id="x1-35042r17"></a><span class="ecrm-0500">17</span> 
<a id="x1-35044r18"></a><span class="ecrm-0500">18</span><span id="textcolor634"><span class="ectt-0800">/*&nbsp;This&nbsp;structure&nbsp;hold&nbsp;information&nbsp;about&nbsp;the&nbsp;/proc&nbsp;file&nbsp;*/</span></span> 
<a id="x1-35046r19"></a><span class="ecrm-0500">19</span><span id="textcolor635"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor636"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;proc_dir_entry&nbsp;*Our_Proc_File;</span> 
<a id="x1-35048r20"></a><span class="ecrm-0500">20</span> 
<a id="x1-35050r21"></a><span class="ecrm-0500">21</span><span id="textcolor637"><span class="ectt-0800">/*&nbsp;The&nbsp;buffer&nbsp;used&nbsp;to&nbsp;store&nbsp;character&nbsp;for&nbsp;this&nbsp;module&nbsp;*/</span></span> 
<a id="x1-35052r22"></a><span class="ecrm-0500">22</span><span id="textcolor638"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor639"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;procfs_buffer[PROCFS_MAX_SIZE];</span> 
<a id="x1-35054r23"></a><span class="ecrm-0500">23</span> 
<a id="x1-35056r24"></a><span class="ecrm-0500">24</span><span id="textcolor640"><span class="ectt-0800">/*&nbsp;The&nbsp;size&nbsp;of&nbsp;the&nbsp;buffer&nbsp;*/</span></span> 
<a id="x1-35058r25"></a><span class="ecrm-0500">25</span><span id="textcolor641"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor642"><span class="ectt-0800">unsigned</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor643"><span class="ectt-0800">long</span></span><span class="ectt-0800">&nbsp;procfs_buffer_size&nbsp;=&nbsp;0;</span> 
<a id="x1-35060r26"></a><span class="ecrm-0500">26</span> 
<a id="x1-35062r27"></a><span class="ecrm-0500">27</span><span id="textcolor644"><span class="ectt-0800">/*&nbsp;This&nbsp;function&nbsp;is&nbsp;called&nbsp;then&nbsp;the&nbsp;/proc&nbsp;file&nbsp;is&nbsp;read&nbsp;*/</span></span> 
<a id="x1-35064r28"></a><span class="ecrm-0500">28</span><span id="textcolor645"><span class="ectt-0800">ssize_t</span></span><span class="ectt-0800">&nbsp;procfile_read(</span><span id="textcolor646"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*filePointer,</span> 
<a id="x1-35066r29"></a><span class="ecrm-0500">29</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor647"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;*buffer,</span> 
<a id="x1-35068r30"></a><span class="ecrm-0500">30</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor648"><span class="ectt-0800">size_t</span></span><span class="ectt-0800">&nbsp;buffer_length,</span> 
<a id="x1-35070r31"></a><span class="ecrm-0500">31</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;loff_t&nbsp;*offset)</span> 
<a id="x1-35072r32"></a><span class="ecrm-0500">32</span><span class="ectt-0800">{</span> 
<a id="x1-35074r33"></a><span class="ecrm-0500">33</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor649"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;s[13]&nbsp;=&nbsp;</span><span id="textcolor650"><span class="ectt-0800">"HelloWorld!</span></span><span id="textcolor651"><span class="ectt-0800">\n</span></span><span id="textcolor652"><span class="ectt-0800">"</span></span><span class="ectt-0800">;</span> 
<a id="x1-35076r34"></a><span class="ecrm-0500">34</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor653"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;len&nbsp;=&nbsp;</span><span id="textcolor654"><span class="ectt-0800">sizeof</span></span><span class="ectt-0800">(s);</span> 
<a id="x1-35078r35"></a><span class="ecrm-0500">35</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor655"><span class="ectt-0800">ssize_t</span></span><span class="ectt-0800">&nbsp;ret&nbsp;=&nbsp;len;</span> 
<a id="x1-35080r36"></a><span class="ecrm-0500">36</span> 
<a id="x1-35082r37"></a><span class="ecrm-0500">37</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor656"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(*offset&nbsp;&gt;=&nbsp;len&nbsp;||&nbsp;copy_to_user(buffer,&nbsp;s,&nbsp;len))&nbsp;{</span> 
<a id="x1-35084r38"></a><span class="ecrm-0500">38</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor657"><span class="ectt-0800">"copy_to_user&nbsp;failed</span></span><span id="textcolor658"><span class="ectt-0800">\n</span></span><span id="textcolor659"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-35086r39"></a><span class="ecrm-0500">39</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret&nbsp;=&nbsp;0;</span> 
<a id="x1-35088r40"></a><span class="ecrm-0500">40</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;</span><span id="textcolor660"><span class="ectt-0800">else</span></span><span class="ectt-0800">&nbsp;{</span> 
<a id="x1-35090r41"></a><span class="ecrm-0500">41</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor661"><span class="ectt-0800">"procfile&nbsp;read&nbsp;%s</span></span><span id="textcolor662"><span class="ectt-0800">\n</span></span><span id="textcolor663"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;filePointer-&gt;f_path.dentry-&gt;d_name.name);</span> 
<a id="x1-35092r42"></a><span class="ecrm-0500">42</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*offset&nbsp;+=&nbsp;len;</span> 
<a id="x1-35094r43"></a><span class="ecrm-0500">43</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-35096r44"></a><span class="ecrm-0500">44</span> 
<a id="x1-35098r45"></a><span class="ecrm-0500">45</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor664"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;ret;</span> 
<a id="x1-35100r46"></a><span class="ecrm-0500">46</span><span class="ectt-0800">}</span> 
<a id="x1-35102r47"></a><span class="ecrm-0500">47</span> 
<a id="x1-35104r48"></a><span class="ecrm-0500">48</span><span id="textcolor665"><span class="ectt-0800">/*&nbsp;This&nbsp;function&nbsp;is&nbsp;called&nbsp;with&nbsp;the&nbsp;/proc&nbsp;file&nbsp;is&nbsp;written.&nbsp;*/</span></span> 
<a id="x1-35106r49"></a><span class="ecrm-0500">49</span><span id="textcolor666"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor667"><span class="ectt-0800">ssize_t</span></span><span class="ectt-0800">&nbsp;procfile_write(</span><span id="textcolor668"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*file,</span> 
<a id="x1-35108r50"></a><span class="ecrm-0500">50</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor669"><span class="ectt-0800">const</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor670"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;*buff,</span> 
<a id="x1-35110r51"></a><span class="ecrm-0500">51</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor671"><span class="ectt-0800">size_t</span></span><span class="ectt-0800">&nbsp;len,</span> 
<a id="x1-35112r52"></a><span class="ecrm-0500">52</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;loff_t&nbsp;*off)</span> 
<a id="x1-35114r53"></a><span class="ecrm-0500">53</span><span class="ectt-0800">{</span> 
<a id="x1-35116r54"></a><span class="ecrm-0500">54</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;procfs_buffer_size&nbsp;=&nbsp;len;</span> 
<a id="x1-35118r55"></a><span class="ecrm-0500">55</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor672"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(procfs_buffer_size&nbsp;&gt;&nbsp;PROCFS_MAX_SIZE)</span> 
<a id="x1-35120r56"></a><span class="ecrm-0500">56</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;procfs_buffer_size&nbsp;=&nbsp;PROCFS_MAX_SIZE;</span> 
<a id="x1-35122r57"></a><span class="ecrm-0500">57</span> 
<a id="x1-35124r58"></a><span class="ecrm-0500">58</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor673"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(copy_from_user(procfs_buffer,&nbsp;buff,&nbsp;procfs_buffer_size))</span> 
<a id="x1-35126r59"></a><span class="ecrm-0500">59</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor674"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;-EFAULT;</span> 
<a id="x1-35128r60"></a><span class="ecrm-0500">60</span> 
<a id="x1-35130r61"></a><span class="ecrm-0500">61</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;procfs_buffer[procfs_buffer_size]&nbsp;=&nbsp;</span><span id="textcolor675"><span class="tctt-0800">'</span><span class="ectt-0800">\0</span><span class="tctt-0800">'</span></span><span class="ectt-0800">;</span> 
<a id="x1-35132r62"></a><span class="ecrm-0500">62</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor676"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;procfs_buffer_size;</span> 
<a id="x1-35134r63"></a><span class="ecrm-0500">63</span><span class="ectt-0800">}</span> 
<a id="x1-35136r64"></a><span class="ecrm-0500">64</span> 
<a id="x1-35138r65"></a><span class="ecrm-0500">65</span><span id="textcolor677"><span class="ectt-0800">#ifdef&nbsp;HAVE_PROC_OPS</span></span> 
<a id="x1-35140r66"></a><span class="ecrm-0500">66</span><span id="textcolor678"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor679"><span class="ectt-0800">const</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor680"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;proc_ops&nbsp;proc_file_fops&nbsp;=&nbsp;{</span> 
<a id="x1-35142r67"></a><span class="ecrm-0500">67</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.proc_read&nbsp;=&nbsp;procfile_read,</span> 
<a id="x1-35144r68"></a><span class="ecrm-0500">68</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.proc_write&nbsp;=&nbsp;procfile_write,</span> 
<a id="x1-35146r69"></a><span class="ecrm-0500">69</span><span class="ectt-0800">};</span> 
<a id="x1-35148r70"></a><span class="ecrm-0500">70</span><span id="textcolor681"><span class="ectt-0800">#else</span></span> 
<a id="x1-35150r71"></a><span class="ecrm-0500">71</span><span id="textcolor682"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor683"><span class="ectt-0800">const</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor684"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file_operations&nbsp;proc_file_fops&nbsp;=&nbsp;{</span> 
<a id="x1-35152r72"></a><span class="ecrm-0500">72</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.read&nbsp;=&nbsp;procfile_read,</span> 
<a id="x1-35154r73"></a><span class="ecrm-0500">73</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.write&nbsp;=&nbsp;procfile_write,</span> 
<a id="x1-35156r74"></a><span class="ecrm-0500">74</span><span class="ectt-0800">};</span> 
<a id="x1-35158r75"></a><span class="ecrm-0500">75</span><span id="textcolor685"><span class="ectt-0800">#endif</span></span> 
<a id="x1-35160r76"></a><span class="ecrm-0500">76</span> 
<a id="x1-35162r77"></a><span class="ecrm-0500">77</span><span id="textcolor686"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor687"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;__init&nbsp;procfs2_init(</span><span id="textcolor688"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-35164r78"></a><span class="ecrm-0500">78</span><span class="ectt-0800">{</span> 
<a id="x1-35166r79"></a><span class="ecrm-0500">79</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;Our_Proc_File&nbsp;=&nbsp;proc_create(PROCFS_NAME,&nbsp;0644,&nbsp;NULL,&nbsp;&amp;proc_file_fops);</span> 
<a id="x1-35168r80"></a><span class="ecrm-0500">80</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor689"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(NULL&nbsp;==&nbsp;Our_Proc_File)&nbsp;{</span> 
<a id="x1-35170r81"></a><span class="ecrm-0500">81</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;proc_remove(Our_Proc_File);</span> 
<a id="x1-35172r82"></a><span class="ecrm-0500">82</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pr_alert(</span><span id="textcolor690"><span class="ectt-0800">"Error:Could&nbsp;not&nbsp;initialize&nbsp;/proc/%s</span></span><span id="textcolor691"><span class="ectt-0800">\n</span></span><span id="textcolor692"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;PROCFS_NAME);</span> 
<a id="x1-35174r83"></a><span class="ecrm-0500">83</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor693"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;-ENOMEM;</span> 
<a id="x1-35176r84"></a><span class="ecrm-0500">84</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-35178r85"></a><span class="ecrm-0500">85</span> 
<a id="x1-35180r86"></a><span class="ecrm-0500">86</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor694"><span class="ectt-0800">"/proc/%s&nbsp;created</span></span><span id="textcolor695"><span class="ectt-0800">\n</span></span><span id="textcolor696"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;PROCFS_NAME);</span> 
<a id="x1-35182r87"></a><span class="ecrm-0500">87</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor697"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;0;</span> 
<a id="x1-35184r88"></a><span class="ecrm-0500">88</span><span class="ectt-0800">}</span> 
<a id="x1-35186r89"></a><span class="ecrm-0500">89</span> 
<a id="x1-35188r90"></a><span class="ecrm-0500">90</span><span id="textcolor698"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor699"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;__exit&nbsp;procfs2_exit(</span><span id="textcolor700"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-35190r91"></a><span class="ecrm-0500">91</span><span class="ectt-0800">{</span> 
<a id="x1-35192r92"></a><span class="ecrm-0500">92</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;proc_remove(Our_Proc_File);</span> 
<a id="x1-35194r93"></a><span class="ecrm-0500">93</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor701"><span class="ectt-0800">"/proc/%s&nbsp;removed</span></span><span id="textcolor702"><span class="ectt-0800">\n</span></span><span id="textcolor703"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;PROCFS_NAME);</span> 
<a id="x1-35196r94"></a><span class="ecrm-0500">94</span><span class="ectt-0800">}</span> 
<a id="x1-35198r95"></a><span class="ecrm-0500">95</span> 
<a id="x1-35200r96"></a><span class="ecrm-0500">96</span><span class="ectt-0800">module_init(procfs2_init);</span> 
<a id="x1-35202r97"></a><span class="ecrm-0500">97</span><span class="ectt-0800">module_exit(procfs2_exit);</span> 
<a id="x1-35204r98"></a><span class="ecrm-0500">98</span> 
<a id="x1-35206r99"></a><span class="ecrm-0500">99</span><span class="ectt-0800">MODULE_LICENSE(</span><span id="textcolor704"><span class="ectt-0800">"GPL"</span></span><span class="ectt-0800">);</span></pre>
<!-- l. 996 --><p class="noindent">
</p>
   <h4 class="subsectionHead" id="manage-proc-file-with-standard-filesystem"><span class="titlemark">0.7.3   </span> <a id="x1-360000.7.3"></a>Manage /proc file with standard filesystem</h4>
<!-- l. 998 --><p class="noindent">We have seen how to read and write a /proc file with the /proc interface. But it is
also possible to manage /proc file with inodes. The main concern is to use advanced
functions, like permissions.
</p><!-- l. 1002 --><p class="indent">   In Linux, there is a standard mechanism for file system registration.
Since every file system has to have its own functions to handle inode and file
operations, there is a special structure to hold pointers to all those functions,
<code> <span id="textcolor705"><span class="ectt-1000">struct</span></span><span class="ectt-1000">&nbsp;inode_operations</span>
</code>, which includes a pointer to <code>  <span id="textcolor706"><span class="ectt-1000">struct</span></span><span class="ectt-1000">&nbsp;proc_ops</span>
</code>.
</p><!-- l. 1005 --><p class="indent">   The difference between file and inode operations is that file operations deal with
the file itself whereas inode operations deal with ways of referencing the file, such as
creating links to it.
</p><!-- l. 1007 --><p class="indent">   In /proc, whenever we register a new file, we’re allowed to specify which
<code> <span id="textcolor707"><span class="ectt-1000">struct</span></span><span class="ectt-1000">&nbsp;inode_operations</span>
</code> will be used to access to it. This is the mechanism we use, a
<code> <span id="textcolor708"><span class="ectt-1000">struct</span></span><span class="ectt-1000">&nbsp;inode_operations</span>
                                                                  

                                                                  
</code> which includes a pointer to a <code>  <span id="textcolor709"><span class="ectt-1000">struct</span></span><span class="ectt-1000">&nbsp;proc_ops</span>
</code> which includes pointers to our <code>  <span class="ectt-1000">procf_read</span>
</code> and <code>  <span class="ectt-1000">procfs_write</span>
</code> functions.
</p><!-- l. 1010 --><p class="indent">   Another interesting point here is the
<code> <span class="ectt-1000">module_permission</span>
</code> function. This function is called whenever a process tries to do something with the
/proc file, and it can decide whether to allow access or not. Right now it is only
based on the operation and the uid of the current user (as available in current, a
pointer to a structure which includes information on the currently running
process), but it could be based on anything we like, such as what other
processes are doing with the same file, the time of day, or the last input we
received.
</p><!-- l. 1014 --><p class="indent">   It is important to note that the standard roles of read and write are reversed in
the kernel. Read functions are used for output, whereas write functions are used for
input. The reason for that is that read and write refer to the user’s point of view — if
a process reads something from the kernel, then the kernel needs to output it, and
if a process writes something to the kernel, then the kernel receives it as
input.
</p><!-- l. 1 --><p class="indent">
</p>
   <pre class="fancyvrb" id="fancyvrb40"><a id="x1-36010r1"></a><span class="ecrm-0500">1</span><span id="textcolor710"><span class="ectt-0800">/*</span></span> 
<a id="x1-36012r2"></a><span class="ecrm-0500">2</span><span id="textcolor711"><span class="ectt-0800">&nbsp;*&nbsp;procfs3.c</span></span> 
<a id="x1-36014r3"></a><span class="ecrm-0500">3</span><span id="textcolor712"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-36016r4"></a><span class="ecrm-0500">4</span> 
<a id="x1-36018r5"></a><span class="ecrm-0500">5</span><span id="textcolor713"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor714"><span class="ectt-0800">&lt;linux/kernel.h&gt;</span></span> 
<a id="x1-36020r6"></a><span class="ecrm-0500">6</span><span id="textcolor715"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor716"><span class="ectt-0800">&lt;linux/module.h&gt;</span></span> 
<a id="x1-36022r7"></a><span class="ecrm-0500">7</span><span id="textcolor717"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor718"><span class="ectt-0800">&lt;linux/proc_fs.h&gt;</span></span> 
<a id="x1-36024r8"></a><span class="ecrm-0500">8</span><span id="textcolor719"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor720"><span class="ectt-0800">&lt;linux/sched.h&gt;</span></span> 
<a id="x1-36026r9"></a><span class="ecrm-0500">9</span><span id="textcolor721"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor722"><span class="ectt-0800">&lt;linux/uaccess.h&gt;</span></span> 
<a id="x1-36028r10"></a><span class="ecrm-0500">10</span><span id="textcolor723"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor724"><span class="ectt-0800">&lt;linux/version.h&gt;</span></span> 
<a id="x1-36030r11"></a><span class="ecrm-0500">11</span> 
<a id="x1-36032r12"></a><span class="ecrm-0500">12</span><span id="textcolor725"><span class="ectt-0800">#if&nbsp;LINUX_VERSION_CODE&nbsp;&gt;=&nbsp;KERNEL_VERSION(5,&nbsp;6,&nbsp;0)</span></span> 
<a id="x1-36034r13"></a><span class="ecrm-0500">13</span><span id="textcolor726"><span class="ectt-0800">#define&nbsp;HAVE_PROC_OPS</span></span> 
<a id="x1-36036r14"></a><span class="ecrm-0500">14</span><span id="textcolor727"><span class="ectt-0800">#endif</span></span> 
<a id="x1-36038r15"></a><span class="ecrm-0500">15</span> 
<a id="x1-36040r16"></a><span class="ecrm-0500">16</span><span id="textcolor728"><span class="ectt-0800">#define&nbsp;PROCFS_MAX_SIZE&nbsp;2048</span></span> 
<a id="x1-36042r17"></a><span class="ecrm-0500">17</span><span id="textcolor729"><span class="ectt-0800">#define&nbsp;PROCFS_ENTRY_FILENAME&nbsp;"buffer2k"</span></span> 
<a id="x1-36044r18"></a><span class="ecrm-0500">18</span> 
<a id="x1-36046r19"></a><span class="ecrm-0500">19</span><span id="textcolor730"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;proc_dir_entry&nbsp;*Our_Proc_File;</span> 
<a id="x1-36048r20"></a><span class="ecrm-0500">20</span><span id="textcolor731"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor732"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;procfs_buffer[PROCFS_MAX_SIZE];</span> 
<a id="x1-36050r21"></a><span class="ecrm-0500">21</span><span id="textcolor733"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor734"><span class="ectt-0800">unsigned</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor735"><span class="ectt-0800">long</span></span><span class="ectt-0800">&nbsp;procfs_buffer_size&nbsp;=&nbsp;0;</span> 
<a id="x1-36052r22"></a><span class="ecrm-0500">22</span> 
<a id="x1-36054r23"></a><span class="ecrm-0500">23</span><span id="textcolor736"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor737"><span class="ectt-0800">ssize_t</span></span><span class="ectt-0800">&nbsp;procfs_read(</span><span id="textcolor738"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*filp,</span> 
<a id="x1-36056r24"></a><span class="ecrm-0500">24</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor739"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;*buffer,</span> 
<a id="x1-36058r25"></a><span class="ecrm-0500">25</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor740"><span class="ectt-0800">size_t</span></span><span class="ectt-0800">&nbsp;length,</span> 
<a id="x1-36060r26"></a><span class="ecrm-0500">26</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;loff_t&nbsp;*offset)</span> 
<a id="x1-36062r27"></a><span class="ecrm-0500">27</span><span class="ectt-0800">{</span> 
<a id="x1-36064r28"></a><span class="ecrm-0500">28</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor741"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor742"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;finished&nbsp;=&nbsp;0;</span> 
<a id="x1-36066r29"></a><span class="ecrm-0500">29</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor743"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(finished)&nbsp;{</span> 
<a id="x1-36068r30"></a><span class="ecrm-0500">30</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pr_debug(</span><span id="textcolor744"><span class="ectt-0800">"procfs_read:&nbsp;END</span></span><span id="textcolor745"><span class="ectt-0800">\n</span></span><span id="textcolor746"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-36070r31"></a><span class="ecrm-0500">31</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;finished&nbsp;=&nbsp;0;</span> 
<a id="x1-36072r32"></a><span class="ecrm-0500">32</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor747"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;0;</span> 
<a id="x1-36074r33"></a><span class="ecrm-0500">33</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-36076r34"></a><span class="ecrm-0500">34</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;finished&nbsp;=&nbsp;1;</span> 
<a id="x1-36078r35"></a><span class="ecrm-0500">35</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor748"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(copy_to_user(buffer,&nbsp;procfs_buffer,&nbsp;procfs_buffer_size))</span> 
<a id="x1-36080r36"></a><span class="ecrm-0500">36</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor749"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;-EFAULT;</span> 
<a id="x1-36082r37"></a><span class="ecrm-0500">37</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_debug(</span><span id="textcolor750"><span class="ectt-0800">"procfs_read:&nbsp;read&nbsp;%lu&nbsp;bytes</span></span><span id="textcolor751"><span class="ectt-0800">\n</span></span><span id="textcolor752"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;procfs_buffer_size);</span> 
<a id="x1-36084r38"></a><span class="ecrm-0500">38</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor753"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;procfs_buffer_size;</span> 
<a id="x1-36086r39"></a><span class="ecrm-0500">39</span><span class="ectt-0800">}</span> 
<a id="x1-36088r40"></a><span class="ecrm-0500">40</span><span id="textcolor754"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor755"><span class="ectt-0800">ssize_t</span></span><span class="ectt-0800">&nbsp;procfs_write(</span><span id="textcolor756"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*file,</span> 
<a id="x1-36090r41"></a><span class="ecrm-0500">41</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor757"><span class="ectt-0800">const</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor758"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;*buffer,</span> 
<a id="x1-36092r42"></a><span class="ecrm-0500">42</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor759"><span class="ectt-0800">size_t</span></span><span class="ectt-0800">&nbsp;len,</span> 
<a id="x1-36094r43"></a><span class="ecrm-0500">43</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;loff_t&nbsp;*off)</span> 
<a id="x1-36096r44"></a><span class="ecrm-0500">44</span><span class="ectt-0800">{</span> 
<a id="x1-36098r45"></a><span class="ecrm-0500">45</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor760"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(len&nbsp;&gt;&nbsp;PROCFS_MAX_SIZE)</span> 
<a id="x1-36100r46"></a><span class="ecrm-0500">46</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;procfs_buffer_size&nbsp;=&nbsp;PROCFS_MAX_SIZE;</span> 
<a id="x1-36102r47"></a><span class="ecrm-0500">47</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor761"><span class="ectt-0800">else</span></span> 
<a id="x1-36104r48"></a><span class="ecrm-0500">48</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;procfs_buffer_size&nbsp;=&nbsp;len;</span> 
<a id="x1-36106r49"></a><span class="ecrm-0500">49</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor762"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(copy_from_user(procfs_buffer,&nbsp;buffer,&nbsp;procfs_buffer_size))</span> 
<a id="x1-36108r50"></a><span class="ecrm-0500">50</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor763"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;-EFAULT;</span> 
<a id="x1-36110r51"></a><span class="ecrm-0500">51</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_debug(</span><span id="textcolor764"><span class="ectt-0800">"procfs_write:&nbsp;write&nbsp;%lu&nbsp;bytes</span></span><span id="textcolor765"><span class="ectt-0800">\n</span></span><span id="textcolor766"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;procfs_buffer_size);</span> 
<a id="x1-36112r52"></a><span class="ecrm-0500">52</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor767"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;procfs_buffer_size;</span> 
<a id="x1-36114r53"></a><span class="ecrm-0500">53</span><span class="ectt-0800">}</span> 
<a id="x1-36116r54"></a><span class="ecrm-0500">54</span><span id="textcolor768"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;procfs_open(</span><span id="textcolor769"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;inode&nbsp;*inode,&nbsp;</span><span id="textcolor770"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*file)</span> 
<a id="x1-36118r55"></a><span class="ecrm-0500">55</span><span class="ectt-0800">{</span> 
<a id="x1-36120r56"></a><span class="ecrm-0500">56</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;try_module_get(THIS_MODULE);</span> 
<a id="x1-36122r57"></a><span class="ecrm-0500">57</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor771"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;0;</span> 
<a id="x1-36124r58"></a><span class="ecrm-0500">58</span><span class="ectt-0800">}</span> 
<a id="x1-36126r59"></a><span class="ecrm-0500">59</span><span id="textcolor772"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;procfs_close(</span><span id="textcolor773"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;inode&nbsp;*inode,&nbsp;</span><span id="textcolor774"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*file)</span> 
<a id="x1-36128r60"></a><span class="ecrm-0500">60</span><span class="ectt-0800">{</span> 
<a id="x1-36130r61"></a><span class="ecrm-0500">61</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;module_put(THIS_MODULE);</span> 
<a id="x1-36132r62"></a><span class="ecrm-0500">62</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor775"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;0;</span> 
<a id="x1-36134r63"></a><span class="ecrm-0500">63</span><span class="ectt-0800">}</span> 
<a id="x1-36136r64"></a><span class="ecrm-0500">64</span> 
<a id="x1-36138r65"></a><span class="ecrm-0500">65</span><span id="textcolor776"><span class="ectt-0800">#ifdef&nbsp;HAVE_PROC_OPS</span></span> 
<a id="x1-36140r66"></a><span class="ecrm-0500">66</span><span id="textcolor777"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor778"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;proc_ops&nbsp;File_Ops_4_Our_Proc_File&nbsp;=&nbsp;{</span> 
<a id="x1-36142r67"></a><span class="ecrm-0500">67</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.proc_read&nbsp;=&nbsp;procfs_read,</span> 
<a id="x1-36144r68"></a><span class="ecrm-0500">68</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.proc_write&nbsp;=&nbsp;procfs_write,</span> 
<a id="x1-36146r69"></a><span class="ecrm-0500">69</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.proc_open&nbsp;=&nbsp;procfs_open,</span> 
<a id="x1-36148r70"></a><span class="ecrm-0500">70</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.proc_release&nbsp;=&nbsp;procfs_close,</span> 
<a id="x1-36150r71"></a><span class="ecrm-0500">71</span><span class="ectt-0800">};</span> 
<a id="x1-36152r72"></a><span class="ecrm-0500">72</span><span id="textcolor779"><span class="ectt-0800">#else</span></span> 
<a id="x1-36154r73"></a><span class="ecrm-0500">73</span><span id="textcolor780"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor781"><span class="ectt-0800">const</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor782"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file_operations&nbsp;File_Ops_4_Our_Proc_File&nbsp;=&nbsp;{</span> 
<a id="x1-36156r74"></a><span class="ecrm-0500">74</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.read&nbsp;=&nbsp;procfs_read,</span> 
<a id="x1-36158r75"></a><span class="ecrm-0500">75</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.write&nbsp;=&nbsp;procfs_write,</span> 
<a id="x1-36160r76"></a><span class="ecrm-0500">76</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.open&nbsp;=&nbsp;procfs_open,</span> 
<a id="x1-36162r77"></a><span class="ecrm-0500">77</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.release&nbsp;=&nbsp;procfs_close,</span> 
<a id="x1-36164r78"></a><span class="ecrm-0500">78</span><span class="ectt-0800">};</span> 
<a id="x1-36166r79"></a><span class="ecrm-0500">79</span><span id="textcolor783"><span class="ectt-0800">#endif</span></span> 
<a id="x1-36168r80"></a><span class="ecrm-0500">80</span> 
<a id="x1-36170r81"></a><span class="ecrm-0500">81</span><span id="textcolor784"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor785"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;__init&nbsp;procfs3_init(</span><span id="textcolor786"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-36172r82"></a><span class="ecrm-0500">82</span><span class="ectt-0800">{</span> 
<a id="x1-36174r83"></a><span class="ecrm-0500">83</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;Our_Proc_File&nbsp;=&nbsp;proc_create(PROCFS_ENTRY_FILENAME,&nbsp;0644,&nbsp;NULL,</span> 
<a id="x1-36176r84"></a><span class="ecrm-0500">84</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;File_Ops_4_Our_Proc_File);</span> 
<a id="x1-36178r85"></a><span class="ecrm-0500">85</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor787"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(Our_Proc_File&nbsp;==&nbsp;NULL)&nbsp;{</span> 
<a id="x1-36180r86"></a><span class="ecrm-0500">86</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;remove_proc_entry(PROCFS_ENTRY_FILENAME,&nbsp;NULL);</span> 
<a id="x1-36182r87"></a><span class="ecrm-0500">87</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pr_debug(</span><span id="textcolor788"><span class="ectt-0800">"Error:&nbsp;Could&nbsp;not&nbsp;initialize&nbsp;/proc/%s</span></span><span id="textcolor789"><span class="ectt-0800">\n</span></span><span id="textcolor790"><span class="ectt-0800">"</span></span><span class="ectt-0800">,</span> 
<a id="x1-36184r88"></a><span class="ecrm-0500">88</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PROCFS_ENTRY_FILENAME);</span> 
<a id="x1-36186r89"></a><span class="ecrm-0500">89</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor791"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;-ENOMEM;</span> 
<a id="x1-36188r90"></a><span class="ecrm-0500">90</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-36190r91"></a><span class="ecrm-0500">91</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;proc_set_size(Our_Proc_File,&nbsp;80);</span> 
<a id="x1-36192r92"></a><span class="ecrm-0500">92</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;proc_set_user(Our_Proc_File,&nbsp;GLOBAL_ROOT_UID,&nbsp;GLOBAL_ROOT_GID);</span> 
<a id="x1-36194r93"></a><span class="ecrm-0500">93</span> 
<a id="x1-36196r94"></a><span class="ecrm-0500">94</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_debug(</span><span id="textcolor792"><span class="ectt-0800">"/proc/%s&nbsp;created</span></span><span id="textcolor793"><span class="ectt-0800">\n</span></span><span id="textcolor794"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;PROCFS_ENTRY_FILENAME);</span> 
<a id="x1-36198r95"></a><span class="ecrm-0500">95</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor795"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;0;</span> 
<a id="x1-36200r96"></a><span class="ecrm-0500">96</span><span class="ectt-0800">}</span> 
<a id="x1-36202r97"></a><span class="ecrm-0500">97</span> 
<a id="x1-36204r98"></a><span class="ecrm-0500">98</span><span id="textcolor796"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor797"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;__exit&nbsp;procfs3_exit(</span><span id="textcolor798"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-36206r99"></a><span class="ecrm-0500">99</span><span class="ectt-0800">{</span> 
<a id="x1-36208r100"></a><span class="ecrm-0500">100</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;remove_proc_entry(PROCFS_ENTRY_FILENAME,&nbsp;NULL);</span> 
<a id="x1-36210r101"></a><span class="ecrm-0500">101</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_debug(</span><span id="textcolor799"><span class="ectt-0800">"/proc/%s&nbsp;removed</span></span><span id="textcolor800"><span class="ectt-0800">\n</span></span><span id="textcolor801"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;PROCFS_ENTRY_FILENAME);</span> 
<a id="x1-36212r102"></a><span class="ecrm-0500">102</span><span class="ectt-0800">}</span> 
<a id="x1-36214r103"></a><span class="ecrm-0500">103</span> 
<a id="x1-36216r104"></a><span class="ecrm-0500">104</span><span class="ectt-0800">module_init(procfs3_init);</span> 
<a id="x1-36218r105"></a><span class="ecrm-0500">105</span><span class="ectt-0800">module_exit(procfs3_exit);</span> 
<a id="x1-36220r106"></a><span class="ecrm-0500">106</span> 
<a id="x1-36222r107"></a><span class="ecrm-0500">107</span><span class="ectt-0800">MODULE_LICENSE(</span><span id="textcolor802"><span class="ectt-0800">"GPL"</span></span><span class="ectt-0800">);</span></pre>
<!-- l. 1020 --><p class="indent">   Still hungry for procfs examples? Well, first of all keep in mind, there are rumors
around, claiming that procfs is on its way out, consider using <span class="obeylines-h"><span class="verb"><span class="ectt-1000">sysfs</span></span></span> instead. Consider
using this mechanism, in case you want to document something kernel related
yourself.
</p><!-- l. 1024 --><p class="noindent">
</p>
   <h4 class="subsectionHead" id="manage-proc-file-with-seqfile"><span class="titlemark">0.7.4   </span> <a id="x1-370000.7.4"></a>Manage /proc file with seq_file</h4>
<!-- l. 1026 --><p class="noindent">As we have seen, writing a /proc file may be quite “complex”.
So to help people writting /proc file, there is an API named
<code> <span class="ectt-1000">seq_file</span>
</code> that helps formating a <span class="obeylines-h"><span class="verb"><span class="ectt-1000">/proc</span></span></span> file for output. It is based on sequence, which is composed of
3 functions: <code>  <span class="ectt-1000">start()</span>
</code>, <code>  <span class="ectt-1000">next()</span>
</code>, and <code>  <span class="ectt-1000">stop()</span>
</code>. The <code>  <span class="ectt-1000">seq_file</span>
</code> API starts a sequence when a user read the /proc file.
</p><!-- l. 1031 --><p class="indent">   A sequence begins with the call of the function
<code> <span class="ectt-1000">start()</span>
</code>. If the return is a non <code>  <span class="ectt-1000">NULL</span>
</code> value, the function <code>  <span class="ectt-1000">next()</span>
</code> is called. This function is an iterator, the goal is to go through all the data. Each
                                                                  

                                                                  
time <code>  <span class="ectt-1000">next()</span>
</code> is called, the function <code>  <span class="ectt-1000">show()</span>
</code> is also called. It writes data values in the buffer read by the user. The function
<code> <span class="ectt-1000">next()</span>
</code> is called until it returns <code>  <span class="ectt-1000">NULL</span>
</code>. The sequence ends when <code>  <span class="ectt-1000">next()</span>
</code> returns <code>  <span class="ectt-1000">NULL</span>
</code>, then the function <code>  <span class="ectt-1000">stop()</span>
</code> is called.
</p><!-- l. 1039 --><p class="indent">   BE CAREFUL: when a sequence is finished, another one starts. That means that at the end
of function <code>  <span class="ectt-1000">stop()</span>
</code>, the function <code>  <span class="ectt-1000">start()</span>
</code> is called again. This loop finishes when the function
<code> <span class="ectt-1000">start()</span>
</code> returns <code>  <span class="ectt-1000">NULL</span>
</code>. You can see a scheme of this in the Figure&nbsp;<a href="https://sysprog21.github.io/lkmpg/#ignorespaces-how-seqfile-works">1<!-- tex4ht:ref: img:seqfile  --></a>.
</p>
   <figure class="figure" id="ignorespaces-how-seqfile-works"> 

                                                                  

                                                                  
<a id="x1-37020r1"></a>
                                                                  

                                                                  
<!-- l. 1046 --><p class="noindent"><img alt="srYrsNNYtaeenetoooertusetupstrxr((ntn))( tis)istrr teeaNreNatUaUtmLtLmeLmLen?e?ntntt  " src="./The Linux Kernel Module Programming Guide_files/lkmpg-for-ht1x.svg">
</p>
<figcaption class="caption"><span class="id">Figure&nbsp;1:</span><span class="content">How seq_file works</span></figcaption><!-- tex4ht:label?: x1-37020r1  -->
                                                                  

                                                                  
   </figure>
<!-- l. 1066 --><p class="indent">   The <code>  <span class="ectt-1000">seq_file</span>
</code> provides basic functions for <code>  <span class="ectt-1000">proc_ops</span>
</code>, such as <code>  <span class="ectt-1000">seq_read</span>
</code>, <code>  <span class="ectt-1000">seq_lseek</span>
</code>, and some others. But nothing to write in the /proc file. Of course, you can still use
the same way as in the previous example.
</p>
   <pre class="fancyvrb" id="fancyvrb41"><a id="x1-37026r1"></a><span class="ecrm-0500">1</span><span id="textcolor803"><span class="ectt-0800">/*</span></span> 
<a id="x1-37028r2"></a><span class="ecrm-0500">2</span><span id="textcolor804"><span class="ectt-0800">&nbsp;*&nbsp;procfs4.c&nbsp;-&nbsp;&nbsp;create&nbsp;a&nbsp;"file"&nbsp;in&nbsp;/proc</span></span> 
<a id="x1-37030r3"></a><span class="ecrm-0500">3</span><span id="textcolor805"><span class="ectt-0800">&nbsp;*&nbsp;This&nbsp;program&nbsp;uses&nbsp;the&nbsp;seq_file&nbsp;library&nbsp;to&nbsp;manage&nbsp;the&nbsp;/proc&nbsp;file.</span></span> 
<a id="x1-37032r4"></a><span class="ecrm-0500">4</span><span id="textcolor806"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-37034r5"></a><span class="ecrm-0500">5</span> 
<a id="x1-37036r6"></a><span class="ecrm-0500">6</span><span id="textcolor807"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor808"><span class="ectt-0800">&lt;linux/kernel.h&gt;&nbsp;&nbsp;&nbsp;/*&nbsp;We&nbsp;are&nbsp;doing&nbsp;kernel&nbsp;work&nbsp;*/</span></span> 
<a id="x1-37038r7"></a><span class="ecrm-0500">7</span><span id="textcolor809"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor810"><span class="ectt-0800">&lt;linux/module.h&gt;&nbsp;&nbsp;&nbsp;/*&nbsp;Specifically,&nbsp;a&nbsp;module&nbsp;*/</span></span> 
<a id="x1-37040r8"></a><span class="ecrm-0500">8</span><span id="textcolor811"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor812"><span class="ectt-0800">&lt;linux/proc_fs.h&gt;&nbsp;&nbsp;/*&nbsp;Necessary&nbsp;because&nbsp;we&nbsp;use&nbsp;proc&nbsp;fs&nbsp;*/</span></span> 
<a id="x1-37042r9"></a><span class="ecrm-0500">9</span><span id="textcolor813"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor814"><span class="ectt-0800">&lt;linux/seq_file.h&gt;&nbsp;/*&nbsp;for&nbsp;seq_file&nbsp;*/</span></span> 
<a id="x1-37044r10"></a><span class="ecrm-0500">10</span><span id="textcolor815"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor816"><span class="ectt-0800">&lt;linux/version.h&gt;</span></span> 
<a id="x1-37046r11"></a><span class="ecrm-0500">11</span> 
<a id="x1-37048r12"></a><span class="ecrm-0500">12</span><span id="textcolor817"><span class="ectt-0800">#if&nbsp;LINUX_VERSION_CODE&nbsp;&gt;=&nbsp;KERNEL_VERSION(5,&nbsp;6,&nbsp;0)</span></span> 
<a id="x1-37050r13"></a><span class="ecrm-0500">13</span><span id="textcolor818"><span class="ectt-0800">#define&nbsp;HAVE_PROC_OPS</span></span> 
<a id="x1-37052r14"></a><span class="ecrm-0500">14</span><span id="textcolor819"><span class="ectt-0800">#endif</span></span> 
<a id="x1-37054r15"></a><span class="ecrm-0500">15</span> 
<a id="x1-37056r16"></a><span class="ecrm-0500">16</span><span id="textcolor820"><span class="ectt-0800">#define&nbsp;PROC_NAME&nbsp;"iter"</span></span> 
<a id="x1-37058r17"></a><span class="ecrm-0500">17</span> 
<a id="x1-37060r18"></a><span class="ecrm-0500">18</span><span id="textcolor821"><span class="ectt-0800">/*&nbsp;This&nbsp;function&nbsp;is&nbsp;called&nbsp;at&nbsp;the&nbsp;beginning&nbsp;of&nbsp;a&nbsp;sequence.</span></span> 
<a id="x1-37062r19"></a><span class="ecrm-0500">19</span><span id="textcolor822"><span class="ectt-0800">&nbsp;*&nbsp;ie,&nbsp;when:</span></span> 
<a id="x1-37064r20"></a><span class="ecrm-0500">20</span><span id="textcolor823"><span class="ectt-0800">&nbsp;*&nbsp;&nbsp;&nbsp;-&nbsp;the&nbsp;/proc&nbsp;file&nbsp;is&nbsp;read&nbsp;(first&nbsp;time)</span></span> 
<a id="x1-37066r21"></a><span class="ecrm-0500">21</span><span id="textcolor824"><span class="ectt-0800">&nbsp;*&nbsp;&nbsp;&nbsp;-&nbsp;after&nbsp;the&nbsp;function&nbsp;stop&nbsp;(end&nbsp;of&nbsp;sequence)</span></span> 
<a id="x1-37068r22"></a><span class="ecrm-0500">22</span><span id="textcolor825"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-37070r23"></a><span class="ecrm-0500">23</span><span id="textcolor826"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor827"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;*my_seq_start(</span><span id="textcolor828"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;seq_file&nbsp;*s,&nbsp;loff_t&nbsp;*pos)</span> 
<a id="x1-37072r24"></a><span class="ecrm-0500">24</span><span class="ectt-0800">{</span> 
<a id="x1-37074r25"></a><span class="ecrm-0500">25</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor829"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor830"><span class="ectt-0800">unsigned</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor831"><span class="ectt-0800">long</span></span><span class="ectt-0800">&nbsp;counter&nbsp;=&nbsp;0;</span> 
<a id="x1-37076r26"></a><span class="ecrm-0500">26</span> 
<a id="x1-37078r27"></a><span class="ecrm-0500">27</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor832"><span class="ectt-0800">/*&nbsp;beginning&nbsp;a&nbsp;new&nbsp;sequence?&nbsp;*/</span></span> 
<a id="x1-37080r28"></a><span class="ecrm-0500">28</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor833"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(*pos&nbsp;==&nbsp;0)&nbsp;{</span> 
<a id="x1-37082r29"></a><span class="ecrm-0500">29</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor834"><span class="ectt-0800">/*&nbsp;yes&nbsp;=&gt;&nbsp;return&nbsp;a&nbsp;non&nbsp;null&nbsp;value&nbsp;to&nbsp;begin&nbsp;the&nbsp;sequence&nbsp;*/</span></span> 
<a id="x1-37084r30"></a><span class="ecrm-0500">30</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor835"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;&amp;counter;</span> 
<a id="x1-37086r31"></a><span class="ecrm-0500">31</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-37088r32"></a><span class="ecrm-0500">32</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor836"><span class="ectt-0800">/*&nbsp;no&nbsp;=&gt;&nbsp;it&nbsp;is&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;sequence,&nbsp;return&nbsp;end&nbsp;to&nbsp;stop&nbsp;reading&nbsp;*/</span></span> 
<a id="x1-37090r33"></a><span class="ecrm-0500">33</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;*pos&nbsp;=&nbsp;0;</span> 
<a id="x1-37092r34"></a><span class="ecrm-0500">34</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor837"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;NULL;</span> 
<a id="x1-37094r35"></a><span class="ecrm-0500">35</span><span class="ectt-0800">}</span> 
<a id="x1-37096r36"></a><span class="ecrm-0500">36</span> 
<a id="x1-37098r37"></a><span class="ecrm-0500">37</span><span id="textcolor838"><span class="ectt-0800">/*&nbsp;This&nbsp;function&nbsp;is&nbsp;called&nbsp;after&nbsp;the&nbsp;beginning&nbsp;of&nbsp;a&nbsp;sequence.</span></span> 
<a id="x1-37100r38"></a><span class="ecrm-0500">38</span><span id="textcolor839"><span class="ectt-0800">&nbsp;*&nbsp;It&nbsp;is&nbsp;called&nbsp;untill&nbsp;the&nbsp;return&nbsp;is&nbsp;NULL&nbsp;(this&nbsp;ends&nbsp;the&nbsp;sequence).</span></span> 
<a id="x1-37102r39"></a><span class="ecrm-0500">39</span><span id="textcolor840"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-37104r40"></a><span class="ecrm-0500">40</span><span id="textcolor841"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor842"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;*my_seq_next(</span><span id="textcolor843"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;seq_file&nbsp;*s,&nbsp;</span><span id="textcolor844"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;*v,&nbsp;loff_t&nbsp;*pos)</span> 
<a id="x1-37106r41"></a><span class="ecrm-0500">41</span><span class="ectt-0800">{</span> 
<a id="x1-37108r42"></a><span class="ecrm-0500">42</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor845"><span class="ectt-0800">unsigned</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor846"><span class="ectt-0800">long</span></span><span class="ectt-0800">&nbsp;*tmp_v&nbsp;=&nbsp;(</span><span id="textcolor847"><span class="ectt-0800">unsigned</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor848"><span class="ectt-0800">long</span></span><span class="ectt-0800">&nbsp;*)&nbsp;v;</span> 
<a id="x1-37110r43"></a><span class="ecrm-0500">43</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;(*tmp_v)++;</span> 
<a id="x1-37112r44"></a><span class="ecrm-0500">44</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;(*pos)++;</span> 
<a id="x1-37114r45"></a><span class="ecrm-0500">45</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor849"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;NULL;</span> 
<a id="x1-37116r46"></a><span class="ecrm-0500">46</span><span class="ectt-0800">}</span> 
<a id="x1-37118r47"></a><span class="ecrm-0500">47</span> 
<a id="x1-37120r48"></a><span class="ecrm-0500">48</span><span id="textcolor850"><span class="ectt-0800">/*&nbsp;This&nbsp;function&nbsp;is&nbsp;called&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;a&nbsp;sequence.&nbsp;*/</span></span> 
<a id="x1-37122r49"></a><span class="ecrm-0500">49</span><span id="textcolor851"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor852"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;my_seq_stop(</span><span id="textcolor853"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;seq_file&nbsp;*s,&nbsp;</span><span id="textcolor854"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;*v)</span> 
<a id="x1-37124r50"></a><span class="ecrm-0500">50</span><span class="ectt-0800">{</span> 
<a id="x1-37126r51"></a><span class="ecrm-0500">51</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor855"><span class="ectt-0800">/*&nbsp;nothing&nbsp;to&nbsp;do,&nbsp;we&nbsp;use&nbsp;a&nbsp;static&nbsp;value&nbsp;in&nbsp;start()&nbsp;*/</span></span> 
<a id="x1-37128r52"></a><span class="ecrm-0500">52</span><span class="ectt-0800">}</span> 
<a id="x1-37130r53"></a><span class="ecrm-0500">53</span> 
<a id="x1-37132r54"></a><span class="ecrm-0500">54</span><span id="textcolor856"><span class="ectt-0800">/*&nbsp;This&nbsp;function&nbsp;is&nbsp;called&nbsp;for&nbsp;each&nbsp;"step"&nbsp;of&nbsp;a&nbsp;sequence.&nbsp;*/</span></span> 
<a id="x1-37134r55"></a><span class="ecrm-0500">55</span><span id="textcolor857"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor858"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;my_seq_show(</span><span id="textcolor859"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;seq_file&nbsp;*s,&nbsp;</span><span id="textcolor860"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;*v)</span> 
<a id="x1-37136r56"></a><span class="ecrm-0500">56</span><span class="ectt-0800">{</span> 
<a id="x1-37138r57"></a><span class="ecrm-0500">57</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;loff_t&nbsp;*spos&nbsp;=&nbsp;(loff_t&nbsp;*)&nbsp;v;</span> 
<a id="x1-37140r58"></a><span class="ecrm-0500">58</span> 
<a id="x1-37142r59"></a><span class="ecrm-0500">59</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;seq_printf(s,&nbsp;</span><span id="textcolor861"><span class="ectt-0800">"%Ld</span></span><span id="textcolor862"><span class="ectt-0800">\n</span></span><span id="textcolor863"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;*spos);</span> 
<a id="x1-37144r60"></a><span class="ecrm-0500">60</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor864"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;0;</span> 
<a id="x1-37146r61"></a><span class="ecrm-0500">61</span><span class="ectt-0800">}</span> 
<a id="x1-37148r62"></a><span class="ecrm-0500">62</span> 
<a id="x1-37150r63"></a><span class="ecrm-0500">63</span><span id="textcolor865"><span class="ectt-0800">/*&nbsp;This&nbsp;structure&nbsp;gather&nbsp;"function"&nbsp;to&nbsp;manage&nbsp;the&nbsp;sequence&nbsp;*/</span></span> 
<a id="x1-37152r64"></a><span class="ecrm-0500">64</span><span id="textcolor866"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor867"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;seq_operations&nbsp;my_seq_ops&nbsp;=&nbsp;{</span> 
<a id="x1-37154r65"></a><span class="ecrm-0500">65</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.start&nbsp;=&nbsp;my_seq_start,</span> 
<a id="x1-37156r66"></a><span class="ecrm-0500">66</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.next&nbsp;=&nbsp;my_seq_next,</span> 
<a id="x1-37158r67"></a><span class="ecrm-0500">67</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.stop&nbsp;=&nbsp;my_seq_stop,</span> 
<a id="x1-37160r68"></a><span class="ecrm-0500">68</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.show&nbsp;=&nbsp;my_seq_show,</span> 
<a id="x1-37162r69"></a><span class="ecrm-0500">69</span><span class="ectt-0800">};</span> 
<a id="x1-37164r70"></a><span class="ecrm-0500">70</span> 
<a id="x1-37166r71"></a><span class="ecrm-0500">71</span><span id="textcolor868"><span class="ectt-0800">/*&nbsp;This&nbsp;function&nbsp;is&nbsp;called&nbsp;when&nbsp;the&nbsp;/proc&nbsp;file&nbsp;is&nbsp;open.&nbsp;*/</span></span> 
<a id="x1-37168r72"></a><span class="ecrm-0500">72</span><span id="textcolor869"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor870"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;my_open(</span><span id="textcolor871"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;inode&nbsp;*inode,&nbsp;</span><span id="textcolor872"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*file)</span> 
<a id="x1-37170r73"></a><span class="ecrm-0500">73</span><span class="ectt-0800">{</span> 
<a id="x1-37172r74"></a><span class="ecrm-0500">74</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor873"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;seq_open(file,&nbsp;&amp;my_seq_ops);</span> 
<a id="x1-37174r75"></a><span class="ecrm-0500">75</span><span class="ectt-0800">};</span> 
<a id="x1-37176r76"></a><span class="ecrm-0500">76</span> 
<a id="x1-37178r77"></a><span class="ecrm-0500">77</span><span id="textcolor874"><span class="ectt-0800">/*&nbsp;This&nbsp;structure&nbsp;gather&nbsp;"function"&nbsp;that&nbsp;manage&nbsp;the&nbsp;/proc&nbsp;file&nbsp;*/</span></span> 
<a id="x1-37180r78"></a><span class="ecrm-0500">78</span><span id="textcolor875"><span class="ectt-0800">#ifdef&nbsp;HAVE_PROC_OPS</span></span> 
<a id="x1-37182r79"></a><span class="ecrm-0500">79</span><span id="textcolor876"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor877"><span class="ectt-0800">const</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor878"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;proc_ops&nbsp;my_file_ops&nbsp;=&nbsp;{</span> 
<a id="x1-37184r80"></a><span class="ecrm-0500">80</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.proc_open&nbsp;=&nbsp;my_open,</span> 
<a id="x1-37186r81"></a><span class="ecrm-0500">81</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.proc_read&nbsp;=&nbsp;seq_read,</span> 
<a id="x1-37188r82"></a><span class="ecrm-0500">82</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.proc_lseek&nbsp;=&nbsp;seq_lseek,</span> 
<a id="x1-37190r83"></a><span class="ecrm-0500">83</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.proc_release&nbsp;=&nbsp;seq_release,</span> 
<a id="x1-37192r84"></a><span class="ecrm-0500">84</span><span class="ectt-0800">};</span> 
<a id="x1-37194r85"></a><span class="ecrm-0500">85</span><span id="textcolor879"><span class="ectt-0800">#else</span></span> 
<a id="x1-37196r86"></a><span class="ecrm-0500">86</span><span id="textcolor880"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor881"><span class="ectt-0800">const</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor882"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file_operations&nbsp;my_file_ops&nbsp;=&nbsp;{</span> 
<a id="x1-37198r87"></a><span class="ecrm-0500">87</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.open&nbsp;=&nbsp;my_open,</span> 
<a id="x1-37200r88"></a><span class="ecrm-0500">88</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.read&nbsp;=&nbsp;seq_read,</span> 
<a id="x1-37202r89"></a><span class="ecrm-0500">89</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.llseek&nbsp;=&nbsp;seq_lseek,</span> 
<a id="x1-37204r90"></a><span class="ecrm-0500">90</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.release&nbsp;=&nbsp;seq_release,</span> 
<a id="x1-37206r91"></a><span class="ecrm-0500">91</span><span class="ectt-0800">};</span> 
<a id="x1-37208r92"></a><span class="ecrm-0500">92</span><span id="textcolor883"><span class="ectt-0800">#endif</span></span> 
<a id="x1-37210r93"></a><span class="ecrm-0500">93</span> 
<a id="x1-37212r94"></a><span class="ecrm-0500">94</span><span id="textcolor884"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor885"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;__init&nbsp;procfs4_init(</span><span id="textcolor886"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-37214r95"></a><span class="ecrm-0500">95</span><span class="ectt-0800">{</span> 
<a id="x1-37216r96"></a><span class="ecrm-0500">96</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor887"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;proc_dir_entry&nbsp;*entry;</span> 
<a id="x1-37218r97"></a><span class="ecrm-0500">97</span> 
<a id="x1-37220r98"></a><span class="ecrm-0500">98</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;entry&nbsp;=&nbsp;proc_create(PROC_NAME,&nbsp;0,&nbsp;NULL,&nbsp;&amp;my_file_ops);</span> 
<a id="x1-37222r99"></a><span class="ecrm-0500">99</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor888"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(entry&nbsp;==&nbsp;NULL)&nbsp;{</span> 
<a id="x1-37224r100"></a><span class="ecrm-0500">100</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;remove_proc_entry(PROC_NAME,&nbsp;NULL);</span> 
<a id="x1-37226r101"></a><span class="ecrm-0500">101</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pr_debug(</span><span id="textcolor889"><span class="ectt-0800">"Error:&nbsp;Could&nbsp;not&nbsp;initialize&nbsp;/proc/%s</span></span><span id="textcolor890"><span class="ectt-0800">\n</span></span><span id="textcolor891"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;PROC_NAME);</span> 
<a id="x1-37228r102"></a><span class="ecrm-0500">102</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor892"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;-ENOMEM;</span> 
<a id="x1-37230r103"></a><span class="ecrm-0500">103</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-37232r104"></a><span class="ecrm-0500">104</span> 
<a id="x1-37234r105"></a><span class="ecrm-0500">105</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor893"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;0;</span> 
<a id="x1-37236r106"></a><span class="ecrm-0500">106</span><span class="ectt-0800">}</span> 
<a id="x1-37238r107"></a><span class="ecrm-0500">107</span> 
<a id="x1-37240r108"></a><span class="ecrm-0500">108</span><span id="textcolor894"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor895"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;__exit&nbsp;procfs4_exit(</span><span id="textcolor896"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-37242r109"></a><span class="ecrm-0500">109</span><span class="ectt-0800">{</span> 
<a id="x1-37244r110"></a><span class="ecrm-0500">110</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;remove_proc_entry(PROC_NAME,&nbsp;NULL);</span> 
<a id="x1-37246r111"></a><span class="ecrm-0500">111</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_debug(</span><span id="textcolor897"><span class="ectt-0800">"/proc/%s&nbsp;removed</span></span><span id="textcolor898"><span class="ectt-0800">\n</span></span><span id="textcolor899"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;PROC_NAME);</span> 
<a id="x1-37248r112"></a><span class="ecrm-0500">112</span><span class="ectt-0800">}</span> 
<a id="x1-37250r113"></a><span class="ecrm-0500">113</span> 
<a id="x1-37252r114"></a><span class="ecrm-0500">114</span><span class="ectt-0800">module_init(procfs4_init);</span> 
<a id="x1-37254r115"></a><span class="ecrm-0500">115</span><span class="ectt-0800">module_exit(procfs4_exit);</span> 
<a id="x1-37256r116"></a><span class="ecrm-0500">116</span> 
<a id="x1-37258r117"></a><span class="ecrm-0500">117</span><span class="ectt-0800">MODULE_LICENSE(</span><span id="textcolor900"><span class="ectt-0800">"GPL"</span></span><span class="ectt-0800">);</span></pre>
<!-- l. 1072 --><p class="indent">   If you want more information, you can read this web page:
</p>
     <ul class="itemize1">
     <li class="itemize"><a class="url" href="http://lwn.net/Articles/22355/"><span class="ectt-1000">http://lwn.net/Articles/22355/</span></a>
     </li>
     <li class="itemize"><a class="url" href="https://kernelnewbies.org/Documents/SeqFileHowTo"><span class="ectt-1000">https://kernelnewbies.org/Documents/SeqFileHowTo</span></a></li></ul>
<!-- l. 1079 --><p class="indent">   You can also read the code of <a href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/seq_file.c">fs/seq_file.c</a> in the linux kernel.
</p>
   <h3 class="sectionHead" id="sysfs-interacting-with-your-module"><span class="titlemark">0.8   </span> <a id="x1-380000.8"></a>sysfs: Interacting with your module</h3>
<!-- l. 1083 --><p class="noindent"><span class="ecti-1000">sysfs </span>allows you to interact with the running kernel from userspace by reading or
setting variables inside of modules. This can be useful for debugging purposes, or just
as an interface for applications or scripts. You can find sysfs directories and files
under the <span class="obeylines-h"><span class="verb"><span class="ectt-1000">/sys</span></span></span> directory on your system.
</p><!-- l. 1 --><p class="indent">
</p>
   <pre class="fancyvrb" id="fancyvrb42"><a id="x1-38003r1"></a><span class="ecrm-0500">1</span><span class="ectt-1000">ls&nbsp;-l&nbsp;/sys</span></pre>
<!-- l. 1091 --><p class="indent">   An example of a hello world module which includes the creation of a variable
accessible via sysfs is given below.
</p><!-- l. 1 --><p class="indent">
</p>
   <pre class="fancyvrb" id="fancyvrb43"><a id="x1-38005r1"></a><span class="ecrm-0500">1</span><span id="textcolor901"><span class="ectt-0800">/*</span></span> 
<a id="x1-38007r2"></a><span class="ecrm-0500">2</span><span id="textcolor902"><span class="ectt-0800">&nbsp;*&nbsp;hello-sysfs.c&nbsp;sysfs&nbsp;example</span></span> 
<a id="x1-38009r3"></a><span class="ecrm-0500">3</span><span id="textcolor903"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-38011r4"></a><span class="ecrm-0500">4</span><span id="textcolor904"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor905"><span class="ectt-0800">&lt;linux/fs.h&gt;</span></span> 
<a id="x1-38013r5"></a><span class="ecrm-0500">5</span><span id="textcolor906"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor907"><span class="ectt-0800">&lt;linux/init.h&gt;</span></span> 
<a id="x1-38015r6"></a><span class="ecrm-0500">6</span><span id="textcolor908"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor909"><span class="ectt-0800">&lt;linux/kobject.h&gt;</span></span> 
<a id="x1-38017r7"></a><span class="ecrm-0500">7</span><span id="textcolor910"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor911"><span class="ectt-0800">&lt;linux/module.h&gt;</span></span> 
<a id="x1-38019r8"></a><span class="ecrm-0500">8</span><span id="textcolor912"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor913"><span class="ectt-0800">&lt;linux/string.h&gt;</span></span> 
<a id="x1-38021r9"></a><span class="ecrm-0500">9</span><span id="textcolor914"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor915"><span class="ectt-0800">&lt;linux/sysfs.h&gt;</span></span> 
<a id="x1-38023r10"></a><span class="ecrm-0500">10</span> 
<a id="x1-38025r11"></a><span class="ecrm-0500">11</span><span id="textcolor916"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor917"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;kobject&nbsp;*mymodule;</span> 
<a id="x1-38027r12"></a><span class="ecrm-0500">12</span> 
<a id="x1-38029r13"></a><span class="ecrm-0500">13</span><span id="textcolor918"><span class="ectt-0800">/*&nbsp;the&nbsp;variable&nbsp;you&nbsp;want&nbsp;to&nbsp;be&nbsp;able&nbsp;to&nbsp;change&nbsp;*/</span></span> 
<a id="x1-38031r14"></a><span class="ecrm-0500">14</span><span id="textcolor919"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor920"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;myvariable&nbsp;=&nbsp;0;</span> 
<a id="x1-38033r15"></a><span class="ecrm-0500">15</span> 
<a id="x1-38035r16"></a><span class="ecrm-0500">16</span><span id="textcolor921"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor922"><span class="ectt-0800">ssize_t</span></span><span class="ectt-0800">&nbsp;myvariable_show(</span><span id="textcolor923"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;kobject&nbsp;*kobj,</span> 
<a id="x1-38037r17"></a><span class="ecrm-0500">17</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor924"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;kobj_attribute&nbsp;*attr,</span> 
<a id="x1-38039r18"></a><span class="ecrm-0500">18</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor925"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;*buf)</span> 
<a id="x1-38041r19"></a><span class="ecrm-0500">19</span><span class="ectt-0800">{</span> 
<a id="x1-38043r20"></a><span class="ecrm-0500">20</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor926"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;sprintf(buf,&nbsp;</span><span id="textcolor927"><span class="ectt-0800">"%d</span></span><span id="textcolor928"><span class="ectt-0800">\n</span></span><span id="textcolor929"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;myvariable);</span> 
<a id="x1-38045r21"></a><span class="ecrm-0500">21</span><span class="ectt-0800">}</span> 
<a id="x1-38047r22"></a><span class="ecrm-0500">22</span> 
<a id="x1-38049r23"></a><span class="ecrm-0500">23</span><span id="textcolor930"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor931"><span class="ectt-0800">ssize_t</span></span><span class="ectt-0800">&nbsp;myvariable_store(</span><span id="textcolor932"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;kobject&nbsp;*kobj,</span> 
<a id="x1-38051r24"></a><span class="ecrm-0500">24</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor933"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;kobj_attribute&nbsp;*attr,</span> 
<a id="x1-38053r25"></a><span class="ecrm-0500">25</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor934"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;*buf,</span> 
<a id="x1-38055r26"></a><span class="ecrm-0500">26</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor935"><span class="ectt-0800">size_t</span></span><span class="ectt-0800">&nbsp;count)</span> 
<a id="x1-38057r27"></a><span class="ecrm-0500">27</span><span class="ectt-0800">{</span> 
<a id="x1-38059r28"></a><span class="ecrm-0500">28</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;sscanf(buf,&nbsp;</span><span id="textcolor936"><span class="ectt-0800">"%du"</span></span><span class="ectt-0800">,&nbsp;&amp;myvariable);</span> 
<a id="x1-38061r29"></a><span class="ecrm-0500">29</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor937"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;count;</span> 
<a id="x1-38063r30"></a><span class="ecrm-0500">30</span><span class="ectt-0800">}</span> 
<a id="x1-38065r31"></a><span class="ecrm-0500">31</span> 
<a id="x1-38067r32"></a><span class="ecrm-0500">32</span> 
<a id="x1-38069r33"></a><span class="ecrm-0500">33</span><span id="textcolor938"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor939"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;kobj_attribute&nbsp;myvariable_attribute&nbsp;=</span> 
<a id="x1-38071r34"></a><span class="ecrm-0500">34</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;__ATTR(myvariable,&nbsp;0660,&nbsp;myvariable_show,&nbsp;(</span><span id="textcolor940"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;*)&nbsp;myvariable_store);</span> 
<a id="x1-38073r35"></a><span class="ecrm-0500">35</span> 
<a id="x1-38075r36"></a><span class="ecrm-0500">36</span><span id="textcolor941"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor942"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;__init&nbsp;mymodule_init(</span><span id="textcolor943"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-38077r37"></a><span class="ecrm-0500">37</span><span class="ectt-0800">{</span> 
<a id="x1-38079r38"></a><span class="ecrm-0500">38</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor944"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;error&nbsp;=&nbsp;0;</span> 
<a id="x1-38081r39"></a><span class="ecrm-0500">39</span> 
<a id="x1-38083r40"></a><span class="ecrm-0500">40</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor945"><span class="ectt-0800">"mymodule:&nbsp;initialised</span></span><span id="textcolor946"><span class="ectt-0800">\n</span></span><span id="textcolor947"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-38085r41"></a><span class="ecrm-0500">41</span> 
<a id="x1-38087r42"></a><span class="ecrm-0500">42</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;mymodule&nbsp;=&nbsp;kobject_create_and_add(</span><span id="textcolor948"><span class="ectt-0800">"mymodule"</span></span><span class="ectt-0800">,&nbsp;kernel_kobj);</span> 
<a id="x1-38089r43"></a><span class="ecrm-0500">43</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor949"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(!mymodule)</span> 
<a id="x1-38091r44"></a><span class="ecrm-0500">44</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor950"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;-ENOMEM;</span> 
<a id="x1-38093r45"></a><span class="ecrm-0500">45</span> 
<a id="x1-38095r46"></a><span class="ecrm-0500">46</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;error&nbsp;=&nbsp;sysfs_create_file(mymodule,&nbsp;&amp;myvariable_attribute.attr);</span> 
<a id="x1-38097r47"></a><span class="ecrm-0500">47</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor951"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(error)&nbsp;{</span> 
<a id="x1-38099r48"></a><span class="ecrm-0500">48</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span> 
<a id="x1-38101r49"></a><span class="ecrm-0500">49</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor952"><span class="ectt-0800">"failed&nbsp;to&nbsp;create&nbsp;the&nbsp;myvariable&nbsp;file&nbsp;"</span></span> 
<a id="x1-38103r50"></a><span class="ecrm-0500">50</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor953"><span class="ectt-0800">"in&nbsp;/sys/kernel/mymodule</span></span><span id="textcolor954"><span class="ectt-0800">\n</span></span><span id="textcolor955"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-38105r51"></a><span class="ecrm-0500">51</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-38107r52"></a><span class="ecrm-0500">52</span> 
<a id="x1-38109r53"></a><span class="ecrm-0500">53</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor956"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;error;</span> 
<a id="x1-38111r54"></a><span class="ecrm-0500">54</span><span class="ectt-0800">}</span> 
<a id="x1-38113r55"></a><span class="ecrm-0500">55</span> 
<a id="x1-38115r56"></a><span class="ecrm-0500">56</span><span id="textcolor957"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor958"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;__exit&nbsp;mymodule_exit(</span><span id="textcolor959"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-38117r57"></a><span class="ecrm-0500">57</span><span class="ectt-0800">{</span> 
<a id="x1-38119r58"></a><span class="ecrm-0500">58</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor960"><span class="ectt-0800">"mymodule:&nbsp;Exit&nbsp;success</span></span><span id="textcolor961"><span class="ectt-0800">\n</span></span><span id="textcolor962"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-38121r59"></a><span class="ecrm-0500">59</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;kobject_put(mymodule);</span> 
<a id="x1-38123r60"></a><span class="ecrm-0500">60</span><span class="ectt-0800">}</span> 
<a id="x1-38125r61"></a><span class="ecrm-0500">61</span> 
<a id="x1-38127r62"></a><span class="ecrm-0500">62</span><span class="ectt-0800">module_init(mymodule_init);</span> 
<a id="x1-38129r63"></a><span class="ecrm-0500">63</span><span class="ectt-0800">module_exit(mymodule_exit);</span> 
<a id="x1-38131r64"></a><span class="ecrm-0500">64</span> 
<a id="x1-38133r65"></a><span class="ecrm-0500">65</span><span class="ectt-0800">MODULE_LICENSE(</span><span id="textcolor963"><span class="ectt-0800">"GPL"</span></span><span class="ectt-0800">);</span></pre>
<!-- l. 1095 --><p class="indent">   Make and install the module:
</p><!-- l. 1 --><p class="indent">
</p>
   <pre class="fancyvrb" id="fancyvrb44"><a id="x1-38137r1"></a><span class="ecrm-0500">1</span><span class="ectt-1000">make</span> 
<a id="x1-38139r2"></a><span class="ecrm-0500">2</span><span class="ectt-1000">sudo&nbsp;insmod&nbsp;hello-sysfs.ko</span></pre>
                                                                  

                                                                  
<!-- l. 1102 --><p class="indent">   Check that it exists:
</p><!-- l. 1 --><p class="indent">
</p>
   <pre class="fancyvrb" id="fancyvrb45"><a id="x1-38142r1"></a><span class="ecrm-0500">1</span><span class="ectt-1000">sudo&nbsp;lsmod&nbsp;|&nbsp;grep&nbsp;hello_sysfs</span></pre>
<!-- l. 1108 --><p class="indent">   What is the current value of <code>  <span class="ectt-1000">myvariable</span>
</code> ?
</p><!-- l. 1 --><p class="indent">
</p>
   <pre class="fancyvrb" id="fancyvrb46"><a id="x1-38146r1"></a><span class="ecrm-0500">1</span><span class="ectt-1000">cat&nbsp;/sys/kernel/mymodule/myvariable</span></pre>
<!-- l. 1114 --><p class="indent">   Set the value of <code>  <span class="ectt-1000">myvariable</span>
</code> and check that it changed.
</p><!-- l. 1 --><p class="indent">
</p>
   <pre class="fancyvrb" id="fancyvrb47"><a id="x1-38151r1"></a><span class="ecrm-0500">1</span><span class="ectt-1000">echo&nbsp;</span><span id="textcolor964"><span class="ectt-1000">"32"</span></span><span class="ectt-1000">&nbsp;&gt;&nbsp;/sys/kernel/mymodule/myvariable</span> 
<a id="x1-38153r2"></a><span class="ecrm-0500">2</span><span class="ectt-1000">cat&nbsp;/sys/kernel/mymodule/myvariable</span></pre>
<!-- l. 1121 --><p class="indent">   Finally, remove the test module:
</p><!-- l. 1 --><p class="indent">
</p>
   <pre class="fancyvrb" id="fancyvrb48"><a id="x1-38156r1"></a><span class="ecrm-0500">1</span><span class="ectt-1000">sudo&nbsp;rmmod&nbsp;hello_sysfs</span></pre>
<!-- l. 1127 --><p class="noindent">
</p>
   <h3 class="sectionHead" id="talking-to-device-files"><span class="titlemark">0.9   </span> <a id="x1-390000.9"></a>Talking To Device Files</h3>
<!-- l. 1129 --><p class="noindent">Device files are supposed to represent physical devices. Most physical devices are
used for output as well as input, so there has to be some mechanism for
device drivers in the kernel to get the output to send to the device from
processes. This is done by opening the device file for output and writing to it,
just like writing to a file. In the following example, this is implemented by
<code> <span class="ectt-1000">device_write</span>
</code>.
</p><!-- l. 1134 --><p class="indent">   This is not always enough. Imagine you had a serial port connected to a modem
(even if you have an internal modem, it is still implemented from the CPU’s
perspective as a serial port connected to a modem, so you don’t have to tax
your imagination too hard). The natural thing to do would be to use the
device file to write things to the modem (either modem commands or data to
be sent through the phone line) and read things from the modem (either
responses for commands or the data received through the phone line). However,
this leaves open the question of what to do when you need to talk to the
serial port itself, for example to send the rate at which data is sent and
received.
                                                                  

                                                                  
</p><!-- l. 1139 --><p class="indent">   The answer in Unix is to use a special function called
<code> <span class="ectt-1000">ioctl</span>
</code> (short for Input Output ConTroL). Every device can have its own
<code> <span class="ectt-1000">ioctl</span>
</code> commands, which can be read ioctl’s (to send information from a process to the
kernel), write ioctl’s (to return information to a process), both or neither. Notice
here the roles of read and write are reversed again, so in ioctl’s read is to
send information to the kernel and write is to receive information from the
kernel.
</p><!-- l. 1143 --><p class="indent">   The ioctl function is called with three parameters: the file descriptor of the
appropriate device file, the ioctl number, and a parameter, which is of type
long so you can use a cast to use it to pass anything. You will not be able
to pass a structure this way, but you will be able to pass a pointer to the
structure.
</p><!-- l. 1146 --><p class="indent">   The ioctl number encodes the major device number, the type of the ioctl, the
command, and the type of the parameter. This ioctl number is usually created by a macro
call (<code>  <span class="ectt-1000">_IO</span>
</code>, <code>  <span class="ectt-1000">_IOR</span>
</code>, <code>  <span class="ectt-1000">_IOW</span>
</code> or <code>  <span class="ectt-1000">_IOWR</span>
</code> — depending on the type) in a header file. This header file should then be
included both by the programs which will use ioctl (so they can generate the
appropriate ioctl’s) and by the kernel module (so it can understand it). In the
example below, the header file is chardev.h and the program which uses it is
ioctl.c.
</p><!-- l. 1151 --><p class="indent">   If you want to use ioctls in your own kernel modules, it is best to receive an
official ioctl assignment, so if you accidentally get somebody else’s ioctls, or if they
get yours, you’ll know something is wrong. For more information, consult the kernel
source tree at <a href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/tree/Documentation/driver-api/ioctl.rst">Documentation/driver-api/ioctl.rst</a>.
</p><!-- l. 1 --><p class="indent">
</p>
   <pre class="fancyvrb" id="fancyvrb49"><a id="x1-39009r1"></a><span class="ecrm-0500">1</span><span id="textcolor965"><span class="ectt-0800">/*</span></span> 
<a id="x1-39011r2"></a><span class="ecrm-0500">2</span><span id="textcolor966"><span class="ectt-0800">&nbsp;*&nbsp;chardev2.c&nbsp;-&nbsp;Create&nbsp;an&nbsp;input/output&nbsp;character&nbsp;device</span></span> 
<a id="x1-39013r3"></a><span class="ecrm-0500">3</span><span id="textcolor967"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-39015r4"></a><span class="ecrm-0500">4</span> 
<a id="x1-39017r5"></a><span class="ecrm-0500">5</span><span id="textcolor968"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor969"><span class="ectt-0800">&lt;linux/cdev.h&gt;</span></span> 
<a id="x1-39019r6"></a><span class="ecrm-0500">6</span><span id="textcolor970"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor971"><span class="ectt-0800">&lt;linux/delay.h&gt;</span></span> 
<a id="x1-39021r7"></a><span class="ecrm-0500">7</span><span id="textcolor972"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor973"><span class="ectt-0800">&lt;linux/device.h&gt;</span></span> 
<a id="x1-39023r8"></a><span class="ecrm-0500">8</span><span id="textcolor974"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor975"><span class="ectt-0800">&lt;linux/fs.h&gt;</span></span> 
<a id="x1-39025r9"></a><span class="ecrm-0500">9</span><span id="textcolor976"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor977"><span class="ectt-0800">&lt;linux/init.h&gt;</span></span> 
<a id="x1-39027r10"></a><span class="ecrm-0500">10</span><span id="textcolor978"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor979"><span class="ectt-0800">&lt;linux/irq.h&gt;</span></span> 
<a id="x1-39029r11"></a><span class="ecrm-0500">11</span><span id="textcolor980"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor981"><span class="ectt-0800">&lt;linux/kernel.h&gt;&nbsp;/*&nbsp;We&nbsp;are&nbsp;doing&nbsp;kernel&nbsp;work&nbsp;*/</span></span> 
<a id="x1-39031r12"></a><span class="ecrm-0500">12</span><span id="textcolor982"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor983"><span class="ectt-0800">&lt;linux/module.h&gt;&nbsp;/*&nbsp;Specifically,&nbsp;a&nbsp;module&nbsp;*/</span></span> 
<a id="x1-39033r13"></a><span class="ecrm-0500">13</span><span id="textcolor984"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor985"><span class="ectt-0800">&lt;linux/poll.h&gt;</span></span> 
<a id="x1-39035r14"></a><span class="ecrm-0500">14</span> 
<a id="x1-39037r15"></a><span class="ecrm-0500">15</span><span id="textcolor986"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor987"><span class="ectt-0800">"chardev.h"</span></span> 
<a id="x1-39039r16"></a><span class="ecrm-0500">16</span><span id="textcolor988"><span class="ectt-0800">#define&nbsp;SUCCESS&nbsp;0</span></span> 
<a id="x1-39041r17"></a><span class="ecrm-0500">17</span><span id="textcolor989"><span class="ectt-0800">#define&nbsp;DEVICE_NAME&nbsp;"char_dev"</span></span> 
<a id="x1-39043r18"></a><span class="ecrm-0500">18</span><span id="textcolor990"><span class="ectt-0800">#define&nbsp;BUF_LEN&nbsp;80</span></span> 
<a id="x1-39045r19"></a><span class="ecrm-0500">19</span> 
<a id="x1-39047r20"></a><span class="ecrm-0500">20</span><span id="textcolor991"><span class="ectt-0800">/*&nbsp;Is&nbsp;the&nbsp;device&nbsp;open&nbsp;right&nbsp;now?&nbsp;Used&nbsp;to&nbsp;prevent&nbsp;concurent&nbsp;access&nbsp;into</span></span> 
<a id="x1-39049r21"></a><span class="ecrm-0500">21</span><span id="textcolor992"><span class="ectt-0800">&nbsp;*&nbsp;the&nbsp;same&nbsp;device</span></span> 
<a id="x1-39051r22"></a><span class="ecrm-0500">22</span><span id="textcolor993"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-39053r23"></a><span class="ecrm-0500">23</span><span id="textcolor994"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor995"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;Device_Open&nbsp;=&nbsp;0;</span> 
<a id="x1-39055r24"></a><span class="ecrm-0500">24</span> 
<a id="x1-39057r25"></a><span class="ecrm-0500">25</span><span id="textcolor996"><span class="ectt-0800">/*&nbsp;The&nbsp;message&nbsp;the&nbsp;device&nbsp;will&nbsp;give&nbsp;when&nbsp;asked&nbsp;*/</span></span> 
<a id="x1-39059r26"></a><span class="ecrm-0500">26</span><span id="textcolor997"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor998"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;Message[BUF_LEN];</span> 
<a id="x1-39061r27"></a><span class="ecrm-0500">27</span> 
<a id="x1-39063r28"></a><span class="ecrm-0500">28</span><span id="textcolor999"><span class="ectt-0800">/*&nbsp;How&nbsp;far&nbsp;did&nbsp;the&nbsp;process&nbsp;reading&nbsp;the&nbsp;message&nbsp;get?&nbsp;Useful&nbsp;if&nbsp;the&nbsp;message</span></span> 
<a id="x1-39065r29"></a><span class="ecrm-0500">29</span><span id="textcolor1000"><span class="ectt-0800">&nbsp;*&nbsp;is&nbsp;larger&nbsp;than&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;buffer&nbsp;we&nbsp;get&nbsp;to&nbsp;fill&nbsp;in&nbsp;device_read.</span></span> 
<a id="x1-39067r30"></a><span class="ecrm-0500">30</span><span id="textcolor1001"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-39069r31"></a><span class="ecrm-0500">31</span><span id="textcolor1002"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1003"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;*Message_Ptr;</span> 
<a id="x1-39071r32"></a><span class="ecrm-0500">32</span> 
<a id="x1-39073r33"></a><span class="ecrm-0500">33</span><span id="textcolor1004"><span class="ectt-0800">/*&nbsp;Major&nbsp;number&nbsp;assigned&nbsp;to&nbsp;our&nbsp;device&nbsp;driver&nbsp;*/</span></span> 
<a id="x1-39075r34"></a><span class="ecrm-0500">34</span><span id="textcolor1005"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1006"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;Major;</span> 
<a id="x1-39077r35"></a><span class="ecrm-0500">35</span><span id="textcolor1007"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1008"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;class&nbsp;*cls;</span> 
<a id="x1-39079r36"></a><span class="ecrm-0500">36</span> 
<a id="x1-39081r37"></a><span class="ecrm-0500">37</span><span id="textcolor1009"><span class="ectt-0800">/*&nbsp;This&nbsp;is&nbsp;called&nbsp;whenever&nbsp;a&nbsp;process&nbsp;attempts&nbsp;to&nbsp;open&nbsp;the&nbsp;device&nbsp;file&nbsp;*/</span></span> 
<a id="x1-39083r38"></a><span class="ecrm-0500">38</span><span id="textcolor1010"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1011"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;device_open(</span><span id="textcolor1012"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;inode&nbsp;*inode,&nbsp;</span><span id="textcolor1013"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*file)</span> 
<a id="x1-39085r39"></a><span class="ecrm-0500">39</span><span class="ectt-0800">{</span> 
<a id="x1-39087r40"></a><span class="ecrm-0500">40</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor1014"><span class="ectt-0800">"device_open(%p)</span></span><span id="textcolor1015"><span class="ectt-0800">\n</span></span><span id="textcolor1016"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;file);</span> 
<a id="x1-39089r41"></a><span class="ecrm-0500">41</span> 
<a id="x1-39091r42"></a><span class="ecrm-0500">42</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1017"><span class="ectt-0800">/*&nbsp;We&nbsp;don</span><span class="tctt-0800">'</span><span class="ectt-0800">t&nbsp;want&nbsp;to&nbsp;talk&nbsp;to&nbsp;two&nbsp;processes&nbsp;at&nbsp;the&nbsp;same&nbsp;time.&nbsp;*/</span></span> 
<a id="x1-39093r43"></a><span class="ecrm-0500">43</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1018"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(Device_Open)</span> 
<a id="x1-39095r44"></a><span class="ecrm-0500">44</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1019"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;-EBUSY;</span> 
<a id="x1-39097r45"></a><span class="ecrm-0500">45</span> 
<a id="x1-39099r46"></a><span class="ecrm-0500">46</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;Device_Open++;</span> 
<a id="x1-39101r47"></a><span class="ecrm-0500">47</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1020"><span class="ectt-0800">/*&nbsp;Initialize&nbsp;the&nbsp;message&nbsp;*/</span></span> 
<a id="x1-39103r48"></a><span class="ecrm-0500">48</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;Message_Ptr&nbsp;=&nbsp;Message;</span> 
<a id="x1-39105r49"></a><span class="ecrm-0500">49</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;try_module_get(THIS_MODULE);</span> 
<a id="x1-39107r50"></a><span class="ecrm-0500">50</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1021"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;SUCCESS;</span> 
<a id="x1-39109r51"></a><span class="ecrm-0500">51</span><span class="ectt-0800">}</span> 
<a id="x1-39111r52"></a><span class="ecrm-0500">52</span> 
<a id="x1-39113r53"></a><span class="ecrm-0500">53</span><span id="textcolor1022"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1023"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;device_release(</span><span id="textcolor1024"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;inode&nbsp;*inode,&nbsp;</span><span id="textcolor1025"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*file)</span> 
<a id="x1-39115r54"></a><span class="ecrm-0500">54</span><span class="ectt-0800">{</span> 
<a id="x1-39117r55"></a><span class="ecrm-0500">55</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor1026"><span class="ectt-0800">"device_release(%p,%p)</span></span><span id="textcolor1027"><span class="ectt-0800">\n</span></span><span id="textcolor1028"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;inode,&nbsp;file);</span> 
<a id="x1-39119r56"></a><span class="ecrm-0500">56</span> 
<a id="x1-39121r57"></a><span class="ecrm-0500">57</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1029"><span class="ectt-0800">/*&nbsp;We</span><span class="tctt-0800">'</span><span class="ectt-0800">re&nbsp;now&nbsp;ready&nbsp;for&nbsp;our&nbsp;next&nbsp;caller&nbsp;*/</span></span> 
<a id="x1-39123r58"></a><span class="ecrm-0500">58</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;Device_Open--;</span> 
<a id="x1-39125r59"></a><span class="ecrm-0500">59</span> 
<a id="x1-39127r60"></a><span class="ecrm-0500">60</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;module_put(THIS_MODULE);</span> 
<a id="x1-39129r61"></a><span class="ecrm-0500">61</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1030"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;SUCCESS;</span> 
<a id="x1-39131r62"></a><span class="ecrm-0500">62</span><span class="ectt-0800">}</span> 
<a id="x1-39133r63"></a><span class="ecrm-0500">63</span> 
<a id="x1-39135r64"></a><span class="ecrm-0500">64</span><span id="textcolor1031"><span class="ectt-0800">/*&nbsp;This&nbsp;function&nbsp;is&nbsp;called&nbsp;whenever&nbsp;a&nbsp;process&nbsp;which&nbsp;has&nbsp;already&nbsp;opened&nbsp;the</span></span> 
<a id="x1-39137r65"></a><span class="ecrm-0500">65</span><span id="textcolor1032"><span class="ectt-0800">&nbsp;*&nbsp;device&nbsp;file&nbsp;attempts&nbsp;to&nbsp;read&nbsp;from&nbsp;it.</span></span> 
<a id="x1-39139r66"></a><span class="ecrm-0500">66</span><span id="textcolor1033"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-39141r67"></a><span class="ecrm-0500">67</span><span id="textcolor1034"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1035"><span class="ectt-0800">ssize_t</span></span><span class="ectt-0800">&nbsp;device_read(</span><span id="textcolor1036"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*file,&nbsp;&nbsp;&nbsp;</span><span id="textcolor1037"><span class="ectt-0800">/*&nbsp;see&nbsp;include/linux/fs.h&nbsp;&nbsp;&nbsp;*/</span></span> 
<a id="x1-39143r68"></a><span class="ecrm-0500">68</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1038"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;__user&nbsp;*buffer,&nbsp;</span><span id="textcolor1039"><span class="ectt-0800">/*&nbsp;buffer&nbsp;to&nbsp;be&nbsp;filled&nbsp;&nbsp;*/</span></span> 
<a id="x1-39145r69"></a><span class="ecrm-0500">69</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1040"><span class="ectt-0800">size_t</span></span><span class="ectt-0800">&nbsp;length,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1041"><span class="ectt-0800">/*&nbsp;length&nbsp;of&nbsp;the&nbsp;buffer&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span></span> 
<a id="x1-39147r70"></a><span class="ecrm-0500">70</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;loff_t&nbsp;*offset)</span> 
<a id="x1-39149r71"></a><span class="ecrm-0500">71</span><span class="ectt-0800">{</span> 
<a id="x1-39151r72"></a><span class="ecrm-0500">72</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1042"><span class="ectt-0800">/*&nbsp;Number&nbsp;of&nbsp;bytes&nbsp;actually&nbsp;written&nbsp;to&nbsp;the&nbsp;buffer&nbsp;*/</span></span> 
<a id="x1-39153r73"></a><span class="ecrm-0500">73</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1043"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;bytes_read&nbsp;=&nbsp;0;</span> 
<a id="x1-39155r74"></a><span class="ecrm-0500">74</span> 
<a id="x1-39157r75"></a><span class="ecrm-0500">75</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor1044"><span class="ectt-0800">"device_read(%p,%p,%ld)</span></span><span id="textcolor1045"><span class="ectt-0800">\n</span></span><span id="textcolor1046"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;file,&nbsp;buffer,&nbsp;length);</span> 
<a id="x1-39159r76"></a><span class="ecrm-0500">76</span> 
<a id="x1-39161r77"></a><span class="ecrm-0500">77</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1047"><span class="ectt-0800">/*&nbsp;If&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;message,&nbsp;return&nbsp;0&nbsp;(which&nbsp;signifies&nbsp;end&nbsp;of&nbsp;file).&nbsp;*/</span></span> 
<a id="x1-39163r78"></a><span class="ecrm-0500">78</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1048"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(*Message_Ptr&nbsp;==&nbsp;0)</span> 
<a id="x1-39165r79"></a><span class="ecrm-0500">79</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1049"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;0;</span> 
<a id="x1-39167r80"></a><span class="ecrm-0500">80</span> 
<a id="x1-39169r81"></a><span class="ecrm-0500">81</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1050"><span class="ectt-0800">/*&nbsp;Actually&nbsp;put&nbsp;the&nbsp;data&nbsp;into&nbsp;the&nbsp;buffer&nbsp;*/</span></span> 
<a id="x1-39171r82"></a><span class="ecrm-0500">82</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1051"><span class="ectt-0800">while</span></span><span class="ectt-0800">&nbsp;(length&nbsp;&amp;&amp;&nbsp;*Message_Ptr)&nbsp;{</span> 
<a id="x1-39173r83"></a><span class="ecrm-0500">83</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1052"><span class="ectt-0800">/*&nbsp;Because&nbsp;the&nbsp;buffer&nbsp;is&nbsp;in&nbsp;the&nbsp;user&nbsp;data&nbsp;segment,&nbsp;not&nbsp;the&nbsp;kernel</span></span> 
<a id="x1-39175r84"></a><span class="ecrm-0500">84</span><span id="textcolor1053"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;data&nbsp;segment,&nbsp;assignment&nbsp;would&nbsp;not&nbsp;work.&nbsp;Instead,&nbsp;we&nbsp;have&nbsp;to</span></span> 
<a id="x1-39177r85"></a><span class="ecrm-0500">85</span><span id="textcolor1054"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;use&nbsp;put_user&nbsp;which&nbsp;copies&nbsp;data&nbsp;from&nbsp;the&nbsp;kernel&nbsp;data&nbsp;segment&nbsp;to</span></span> 
<a id="x1-39179r86"></a><span class="ecrm-0500">86</span><span id="textcolor1055"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;the&nbsp;user&nbsp;data&nbsp;segment.</span></span> 
<a id="x1-39181r87"></a><span class="ecrm-0500">87</span><span id="textcolor1056"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span></span> 
<a id="x1-39183r88"></a><span class="ecrm-0500">88</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;put_user(*(Message_Ptr++),&nbsp;buffer++);</span> 
<a id="x1-39185r89"></a><span class="ecrm-0500">89</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;length--;</span> 
<a id="x1-39187r90"></a><span class="ecrm-0500">90</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bytes_read++;</span> 
<a id="x1-39189r91"></a><span class="ecrm-0500">91</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-39191r92"></a><span class="ecrm-0500">92</span> 
<a id="x1-39193r93"></a><span class="ecrm-0500">93</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor1057"><span class="ectt-0800">"Read&nbsp;%d&nbsp;bytes,&nbsp;%ld&nbsp;left</span></span><span id="textcolor1058"><span class="ectt-0800">\n</span></span><span id="textcolor1059"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;bytes_read,&nbsp;length);</span> 
<a id="x1-39195r94"></a><span class="ecrm-0500">94</span> 
<a id="x1-39197r95"></a><span class="ecrm-0500">95</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1060"><span class="ectt-0800">/*&nbsp;Read&nbsp;functions&nbsp;are&nbsp;supposed&nbsp;to&nbsp;return&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;actually</span></span> 
<a id="x1-39199r96"></a><span class="ecrm-0500">96</span><span id="textcolor1061"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;inserted&nbsp;into&nbsp;the&nbsp;buffer.</span></span> 
<a id="x1-39201r97"></a><span class="ecrm-0500">97</span><span id="textcolor1062"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span></span> 
<a id="x1-39203r98"></a><span class="ecrm-0500">98</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1063"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;bytes_read;</span> 
<a id="x1-39205r99"></a><span class="ecrm-0500">99</span><span class="ectt-0800">}</span> 
<a id="x1-39207r100"></a><span class="ecrm-0500">100</span> 
<a id="x1-39209r101"></a><span class="ecrm-0500">101</span><span id="textcolor1064"><span class="ectt-0800">/*&nbsp;called&nbsp;when&nbsp;somebody&nbsp;tries&nbsp;to&nbsp;write&nbsp;into&nbsp;our&nbsp;device&nbsp;file.&nbsp;*/</span></span> 
<a id="x1-39211r102"></a><span class="ecrm-0500">102</span><span id="textcolor1065"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1066"><span class="ectt-0800">ssize_t</span></span><span class="ectt-0800">&nbsp;device_write(</span><span id="textcolor1067"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*file,</span> 
<a id="x1-39213r103"></a><span class="ecrm-0500">103</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1068"><span class="ectt-0800">const</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1069"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;__user&nbsp;*buffer,</span> 
<a id="x1-39215r104"></a><span class="ecrm-0500">104</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1070"><span class="ectt-0800">size_t</span></span><span class="ectt-0800">&nbsp;length,</span> 
<a id="x1-39217r105"></a><span class="ecrm-0500">105</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;loff_t&nbsp;*offset)</span> 
<a id="x1-39219r106"></a><span class="ecrm-0500">106</span><span class="ectt-0800">{</span> 
<a id="x1-39221r107"></a><span class="ecrm-0500">107</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1071"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;i;</span> 
<a id="x1-39223r108"></a><span class="ecrm-0500">108</span> 
<a id="x1-39225r109"></a><span class="ecrm-0500">109</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor1072"><span class="ectt-0800">"device_write(%p,%s,%ld)"</span></span><span class="ectt-0800">,&nbsp;file,&nbsp;buffer,&nbsp;length);</span> 
<a id="x1-39227r110"></a><span class="ecrm-0500">110</span> 
<a id="x1-39229r111"></a><span class="ecrm-0500">111</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1073"><span class="ectt-0800">for</span></span><span class="ectt-0800">&nbsp;(i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;length&nbsp;&amp;&amp;&nbsp;i&nbsp;&lt;&nbsp;BUF_LEN;&nbsp;i++)</span> 
<a id="x1-39231r112"></a><span class="ecrm-0500">112</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;get_user(Message[i],&nbsp;buffer&nbsp;+&nbsp;i);</span> 
<a id="x1-39233r113"></a><span class="ecrm-0500">113</span> 
<a id="x1-39235r114"></a><span class="ecrm-0500">114</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;Message_Ptr&nbsp;=&nbsp;Message;</span> 
<a id="x1-39237r115"></a><span class="ecrm-0500">115</span> 
<a id="x1-39239r116"></a><span class="ecrm-0500">116</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1074"><span class="ectt-0800">/*&nbsp;Again,&nbsp;return&nbsp;the&nbsp;number&nbsp;of&nbsp;input&nbsp;characters&nbsp;used.&nbsp;*/</span></span> 
<a id="x1-39241r117"></a><span class="ecrm-0500">117</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1075"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;i;</span> 
<a id="x1-39243r118"></a><span class="ecrm-0500">118</span><span class="ectt-0800">}</span> 
<a id="x1-39245r119"></a><span class="ecrm-0500">119</span> 
<a id="x1-39247r120"></a><span class="ecrm-0500">120</span><span id="textcolor1076"><span class="ectt-0800">/*&nbsp;This&nbsp;function&nbsp;is&nbsp;called&nbsp;whenever&nbsp;a&nbsp;process&nbsp;tries&nbsp;to&nbsp;do&nbsp;an&nbsp;ioctl&nbsp;on&nbsp;our</span></span> 
<a id="x1-39249r121"></a><span class="ecrm-0500">121</span><span id="textcolor1077"><span class="ectt-0800">&nbsp;*&nbsp;device&nbsp;file.&nbsp;We&nbsp;get&nbsp;two&nbsp;extra&nbsp;parameters&nbsp;(additional&nbsp;to&nbsp;the&nbsp;inode&nbsp;and&nbsp;file</span></span> 
<a id="x1-39251r122"></a><span class="ecrm-0500">122</span><span id="textcolor1078"><span class="ectt-0800">&nbsp;*&nbsp;structures,&nbsp;which&nbsp;all&nbsp;device&nbsp;functions&nbsp;get):&nbsp;the&nbsp;number&nbsp;of&nbsp;the&nbsp;ioctl&nbsp;called</span></span> 
<a id="x1-39253r123"></a><span class="ecrm-0500">123</span><span id="textcolor1079"><span class="ectt-0800">&nbsp;*&nbsp;and&nbsp;the&nbsp;parameter&nbsp;given&nbsp;to&nbsp;the&nbsp;ioctl&nbsp;function.</span></span> 
<a id="x1-39255r124"></a><span class="ecrm-0500">124</span><span id="textcolor1080"><span class="ectt-0800">&nbsp;*</span></span> 
<a id="x1-39257r125"></a><span class="ecrm-0500">125</span><span id="textcolor1081"><span class="ectt-0800">&nbsp;*&nbsp;If&nbsp;the&nbsp;ioctl&nbsp;is&nbsp;write&nbsp;or&nbsp;read/write&nbsp;(meaning&nbsp;output&nbsp;is&nbsp;returned&nbsp;to&nbsp;the</span></span> 
<a id="x1-39259r126"></a><span class="ecrm-0500">126</span><span id="textcolor1082"><span class="ectt-0800">&nbsp;*&nbsp;calling&nbsp;process),&nbsp;the&nbsp;ioctl&nbsp;call&nbsp;returns&nbsp;the&nbsp;output&nbsp;of&nbsp;this&nbsp;function.</span></span> 
<a id="x1-39261r127"></a><span class="ecrm-0500">127</span><span id="textcolor1083"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-39263r128"></a><span class="ecrm-0500">128</span><span id="textcolor1084"><span class="ectt-0800">long</span></span><span class="ectt-0800">&nbsp;device_ioctl(</span><span id="textcolor1085"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*file,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1086"><span class="ectt-0800">/*&nbsp;ditto&nbsp;*/</span></span> 
<a id="x1-39265r129"></a><span class="ecrm-0500">129</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1087"><span class="ectt-0800">unsigned</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1088"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;ioctl_num,&nbsp;</span><span id="textcolor1089"><span class="ectt-0800">/*&nbsp;number&nbsp;and&nbsp;param&nbsp;for&nbsp;ioctl&nbsp;*/</span></span> 
<a id="x1-39267r130"></a><span class="ecrm-0500">130</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1090"><span class="ectt-0800">unsigned</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1091"><span class="ectt-0800">long</span></span><span class="ectt-0800">&nbsp;ioctl_param)</span> 
<a id="x1-39269r131"></a><span class="ecrm-0500">131</span><span class="ectt-0800">{</span> 
<a id="x1-39271r132"></a><span class="ecrm-0500">132</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1092"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;i;</span> 
<a id="x1-39273r133"></a><span class="ecrm-0500">133</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1093"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;*temp;</span> 
<a id="x1-39275r134"></a><span class="ecrm-0500">134</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1094"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;ch;</span> 
<a id="x1-39277r135"></a><span class="ecrm-0500">135</span> 
<a id="x1-39279r136"></a><span class="ecrm-0500">136</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1095"><span class="ectt-0800">/*&nbsp;Switch&nbsp;according&nbsp;to&nbsp;the&nbsp;ioctl&nbsp;called&nbsp;*/</span></span> 
<a id="x1-39281r137"></a><span class="ecrm-0500">137</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1096"><span class="ectt-0800">switch</span></span><span class="ectt-0800">&nbsp;(ioctl_num)&nbsp;{</span> 
<a id="x1-39283r138"></a><span class="ecrm-0500">138</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1097"><span class="ectt-0800">case</span></span><span class="ectt-0800">&nbsp;IOCTL_SET_MSG:</span> 
<a id="x1-39285r139"></a><span class="ecrm-0500">139</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1098"><span class="ectt-0800">/*&nbsp;Receive&nbsp;a&nbsp;pointer&nbsp;to&nbsp;a&nbsp;message&nbsp;(in&nbsp;user&nbsp;space)&nbsp;and&nbsp;set&nbsp;that&nbsp;to</span></span> 
<a id="x1-39287r140"></a><span class="ecrm-0500">140</span><span id="textcolor1099"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;be&nbsp;the&nbsp;device</span><span class="tctt-0800">'</span><span class="ectt-0800">s&nbsp;message.&nbsp;&nbsp;Get&nbsp;the&nbsp;parameter&nbsp;given&nbsp;to&nbsp;ioctl&nbsp;by</span></span> 
<a id="x1-39289r141"></a><span class="ecrm-0500">141</span><span id="textcolor1100"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;the&nbsp;process.</span></span> 
<a id="x1-39291r142"></a><span class="ecrm-0500">142</span><span id="textcolor1101"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span></span> 
<a id="x1-39293r143"></a><span class="ecrm-0500">143</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;temp&nbsp;=&nbsp;(</span><span id="textcolor1102"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;*)&nbsp;ioctl_param;</span> 
<a id="x1-39295r144"></a><span class="ecrm-0500">144</span> 
<a id="x1-39297r145"></a><span class="ecrm-0500">145</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1103"><span class="ectt-0800">/*&nbsp;Find&nbsp;the&nbsp;length&nbsp;of&nbsp;the&nbsp;message&nbsp;*/</span></span> 
<a id="x1-39299r146"></a><span class="ecrm-0500">146</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;get_user(ch,&nbsp;temp);</span> 
<a id="x1-39301r147"></a><span class="ecrm-0500">147</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1104"><span class="ectt-0800">for</span></span><span class="ectt-0800">&nbsp;(i&nbsp;=&nbsp;0;&nbsp;ch&nbsp;&amp;&amp;&nbsp;i&nbsp;&lt;&nbsp;BUF_LEN;&nbsp;i++,&nbsp;temp++)</span> 
<a id="x1-39303r148"></a><span class="ecrm-0500">148</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;get_user(ch,&nbsp;temp);</span> 
<a id="x1-39305r149"></a><span class="ecrm-0500">149</span> 
<a id="x1-39307r150"></a><span class="ecrm-0500">150</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;device_write(file,&nbsp;(</span><span id="textcolor1105"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;*)&nbsp;ioctl_param,&nbsp;i,&nbsp;0);</span> 
<a id="x1-39309r151"></a><span class="ecrm-0500">151</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1106"><span class="ectt-0800">break</span></span><span class="ectt-0800">;</span> 
<a id="x1-39311r152"></a><span class="ecrm-0500">152</span> 
<a id="x1-39313r153"></a><span class="ecrm-0500">153</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1107"><span class="ectt-0800">case</span></span><span class="ectt-0800">&nbsp;IOCTL_GET_MSG:</span> 
<a id="x1-39315r154"></a><span class="ecrm-0500">154</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1108"><span class="ectt-0800">/*&nbsp;Give&nbsp;the&nbsp;current&nbsp;message&nbsp;to&nbsp;the&nbsp;calling&nbsp;process&nbsp;-&nbsp;the&nbsp;parameter</span></span> 
<a id="x1-39317r155"></a><span class="ecrm-0500">155</span><span id="textcolor1109"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;we&nbsp;got&nbsp;is&nbsp;a&nbsp;pointer,&nbsp;fill&nbsp;it.</span></span> 
<a id="x1-39319r156"></a><span class="ecrm-0500">156</span><span id="textcolor1110"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span></span> 
<a id="x1-39321r157"></a><span class="ecrm-0500">157</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i&nbsp;=&nbsp;device_read(file,&nbsp;(</span><span id="textcolor1111"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;*)&nbsp;ioctl_param,&nbsp;99,&nbsp;0);</span> 
<a id="x1-39323r158"></a><span class="ecrm-0500">158</span> 
<a id="x1-39325r159"></a><span class="ecrm-0500">159</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1112"><span class="ectt-0800">/*&nbsp;Put&nbsp;a&nbsp;zero&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;buffer,&nbsp;so&nbsp;it&nbsp;will&nbsp;be&nbsp;properly</span></span> 
<a id="x1-39327r160"></a><span class="ecrm-0500">160</span><span id="textcolor1113"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;terminated.</span></span> 
<a id="x1-39329r161"></a><span class="ecrm-0500">161</span><span id="textcolor1114"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span></span> 
<a id="x1-39331r162"></a><span class="ecrm-0500">162</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;put_user(</span><span id="textcolor1115"><span class="tctt-0800">'</span><span class="ectt-0800">\0</span><span class="tctt-0800">'</span></span><span class="ectt-0800">,&nbsp;(</span><span id="textcolor1116"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;*)&nbsp;ioctl_param&nbsp;+&nbsp;i);</span> 
<a id="x1-39333r163"></a><span class="ecrm-0500">163</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1117"><span class="ectt-0800">break</span></span><span class="ectt-0800">;</span> 
<a id="x1-39335r164"></a><span class="ecrm-0500">164</span> 
<a id="x1-39337r165"></a><span class="ecrm-0500">165</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1118"><span class="ectt-0800">case</span></span><span class="ectt-0800">&nbsp;IOCTL_GET_NTH_BYTE:</span> 
<a id="x1-39339r166"></a><span class="ecrm-0500">166</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1119"><span class="ectt-0800">/*&nbsp;This&nbsp;ioctl&nbsp;is&nbsp;both&nbsp;input&nbsp;(ioctl_param)&nbsp;and&nbsp;output&nbsp;(the&nbsp;return</span></span> 
<a id="x1-39341r167"></a><span class="ecrm-0500">167</span><span id="textcolor1120"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;value&nbsp;of&nbsp;this&nbsp;function).</span></span> 
<a id="x1-39343r168"></a><span class="ecrm-0500">168</span><span id="textcolor1121"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span></span> 
<a id="x1-39345r169"></a><span class="ecrm-0500">169</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1122"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;Message[ioctl_param];</span> 
<a id="x1-39347r170"></a><span class="ecrm-0500">170</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1123"><span class="ectt-0800">break</span></span><span class="ectt-0800">;</span> 
<a id="x1-39349r171"></a><span class="ecrm-0500">171</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-39351r172"></a><span class="ecrm-0500">172</span> 
<a id="x1-39353r173"></a><span class="ecrm-0500">173</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1124"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;SUCCESS;</span> 
<a id="x1-39355r174"></a><span class="ecrm-0500">174</span><span class="ectt-0800">}</span> 
<a id="x1-39357r175"></a><span class="ecrm-0500">175</span> 
<a id="x1-39359r176"></a><span class="ecrm-0500">176</span><span id="textcolor1125"><span class="ectt-0800">/*&nbsp;Module&nbsp;Declarations&nbsp;*/</span></span> 
<a id="x1-39361r177"></a><span class="ecrm-0500">177</span> 
<a id="x1-39363r178"></a><span class="ecrm-0500">178</span><span id="textcolor1126"><span class="ectt-0800">/*&nbsp;This&nbsp;structure&nbsp;will&nbsp;hold&nbsp;the&nbsp;functions&nbsp;to&nbsp;be&nbsp;called&nbsp;when&nbsp;a&nbsp;process&nbsp;does</span></span> 
<a id="x1-39365r179"></a><span class="ecrm-0500">179</span><span id="textcolor1127"><span class="ectt-0800">&nbsp;*&nbsp;something&nbsp;to&nbsp;the&nbsp;device&nbsp;we&nbsp;created.&nbsp;Since&nbsp;a&nbsp;pointer&nbsp;to&nbsp;this&nbsp;structure</span></span> 
<a id="x1-39367r180"></a><span class="ecrm-0500">180</span><span id="textcolor1128"><span class="ectt-0800">&nbsp;*&nbsp;is&nbsp;kept&nbsp;in&nbsp;the&nbsp;devices&nbsp;table,&nbsp;it&nbsp;can</span><span class="tctt-0800">'</span><span class="ectt-0800">t&nbsp;be&nbsp;local&nbsp;to&nbsp;init_module.&nbsp;NULL&nbsp;is</span></span> 
<a id="x1-39369r181"></a><span class="ecrm-0500">181</span><span id="textcolor1129"><span class="ectt-0800">&nbsp;*&nbsp;for&nbsp;unimplemented&nbsp;functions.</span></span> 
<a id="x1-39371r182"></a><span class="ecrm-0500">182</span><span id="textcolor1130"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-39373r183"></a><span class="ecrm-0500">183</span><span id="textcolor1131"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file_operations&nbsp;Fops&nbsp;=&nbsp;{</span> 
<a id="x1-39375r184"></a><span class="ecrm-0500">184</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.read&nbsp;=&nbsp;device_read,</span> 
<a id="x1-39377r185"></a><span class="ecrm-0500">185</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.write&nbsp;=&nbsp;device_write,</span> 
<a id="x1-39379r186"></a><span class="ecrm-0500">186</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.unlocked_ioctl&nbsp;=&nbsp;device_ioctl,</span> 
<a id="x1-39381r187"></a><span class="ecrm-0500">187</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.open&nbsp;=&nbsp;device_open,</span> 
<a id="x1-39383r188"></a><span class="ecrm-0500">188</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.release&nbsp;=&nbsp;device_release,&nbsp;</span><span id="textcolor1132"><span class="ectt-0800">/*&nbsp;a.k.a.&nbsp;close&nbsp;*/</span></span> 
<a id="x1-39385r189"></a><span class="ecrm-0500">189</span><span class="ectt-0800">};</span> 
<a id="x1-39387r190"></a><span class="ecrm-0500">190</span> 
<a id="x1-39389r191"></a><span class="ecrm-0500">191</span><span id="textcolor1133"><span class="ectt-0800">/*&nbsp;Initialize&nbsp;the&nbsp;module&nbsp;-&nbsp;Register&nbsp;the&nbsp;character&nbsp;device&nbsp;*/</span></span> 
<a id="x1-39391r192"></a><span class="ecrm-0500">192</span><span id="textcolor1134"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1135"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;__init&nbsp;chardev2_init(</span><span id="textcolor1136"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-39393r193"></a><span class="ecrm-0500">193</span><span class="ectt-0800">{</span> 
<a id="x1-39395r194"></a><span class="ecrm-0500">194</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1137"><span class="ectt-0800">/*&nbsp;Register&nbsp;the&nbsp;character&nbsp;device&nbsp;(atleast&nbsp;try)&nbsp;*/</span></span> 
<a id="x1-39397r195"></a><span class="ecrm-0500">195</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1138"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;ret_val&nbsp;=&nbsp;register_chrdev(MAJOR_NUM,&nbsp;DEVICE_NAME,&nbsp;&amp;Fops);</span> 
<a id="x1-39399r196"></a><span class="ecrm-0500">196</span> 
<a id="x1-39401r197"></a><span class="ecrm-0500">197</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1139"><span class="ectt-0800">/*&nbsp;Negative&nbsp;values&nbsp;signify&nbsp;an&nbsp;error&nbsp;*/</span></span> 
<a id="x1-39403r198"></a><span class="ecrm-0500">198</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1140"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(ret_val&nbsp;&lt;&nbsp;0)&nbsp;{</span> 
<a id="x1-39405r199"></a><span class="ecrm-0500">199</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pr_alert(</span><span id="textcolor1141"><span class="ectt-0800">"%s&nbsp;failed&nbsp;with&nbsp;%d</span></span><span id="textcolor1142"><span class="ectt-0800">\n</span></span><span id="textcolor1143"><span class="ectt-0800">"</span></span><span class="ectt-0800">,</span> 
<a id="x1-39407r200"></a><span class="ecrm-0500">200</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1144"><span class="ectt-0800">"Sorry,&nbsp;registering&nbsp;the&nbsp;character&nbsp;device&nbsp;"</span></span><span class="ectt-0800">,&nbsp;ret_val);</span> 
<a id="x1-39409r201"></a><span class="ecrm-0500">201</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1145"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;ret_val;</span> 
<a id="x1-39411r202"></a><span class="ecrm-0500">202</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-39413r203"></a><span class="ecrm-0500">203</span> 
<a id="x1-39415r204"></a><span class="ecrm-0500">204</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;Major&nbsp;=&nbsp;ret_val;</span> 
<a id="x1-39417r205"></a><span class="ecrm-0500">205</span> 
<a id="x1-39419r206"></a><span class="ecrm-0500">206</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;cls&nbsp;=&nbsp;class_create(THIS_MODULE,&nbsp;DEVICE_FILE_NAME);</span> 
<a id="x1-39421r207"></a><span class="ecrm-0500">207</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;device_create(cls,&nbsp;NULL,&nbsp;MKDEV(Major,&nbsp;MAJOR_NUM),&nbsp;NULL,&nbsp;DEVICE_FILE_NAME);</span> 
<a id="x1-39423r208"></a><span class="ecrm-0500">208</span> 
<a id="x1-39425r209"></a><span class="ecrm-0500">209</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor1146"><span class="ectt-0800">"Device&nbsp;created&nbsp;on&nbsp;/dev/%s</span></span><span id="textcolor1147"><span class="ectt-0800">\n</span></span><span id="textcolor1148"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;DEVICE_FILE_NAME);</span> 
<a id="x1-39427r210"></a><span class="ecrm-0500">210</span> 
<a id="x1-39429r211"></a><span class="ecrm-0500">211</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1149"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;0;</span> 
<a id="x1-39431r212"></a><span class="ecrm-0500">212</span><span class="ectt-0800">}</span> 
<a id="x1-39433r213"></a><span class="ecrm-0500">213</span> 
<a id="x1-39435r214"></a><span class="ecrm-0500">214</span><span id="textcolor1150"><span class="ectt-0800">/*&nbsp;Cleanup&nbsp;-&nbsp;unregister&nbsp;the&nbsp;appropriate&nbsp;file&nbsp;from&nbsp;/proc&nbsp;*/</span></span> 
<a id="x1-39437r215"></a><span class="ecrm-0500">215</span><span id="textcolor1151"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1152"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;__exit&nbsp;chardev2_exit(</span><span id="textcolor1153"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-39439r216"></a><span class="ecrm-0500">216</span><span class="ectt-0800">{</span> 
<a id="x1-39441r217"></a><span class="ecrm-0500">217</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;device_destroy(cls,&nbsp;MKDEV(Major,&nbsp;0));</span> 
<a id="x1-39443r218"></a><span class="ecrm-0500">218</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;class_destroy(cls);</span> 
<a id="x1-39445r219"></a><span class="ecrm-0500">219</span> 
<a id="x1-39447r220"></a><span class="ecrm-0500">220</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1154"><span class="ectt-0800">/*&nbsp;Unregister&nbsp;the&nbsp;device&nbsp;*/</span></span> 
<a id="x1-39449r221"></a><span class="ecrm-0500">221</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;unregister_chrdev(Major,&nbsp;DEVICE_NAME);</span> 
<a id="x1-39451r222"></a><span class="ecrm-0500">222</span><span class="ectt-0800">}</span> 
<a id="x1-39453r223"></a><span class="ecrm-0500">223</span> 
<a id="x1-39455r224"></a><span class="ecrm-0500">224</span><span class="ectt-0800">module_init(chardev2_init);</span> 
<a id="x1-39457r225"></a><span class="ecrm-0500">225</span><span class="ectt-0800">module_exit(chardev2_exit);</span> 
<a id="x1-39459r226"></a><span class="ecrm-0500">226</span> 
<a id="x1-39461r227"></a><span class="ecrm-0500">227</span><span class="ectt-0800">MODULE_LICENSE(</span><span id="textcolor1155"><span class="ectt-0800">"GPL"</span></span><span class="ectt-0800">);</span></pre>

<!-- l. 1 --><p class="indent">
</p>
   <pre class="fancyvrb" id="fancyvrb50"><a id="x1-39463r1"></a><span class="ecrm-0500">1</span><span id="textcolor1156"><span class="ectt-0800">/*</span></span> 
<a id="x1-39465r2"></a><span class="ecrm-0500">2</span><span id="textcolor1157"><span class="ectt-0800">&nbsp;*&nbsp;chardev.h&nbsp;-&nbsp;the&nbsp;header&nbsp;file&nbsp;with&nbsp;the&nbsp;ioctl&nbsp;definitions.</span></span> 
<a id="x1-39467r3"></a><span class="ecrm-0500">3</span><span id="textcolor1158"><span class="ectt-0800">&nbsp;*</span></span> 
<a id="x1-39469r4"></a><span class="ecrm-0500">4</span><span id="textcolor1159"><span class="ectt-0800">&nbsp;*&nbsp;The&nbsp;declarations&nbsp;here&nbsp;have&nbsp;to&nbsp;be&nbsp;in&nbsp;a&nbsp;header&nbsp;file,&nbsp;because&nbsp;they&nbsp;need</span></span> 
<a id="x1-39471r5"></a><span class="ecrm-0500">5</span><span id="textcolor1160"><span class="ectt-0800">&nbsp;*&nbsp;to&nbsp;be&nbsp;known&nbsp;both&nbsp;to&nbsp;the&nbsp;kernel&nbsp;module&nbsp;(in&nbsp;chardev.c)&nbsp;and&nbsp;the&nbsp;process</span></span> 
<a id="x1-39473r6"></a><span class="ecrm-0500">6</span><span id="textcolor1161"><span class="ectt-0800">&nbsp;*&nbsp;calling&nbsp;ioctl&nbsp;(ioctl.c).</span></span> 
<a id="x1-39475r7"></a><span class="ecrm-0500">7</span><span id="textcolor1162"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-39477r8"></a><span class="ecrm-0500">8</span> 
<a id="x1-39479r9"></a><span class="ecrm-0500">9</span><span id="textcolor1163"><span class="ectt-0800">#ifndef&nbsp;CHARDEV_H</span></span> 
<a id="x1-39481r10"></a><span class="ecrm-0500">10</span><span id="textcolor1164"><span class="ectt-0800">#define&nbsp;CHARDEV_H</span></span> 
<a id="x1-39483r11"></a><span class="ecrm-0500">11</span> 
<a id="x1-39485r12"></a><span class="ecrm-0500">12</span><span id="textcolor1165"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1166"><span class="ectt-0800">&lt;linux/ioctl.h&gt;</span></span> 
<a id="x1-39487r13"></a><span class="ecrm-0500">13</span> 
<a id="x1-39489r14"></a><span class="ecrm-0500">14</span><span id="textcolor1167"><span class="ectt-0800">/*&nbsp;The&nbsp;major&nbsp;device&nbsp;number.&nbsp;We&nbsp;can&nbsp;not&nbsp;rely&nbsp;on&nbsp;dynamic&nbsp;registration</span></span> 
<a id="x1-39491r15"></a><span class="ecrm-0500">15</span><span id="textcolor1168"><span class="ectt-0800">&nbsp;*&nbsp;any&nbsp;more,&nbsp;because&nbsp;ioctls&nbsp;need&nbsp;to&nbsp;know&nbsp;it.</span></span> 
<a id="x1-39493r16"></a><span class="ecrm-0500">16</span><span id="textcolor1169"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-39495r17"></a><span class="ecrm-0500">17</span><span id="textcolor1170"><span class="ectt-0800">#define&nbsp;MAJOR_NUM&nbsp;100</span></span> 
<a id="x1-39497r18"></a><span class="ecrm-0500">18</span> 
<a id="x1-39499r19"></a><span class="ecrm-0500">19</span><span id="textcolor1171"><span class="ectt-0800">/*&nbsp;Set&nbsp;the&nbsp;message&nbsp;of&nbsp;the&nbsp;device&nbsp;driver&nbsp;*/</span></span> 
<a id="x1-39501r20"></a><span class="ecrm-0500">20</span><span id="textcolor1172"><span class="ectt-0800">#define&nbsp;IOCTL_SET_MSG&nbsp;_IOW(MAJOR_NUM,&nbsp;0,&nbsp;char&nbsp;*)</span></span> 
<a id="x1-39503r21"></a><span class="ecrm-0500">21</span><span id="textcolor1173"><span class="ectt-0800">/*&nbsp;_IOW&nbsp;means&nbsp;that&nbsp;we&nbsp;are&nbsp;creating&nbsp;an&nbsp;ioctl&nbsp;command&nbsp;number&nbsp;for&nbsp;passing</span></span> 
<a id="x1-39505r22"></a><span class="ecrm-0500">22</span><span id="textcolor1174"><span class="ectt-0800">&nbsp;*&nbsp;information&nbsp;from&nbsp;a&nbsp;user&nbsp;process&nbsp;to&nbsp;the&nbsp;kernel&nbsp;module.</span></span> 
<a id="x1-39507r23"></a><span class="ecrm-0500">23</span><span id="textcolor1175"><span class="ectt-0800">&nbsp;*</span></span> 
<a id="x1-39509r24"></a><span class="ecrm-0500">24</span><span id="textcolor1176"><span class="ectt-0800">&nbsp;*&nbsp;The&nbsp;first&nbsp;arguments,&nbsp;MAJOR_NUM,&nbsp;is&nbsp;the&nbsp;major&nbsp;device&nbsp;number&nbsp;we&nbsp;are&nbsp;using.</span></span> 
<a id="x1-39511r25"></a><span class="ecrm-0500">25</span><span id="textcolor1177"><span class="ectt-0800">&nbsp;*</span></span> 
<a id="x1-39513r26"></a><span class="ecrm-0500">26</span><span id="textcolor1178"><span class="ectt-0800">&nbsp;*&nbsp;The&nbsp;second&nbsp;argument&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;the&nbsp;command&nbsp;(there&nbsp;could&nbsp;be&nbsp;several</span></span> 
<a id="x1-39515r27"></a><span class="ecrm-0500">27</span><span id="textcolor1179"><span class="ectt-0800">&nbsp;*&nbsp;with&nbsp;different&nbsp;meanings).</span></span> 
<a id="x1-39517r28"></a><span class="ecrm-0500">28</span><span id="textcolor1180"><span class="ectt-0800">&nbsp;*</span></span> 
<a id="x1-39519r29"></a><span class="ecrm-0500">29</span><span id="textcolor1181"><span class="ectt-0800">&nbsp;*&nbsp;The&nbsp;third&nbsp;argument&nbsp;is&nbsp;the&nbsp;type&nbsp;we&nbsp;want&nbsp;to&nbsp;get&nbsp;from&nbsp;the&nbsp;process&nbsp;to&nbsp;the</span></span> 
<a id="x1-39521r30"></a><span class="ecrm-0500">30</span><span id="textcolor1182"><span class="ectt-0800">&nbsp;*&nbsp;kernel.</span></span> 
<a id="x1-39523r31"></a><span class="ecrm-0500">31</span><span id="textcolor1183"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-39525r32"></a><span class="ecrm-0500">32</span> 
<a id="x1-39527r33"></a><span class="ecrm-0500">33</span><span id="textcolor1184"><span class="ectt-0800">/*&nbsp;Get&nbsp;the&nbsp;message&nbsp;of&nbsp;the&nbsp;device&nbsp;driver&nbsp;*/</span></span> 
<a id="x1-39529r34"></a><span class="ecrm-0500">34</span><span id="textcolor1185"><span class="ectt-0800">#define&nbsp;IOCTL_GET_MSG&nbsp;_IOR(MAJOR_NUM,&nbsp;1,&nbsp;char&nbsp;*)</span></span> 
<a id="x1-39531r35"></a><span class="ecrm-0500">35</span><span id="textcolor1186"><span class="ectt-0800">/*&nbsp;This&nbsp;IOCTL&nbsp;is&nbsp;used&nbsp;for&nbsp;output,&nbsp;to&nbsp;get&nbsp;the&nbsp;message&nbsp;of&nbsp;the&nbsp;device&nbsp;driver.</span></span> 
<a id="x1-39533r36"></a><span class="ecrm-0500">36</span><span id="textcolor1187"><span class="ectt-0800">&nbsp;*&nbsp;However,&nbsp;we&nbsp;still&nbsp;need&nbsp;the&nbsp;buffer&nbsp;to&nbsp;place&nbsp;the&nbsp;message&nbsp;in&nbsp;to&nbsp;be&nbsp;input,</span></span> 
<a id="x1-39535r37"></a><span class="ecrm-0500">37</span><span id="textcolor1188"><span class="ectt-0800">&nbsp;*&nbsp;as&nbsp;it&nbsp;is&nbsp;allocated&nbsp;by&nbsp;the&nbsp;process.</span></span> 
<a id="x1-39537r38"></a><span class="ecrm-0500">38</span><span id="textcolor1189"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-39539r39"></a><span class="ecrm-0500">39</span> 
<a id="x1-39541r40"></a><span class="ecrm-0500">40</span><span id="textcolor1190"><span class="ectt-0800">/*&nbsp;Get&nbsp;the&nbsp;n</span><span class="tctt-0800">'</span><span class="ectt-0800">th&nbsp;byte&nbsp;of&nbsp;the&nbsp;message&nbsp;*/</span></span> 
<a id="x1-39543r41"></a><span class="ecrm-0500">41</span><span id="textcolor1191"><span class="ectt-0800">#define&nbsp;IOCTL_GET_NTH_BYTE&nbsp;_IOWR(MAJOR_NUM,&nbsp;2,&nbsp;int)</span></span> 
<a id="x1-39545r42"></a><span class="ecrm-0500">42</span><span id="textcolor1192"><span class="ectt-0800">/*&nbsp;The&nbsp;IOCTL&nbsp;is&nbsp;used&nbsp;for&nbsp;both&nbsp;input&nbsp;and&nbsp;output.&nbsp;It&nbsp;receives&nbsp;from&nbsp;the&nbsp;user</span></span> 
<a id="x1-39547r43"></a><span class="ecrm-0500">43</span><span id="textcolor1193"><span class="ectt-0800">&nbsp;*&nbsp;a&nbsp;number,&nbsp;n,&nbsp;and&nbsp;returns&nbsp;Message[n].</span></span> 
<a id="x1-39549r44"></a><span class="ecrm-0500">44</span><span id="textcolor1194"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-39551r45"></a><span class="ecrm-0500">45</span> 
<a id="x1-39553r46"></a><span class="ecrm-0500">46</span><span id="textcolor1195"><span class="ectt-0800">/*&nbsp;The&nbsp;name&nbsp;of&nbsp;the&nbsp;device&nbsp;file&nbsp;*/</span></span> 
<a id="x1-39555r47"></a><span class="ecrm-0500">47</span><span id="textcolor1196"><span class="ectt-0800">#define&nbsp;DEVICE_FILE_NAME&nbsp;"char_dev"</span></span> 
<a id="x1-39557r48"></a><span class="ecrm-0500">48</span> 
<a id="x1-39559r49"></a><span class="ecrm-0500">49</span><span id="textcolor1197"><span class="ectt-0800">#endif</span></span></pre>

<!-- l. 1 --><p class="indent">
</p>
   <pre class="fancyvrb" id="fancyvrb51"><a id="x1-39561r1"></a><span class="ecrm-0500">1</span><span id="textcolor1198"><span class="ectt-0800">/*</span></span> 
<a id="x1-39563r2"></a><span class="ecrm-0500">2</span><span id="textcolor1199"><span class="ectt-0800">&nbsp;*&nbsp;ioctl.c</span></span> 
<a id="x1-39565r3"></a><span class="ecrm-0500">3</span><span id="textcolor1200"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-39567r4"></a><span class="ecrm-0500">4</span><span id="textcolor1201"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1202"><span class="ectt-0800">&lt;linux/cdev.h&gt;</span></span> 
<a id="x1-39569r5"></a><span class="ecrm-0500">5</span><span id="textcolor1203"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1204"><span class="ectt-0800">&lt;linux/fs.h&gt;</span></span> 
<a id="x1-39571r6"></a><span class="ecrm-0500">6</span><span id="textcolor1205"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1206"><span class="ectt-0800">&lt;linux/init.h&gt;</span></span> 
<a id="x1-39573r7"></a><span class="ecrm-0500">7</span><span id="textcolor1207"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1208"><span class="ectt-0800">&lt;linux/ioctl.h&gt;</span></span> 
<a id="x1-39575r8"></a><span class="ecrm-0500">8</span><span id="textcolor1209"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1210"><span class="ectt-0800">&lt;linux/module.h&gt;</span></span> 
<a id="x1-39577r9"></a><span class="ecrm-0500">9</span><span id="textcolor1211"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1212"><span class="ectt-0800">&lt;linux/slab.h&gt;</span></span> 
<a id="x1-39579r10"></a><span class="ecrm-0500">10</span><span id="textcolor1213"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1214"><span class="ectt-0800">&lt;linux/uaccess.h&gt;</span></span> 
<a id="x1-39581r11"></a><span class="ecrm-0500">11</span> 
<a id="x1-39583r12"></a><span class="ecrm-0500">12</span><span id="textcolor1215"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;ioctl_arg&nbsp;{</span> 
<a id="x1-39585r13"></a><span class="ecrm-0500">13</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1216"><span class="ectt-0800">unsigned</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1217"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;reg;</span> 
<a id="x1-39587r14"></a><span class="ecrm-0500">14</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1218"><span class="ectt-0800">unsigned</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1219"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;val;</span> 
<a id="x1-39589r15"></a><span class="ecrm-0500">15</span><span class="ectt-0800">};</span> 
<a id="x1-39591r16"></a><span class="ecrm-0500">16</span> 
<a id="x1-39593r17"></a><span class="ecrm-0500">17</span><span id="textcolor1220"><span class="ectt-0800">/*&nbsp;Documentation/ioctl/ioctl-number.txt&nbsp;*/</span></span> 
<a id="x1-39595r18"></a><span class="ecrm-0500">18</span><span id="textcolor1221"><span class="ectt-0800">#define&nbsp;IOC_MAGIC&nbsp;</span><span class="tctt-0800">'</span><span class="ectt-0800">\x66</span><span class="tctt-0800">'</span></span> 
<a id="x1-39597r19"></a><span class="ecrm-0500">19</span> 
<a id="x1-39599r20"></a><span class="ecrm-0500">20</span><span id="textcolor1222"><span class="ectt-0800">#define&nbsp;IOCTL_VALSET&nbsp;_IOW(IOC_MAGIC,&nbsp;0,&nbsp;struct&nbsp;ioctl_arg)</span></span> 
<a id="x1-39601r21"></a><span class="ecrm-0500">21</span><span id="textcolor1223"><span class="ectt-0800">#define&nbsp;IOCTL_VALGET&nbsp;_IOR(IOC_MAGIC,&nbsp;1,&nbsp;struct&nbsp;ioctl_arg)</span></span> 
<a id="x1-39603r22"></a><span class="ecrm-0500">22</span><span id="textcolor1224"><span class="ectt-0800">#define&nbsp;IOCTL_VALGET_NUM&nbsp;_IOR(IOC_MAGIC,&nbsp;2,&nbsp;int)</span></span> 
<a id="x1-39605r23"></a><span class="ecrm-0500">23</span><span id="textcolor1225"><span class="ectt-0800">#define&nbsp;IOCTL_VALSET_NUM&nbsp;_IOW(IOC_MAGIC,&nbsp;3,&nbsp;int)</span></span> 
<a id="x1-39607r24"></a><span class="ecrm-0500">24</span> 
<a id="x1-39609r25"></a><span class="ecrm-0500">25</span><span id="textcolor1226"><span class="ectt-0800">#define&nbsp;IOCTL_VAL_MAXNR&nbsp;3</span></span> 
<a id="x1-39611r26"></a><span class="ecrm-0500">26</span><span id="textcolor1227"><span class="ectt-0800">#define&nbsp;DRIVER_NAME&nbsp;"ioctltest"</span></span> 
<a id="x1-39613r27"></a><span class="ecrm-0500">27</span> 
<a id="x1-39615r28"></a><span class="ecrm-0500">28</span><span id="textcolor1228"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1229"><span class="ectt-0800">unsigned</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1230"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;test_ioctl_major&nbsp;=&nbsp;0;</span> 
<a id="x1-39617r29"></a><span class="ecrm-0500">29</span><span id="textcolor1231"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1232"><span class="ectt-0800">unsigned</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1233"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;num_of_dev&nbsp;=&nbsp;1;</span> 
<a id="x1-39619r30"></a><span class="ecrm-0500">30</span><span id="textcolor1234"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1235"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;cdev&nbsp;test_ioctl_cdev;</span> 
<a id="x1-39621r31"></a><span class="ecrm-0500">31</span><span id="textcolor1236"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1237"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;ioctl_num&nbsp;=&nbsp;0;</span> 
<a id="x1-39623r32"></a><span class="ecrm-0500">32</span> 
<a id="x1-39625r33"></a><span class="ecrm-0500">33</span><span id="textcolor1238"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;test_ioctl_data&nbsp;{</span> 
<a id="x1-39627r34"></a><span class="ecrm-0500">34</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1239"><span class="ectt-0800">unsigned</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1240"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;val;</span> 
<a id="x1-39629r35"></a><span class="ecrm-0500">35</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;rwlock_t&nbsp;lock;</span> 
<a id="x1-39631r36"></a><span class="ecrm-0500">36</span><span class="ectt-0800">};</span> 
<a id="x1-39633r37"></a><span class="ecrm-0500">37</span> 
<a id="x1-39635r38"></a><span class="ecrm-0500">38</span><span id="textcolor1241"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1242"><span class="ectt-0800">long</span></span><span class="ectt-0800">&nbsp;test_ioctl_ioctl(</span><span id="textcolor1243"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*filp,</span> 
<a id="x1-39637r39"></a><span class="ecrm-0500">39</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1244"><span class="ectt-0800">unsigned</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1245"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;cmd,</span> 
<a id="x1-39639r40"></a><span class="ecrm-0500">40</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1246"><span class="ectt-0800">unsigned</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1247"><span class="ectt-0800">long</span></span><span class="ectt-0800">&nbsp;arg)</span> 
<a id="x1-39641r41"></a><span class="ecrm-0500">41</span><span class="ectt-0800">{</span> 
<a id="x1-39643r42"></a><span class="ecrm-0500">42</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1248"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;test_ioctl_data&nbsp;*ioctl_data&nbsp;=&nbsp;filp-&gt;private_data;</span> 
<a id="x1-39645r43"></a><span class="ecrm-0500">43</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1249"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;retval&nbsp;=&nbsp;0;</span> 
<a id="x1-39647r44"></a><span class="ecrm-0500">44</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1250"><span class="ectt-0800">unsigned</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1251"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;val;</span> 
<a id="x1-39649r45"></a><span class="ecrm-0500">45</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1252"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;ioctl_arg&nbsp;data;</span> 
<a id="x1-39651r46"></a><span class="ecrm-0500">46</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;memset(&amp;data,&nbsp;0,&nbsp;</span><span id="textcolor1253"><span class="ectt-0800">sizeof</span></span><span class="ectt-0800">(data));</span> 
<a id="x1-39653r47"></a><span class="ecrm-0500">47</span> 
<a id="x1-39655r48"></a><span class="ecrm-0500">48</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1254"><span class="ectt-0800">switch</span></span><span class="ectt-0800">&nbsp;(cmd)&nbsp;{</span> 
<a id="x1-39657r49"></a><span class="ecrm-0500">49</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1255"><span class="ectt-0800">case</span></span><span class="ectt-0800">&nbsp;IOCTL_VALSET:</span> 
<a id="x1-39659r50"></a><span class="ecrm-0500">50</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1256"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(copy_from_user(&amp;data,&nbsp;(</span><span id="textcolor1257"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;__user&nbsp;*)&nbsp;arg,&nbsp;</span><span id="textcolor1258"><span class="ectt-0800">sizeof</span></span><span class="ectt-0800">(data)))&nbsp;{</span> 
<a id="x1-39661r51"></a><span class="ecrm-0500">51</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;retval&nbsp;=&nbsp;-EFAULT;</span> 
<a id="x1-39663r52"></a><span class="ecrm-0500">52</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1259"><span class="ectt-0800">goto</span></span><span class="ectt-0800">&nbsp;done;</span> 
<a id="x1-39665r53"></a><span class="ecrm-0500">53</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-39667r54"></a><span class="ecrm-0500">54</span> 
<a id="x1-39669r55"></a><span class="ecrm-0500">55</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pr_alert(</span><span id="textcolor1260"><span class="ectt-0800">"IOCTL&nbsp;set&nbsp;val:%x&nbsp;.</span></span><span id="textcolor1261"><span class="ectt-0800">\n</span></span><span id="textcolor1262"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;data.val);</span> 
<a id="x1-39671r56"></a><span class="ecrm-0500">56</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;write_lock(&amp;ioctl_data-&gt;lock);</span> 
<a id="x1-39673r57"></a><span class="ecrm-0500">57</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ioctl_data-&gt;val&nbsp;=&nbsp;data.val;</span> 
<a id="x1-39675r58"></a><span class="ecrm-0500">58</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;write_unlock(&amp;ioctl_data-&gt;lock);</span> 
<a id="x1-39677r59"></a><span class="ecrm-0500">59</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1263"><span class="ectt-0800">break</span></span><span class="ectt-0800">;</span> 
<a id="x1-39679r60"></a><span class="ecrm-0500">60</span> 
<a id="x1-39681r61"></a><span class="ecrm-0500">61</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1264"><span class="ectt-0800">case</span></span><span class="ectt-0800">&nbsp;IOCTL_VALGET:</span> 
<a id="x1-39683r62"></a><span class="ecrm-0500">62</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;read_lock(&amp;ioctl_data-&gt;lock);</span> 
<a id="x1-39685r63"></a><span class="ecrm-0500">63</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;val&nbsp;=&nbsp;ioctl_data-&gt;val;</span> 
<a id="x1-39687r64"></a><span class="ecrm-0500">64</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;read_unlock(&amp;ioctl_data-&gt;lock);</span> 
<a id="x1-39689r65"></a><span class="ecrm-0500">65</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data.val&nbsp;=&nbsp;val;</span> 
<a id="x1-39691r66"></a><span class="ecrm-0500">66</span> 
<a id="x1-39693r67"></a><span class="ecrm-0500">67</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1265"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(copy_to_user((</span><span id="textcolor1266"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;__user&nbsp;*)&nbsp;arg,&nbsp;&amp;data,&nbsp;</span><span id="textcolor1267"><span class="ectt-0800">sizeof</span></span><span class="ectt-0800">(data)))&nbsp;{</span> 
<a id="x1-39695r68"></a><span class="ecrm-0500">68</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;retval&nbsp;=&nbsp;-EFAULT;</span> 
<a id="x1-39697r69"></a><span class="ecrm-0500">69</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1268"><span class="ectt-0800">goto</span></span><span class="ectt-0800">&nbsp;done;</span> 
<a id="x1-39699r70"></a><span class="ecrm-0500">70</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-39701r71"></a><span class="ecrm-0500">71</span> 
<a id="x1-39703r72"></a><span class="ecrm-0500">72</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1269"><span class="ectt-0800">break</span></span><span class="ectt-0800">;</span> 
<a id="x1-39705r73"></a><span class="ecrm-0500">73</span> 
<a id="x1-39707r74"></a><span class="ecrm-0500">74</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1270"><span class="ectt-0800">case</span></span><span class="ectt-0800">&nbsp;IOCTL_VALGET_NUM:</span> 
<a id="x1-39709r75"></a><span class="ecrm-0500">75</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;retval&nbsp;=&nbsp;__put_user(ioctl_num,&nbsp;(</span><span id="textcolor1271"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;__user&nbsp;*)&nbsp;arg);</span> 
<a id="x1-39711r76"></a><span class="ecrm-0500">76</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1272"><span class="ectt-0800">break</span></span><span class="ectt-0800">;</span> 
<a id="x1-39713r77"></a><span class="ecrm-0500">77</span> 
<a id="x1-39715r78"></a><span class="ecrm-0500">78</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1273"><span class="ectt-0800">case</span></span><span class="ectt-0800">&nbsp;IOCTL_VALSET_NUM:</span> 
<a id="x1-39717r79"></a><span class="ecrm-0500">79</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ioctl_num&nbsp;=&nbsp;arg;</span> 
<a id="x1-39719r80"></a><span class="ecrm-0500">80</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1274"><span class="ectt-0800">break</span></span><span class="ectt-0800">;</span> 
<a id="x1-39721r81"></a><span class="ecrm-0500">81</span> 
<a id="x1-39723r82"></a><span class="ecrm-0500">82</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1275"><span class="ectt-0800">default</span></span><span class="ectt-0800">:</span> 
<a id="x1-39725r83"></a><span class="ecrm-0500">83</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;retval&nbsp;=&nbsp;-ENOTTY;</span> 
<a id="x1-39727r84"></a><span class="ecrm-0500">84</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-39729r85"></a><span class="ecrm-0500">85</span> 
<a id="x1-39731r86"></a><span class="ecrm-0500">86</span><span class="ectt-0800">done:</span> 
<a id="x1-39733r87"></a><span class="ecrm-0500">87</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1276"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;retval;</span> 
<a id="x1-39735r88"></a><span class="ecrm-0500">88</span><span class="ectt-0800">}</span> 
<a id="x1-39737r89"></a><span class="ecrm-0500">89</span> 
<a id="x1-39739r90"></a><span class="ecrm-0500">90</span><span id="textcolor1277"><span class="ectt-0800">ssize_t</span></span><span class="ectt-0800">&nbsp;test_ioctl_read(</span><span id="textcolor1278"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*filp,</span> 
<a id="x1-39741r91"></a><span class="ecrm-0500">91</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1279"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;__user&nbsp;*buf,</span> 
<a id="x1-39743r92"></a><span class="ecrm-0500">92</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1280"><span class="ectt-0800">size_t</span></span><span class="ectt-0800">&nbsp;count,</span> 
<a id="x1-39745r93"></a><span class="ecrm-0500">93</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;loff_t&nbsp;*f_pos)</span> 
<a id="x1-39747r94"></a><span class="ecrm-0500">94</span><span class="ectt-0800">{</span> 
<a id="x1-39749r95"></a><span class="ecrm-0500">95</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1281"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;test_ioctl_data&nbsp;*ioctl_data&nbsp;=&nbsp;filp-&gt;private_data;</span> 
<a id="x1-39751r96"></a><span class="ecrm-0500">96</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1282"><span class="ectt-0800">unsigned</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1283"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;val;</span> 
<a id="x1-39753r97"></a><span class="ecrm-0500">97</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1284"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;retval;</span> 
<a id="x1-39755r98"></a><span class="ecrm-0500">98</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1285"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;i&nbsp;=&nbsp;0;</span> 
<a id="x1-39757r99"></a><span class="ecrm-0500">99</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;read_lock(&amp;ioctl_data-&gt;lock);</span> 
<a id="x1-39759r100"></a><span class="ecrm-0500">100</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;val&nbsp;=&nbsp;ioctl_data-&gt;val;</span> 
<a id="x1-39761r101"></a><span class="ecrm-0500">101</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;read_unlock(&amp;ioctl_data-&gt;lock);</span> 
<a id="x1-39763r102"></a><span class="ecrm-0500">102</span> 
<a id="x1-39765r103"></a><span class="ecrm-0500">103</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1286"><span class="ectt-0800">for</span></span><span class="ectt-0800">&nbsp;(;&nbsp;i&nbsp;&lt;&nbsp;count;&nbsp;i++)&nbsp;{</span> 
<a id="x1-39767r104"></a><span class="ecrm-0500">104</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1287"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(copy_to_user(&amp;buf[i],&nbsp;&amp;val,&nbsp;1))&nbsp;{</span> 
<a id="x1-39769r105"></a><span class="ecrm-0500">105</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;retval&nbsp;=&nbsp;-EFAULT;</span> 
<a id="x1-39771r106"></a><span class="ecrm-0500">106</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1288"><span class="ectt-0800">goto</span></span><span class="ectt-0800">&nbsp;out;</span> 
<a id="x1-39773r107"></a><span class="ecrm-0500">107</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-39775r108"></a><span class="ecrm-0500">108</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-39777r109"></a><span class="ecrm-0500">109</span> 
<a id="x1-39779r110"></a><span class="ecrm-0500">110</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;retval&nbsp;=&nbsp;count;</span> 
<a id="x1-39781r111"></a><span class="ecrm-0500">111</span><span class="ectt-0800">out:</span> 
<a id="x1-39783r112"></a><span class="ecrm-0500">112</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1289"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;retval;</span> 
<a id="x1-39785r113"></a><span class="ecrm-0500">113</span><span class="ectt-0800">}</span> 
<a id="x1-39787r114"></a><span class="ecrm-0500">114</span> 
<a id="x1-39789r115"></a><span class="ecrm-0500">115</span><span id="textcolor1290"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1291"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;test_ioctl_close(</span><span id="textcolor1292"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;inode&nbsp;*inode,&nbsp;</span><span id="textcolor1293"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*filp)</span> 
<a id="x1-39791r116"></a><span class="ecrm-0500">116</span><span class="ectt-0800">{</span> 
<a id="x1-39793r117"></a><span class="ecrm-0500">117</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_alert(</span><span id="textcolor1294"><span class="ectt-0800">"%s&nbsp;call.</span></span><span id="textcolor1295"><span class="ectt-0800">\n</span></span><span id="textcolor1296"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;__func__);</span> 
<a id="x1-39795r118"></a><span class="ecrm-0500">118</span> 
<a id="x1-39797r119"></a><span class="ecrm-0500">119</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1297"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(filp-&gt;private_data)&nbsp;{</span> 
<a id="x1-39799r120"></a><span class="ecrm-0500">120</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kfree(filp-&gt;private_data);</span> 
<a id="x1-39801r121"></a><span class="ecrm-0500">121</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;filp-&gt;private_data&nbsp;=&nbsp;NULL;</span> 
<a id="x1-39803r122"></a><span class="ecrm-0500">122</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-39805r123"></a><span class="ecrm-0500">123</span> 
<a id="x1-39807r124"></a><span class="ecrm-0500">124</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1298"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;0;</span> 
<a id="x1-39809r125"></a><span class="ecrm-0500">125</span><span class="ectt-0800">}</span> 
<a id="x1-39811r126"></a><span class="ecrm-0500">126</span> 
<a id="x1-39813r127"></a><span class="ecrm-0500">127</span><span id="textcolor1299"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1300"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;test_ioctl_open(</span><span id="textcolor1301"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;inode&nbsp;*inode,&nbsp;</span><span id="textcolor1302"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*filp)</span> 
<a id="x1-39815r128"></a><span class="ecrm-0500">128</span><span class="ectt-0800">{</span> 
<a id="x1-39817r129"></a><span class="ecrm-0500">129</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1303"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;test_ioctl_data&nbsp;*ioctl_data;</span> 
<a id="x1-39819r130"></a><span class="ecrm-0500">130</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_alert(</span><span id="textcolor1304"><span class="ectt-0800">"%s&nbsp;call.</span></span><span id="textcolor1305"><span class="ectt-0800">\n</span></span><span id="textcolor1306"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;__func__);</span> 
<a id="x1-39821r131"></a><span class="ecrm-0500">131</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;ioctl_data&nbsp;=&nbsp;kmalloc(</span><span id="textcolor1307"><span class="ectt-0800">sizeof</span></span><span class="ectt-0800">(</span><span id="textcolor1308"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;test_ioctl_data),&nbsp;GFP_KERNEL);</span> 
<a id="x1-39823r132"></a><span class="ecrm-0500">132</span> 
<a id="x1-39825r133"></a><span class="ecrm-0500">133</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1309"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(ioctl_data&nbsp;==&nbsp;NULL)&nbsp;{</span> 
<a id="x1-39827r134"></a><span class="ecrm-0500">134</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1310"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;-ENOMEM;</span> 
<a id="x1-39829r135"></a><span class="ecrm-0500">135</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-39831r136"></a><span class="ecrm-0500">136</span> 
<a id="x1-39833r137"></a><span class="ecrm-0500">137</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;rwlock_init(&amp;ioctl_data-&gt;lock);</span> 
<a id="x1-39835r138"></a><span class="ecrm-0500">138</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;ioctl_data-&gt;val&nbsp;=&nbsp;0xFF;</span> 
<a id="x1-39837r139"></a><span class="ecrm-0500">139</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;filp-&gt;private_data&nbsp;=&nbsp;ioctl_data;</span> 
<a id="x1-39839r140"></a><span class="ecrm-0500">140</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1311"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;0;</span> 
<a id="x1-39841r141"></a><span class="ecrm-0500">141</span><span class="ectt-0800">}</span> 
<a id="x1-39843r142"></a><span class="ecrm-0500">142</span> 
<a id="x1-39845r143"></a><span class="ecrm-0500">143</span><span id="textcolor1312"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file_operations&nbsp;fops&nbsp;=&nbsp;{</span> 
<a id="x1-39847r144"></a><span class="ecrm-0500">144</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.owner&nbsp;=&nbsp;THIS_MODULE,</span> 
<a id="x1-39849r145"></a><span class="ecrm-0500">145</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.open&nbsp;=&nbsp;test_ioctl_open,</span> 
<a id="x1-39851r146"></a><span class="ecrm-0500">146</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.release&nbsp;=&nbsp;test_ioctl_close,</span> 
<a id="x1-39853r147"></a><span class="ecrm-0500">147</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.read&nbsp;=&nbsp;test_ioctl_read,</span> 
<a id="x1-39855r148"></a><span class="ecrm-0500">148</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.unlocked_ioctl&nbsp;=&nbsp;test_ioctl_ioctl,</span> 
<a id="x1-39857r149"></a><span class="ecrm-0500">149</span><span class="ectt-0800">};</span> 
<a id="x1-39859r150"></a><span class="ecrm-0500">150</span> 
<a id="x1-39861r151"></a><span class="ecrm-0500">151</span><span id="textcolor1313"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1314"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;ioctl_init(</span><span id="textcolor1315"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-39863r152"></a><span class="ecrm-0500">152</span><span class="ectt-0800">{</span> 
<a id="x1-39865r153"></a><span class="ecrm-0500">153</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1316"><span class="ectt-0800">dev_t</span></span><span class="ectt-0800">&nbsp;dev&nbsp;=&nbsp;MKDEV(test_ioctl_major,&nbsp;0);</span> 
<a id="x1-39867r154"></a><span class="ecrm-0500">154</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1317"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;alloc_ret&nbsp;=&nbsp;0;</span> 
<a id="x1-39869r155"></a><span class="ecrm-0500">155</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1318"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;cdev_ret&nbsp;=&nbsp;0;</span> 
<a id="x1-39871r156"></a><span class="ecrm-0500">156</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;alloc_ret&nbsp;=&nbsp;alloc_chrdev_region(&amp;dev,&nbsp;0,&nbsp;num_of_dev,&nbsp;DRIVER_NAME);</span> 
<a id="x1-39873r157"></a><span class="ecrm-0500">157</span> 
<a id="x1-39875r158"></a><span class="ecrm-0500">158</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1319"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(alloc_ret)&nbsp;{</span> 
<a id="x1-39877r159"></a><span class="ecrm-0500">159</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1320"><span class="ectt-0800">goto</span></span><span class="ectt-0800">&nbsp;error;</span> 
<a id="x1-39879r160"></a><span class="ecrm-0500">160</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-39881r161"></a><span class="ecrm-0500">161</span> 
<a id="x1-39883r162"></a><span class="ecrm-0500">162</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;test_ioctl_major&nbsp;=&nbsp;MAJOR(dev);</span> 
<a id="x1-39885r163"></a><span class="ecrm-0500">163</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;cdev_init(&amp;test_ioctl_cdev,&nbsp;&amp;fops);</span> 
<a id="x1-39887r164"></a><span class="ecrm-0500">164</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;cdev_ret&nbsp;=&nbsp;cdev_add(&amp;test_ioctl_cdev,&nbsp;dev,&nbsp;num_of_dev);</span> 
<a id="x1-39889r165"></a><span class="ecrm-0500">165</span> 
<a id="x1-39891r166"></a><span class="ecrm-0500">166</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1321"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(cdev_ret)&nbsp;{</span> 
<a id="x1-39893r167"></a><span class="ecrm-0500">167</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1322"><span class="ectt-0800">goto</span></span><span class="ectt-0800">&nbsp;error;</span> 
<a id="x1-39895r168"></a><span class="ecrm-0500">168</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-39897r169"></a><span class="ecrm-0500">169</span> 
<a id="x1-39899r170"></a><span class="ecrm-0500">170</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_alert(</span><span id="textcolor1323"><span class="ectt-0800">"%s&nbsp;driver(major:&nbsp;%d)&nbsp;installed.</span></span><span id="textcolor1324"><span class="ectt-0800">\n</span></span><span id="textcolor1325"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;DRIVER_NAME,</span> 
<a id="x1-39901r171"></a><span class="ecrm-0500">171</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;test_ioctl_major);</span> 
<a id="x1-39903r172"></a><span class="ecrm-0500">172</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1326"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;0;</span> 
<a id="x1-39905r173"></a><span class="ecrm-0500">173</span><span class="ectt-0800">error:</span> 
<a id="x1-39907r174"></a><span class="ecrm-0500">174</span> 
<a id="x1-39909r175"></a><span class="ecrm-0500">175</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1327"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(cdev_ret&nbsp;==&nbsp;0)&nbsp;{</span> 
<a id="x1-39911r176"></a><span class="ecrm-0500">176</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cdev_del(&amp;test_ioctl_cdev);</span> 
<a id="x1-39913r177"></a><span class="ecrm-0500">177</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-39915r178"></a><span class="ecrm-0500">178</span> 
<a id="x1-39917r179"></a><span class="ecrm-0500">179</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1328"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(alloc_ret&nbsp;==&nbsp;0)&nbsp;{</span> 
<a id="x1-39919r180"></a><span class="ecrm-0500">180</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unregister_chrdev_region(dev,&nbsp;num_of_dev);</span> 
<a id="x1-39921r181"></a><span class="ecrm-0500">181</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-39923r182"></a><span class="ecrm-0500">182</span> 
<a id="x1-39925r183"></a><span class="ecrm-0500">183</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1329"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;-1;</span> 
<a id="x1-39927r184"></a><span class="ecrm-0500">184</span><span class="ectt-0800">}</span> 
<a id="x1-39929r185"></a><span class="ecrm-0500">185</span> 
<a id="x1-39931r186"></a><span class="ecrm-0500">186</span><span id="textcolor1330"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1331"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;ioctl_exit(</span><span id="textcolor1332"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-39933r187"></a><span class="ecrm-0500">187</span><span class="ectt-0800">{</span> 
<a id="x1-39935r188"></a><span class="ecrm-0500">188</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1333"><span class="ectt-0800">dev_t</span></span><span class="ectt-0800">&nbsp;dev&nbsp;=&nbsp;MKDEV(test_ioctl_major,&nbsp;0);</span> 
<a id="x1-39937r189"></a><span class="ecrm-0500">189</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;cdev_del(&amp;test_ioctl_cdev);</span> 
<a id="x1-39939r190"></a><span class="ecrm-0500">190</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;unregister_chrdev_region(dev,&nbsp;num_of_dev);</span> 
<a id="x1-39941r191"></a><span class="ecrm-0500">191</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_alert(</span><span id="textcolor1334"><span class="ectt-0800">"%s&nbsp;driver&nbsp;removed.</span></span><span id="textcolor1335"><span class="ectt-0800">\n</span></span><span id="textcolor1336"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;DRIVER_NAME);</span> 
<a id="x1-39943r192"></a><span class="ecrm-0500">192</span><span class="ectt-0800">}</span> 
<a id="x1-39945r193"></a><span class="ecrm-0500">193</span> 
<a id="x1-39947r194"></a><span class="ecrm-0500">194</span><span class="ectt-0800">module_init(ioctl_init);</span> 
<a id="x1-39949r195"></a><span class="ecrm-0500">195</span><span class="ectt-0800">module_exit(ioctl_exit);</span> 
<a id="x1-39951r196"></a><span class="ecrm-0500">196</span> 
<a id="x1-39953r197"></a><span class="ecrm-0500">197</span><span class="ectt-0800">MODULE_LICENSE(</span><span id="textcolor1337"><span class="ectt-0800">"GPL"</span></span><span class="ectt-0800">);</span> 
<a id="x1-39955r198"></a><span class="ecrm-0500">198</span><span class="ectt-0800">MODULE_DESCRIPTION(</span><span id="textcolor1338"><span class="ectt-0800">"This&nbsp;is&nbsp;test_ioctl&nbsp;module"</span></span><span class="ectt-0800">);</span></pre>
<!-- l. 1161 --><p class="noindent">
</p>
                                                                  

                                                                  
   <h3 class="sectionHead" id="system-calls"><span class="titlemark">0.10   </span> <a id="x1-400000.10"></a>System Calls</h3>
<!-- l. 1163 --><p class="noindent">So far, the only thing we’ve done was to use well defined kernel mechanisms to
register <span class="obeylines-h"><span class="verb"><span class="ectt-1000">/proc</span></span></span> files and device handlers. This is fine if you want to do something the
kernel programmers thought you’d want, such as write a device driver. But what if
you want to do something unusual, to change the behavior of the system in some
way? Then, you are mostly on your own.
</p><!-- l. 1168 --><p class="indent">   If you are not being sensible and using a virtual machine then this is where kernel
programming can become hazardous. While writing the example below, I killed the
<code> <span class="ectt-1000">open()</span>
</code> system call. This meant I could not open any files, I could not run any
programs, and I could not shutdown the system. I had to restart the virtual
machine. No important files got anihilated, but if I was doing this on some live
mission critical system then that could have been a possible outcome. To
ensure you do not lose any files, even within a test environment, please run
<code> <span class="ectt-1000">sync</span>
</code> right before you do the <code>  <span class="ectt-1000">insmod</span>
</code> and the <code>  <span class="ectt-1000">rmmod</span>
</code>.
</p><!-- l. 1175 --><p class="indent">   Forget about <span class="obeylines-h"><span class="verb"><span class="ectt-1000">/proc</span></span></span> files, forget about device files. They are just minor details.
Minutiae in the vast expanse of the universe. The real process to kernel
communication mechanism, the one used by all processes, is <span class="ecti-1000">system calls</span>. When a
process requests a service from the kernel (such as opening a file, forking to a new
process, or requesting more memory), this is the mechanism used. If you want to
change the behaviour of the kernel in interesting ways, this is the place to do
it. By the way, if you want to see which system calls a program uses, run
<code> <span class="ectt-1000">strace&nbsp;&lt;arguments&gt;</span>
</code>.
</p><!-- l. 1183 --><p class="indent">   In general, a process is not supposed to be able to access the kernel. It can not
access kernel memory and it can’t call kernel functions. The hardware of the CPU
enforces this (that is the reason why it is called “protected mode” or “page
protection”).
</p><!-- l. 1187 --><p class="indent">   System calls are an exception to this general rule. What happens is that the
process fills the registers with the appropriate values and then calls a special
instruction which jumps to a previously defined location in the kernel (of course, that
location is readable by user processes, it is not writable by them). Under Intel CPUs,
this is done by means of interrupt 0x80. The hardware knows that once you jump to
this location, you are no longer running in restricted user mode, but as the
operating system kernel — and therefore you’re allowed to do whatever you
want.
</p><!-- l. 1192 --><p class="indent">   The location in the kernel a process can jump to is called <span class="obeylines-h"><span class="verb"><span class="ectt-1000">system_call</span></span></span>. The
procedure at that location checks the system call number, which tells the kernel what
service the process requested. Then, it looks at the table of system calls
(<code>  <span class="ectt-1000">sys_call_table</span>
</code>) to see the address of the kernel function to call. Then it calls the function, and after
it returns, does a few system checks and then return back to the process (or to a
different process, if the process time ran out). If you want to read this code, it is
                                                                  

                                                                  
at the source file <span class="obeylines-h"><span class="verb"><span class="ectt-1000">arch/$(architecture)/kernel/entry.S</span></span></span>, after the line
<code> <span class="ectt-1000">ENTRY(system_call)</span>
</code>.
</p><!-- l. 1198 --><p class="indent">   So, if we want to change the way a certain system call works, what we need to do
is to write our own function to implement it (usually by adding a bit of our own
code, and then calling the original function) and then change the pointer at
<code> <span class="ectt-1000">sys_call_table</span>
</code> to point to our function. Because we might be removed later and we
don’t want to leave the system in an unstable state, it’s important for
<code> <span class="ectt-1000">cleanup_module</span>
</code> to restore the table to its original state.
</p><!-- l. 1201 --><p class="indent">   The source code here is an example of such a kernel module. We want to “spy” on a certain
user, and to <code>  <span class="ectt-1000">pr_info()</span>
</code> a message whenever that user opens a file. Towards this end, we
replace the system call to open a file with our own function, called
<code> <span class="ectt-1000">our_sys_open</span>
</code>. This function checks the uid (user’s id) of the current process, and if it is equal to the uid we
spy on, it calls <code>  <span class="ectt-1000">pr_info()</span>
</code> to display the name of the file to be opened. Then, either way, it calls the original
<code> <span class="ectt-1000">open()</span>
</code> function with the same parameters, to actually open the file.
</p><!-- l. 1207 --><p class="indent">   The <code>  <span class="ectt-1000">init_module</span>
</code> function replaces the appropriate location in
<code> <span class="ectt-1000">sys_call_table</span>
</code> and keeps the original pointer in a variable. The
<code> <span class="ectt-1000">cleanup_module</span>
</code> function uses that variable to restore everything back to normal. This approach is
dangerous, because of the possibility of two kernel modules changing the same system
call. Imagine we have two kernel modules, A and B. A’s open system call will be
<code> <span class="ectt-1000">A_open</span>
</code> and B’s will be <code>  <span class="ectt-1000">B_open</span>
</code>. Now, when A is inserted into the kernel, the system call is replaced with
<code> <span class="ectt-1000">A_open</span>
</code>, which will call the original <code>  <span class="ectt-1000">sys_open</span>
</code> when it is done. Next, B is inserted into the kernel, which replaces the system call
with <code>  <span class="ectt-1000">B_open</span>
</code>, which will call what it thinks is the original system call,
<code> <span class="ectt-1000">A_open</span>
</code>, when it’s done.
</p><!-- l. 1214 --><p class="indent">   Now, if B is removed first, everything will be well — it will simply restore the system
call to <code>  <span class="ectt-1000">A_open</span>
</code>, which calls the original. However, if A is removed and then B is removed, the
system will crash. A’s removal will restore the system call to the original,
<code> <span class="ectt-1000">sys_open</span>
</code>, cutting B out of the loop. Then, when B is removed, it will restore the system call to what it thinks
is the original, <code>  <span class="ectt-1000">A_open</span>
                                                                  

                                                                  
</code>, which is no longer in memory. At first glance, it appears we could solve
this particular problem by checking if the system call is equal to our
open function and if so not changing it at all (so that B won’t change
the system call when it is removed), but that will cause an even worse
problem. When A is removed, it sees that the system call was changed to
<code> <span class="ectt-1000">B_open</span>
</code> so that it is no longer pointing to <code>  <span class="ectt-1000">A_open</span>
</code>, so it will not restore it to <code>  <span class="ectt-1000">sys_open</span>
</code> before it is removed from memory. Unfortunately,
<code> <span class="ectt-1000">B_open</span>
</code> will still try to call <code>  <span class="ectt-1000">A_open</span>
</code> which is no longer there, so that even without removing B the system would
crash.
</p><!-- l. 1222 --><p class="indent">   Note that all the related problems make syscall stealing unfeasiable for
production use. In order to keep people from doing potential harmful things
<code> <span class="ectt-1000">sys_call_table</span>
</code> is no longer exported. This means, if you want to do something more than a mere
dry run of this example, you will have to patch your current kernel in order to have
<code> <span class="ectt-1000">sys_call_table</span>
</code> exported. In the example directory you will find a README and the patch. As you
can imagine, such modifications are not to be taken lightly. Do not try this on
valueable systems (ie systems that you do not own - or cannot restore easily). You
will need to get the complete sourcecode of this guide as a tarball in order to get the
patch and the README. Depending on your kernel version, you might even need to
hand apply the patch.
</p><!-- l. 1 --><p class="indent">
</p>
   <pre class="fancyvrb" id="fancyvrb52"><a id="x1-40034r1"></a><span class="ecrm-0500">1</span><span id="textcolor1339"><span class="ectt-0800">/*</span></span> 
<a id="x1-40036r2"></a><span class="ecrm-0500">2</span><span id="textcolor1340"><span class="ectt-0800">&nbsp;*&nbsp;syscall.c</span></span> 
<a id="x1-40038r3"></a><span class="ecrm-0500">3</span><span id="textcolor1341"><span class="ectt-0800">&nbsp;*</span></span> 
<a id="x1-40040r4"></a><span class="ecrm-0500">4</span><span id="textcolor1342"><span class="ectt-0800">&nbsp;*&nbsp;System&nbsp;call&nbsp;"stealing"&nbsp;sample.</span></span> 
<a id="x1-40042r5"></a><span class="ecrm-0500">5</span><span id="textcolor1343"><span class="ectt-0800">&nbsp;*</span></span> 
<a id="x1-40044r6"></a><span class="ecrm-0500">6</span><span id="textcolor1344"><span class="ectt-0800">&nbsp;*&nbsp;Disables&nbsp;page&nbsp;protection&nbsp;at&nbsp;a&nbsp;processor&nbsp;level&nbsp;by&nbsp;changing&nbsp;the&nbsp;16th&nbsp;bit</span></span> 
<a id="x1-40046r7"></a><span class="ecrm-0500">7</span><span id="textcolor1345"><span class="ectt-0800">&nbsp;*&nbsp;in&nbsp;the&nbsp;cr0&nbsp;register&nbsp;(could&nbsp;be&nbsp;Intel&nbsp;specific).</span></span> 
<a id="x1-40048r8"></a><span class="ecrm-0500">8</span><span id="textcolor1346"><span class="ectt-0800">&nbsp;*</span></span> 
<a id="x1-40050r9"></a><span class="ecrm-0500">9</span><span id="textcolor1347"><span class="ectt-0800">&nbsp;*&nbsp;Based&nbsp;on&nbsp;example&nbsp;by&nbsp;Peter&nbsp;Jay&nbsp;Salzman&nbsp;and</span></span> 
<a id="x1-40052r10"></a><span class="ecrm-0500">10</span><span id="textcolor1348"><span class="ectt-0800">&nbsp;*&nbsp;https://bbs.archlinux.org/viewtopic.php?id=139406</span></span> 
<a id="x1-40054r11"></a><span class="ecrm-0500">11</span><span id="textcolor1349"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-40056r12"></a><span class="ecrm-0500">12</span> 
<a id="x1-40058r13"></a><span class="ecrm-0500">13</span><span id="textcolor1350"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1351"><span class="ectt-0800">&lt;linux/delay.h&gt;</span></span> 
<a id="x1-40060r14"></a><span class="ecrm-0500">14</span><span id="textcolor1352"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1353"><span class="ectt-0800">&lt;linux/kernel.h&gt;</span></span> 
<a id="x1-40062r15"></a><span class="ecrm-0500">15</span><span id="textcolor1354"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1355"><span class="ectt-0800">&lt;linux/module.h&gt;</span></span> 
<a id="x1-40064r16"></a><span class="ecrm-0500">16</span><span id="textcolor1356"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1357"><span class="ectt-0800">&lt;linux/moduleparam.h&gt;&nbsp;/*&nbsp;which&nbsp;will&nbsp;have&nbsp;params&nbsp;*/</span></span> 
<a id="x1-40066r17"></a><span class="ecrm-0500">17</span><span id="textcolor1358"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1359"><span class="ectt-0800">&lt;linux/syscalls.h&gt;</span></span> 
<a id="x1-40068r18"></a><span class="ecrm-0500">18</span><span id="textcolor1360"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1361"><span class="ectt-0800">&lt;linux/unistd.h&gt;&nbsp;/*&nbsp;The&nbsp;list&nbsp;of&nbsp;system&nbsp;calls&nbsp;*/</span></span> 
<a id="x1-40070r19"></a><span class="ecrm-0500">19</span> 
<a id="x1-40072r20"></a><span class="ecrm-0500">20</span><span id="textcolor1362"><span class="ectt-0800">/*&nbsp;For&nbsp;the&nbsp;current&nbsp;(process)&nbsp;structure,&nbsp;we&nbsp;need&nbsp;this&nbsp;to&nbsp;know&nbsp;who&nbsp;the</span></span> 
<a id="x1-40074r21"></a><span class="ecrm-0500">21</span><span id="textcolor1363"><span class="ectt-0800">&nbsp;*&nbsp;current&nbsp;user&nbsp;is.</span></span> 
<a id="x1-40076r22"></a><span class="ecrm-0500">22</span><span id="textcolor1364"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-40078r23"></a><span class="ecrm-0500">23</span><span id="textcolor1365"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1366"><span class="ectt-0800">&lt;linux/sched.h&gt;</span></span> 
<a id="x1-40080r24"></a><span class="ecrm-0500">24</span><span id="textcolor1367"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1368"><span class="ectt-0800">&lt;linux/uaccess.h&gt;</span></span> 
<a id="x1-40082r25"></a><span class="ecrm-0500">25</span> 
<a id="x1-40084r26"></a><span class="ecrm-0500">26</span><span id="textcolor1369"><span class="ectt-0800">unsigned</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1370"><span class="ectt-0800">long</span></span><span class="ectt-0800">&nbsp;**sys_call_table;</span> 
<a id="x1-40086r27"></a><span class="ecrm-0500">27</span><span id="textcolor1371"><span class="ectt-0800">unsigned</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1372"><span class="ectt-0800">long</span></span><span class="ectt-0800">&nbsp;original_cr0;</span> 
<a id="x1-40088r28"></a><span class="ecrm-0500">28</span> 
<a id="x1-40090r29"></a><span class="ecrm-0500">29</span><span id="textcolor1373"><span class="ectt-0800">/*&nbsp;UID&nbsp;we&nbsp;want&nbsp;to&nbsp;spy&nbsp;on&nbsp;-&nbsp;will&nbsp;be&nbsp;filled&nbsp;from&nbsp;the&nbsp;command&nbsp;line.&nbsp;*/</span></span> 
<a id="x1-40092r30"></a><span class="ecrm-0500">30</span><span id="textcolor1374"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1375"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;uid;</span> 
<a id="x1-40094r31"></a><span class="ecrm-0500">31</span><span class="ectt-0800">module_param(uid,&nbsp;</span><span id="textcolor1376"><span class="ectt-0800">int</span></span><span class="ectt-0800">,&nbsp;0644);</span> 
<a id="x1-40096r32"></a><span class="ecrm-0500">32</span> 
<a id="x1-40098r33"></a><span class="ecrm-0500">33</span><span id="textcolor1377"><span class="ectt-0800">/*&nbsp;A&nbsp;pointer&nbsp;to&nbsp;the&nbsp;original&nbsp;system&nbsp;call.&nbsp;The&nbsp;reason&nbsp;we&nbsp;keep&nbsp;this,&nbsp;rather</span></span> 
<a id="x1-40100r34"></a><span class="ecrm-0500">34</span><span id="textcolor1378"><span class="ectt-0800">&nbsp;*&nbsp;than&nbsp;call&nbsp;the&nbsp;original&nbsp;function&nbsp;(sys_open),&nbsp;is&nbsp;because&nbsp;somebody&nbsp;else</span></span> 
<a id="x1-40102r35"></a><span class="ecrm-0500">35</span><span id="textcolor1379"><span class="ectt-0800">&nbsp;*&nbsp;might&nbsp;have&nbsp;replaced&nbsp;the&nbsp;system&nbsp;call&nbsp;before&nbsp;us.&nbsp;Note&nbsp;that&nbsp;this&nbsp;is&nbsp;not</span></span> 
<a id="x1-40104r36"></a><span class="ecrm-0500">36</span><span id="textcolor1380"><span class="ectt-0800">&nbsp;*&nbsp;100%&nbsp;safe,&nbsp;because&nbsp;if&nbsp;another&nbsp;module&nbsp;replaced&nbsp;sys_open&nbsp;before&nbsp;us,</span></span> 
<a id="x1-40106r37"></a><span class="ecrm-0500">37</span><span id="textcolor1381"><span class="ectt-0800">&nbsp;*&nbsp;then&nbsp;when&nbsp;we&nbsp;are&nbsp;inserted,&nbsp;we&nbsp;will&nbsp;call&nbsp;the&nbsp;function&nbsp;in&nbsp;that&nbsp;module&nbsp;-</span></span> 
<a id="x1-40108r38"></a><span class="ecrm-0500">38</span><span id="textcolor1382"><span class="ectt-0800">&nbsp;*&nbsp;and&nbsp;it&nbsp;might&nbsp;be&nbsp;removed&nbsp;before&nbsp;we&nbsp;are.</span></span> 
<a id="x1-40110r39"></a><span class="ecrm-0500">39</span><span id="textcolor1383"><span class="ectt-0800">&nbsp;*</span></span> 
<a id="x1-40112r40"></a><span class="ecrm-0500">40</span><span id="textcolor1384"><span class="ectt-0800">&nbsp;*&nbsp;Another&nbsp;reason&nbsp;for&nbsp;this&nbsp;is&nbsp;that&nbsp;we&nbsp;can&nbsp;not&nbsp;get&nbsp;sys_open.</span></span> 
<a id="x1-40114r41"></a><span class="ecrm-0500">41</span><span id="textcolor1385"><span class="ectt-0800">&nbsp;*&nbsp;It&nbsp;is&nbsp;a&nbsp;static&nbsp;variable,&nbsp;so&nbsp;it&nbsp;is&nbsp;not&nbsp;exported.</span></span> 
<a id="x1-40116r42"></a><span class="ecrm-0500">42</span><span id="textcolor1386"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-40118r43"></a><span class="ecrm-0500">43</span><span class="ectt-0800">asmlinkage&nbsp;int&nbsp;(*original_call)(</span><span id="textcolor1387"><span class="ectt-0800">const</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1388"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;*,&nbsp;</span><span id="textcolor1389"><span class="ectt-0800">int</span></span><span class="ectt-0800">,&nbsp;</span><span id="textcolor1390"><span class="ectt-0800">int</span></span><span class="ectt-0800">);</span> 
<a id="x1-40120r44"></a><span class="ecrm-0500">44</span> 
<a id="x1-40122r45"></a><span class="ecrm-0500">45</span><span id="textcolor1391"><span class="ectt-0800">/*&nbsp;The&nbsp;function&nbsp;we&nbsp;will&nbsp;replace&nbsp;sys_open&nbsp;(the&nbsp;function&nbsp;called&nbsp;when&nbsp;you</span></span> 
<a id="x1-40124r46"></a><span class="ecrm-0500">46</span><span id="textcolor1392"><span class="ectt-0800">&nbsp;*&nbsp;call&nbsp;the&nbsp;open&nbsp;system&nbsp;call)&nbsp;with.&nbsp;To&nbsp;find&nbsp;the&nbsp;exact&nbsp;prototype,&nbsp;with</span></span> 
<a id="x1-40126r47"></a><span class="ecrm-0500">47</span><span id="textcolor1393"><span class="ectt-0800">&nbsp;*&nbsp;the&nbsp;number&nbsp;and&nbsp;type&nbsp;of&nbsp;arguments,&nbsp;we&nbsp;find&nbsp;the&nbsp;original&nbsp;function&nbsp;first</span></span> 
<a id="x1-40128r48"></a><span class="ecrm-0500">48</span><span id="textcolor1394"><span class="ectt-0800">&nbsp;*&nbsp;(it&nbsp;is&nbsp;at&nbsp;fs/open.c).</span></span> 
<a id="x1-40130r49"></a><span class="ecrm-0500">49</span><span id="textcolor1395"><span class="ectt-0800">&nbsp;*</span></span> 
<a id="x1-40132r50"></a><span class="ecrm-0500">50</span><span id="textcolor1396"><span class="ectt-0800">&nbsp;*&nbsp;In&nbsp;theory,&nbsp;this&nbsp;means&nbsp;that&nbsp;we&nbsp;are&nbsp;tied&nbsp;to&nbsp;the&nbsp;current&nbsp;version&nbsp;of&nbsp;the</span></span> 
<a id="x1-40134r51"></a><span class="ecrm-0500">51</span><span id="textcolor1397"><span class="ectt-0800">&nbsp;*&nbsp;kernel.&nbsp;In&nbsp;practice,&nbsp;the&nbsp;system&nbsp;calls&nbsp;almost&nbsp;never&nbsp;change&nbsp;(it&nbsp;would</span></span> 
<a id="x1-40136r52"></a><span class="ecrm-0500">52</span><span id="textcolor1398"><span class="ectt-0800">&nbsp;*&nbsp;wreck&nbsp;havoc&nbsp;and&nbsp;require&nbsp;programs&nbsp;to&nbsp;be&nbsp;recompiled,&nbsp;since&nbsp;the&nbsp;system</span></span> 
<a id="x1-40138r53"></a><span class="ecrm-0500">53</span><span id="textcolor1399"><span class="ectt-0800">&nbsp;*&nbsp;calls&nbsp;are&nbsp;the&nbsp;interface&nbsp;between&nbsp;the&nbsp;kernel&nbsp;and&nbsp;the&nbsp;processes).</span></span> 
<a id="x1-40140r54"></a><span class="ecrm-0500">54</span><span id="textcolor1400"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-40142r55"></a><span class="ecrm-0500">55</span><span class="ectt-0800">asmlinkage&nbsp;</span><span id="textcolor1401"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;our_sys_open(</span><span id="textcolor1402"><span class="ectt-0800">const</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1403"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;*filename,&nbsp;</span><span id="textcolor1404"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;flags,&nbsp;</span><span id="textcolor1405"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;mode)</span> 
<a id="x1-40144r56"></a><span class="ecrm-0500">56</span><span class="ectt-0800">{</span> 
<a id="x1-40146r57"></a><span class="ecrm-0500">57</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1406"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;i&nbsp;=&nbsp;0;</span> 
<a id="x1-40148r58"></a><span class="ecrm-0500">58</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1407"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;ch;</span> 
<a id="x1-40150r59"></a><span class="ecrm-0500">59</span> 
<a id="x1-40152r60"></a><span class="ecrm-0500">60</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1408"><span class="ectt-0800">/*&nbsp;Report&nbsp;the&nbsp;file,&nbsp;if&nbsp;relevant&nbsp;*/</span></span> 
<a id="x1-40154r61"></a><span class="ecrm-0500">61</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor1409"><span class="ectt-0800">"Opened&nbsp;file&nbsp;by&nbsp;%d:&nbsp;"</span></span><span class="ectt-0800">,&nbsp;uid);</span> 
<a id="x1-40156r62"></a><span class="ecrm-0500">62</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1410"><span class="ectt-0800">do</span></span><span class="ectt-0800">&nbsp;{</span> 
<a id="x1-40158r63"></a><span class="ecrm-0500">63</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;get_user(ch,&nbsp;filename&nbsp;+&nbsp;i);</span> 
<a id="x1-40160r64"></a><span class="ecrm-0500">64</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i++;</span> 
<a id="x1-40162r65"></a><span class="ecrm-0500">65</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor1411"><span class="ectt-0800">"%c"</span></span><span class="ectt-0800">,&nbsp;ch);</span> 
<a id="x1-40164r66"></a><span class="ecrm-0500">66</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;</span><span id="textcolor1412"><span class="ectt-0800">while</span></span><span class="ectt-0800">&nbsp;(ch&nbsp;!=&nbsp;0);</span> 
<a id="x1-40166r67"></a><span class="ecrm-0500">67</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor1413"><span class="ectt-0800">"</span></span><span id="textcolor1414"><span class="ectt-0800">\n</span></span><span id="textcolor1415"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-40168r68"></a><span class="ecrm-0500">68</span> 
<a id="x1-40170r69"></a><span class="ecrm-0500">69</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1416"><span class="ectt-0800">/*&nbsp;Call&nbsp;the&nbsp;original&nbsp;sys_open&nbsp;-&nbsp;otherwise,&nbsp;we&nbsp;lose&nbsp;the&nbsp;ability&nbsp;to</span></span> 
<a id="x1-40172r70"></a><span class="ecrm-0500">70</span><span id="textcolor1417"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;open&nbsp;files.</span></span> 
<a id="x1-40174r71"></a><span class="ecrm-0500">71</span><span id="textcolor1418"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span></span> 
<a id="x1-40176r72"></a><span class="ecrm-0500">72</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1419"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;original_call(filename,&nbsp;flags,&nbsp;mode);</span> 
<a id="x1-40178r73"></a><span class="ecrm-0500">73</span><span class="ectt-0800">}</span> 
<a id="x1-40180r74"></a><span class="ecrm-0500">74</span> 
<a id="x1-40182r75"></a><span class="ecrm-0500">75</span><span id="textcolor1420"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1421"><span class="ectt-0800">unsigned</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1422"><span class="ectt-0800">long</span></span><span class="ectt-0800">&nbsp;**aquire_sys_call_table(</span><span id="textcolor1423"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-40184r76"></a><span class="ecrm-0500">76</span><span class="ectt-0800">{</span> 
<a id="x1-40186r77"></a><span class="ecrm-0500">77</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1424"><span class="ectt-0800">unsigned</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1425"><span class="ectt-0800">long</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1426"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;offset&nbsp;=&nbsp;PAGE_OFFSET;</span> 
<a id="x1-40188r78"></a><span class="ecrm-0500">78</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1427"><span class="ectt-0800">unsigned</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1428"><span class="ectt-0800">long</span></span><span class="ectt-0800">&nbsp;**sct;</span> 
<a id="x1-40190r79"></a><span class="ecrm-0500">79</span> 
<a id="x1-40192r80"></a><span class="ecrm-0500">80</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1429"><span class="ectt-0800">while</span></span><span class="ectt-0800">&nbsp;(offset&nbsp;&lt;&nbsp;ULLONG_MAX)&nbsp;{</span> 
<a id="x1-40194r81"></a><span class="ecrm-0500">81</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sct&nbsp;=&nbsp;(</span><span id="textcolor1430"><span class="ectt-0800">unsigned</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1431"><span class="ectt-0800">long</span></span><span class="ectt-0800">&nbsp;**)&nbsp;offset;</span> 
<a id="x1-40196r82"></a><span class="ecrm-0500">82</span> 
<a id="x1-40198r83"></a><span class="ecrm-0500">83</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1432"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(sct[__NR_close]&nbsp;==&nbsp;(</span><span id="textcolor1433"><span class="ectt-0800">unsigned</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1434"><span class="ectt-0800">long</span></span><span class="ectt-0800">&nbsp;*)&nbsp;ksys_close)</span> 
<a id="x1-40200r84"></a><span class="ecrm-0500">84</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1435"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;sct;</span> 
<a id="x1-40202r85"></a><span class="ecrm-0500">85</span> 
<a id="x1-40204r86"></a><span class="ecrm-0500">86</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;offset&nbsp;+=&nbsp;</span><span id="textcolor1436"><span class="ectt-0800">sizeof</span></span><span class="ectt-0800">(</span><span id="textcolor1437"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;*);</span> 
<a id="x1-40206r87"></a><span class="ecrm-0500">87</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-40208r88"></a><span class="ecrm-0500">88</span> 
<a id="x1-40210r89"></a><span class="ecrm-0500">89</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1438"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;NULL;</span> 
<a id="x1-40212r90"></a><span class="ecrm-0500">90</span><span class="ectt-0800">}</span> 
<a id="x1-40214r91"></a><span class="ecrm-0500">91</span> 
<a id="x1-40216r92"></a><span class="ecrm-0500">92</span><span id="textcolor1439"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1440"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;__init&nbsp;syscall_start(</span><span id="textcolor1441"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-40218r93"></a><span class="ecrm-0500">93</span><span class="ectt-0800">{</span> 
<a id="x1-40220r94"></a><span class="ecrm-0500">94</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1442"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(!(sys_call_table&nbsp;=&nbsp;aquire_sys_call_table()))</span> 
<a id="x1-40222r95"></a><span class="ecrm-0500">95</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1443"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;-1;</span> 
<a id="x1-40224r96"></a><span class="ecrm-0500">96</span> 
<a id="x1-40226r97"></a><span class="ecrm-0500">97</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;original_cr0&nbsp;=&nbsp;read_cr0();</span> 
<a id="x1-40228r98"></a><span class="ecrm-0500">98</span> 
<a id="x1-40230r99"></a><span class="ecrm-0500">99</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;write_cr0(original_cr0&nbsp;&amp;&nbsp;~0x00010000);</span> 
<a id="x1-40232r100"></a><span class="ecrm-0500">100</span> 
<a id="x1-40234r101"></a><span class="ecrm-0500">101</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1444"><span class="ectt-0800">/*&nbsp;keep&nbsp;track&nbsp;of&nbsp;the&nbsp;original&nbsp;open&nbsp;function&nbsp;*/</span></span> 
<a id="x1-40236r102"></a><span class="ecrm-0500">102</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;original_call&nbsp;=&nbsp;(</span><span id="textcolor1445"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;*)&nbsp;sys_call_table[__NR_open];</span> 
<a id="x1-40238r103"></a><span class="ecrm-0500">103</span> 
<a id="x1-40240r104"></a><span class="ecrm-0500">104</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1446"><span class="ectt-0800">/*&nbsp;use&nbsp;our&nbsp;open&nbsp;function&nbsp;instead&nbsp;*/</span></span> 
<a id="x1-40242r105"></a><span class="ecrm-0500">105</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;sys_call_table[__NR_open]&nbsp;=&nbsp;(</span><span id="textcolor1447"><span class="ectt-0800">unsigned</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1448"><span class="ectt-0800">long</span></span><span class="ectt-0800">&nbsp;*)&nbsp;our_sys_open;</span> 
<a id="x1-40244r106"></a><span class="ecrm-0500">106</span> 
<a id="x1-40246r107"></a><span class="ecrm-0500">107</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;write_cr0(original_cr0);</span> 
<a id="x1-40248r108"></a><span class="ecrm-0500">108</span> 
<a id="x1-40250r109"></a><span class="ecrm-0500">109</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor1449"><span class="ectt-0800">"Spying&nbsp;on&nbsp;UID:%d</span></span><span id="textcolor1450"><span class="ectt-0800">\n</span></span><span id="textcolor1451"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;uid);</span> 
<a id="x1-40252r110"></a><span class="ecrm-0500">110</span> 
<a id="x1-40254r111"></a><span class="ecrm-0500">111</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1452"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;0;</span> 
<a id="x1-40256r112"></a><span class="ecrm-0500">112</span><span class="ectt-0800">}</span> 
<a id="x1-40258r113"></a><span class="ecrm-0500">113</span> 
<a id="x1-40260r114"></a><span class="ecrm-0500">114</span><span id="textcolor1453"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1454"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;__exit&nbsp;syscall_end(</span><span id="textcolor1455"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-40262r115"></a><span class="ecrm-0500">115</span><span class="ectt-0800">{</span> 
<a id="x1-40264r116"></a><span class="ecrm-0500">116</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1456"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(!sys_call_table)</span> 
<a id="x1-40266r117"></a><span class="ecrm-0500">117</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1457"><span class="ectt-0800">return</span></span><span class="ectt-0800">;</span> 
<a id="x1-40268r118"></a><span class="ecrm-0500">118</span> 
<a id="x1-40270r119"></a><span class="ecrm-0500">119</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1458"><span class="ectt-0800">/*&nbsp;Return&nbsp;the&nbsp;system&nbsp;call&nbsp;back&nbsp;to&nbsp;normal&nbsp;*/</span></span> 
<a id="x1-40272r120"></a><span class="ecrm-0500">120</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1459"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(sys_call_table[__NR_open]&nbsp;!=&nbsp;(</span><span id="textcolor1460"><span class="ectt-0800">unsigned</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1461"><span class="ectt-0800">long</span></span><span class="ectt-0800">&nbsp;*)&nbsp;our_sys_open)&nbsp;{</span> 
<a id="x1-40274r121"></a><span class="ecrm-0500">121</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pr_alert(</span><span id="textcolor1462"><span class="ectt-0800">"Somebody&nbsp;else&nbsp;also&nbsp;played&nbsp;with&nbsp;the&nbsp;"</span></span><span class="ectt-0800">);</span> 
<a id="x1-40276r122"></a><span class="ecrm-0500">122</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pr_alert(</span><span id="textcolor1463"><span class="ectt-0800">"open&nbsp;system&nbsp;call</span></span><span id="textcolor1464"><span class="ectt-0800">\n</span></span><span id="textcolor1465"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-40278r123"></a><span class="ecrm-0500">123</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pr_alert(</span><span id="textcolor1466"><span class="ectt-0800">"The&nbsp;system&nbsp;may&nbsp;be&nbsp;left&nbsp;in&nbsp;"</span></span><span class="ectt-0800">);</span> 
<a id="x1-40280r124"></a><span class="ecrm-0500">124</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pr_alert(</span><span id="textcolor1467"><span class="ectt-0800">"an&nbsp;unstable&nbsp;state.</span></span><span id="textcolor1468"><span class="ectt-0800">\n</span></span><span id="textcolor1469"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-40282r125"></a><span class="ecrm-0500">125</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-40284r126"></a><span class="ecrm-0500">126</span> 
<a id="x1-40286r127"></a><span class="ecrm-0500">127</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;write_cr0(original_cr0&nbsp;&amp;&nbsp;~0x00010000);</span> 
<a id="x1-40288r128"></a><span class="ecrm-0500">128</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;sys_call_table[__NR_open]&nbsp;=&nbsp;(</span><span id="textcolor1470"><span class="ectt-0800">unsigned</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1471"><span class="ectt-0800">long</span></span><span class="ectt-0800">&nbsp;*)&nbsp;original_call;</span> 
<a id="x1-40290r129"></a><span class="ecrm-0500">129</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;write_cr0(original_cr0);</span> 
<a id="x1-40292r130"></a><span class="ecrm-0500">130</span> 
<a id="x1-40294r131"></a><span class="ecrm-0500">131</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;msleep(2000);</span> 
<a id="x1-40296r132"></a><span class="ecrm-0500">132</span><span class="ectt-0800">}</span> 
<a id="x1-40298r133"></a><span class="ecrm-0500">133</span> 
<a id="x1-40300r134"></a><span class="ecrm-0500">134</span><span class="ectt-0800">module_init(syscall_start);</span> 
<a id="x1-40302r135"></a><span class="ecrm-0500">135</span><span class="ectt-0800">module_exit(syscall_end);</span> 
<a id="x1-40304r136"></a><span class="ecrm-0500">136</span> 
<a id="x1-40306r137"></a><span class="ecrm-0500">137</span><span class="ectt-0800">MODULE_LICENSE(</span><span id="textcolor1472"><span class="ectt-0800">"GPL"</span></span><span class="ectt-0800">);</span></pre>
<!-- l. 1233 --><p class="noindent">
</p>
   <h3 class="sectionHead" id="blocking-processes-and-threads"><span class="titlemark">0.11   </span> <a id="x1-410000.11"></a>Blocking Processes and threads</h3>
<!-- l. 1235 --><p class="noindent">
</p>
   <h4 class="subsectionHead" id="sleep"><span class="titlemark">0.11.1   </span> <a id="x1-420000.11.1"></a>Sleep</h4>
<!-- l. 1237 --><p class="noindent">What do you do when somebody asks you for something you can not do right
away? If you are a human being and you are bothered by a human being, the
only thing you can say is: "<span class="ecti-1000">Not right now, I’m busy. Go away!</span>". But if you
are a kernel module and you are bothered by a process, you have another
possibility. You can put the process to sleep until you can service it. After all,
processes are being put to sleep by the kernel and woken up all the time (that
                                                                  

                                                                  
is the way multiple processes appear to run on the same time on a single
CPU).
</p><!-- l. 1243 --><p class="indent">   This kernel module is an example of this. The file (called <span class="obeylines-h"><span class="verb"><span class="ectt-1000">/proc/sleep</span></span></span>) can only
be opened by a single process at a time. If the file is already open, the kernel module
calls <code>  <span class="ectt-1000">wait_event_interruptible</span>
</code>. The easiest way to keep a file open is to open it with:
</p><!-- l. 1 --><p class="indent">
</p>
   <pre class="fancyvrb" id="fancyvrb53"><a id="x1-42004r1"></a><span class="ecrm-0500">1</span><span class="ectt-1000">tail&nbsp;-f</span></pre>
<!-- l. 1252 --><p class="indent">   This function changes the status of the task (a task is the kernel data structure
which holds information about a process and the system call it is in, if any) to
<code> <span class="ectt-1000">TASK_INTERRUPTIBLE</span>
</code>, which means that the task will not run until it is woken up somehow, and adds it to
WaitQ, the queue of tasks waiting to access the file. Then, the function calls the
scheduler to context switch to a different process, one which has some use for the
CPU.
</p><!-- l. 1256 --><p class="indent">   When a process is done with the file, it closes it, and
<code> <span class="ectt-1000">module_close</span>
</code> is called. That function wakes up all the processes in the queue (there’s no
mechanism to only wake up one of them). It then returns and the process which just
closed the file can continue to run. In time, the scheduler decides that that
process has had enough and gives control of the CPU to another process.
Eventually, one of the processes which was in the queue will be given control
of the CPU by the scheduler. It starts at the point right after the call to
<code> <span class="ectt-1000">module_interruptible_sleep_on</span>
</code>.
</p><!-- l. 1263 --><p class="indent">   This means that the process is still in kernel mode - as far as the process
is concerned, it issued the open system call and the system call has not
returned yet. The process does not know somebody else used the CPU for
most of the time between the moment it issued the call and the moment it
returned.
</p><!-- l. 1266 --><p class="indent">   It can then proceed to set a global variable to tell all the other processes that the
file is still open and go on with its life. When the other processes get a piece of the
CPU, they’ll see that global variable and go back to sleep.
</p><!-- l. 1269 --><p class="indent">   So we will use <code>  <span class="ectt-1000">tail&nbsp;-f</span>
</code> to keep the file open in the background, while trying to access it with another
process (again in the background, so that we need not switch to a different vt). As
soon as the first background process is killed with kill %1 , the second is woken up, is
able to access the file and finally terminates.
</p><!-- l. 1272 --><p class="indent">   To make our life more interesting, <code>  <span class="ectt-1000">module_close</span>
</code> does not have a monopoly on waking up the processes which wait to access the file.
A signal, such as <span class="ecti-1000">Ctrl +c </span>(<span class="ecbx-1000">SIGINT</span>) can also wake up a process. This is because we
used <code>  <span class="ectt-1000">module_interruptible_sleep_on</span>
</code>. We could have used <code>  <span class="ectt-1000">module_sleep_on</span>
                                                                  

                                                                  
</code> instead, but that would have resulted in extremely angry users whose <span class="ecti-1000">Ctrl+c</span>’s are
ignored.
</p><!-- l. 1276 --><p class="indent">   In that case, we want to return with
<code> <span class="ectt-1000">-EINTR</span>
</code> immediately. This is important so users can, for example, kill the process before it
receives the file.
</p><!-- l. 1278 --><p class="indent">   There is one more point to remember. Some times processes don’t want to sleep, they want
either to get what they want immediately, or to be told it cannot be done. Such processes
use the <code>  <span class="ectt-1000">O_NONBLOCK</span>
</code> flag when opening the file. The kernel is supposed to respond by returning with the error
code <code>  <span class="ectt-1000">-EAGAIN</span>
</code> from operations which would otherwise block, such as opening the file in this example. The
program <code>  <span class="ectt-1000">cat_nonblock</span>
</code>, available in the <span class="obeylines-h"><span class="verb"><span class="ectt-1000">examples/other</span></span></span> directory, can be used to open a file with
<code> <span class="ectt-1000">O_NONBLOCK</span>
</code>.
                                                                  

                                                                  
</p>
   <pre class="verbatim" id="verbatim-11">$&nbsp;sudo&nbsp;insmod&nbsp;sleep.ko
$&nbsp;cat_nonblock&nbsp;/proc/sleep
Last&nbsp;input:
$&nbsp;tail&nbsp;-f&nbsp;/proc/sleep&nbsp;&amp;
Last&nbsp;input:
Last&nbsp;input:
Last&nbsp;input:
Last&nbsp;input:
Last&nbsp;input:
Last&nbsp;input:
Last&nbsp;input:
tail:&nbsp;/proc/sleep:&nbsp;file&nbsp;truncated
[1]&nbsp;6540
$&nbsp;cat_nonblock&nbsp;/proc/sleep
Open&nbsp;would&nbsp;block
$&nbsp;kill&nbsp;%1
[1]+&nbsp;&nbsp;Terminated&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tail&nbsp;-f&nbsp;/proc/sleep
$&nbsp;cat_nonblock&nbsp;/proc/sleep
Last&nbsp;input:
$
</pre>
<!-- l. 1303 --><p class="nopar">
</p><!-- l. 1 --><p class="indent">
</p>
   <pre class="fancyvrb" id="fancyvrb54"><a id="x1-42018r1"></a><span class="ecrm-0500">1</span><span id="textcolor1473"><span class="ectt-0800">/*</span></span> 
<a id="x1-42020r2"></a><span class="ecrm-0500">2</span><span id="textcolor1474"><span class="ectt-0800">&nbsp;*&nbsp;sleep.c&nbsp;-&nbsp;create&nbsp;a&nbsp;/proc&nbsp;file,&nbsp;and&nbsp;if&nbsp;several&nbsp;processes&nbsp;try&nbsp;to&nbsp;open&nbsp;it</span></span> 
<a id="x1-42022r3"></a><span class="ecrm-0500">3</span><span id="textcolor1475"><span class="ectt-0800">&nbsp;*&nbsp;at&nbsp;the&nbsp;same&nbsp;time,&nbsp;put&nbsp;all&nbsp;but&nbsp;one&nbsp;to&nbsp;sleep.</span></span> 
<a id="x1-42024r4"></a><span class="ecrm-0500">4</span><span id="textcolor1476"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-42026r5"></a><span class="ecrm-0500">5</span> 
<a id="x1-42028r6"></a><span class="ecrm-0500">6</span><span id="textcolor1477"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1478"><span class="ectt-0800">&lt;linux/kernel.h&gt;&nbsp;&nbsp;/*&nbsp;We</span><span class="tctt-0800">'</span><span class="ectt-0800">re&nbsp;doing&nbsp;kernel&nbsp;work&nbsp;*/</span></span> 
<a id="x1-42030r7"></a><span class="ecrm-0500">7</span><span id="textcolor1479"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1480"><span class="ectt-0800">&lt;linux/module.h&gt;&nbsp;&nbsp;/*&nbsp;Specifically,&nbsp;a&nbsp;module&nbsp;*/</span></span> 
<a id="x1-42032r8"></a><span class="ecrm-0500">8</span><span id="textcolor1481"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1482"><span class="ectt-0800">&lt;linux/proc_fs.h&gt;&nbsp;/*&nbsp;Necessary&nbsp;because&nbsp;we&nbsp;use&nbsp;proc&nbsp;fs&nbsp;*/</span></span> 
<a id="x1-42034r9"></a><span class="ecrm-0500">9</span><span id="textcolor1483"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1484"><span class="ectt-0800">&lt;linux/sched.h&gt;&nbsp;&nbsp;&nbsp;/*&nbsp;For&nbsp;putting&nbsp;processes&nbsp;to&nbsp;sleep&nbsp;and</span></span> 
<a id="x1-42036r10"></a><span class="ecrm-0500">10</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;waking&nbsp;them&nbsp;up&nbsp;</span><span class="colorbox" id="colorbox1485"><span class="ectt-0800">*/</span></span>  
<a id="x1-42038r11"></a><span class="ecrm-0500">11</span><span id="textcolor1486"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1487"><span class="ectt-0800">&lt;linux/uaccess.h&gt;&nbsp;/*&nbsp;for&nbsp;get_user&nbsp;and&nbsp;put_user&nbsp;*/</span></span> 
<a id="x1-42040r12"></a><span class="ecrm-0500">12</span><span id="textcolor1488"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1489"><span class="ectt-0800">&lt;linux/version.h&gt;</span></span> 
<a id="x1-42042r13"></a><span class="ecrm-0500">13</span> 
<a id="x1-42044r14"></a><span class="ecrm-0500">14</span><span id="textcolor1490"><span class="ectt-0800">#if&nbsp;LINUX_VERSION_CODE&nbsp;&gt;=&nbsp;KERNEL_VERSION(5,&nbsp;6,&nbsp;0)</span></span> 
<a id="x1-42046r15"></a><span class="ecrm-0500">15</span><span id="textcolor1491"><span class="ectt-0800">#define&nbsp;HAVE_PROC_OPS</span></span> 
<a id="x1-42048r16"></a><span class="ecrm-0500">16</span><span id="textcolor1492"><span class="ectt-0800">#endif</span></span> 
<a id="x1-42050r17"></a><span class="ecrm-0500">17</span> 
<a id="x1-42052r18"></a><span class="ecrm-0500">18</span><span id="textcolor1493"><span class="ectt-0800">/*&nbsp;Here&nbsp;we&nbsp;keep&nbsp;the&nbsp;last&nbsp;message&nbsp;received,&nbsp;to&nbsp;prove&nbsp;that&nbsp;we&nbsp;can&nbsp;process&nbsp;our</span></span> 
<a id="x1-42054r19"></a><span class="ecrm-0500">19</span><span id="textcolor1494"><span class="ectt-0800">&nbsp;*&nbsp;input.</span></span> 
<a id="x1-42056r20"></a><span class="ecrm-0500">20</span><span id="textcolor1495"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-42058r21"></a><span class="ecrm-0500">21</span><span id="textcolor1496"><span class="ectt-0800">#define&nbsp;MESSAGE_LENGTH&nbsp;80</span></span> 
<a id="x1-42060r22"></a><span class="ecrm-0500">22</span><span id="textcolor1497"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1498"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;Message[MESSAGE_LENGTH];</span> 
<a id="x1-42062r23"></a><span class="ecrm-0500">23</span> 
<a id="x1-42064r24"></a><span class="ecrm-0500">24</span><span id="textcolor1499"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1500"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;proc_dir_entry&nbsp;*Our_Proc_File;</span> 
<a id="x1-42066r25"></a><span class="ecrm-0500">25</span><span id="textcolor1501"><span class="ectt-0800">#define&nbsp;PROC_ENTRY_FILENAME&nbsp;"sleep"</span></span> 
<a id="x1-42068r26"></a><span class="ecrm-0500">26</span> 
<a id="x1-42070r27"></a><span class="ecrm-0500">27</span><span id="textcolor1502"><span class="ectt-0800">/*&nbsp;Since&nbsp;we&nbsp;use&nbsp;the&nbsp;file&nbsp;operations&nbsp;struct,&nbsp;we&nbsp;can</span><span class="tctt-0800">'</span><span class="ectt-0800">t&nbsp;use&nbsp;the&nbsp;special&nbsp;proc</span></span> 
<a id="x1-42072r28"></a><span class="ecrm-0500">28</span><span id="textcolor1503"><span class="ectt-0800">&nbsp;*&nbsp;output&nbsp;provisions&nbsp;-&nbsp;we&nbsp;have&nbsp;to&nbsp;use&nbsp;a&nbsp;standard&nbsp;read&nbsp;function,&nbsp;which&nbsp;is&nbsp;this</span></span> 
<a id="x1-42074r29"></a><span class="ecrm-0500">29</span><span id="textcolor1504"><span class="ectt-0800">&nbsp;*&nbsp;function.</span></span> 
<a id="x1-42076r30"></a><span class="ecrm-0500">30</span><span id="textcolor1505"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-42078r31"></a><span class="ecrm-0500">31</span><span id="textcolor1506"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1507"><span class="ectt-0800">ssize_t</span></span><span class="ectt-0800">&nbsp;module_output(</span><span id="textcolor1508"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*file,&nbsp;</span><span id="textcolor1509"><span class="ectt-0800">/*&nbsp;see&nbsp;include/linux/fs.h&nbsp;&nbsp;&nbsp;*/</span></span> 
<a id="x1-42080r32"></a><span class="ecrm-0500">32</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1510"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;*buf,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1511"><span class="ectt-0800">/*&nbsp;The&nbsp;buffer&nbsp;to&nbsp;put&nbsp;data&nbsp;to</span></span> 
<a id="x1-42082r33"></a><span class="ecrm-0500">33</span><span id="textcolor1512"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(in&nbsp;the&nbsp;user&nbsp;segment)</span></span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="colorbox" id="colorbox1513"><span class="ectt-0800">*/</span></span>  
<a id="x1-42084r34"></a><span class="ecrm-0500">34</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1514"><span class="ectt-0800">size_t</span></span><span class="ectt-0800">&nbsp;len,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1515"><span class="ectt-0800">/*&nbsp;The&nbsp;length&nbsp;of&nbsp;the&nbsp;buffer&nbsp;*/</span></span> 
<a id="x1-42086r35"></a><span class="ecrm-0500">35</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;loff_t&nbsp;*offset)</span> 
<a id="x1-42088r36"></a><span class="ecrm-0500">36</span><span class="ectt-0800">{</span> 
<a id="x1-42090r37"></a><span class="ecrm-0500">37</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1516"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1517"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;finished&nbsp;=&nbsp;0;</span> 
<a id="x1-42092r38"></a><span class="ecrm-0500">38</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1518"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;i;</span> 
<a id="x1-42094r39"></a><span class="ecrm-0500">39</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1519"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;message[MESSAGE_LENGTH&nbsp;+&nbsp;30];</span> 
<a id="x1-42096r40"></a><span class="ecrm-0500">40</span> 
<a id="x1-42098r41"></a><span class="ecrm-0500">41</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1520"><span class="ectt-0800">/*&nbsp;Return&nbsp;0&nbsp;to&nbsp;signify&nbsp;end&nbsp;of&nbsp;file&nbsp;-&nbsp;that&nbsp;we&nbsp;have&nbsp;nothing&nbsp;more&nbsp;to&nbsp;say</span></span> 
<a id="x1-42100r42"></a><span class="ecrm-0500">42</span><span id="textcolor1521"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;at&nbsp;this&nbsp;point.</span></span> 
<a id="x1-42102r43"></a><span class="ecrm-0500">43</span><span id="textcolor1522"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span></span> 
<a id="x1-42104r44"></a><span class="ecrm-0500">44</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1523"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(finished)&nbsp;{</span> 
<a id="x1-42106r45"></a><span class="ecrm-0500">45</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;finished&nbsp;=&nbsp;0;</span> 
<a id="x1-42108r46"></a><span class="ecrm-0500">46</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1524"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;0;</span> 
<a id="x1-42110r47"></a><span class="ecrm-0500">47</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-42112r48"></a><span class="ecrm-0500">48</span> 
<a id="x1-42114r49"></a><span class="ecrm-0500">49</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;sprintf(message,&nbsp;</span><span id="textcolor1525"><span class="ectt-0800">"Last&nbsp;input:%s</span></span><span id="textcolor1526"><span class="ectt-0800">\n</span></span><span id="textcolor1527"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;Message);</span> 
<a id="x1-42116r50"></a><span class="ecrm-0500">50</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1528"><span class="ectt-0800">for</span></span><span class="ectt-0800">&nbsp;(i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;len&nbsp;&amp;&amp;&nbsp;message[i];&nbsp;i++)</span> 
<a id="x1-42118r51"></a><span class="ecrm-0500">51</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;put_user(message[i],&nbsp;buf&nbsp;+&nbsp;i);</span> 
<a id="x1-42120r52"></a><span class="ecrm-0500">52</span> 
<a id="x1-42122r53"></a><span class="ecrm-0500">53</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;finished&nbsp;=&nbsp;1;</span> 
<a id="x1-42124r54"></a><span class="ecrm-0500">54</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1529"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;i;&nbsp;</span><span id="textcolor1530"><span class="ectt-0800">/*&nbsp;Return&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;"read"&nbsp;*/</span></span> 
<a id="x1-42126r55"></a><span class="ecrm-0500">55</span><span class="ectt-0800">}</span> 
<a id="x1-42128r56"></a><span class="ecrm-0500">56</span> 
<a id="x1-42130r57"></a><span class="ecrm-0500">57</span><span id="textcolor1531"><span class="ectt-0800">/*&nbsp;This&nbsp;function&nbsp;receives&nbsp;input&nbsp;from&nbsp;the&nbsp;user&nbsp;when&nbsp;the&nbsp;user&nbsp;writes&nbsp;to&nbsp;the</span></span> 
<a id="x1-42132r58"></a><span class="ecrm-0500">58</span><span id="textcolor1532"><span class="ectt-0800">&nbsp;*&nbsp;/proc&nbsp;file.</span></span> 
<a id="x1-42134r59"></a><span class="ecrm-0500">59</span><span id="textcolor1533"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-42136r60"></a><span class="ecrm-0500">60</span><span id="textcolor1534"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1535"><span class="ectt-0800">ssize_t</span></span><span class="ectt-0800">&nbsp;module_input(</span><span id="textcolor1536"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*file,&nbsp;</span><span id="textcolor1537"><span class="ectt-0800">/*&nbsp;The&nbsp;file&nbsp;itself&nbsp;*/</span></span> 
<a id="x1-42138r61"></a><span class="ecrm-0500">61</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1538"><span class="ectt-0800">const</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1539"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;*buf,&nbsp;&nbsp;&nbsp;</span><span id="textcolor1540"><span class="ectt-0800">/*&nbsp;The&nbsp;buffer&nbsp;with&nbsp;input&nbsp;*/</span></span> 
<a id="x1-42140r62"></a><span class="ecrm-0500">62</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1541"><span class="ectt-0800">size_t</span></span><span class="ectt-0800">&nbsp;length,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1542"><span class="ectt-0800">/*&nbsp;The&nbsp;buffer</span><span class="tctt-0800">'</span><span class="ectt-0800">s&nbsp;length&nbsp;*/</span></span> 
<a id="x1-42142r63"></a><span class="ecrm-0500">63</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;loff_t&nbsp;*offset)&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1543"><span class="ectt-0800">/*&nbsp;offset&nbsp;to&nbsp;file&nbsp;-&nbsp;ignore&nbsp;*/</span></span> 
<a id="x1-42144r64"></a><span class="ecrm-0500">64</span><span class="ectt-0800">{</span> 
<a id="x1-42146r65"></a><span class="ecrm-0500">65</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1544"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;i;</span> 
<a id="x1-42148r66"></a><span class="ecrm-0500">66</span> 
<a id="x1-42150r67"></a><span class="ecrm-0500">67</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1545"><span class="ectt-0800">/*&nbsp;Put&nbsp;the&nbsp;input&nbsp;into&nbsp;Message,&nbsp;where&nbsp;module_output&nbsp;will&nbsp;later&nbsp;be&nbsp;able</span></span> 
<a id="x1-42152r68"></a><span class="ecrm-0500">68</span><span id="textcolor1546"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;to&nbsp;use&nbsp;it.</span></span> 
<a id="x1-42154r69"></a><span class="ecrm-0500">69</span><span id="textcolor1547"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span></span> 
<a id="x1-42156r70"></a><span class="ecrm-0500">70</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1548"><span class="ectt-0800">for</span></span><span class="ectt-0800">&nbsp;(i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;MESSAGE_LENGTH&nbsp;-&nbsp;1&nbsp;&amp;&amp;&nbsp;i&nbsp;&lt;&nbsp;length;&nbsp;i++)</span> 
<a id="x1-42158r71"></a><span class="ecrm-0500">71</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;get_user(Message[i],&nbsp;buf&nbsp;+&nbsp;i);</span> 
<a id="x1-42160r72"></a><span class="ecrm-0500">72</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1549"><span class="ectt-0800">/*&nbsp;we&nbsp;want&nbsp;a&nbsp;standard,&nbsp;zero&nbsp;terminated&nbsp;string&nbsp;*/</span></span> 
<a id="x1-42162r73"></a><span class="ecrm-0500">73</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;Message[i]&nbsp;=&nbsp;</span><span id="textcolor1550"><span class="tctt-0800">'</span><span class="ectt-0800">\0</span><span class="tctt-0800">'</span></span><span class="ectt-0800">;</span> 
<a id="x1-42164r74"></a><span class="ecrm-0500">74</span> 
<a id="x1-42166r75"></a><span class="ecrm-0500">75</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1551"><span class="ectt-0800">/*&nbsp;We&nbsp;need&nbsp;to&nbsp;return&nbsp;the&nbsp;number&nbsp;of&nbsp;input&nbsp;characters&nbsp;used&nbsp;*/</span></span> 
<a id="x1-42168r76"></a><span class="ecrm-0500">76</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1552"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;i;</span> 
<a id="x1-42170r77"></a><span class="ecrm-0500">77</span><span class="ectt-0800">}</span> 
<a id="x1-42172r78"></a><span class="ecrm-0500">78</span> 
<a id="x1-42174r79"></a><span class="ecrm-0500">79</span><span id="textcolor1553"><span class="ectt-0800">/*&nbsp;1&nbsp;if&nbsp;the&nbsp;file&nbsp;is&nbsp;currently&nbsp;open&nbsp;by&nbsp;somebody&nbsp;*/</span></span> 
<a id="x1-42176r80"></a><span class="ecrm-0500">80</span><span id="textcolor1554"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;Already_Open&nbsp;=&nbsp;0;</span> 
<a id="x1-42178r81"></a><span class="ecrm-0500">81</span> 
<a id="x1-42180r82"></a><span class="ecrm-0500">82</span><span id="textcolor1555"><span class="ectt-0800">/*&nbsp;Queue&nbsp;of&nbsp;processes&nbsp;who&nbsp;want&nbsp;our&nbsp;file&nbsp;*/</span></span> 
<a id="x1-42182r83"></a><span class="ecrm-0500">83</span><span class="ectt-0800">DECLARE_WAIT_QUEUE_HEAD(WaitQ);</span> 
<a id="x1-42184r84"></a><span class="ecrm-0500">84</span> 
<a id="x1-42186r85"></a><span class="ecrm-0500">85</span><span id="textcolor1556"><span class="ectt-0800">/*&nbsp;Called&nbsp;when&nbsp;the&nbsp;/proc&nbsp;file&nbsp;is&nbsp;opened&nbsp;*/</span></span> 
<a id="x1-42188r86"></a><span class="ecrm-0500">86</span><span id="textcolor1557"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1558"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;module_open(</span><span id="textcolor1559"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;inode&nbsp;*inode,&nbsp;</span><span id="textcolor1560"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*file)</span> 
<a id="x1-42190r87"></a><span class="ecrm-0500">87</span><span class="ectt-0800">{</span> 
<a id="x1-42192r88"></a><span class="ecrm-0500">88</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1561"><span class="ectt-0800">/*&nbsp;If&nbsp;the&nbsp;file</span><span class="tctt-0800">'</span><span class="ectt-0800">s&nbsp;flags&nbsp;include&nbsp;O_NONBLOCK,&nbsp;it&nbsp;means&nbsp;the&nbsp;process&nbsp;does&nbsp;not</span></span> 
<a id="x1-42194r89"></a><span class="ecrm-0500">89</span><span id="textcolor1562"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;want&nbsp;to&nbsp;wait&nbsp;for&nbsp;the&nbsp;file.&nbsp;In&nbsp;this&nbsp;case,&nbsp;if&nbsp;the&nbsp;file&nbsp;is&nbsp;already&nbsp;open,</span></span> 
<a id="x1-42196r90"></a><span class="ecrm-0500">90</span><span id="textcolor1563"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;we&nbsp;should&nbsp;fail&nbsp;with&nbsp;-EAGAIN,&nbsp;meaning&nbsp;"you&nbsp;will&nbsp;have&nbsp;to&nbsp;try&nbsp;again",</span></span> 
<a id="x1-42198r91"></a><span class="ecrm-0500">91</span><span id="textcolor1564"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;instead&nbsp;of&nbsp;blocking&nbsp;a&nbsp;process&nbsp;which&nbsp;would&nbsp;rather&nbsp;stay&nbsp;awake.</span></span> 
<a id="x1-42200r92"></a><span class="ecrm-0500">92</span><span id="textcolor1565"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span></span> 
<a id="x1-42202r93"></a><span class="ecrm-0500">93</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1566"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;((file-&gt;f_flags&nbsp;&amp;&nbsp;O_NONBLOCK)&nbsp;&amp;&amp;&nbsp;Already_Open)</span> 
<a id="x1-42204r94"></a><span class="ecrm-0500">94</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1567"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;-EAGAIN;</span> 
<a id="x1-42206r95"></a><span class="ecrm-0500">95</span> 
<a id="x1-42208r96"></a><span class="ecrm-0500">96</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1568"><span class="ectt-0800">/*&nbsp;This&nbsp;is&nbsp;the&nbsp;correct&nbsp;place&nbsp;for&nbsp;try_module_get(THIS_MODULE)&nbsp;because&nbsp;if</span></span> 
<a id="x1-42210r97"></a><span class="ecrm-0500">97</span><span id="textcolor1569"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;a&nbsp;process&nbsp;is&nbsp;in&nbsp;the&nbsp;loop,&nbsp;which&nbsp;is&nbsp;within&nbsp;the&nbsp;kernel&nbsp;module,</span></span> 
<a id="x1-42212r98"></a><span class="ecrm-0500">98</span><span id="textcolor1570"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;the&nbsp;kernel&nbsp;module&nbsp;must&nbsp;not&nbsp;be&nbsp;removed.</span></span> 
<a id="x1-42214r99"></a><span class="ecrm-0500">99</span><span id="textcolor1571"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span></span> 
<a id="x1-42216r100"></a><span class="ecrm-0500">100</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;try_module_get(THIS_MODULE);</span> 
<a id="x1-42218r101"></a><span class="ecrm-0500">101</span> 
<a id="x1-42220r102"></a><span class="ecrm-0500">102</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1572"><span class="ectt-0800">/*&nbsp;If&nbsp;the&nbsp;file&nbsp;is&nbsp;already&nbsp;open,&nbsp;wait&nbsp;until&nbsp;it&nbsp;is&nbsp;not.&nbsp;*/</span></span> 
<a id="x1-42222r103"></a><span class="ecrm-0500">103</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1573"><span class="ectt-0800">while</span></span><span class="ectt-0800">&nbsp;(Already_Open)&nbsp;{</span> 
<a id="x1-42224r104"></a><span class="ecrm-0500">104</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1574"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;i,&nbsp;is_sig&nbsp;=&nbsp;0;</span> 
<a id="x1-42226r105"></a><span class="ecrm-0500">105</span> 
<a id="x1-42228r106"></a><span class="ecrm-0500">106</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1575"><span class="ectt-0800">/*&nbsp;This&nbsp;function&nbsp;puts&nbsp;the&nbsp;current&nbsp;process,&nbsp;including&nbsp;any&nbsp;system</span></span> 
<a id="x1-42230r107"></a><span class="ecrm-0500">107</span><span id="textcolor1576"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;calls,&nbsp;such&nbsp;as&nbsp;us,&nbsp;to&nbsp;sleep.&nbsp;&nbsp;Execution&nbsp;will&nbsp;be&nbsp;resumed&nbsp;right</span></span> 
<a id="x1-42232r108"></a><span class="ecrm-0500">108</span><span id="textcolor1577"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;after&nbsp;the&nbsp;function&nbsp;call,&nbsp;either&nbsp;because&nbsp;somebody&nbsp;called</span></span> 
<a id="x1-42234r109"></a><span class="ecrm-0500">109</span><span id="textcolor1578"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;wake_up(&amp;WaitQ)&nbsp;(only&nbsp;module_close&nbsp;does&nbsp;that,&nbsp;when&nbsp;the&nbsp;file</span></span> 
<a id="x1-42236r110"></a><span class="ecrm-0500">110</span><span id="textcolor1579"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;is&nbsp;closed)&nbsp;or&nbsp;when&nbsp;a&nbsp;signal,&nbsp;such&nbsp;as&nbsp;Ctrl-C,&nbsp;is&nbsp;sent</span></span> 
<a id="x1-42238r111"></a><span class="ecrm-0500">111</span><span id="textcolor1580"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;to&nbsp;the&nbsp;process</span></span> 
<a id="x1-42240r112"></a><span class="ecrm-0500">112</span><span id="textcolor1581"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span></span> 
<a id="x1-42242r113"></a><span class="ecrm-0500">113</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wait_event_interruptible(WaitQ,&nbsp;!Already_Open);</span> 
<a id="x1-42244r114"></a><span class="ecrm-0500">114</span> 
<a id="x1-42246r115"></a><span class="ecrm-0500">115</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1582"><span class="ectt-0800">/*&nbsp;If&nbsp;we&nbsp;woke&nbsp;up&nbsp;because&nbsp;we&nbsp;got&nbsp;a&nbsp;signal&nbsp;we</span><span class="tctt-0800">'</span><span class="ectt-0800">re&nbsp;not&nbsp;blocking,</span></span> 
<a id="x1-42248r116"></a><span class="ecrm-0500">116</span><span id="textcolor1583"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;return&nbsp;-EINTR&nbsp;(fail&nbsp;the&nbsp;system&nbsp;call).&nbsp;&nbsp;This&nbsp;allows&nbsp;processes</span></span> 
<a id="x1-42250r117"></a><span class="ecrm-0500">117</span><span id="textcolor1584"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;to&nbsp;be&nbsp;killed&nbsp;or&nbsp;stopped.</span></span> 
<a id="x1-42252r118"></a><span class="ecrm-0500">118</span><span id="textcolor1585"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span></span> 
<a id="x1-42254r119"></a><span class="ecrm-0500">119</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1586"><span class="ectt-0800">for</span></span><span class="ectt-0800">&nbsp;(i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;_NSIG_WORDS&nbsp;&amp;&amp;&nbsp;!is_sig;&nbsp;i++)</span> 
<a id="x1-42256r120"></a><span class="ecrm-0500">120</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;is_sig&nbsp;=&nbsp;current-&gt;pending.signal.sig[i]&nbsp;&amp;&nbsp;~current-&gt;blocked.sig[i];</span> 
<a id="x1-42258r121"></a><span class="ecrm-0500">121</span> 
<a id="x1-42260r122"></a><span class="ecrm-0500">122</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1587"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(is_sig)&nbsp;{</span> 
<a id="x1-42262r123"></a><span class="ecrm-0500">123</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1588"><span class="ectt-0800">/*&nbsp;It&nbsp;is&nbsp;important&nbsp;to&nbsp;put&nbsp;module_put(THIS_MODULE)&nbsp;here,&nbsp;because</span></span> 
<a id="x1-42264r124"></a><span class="ecrm-0500">124</span><span id="textcolor1589"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;for&nbsp;processes&nbsp;where&nbsp;the&nbsp;open&nbsp;is&nbsp;interrupted&nbsp;there&nbsp;will&nbsp;never</span></span> 
<a id="x1-42266r125"></a><span class="ecrm-0500">125</span><span id="textcolor1590"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;be&nbsp;a&nbsp;corresponding&nbsp;close.&nbsp;If&nbsp;we&nbsp;do&nbsp;not&nbsp;decrement&nbsp;the&nbsp;usage</span></span> 
<a id="x1-42268r126"></a><span class="ecrm-0500">126</span><span id="textcolor1591"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;count&nbsp;here,&nbsp;we&nbsp;will&nbsp;be&nbsp;left&nbsp;with&nbsp;a&nbsp;positive&nbsp;usage&nbsp;count</span></span> 
<a id="x1-42270r127"></a><span class="ecrm-0500">127</span><span id="textcolor1592"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;which&nbsp;we&nbsp;will&nbsp;have&nbsp;no&nbsp;way&nbsp;to&nbsp;bring&nbsp;down&nbsp;to&nbsp;zero,&nbsp;giving&nbsp;us</span></span> 
<a id="x1-42272r128"></a><span class="ecrm-0500">128</span><span id="textcolor1593"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;an&nbsp;immortal&nbsp;module,&nbsp;which&nbsp;can&nbsp;only&nbsp;be&nbsp;killed&nbsp;by&nbsp;rebooting</span></span> 
<a id="x1-42274r129"></a><span class="ecrm-0500">129</span><span id="textcolor1594"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;the&nbsp;machine.</span></span> 
<a id="x1-42276r130"></a><span class="ecrm-0500">130</span><span id="textcolor1595"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span></span> 
<a id="x1-42278r131"></a><span class="ecrm-0500">131</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;module_put(THIS_MODULE);</span> 
<a id="x1-42280r132"></a><span class="ecrm-0500">132</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1596"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;-EINTR;</span> 
<a id="x1-42282r133"></a><span class="ecrm-0500">133</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-42284r134"></a><span class="ecrm-0500">134</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-42286r135"></a><span class="ecrm-0500">135</span> 
<a id="x1-42288r136"></a><span class="ecrm-0500">136</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1597"><span class="ectt-0800">/*&nbsp;If&nbsp;we&nbsp;got&nbsp;here,&nbsp;Already_Open&nbsp;must&nbsp;be&nbsp;zero.&nbsp;*/</span></span> 
<a id="x1-42290r137"></a><span class="ecrm-0500">137</span> 
<a id="x1-42292r138"></a><span class="ecrm-0500">138</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1598"><span class="ectt-0800">/*&nbsp;Open&nbsp;the&nbsp;file&nbsp;*/</span></span> 
<a id="x1-42294r139"></a><span class="ecrm-0500">139</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;Already_Open&nbsp;=&nbsp;1;</span> 
<a id="x1-42296r140"></a><span class="ecrm-0500">140</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1599"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;0;&nbsp;</span><span id="textcolor1600"><span class="ectt-0800">/*&nbsp;Allow&nbsp;the&nbsp;access&nbsp;*/</span></span> 
<a id="x1-42298r141"></a><span class="ecrm-0500">141</span><span class="ectt-0800">}</span> 
<a id="x1-42300r142"></a><span class="ecrm-0500">142</span> 
<a id="x1-42302r143"></a><span class="ecrm-0500">143</span><span id="textcolor1601"><span class="ectt-0800">/*&nbsp;Called&nbsp;when&nbsp;the&nbsp;/proc&nbsp;file&nbsp;is&nbsp;closed&nbsp;*/</span></span> 
<a id="x1-42304r144"></a><span class="ecrm-0500">144</span><span id="textcolor1602"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;module_close(</span><span id="textcolor1603"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;inode&nbsp;*inode,&nbsp;</span><span id="textcolor1604"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file&nbsp;*file)</span> 
<a id="x1-42306r145"></a><span class="ecrm-0500">145</span><span class="ectt-0800">{</span> 
<a id="x1-42308r146"></a><span class="ecrm-0500">146</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1605"><span class="ectt-0800">/*&nbsp;Set&nbsp;Already_Open&nbsp;to&nbsp;zero,&nbsp;so&nbsp;one&nbsp;of&nbsp;the&nbsp;processes&nbsp;in&nbsp;the&nbsp;WaitQ&nbsp;will</span></span> 
<a id="x1-42310r147"></a><span class="ecrm-0500">147</span><span id="textcolor1606"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;be&nbsp;able&nbsp;to&nbsp;set&nbsp;Already_Open&nbsp;back&nbsp;to&nbsp;one&nbsp;and&nbsp;to&nbsp;open&nbsp;the&nbsp;file.&nbsp;All</span></span> 
<a id="x1-42312r148"></a><span class="ecrm-0500">148</span><span id="textcolor1607"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;the&nbsp;other&nbsp;processes&nbsp;will&nbsp;be&nbsp;called&nbsp;when&nbsp;Already_Open&nbsp;is&nbsp;back&nbsp;to&nbsp;one,</span></span> 
<a id="x1-42314r149"></a><span class="ecrm-0500">149</span><span id="textcolor1608"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;so&nbsp;they</span><span class="tctt-0800">'</span><span class="ectt-0800">ll&nbsp;go&nbsp;back&nbsp;to&nbsp;sleep.</span></span> 
<a id="x1-42316r150"></a><span class="ecrm-0500">150</span><span id="textcolor1609"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span></span> 
<a id="x1-42318r151"></a><span class="ecrm-0500">151</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;Already_Open&nbsp;=&nbsp;0;</span> 
<a id="x1-42320r152"></a><span class="ecrm-0500">152</span> 
<a id="x1-42322r153"></a><span class="ecrm-0500">153</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1610"><span class="ectt-0800">/*&nbsp;Wake&nbsp;up&nbsp;all&nbsp;the&nbsp;processes&nbsp;in&nbsp;WaitQ,&nbsp;so&nbsp;if&nbsp;anybody&nbsp;is&nbsp;waiting&nbsp;for&nbsp;the</span></span> 
<a id="x1-42324r154"></a><span class="ecrm-0500">154</span><span id="textcolor1611"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;file,&nbsp;they&nbsp;can&nbsp;have&nbsp;it.</span></span> 
<a id="x1-42326r155"></a><span class="ecrm-0500">155</span><span id="textcolor1612"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span></span> 
<a id="x1-42328r156"></a><span class="ecrm-0500">156</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;wake_up(&amp;WaitQ);</span> 
<a id="x1-42330r157"></a><span class="ecrm-0500">157</span> 
<a id="x1-42332r158"></a><span class="ecrm-0500">158</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;module_put(THIS_MODULE);</span> 
<a id="x1-42334r159"></a><span class="ecrm-0500">159</span> 
<a id="x1-42336r160"></a><span class="ecrm-0500">160</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1613"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;0;&nbsp;</span><span id="textcolor1614"><span class="ectt-0800">/*&nbsp;success&nbsp;*/</span></span> 
<a id="x1-42338r161"></a><span class="ecrm-0500">161</span><span class="ectt-0800">}</span> 
<a id="x1-42340r162"></a><span class="ecrm-0500">162</span> 
<a id="x1-42342r163"></a><span class="ecrm-0500">163</span><span id="textcolor1615"><span class="ectt-0800">/*&nbsp;Structures&nbsp;to&nbsp;register&nbsp;as&nbsp;the&nbsp;/proc&nbsp;file,&nbsp;with&nbsp;pointers&nbsp;to&nbsp;all&nbsp;the&nbsp;relevant</span></span> 
<a id="x1-42344r164"></a><span class="ecrm-0500">164</span><span id="textcolor1616"><span class="ectt-0800">&nbsp;*&nbsp;functions.</span></span> 
<a id="x1-42346r165"></a><span class="ecrm-0500">165</span><span id="textcolor1617"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-42348r166"></a><span class="ecrm-0500">166</span> 
<a id="x1-42350r167"></a><span class="ecrm-0500">167</span><span id="textcolor1618"><span class="ectt-0800">/*&nbsp;File&nbsp;operations&nbsp;for&nbsp;our&nbsp;proc&nbsp;file.&nbsp;This&nbsp;is&nbsp;where&nbsp;we&nbsp;place&nbsp;pointers&nbsp;to&nbsp;all</span></span> 
<a id="x1-42352r168"></a><span class="ecrm-0500">168</span><span id="textcolor1619"><span class="ectt-0800">&nbsp;*&nbsp;the&nbsp;functions&nbsp;called&nbsp;when&nbsp;somebody&nbsp;tries&nbsp;to&nbsp;do&nbsp;something&nbsp;to&nbsp;our&nbsp;file.&nbsp;NULL</span></span> 
<a id="x1-42354r169"></a><span class="ecrm-0500">169</span><span id="textcolor1620"><span class="ectt-0800">&nbsp;*&nbsp;means&nbsp;we&nbsp;don</span><span class="tctt-0800">'</span><span class="ectt-0800">t&nbsp;want&nbsp;to&nbsp;deal&nbsp;with&nbsp;something.</span></span> 
<a id="x1-42356r170"></a><span class="ecrm-0500">170</span><span id="textcolor1621"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-42358r171"></a><span class="ecrm-0500">171</span><span id="textcolor1622"><span class="ectt-0800">#ifdef&nbsp;HAVE_PROC_OPS</span></span> 
<a id="x1-42360r172"></a><span class="ecrm-0500">172</span><span id="textcolor1623"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1624"><span class="ectt-0800">const</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1625"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;proc_ops&nbsp;File_Ops_4_Our_Proc_File&nbsp;=&nbsp;{</span> 
<a id="x1-42362r173"></a><span class="ecrm-0500">173</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.proc_read&nbsp;=&nbsp;module_output,&nbsp;&nbsp;&nbsp;</span><span id="textcolor1626"><span class="ectt-0800">/*&nbsp;"read"&nbsp;from&nbsp;the&nbsp;file&nbsp;*/</span></span> 
<a id="x1-42364r174"></a><span class="ecrm-0500">174</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.proc_write&nbsp;=&nbsp;module_input,&nbsp;&nbsp;&nbsp;</span><span id="textcolor1627"><span class="ectt-0800">/*&nbsp;"write"&nbsp;to&nbsp;the&nbsp;file&nbsp;*/</span></span> 
<a id="x1-42366r175"></a><span class="ecrm-0500">175</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.proc_open&nbsp;=&nbsp;module_open,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1628"><span class="ectt-0800">/*&nbsp;called&nbsp;when&nbsp;the&nbsp;/proc&nbsp;file&nbsp;is&nbsp;opened&nbsp;*/</span></span> 
<a id="x1-42368r176"></a><span class="ecrm-0500">176</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.proc_release&nbsp;=&nbsp;module_close,&nbsp;</span><span id="textcolor1629"><span class="ectt-0800">/*&nbsp;called&nbsp;when&nbsp;it</span><span class="tctt-0800">'</span><span class="ectt-0800">s&nbsp;closed&nbsp;*/</span></span> 
<a id="x1-42370r177"></a><span class="ecrm-0500">177</span><span class="ectt-0800">};</span> 
<a id="x1-42372r178"></a><span class="ecrm-0500">178</span><span id="textcolor1630"><span class="ectt-0800">#else</span></span> 
<a id="x1-42374r179"></a><span class="ecrm-0500">179</span><span id="textcolor1631"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1632"><span class="ectt-0800">const</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1633"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;file_operations&nbsp;File_Ops_4_Our_Proc_File&nbsp;=&nbsp;{</span> 
<a id="x1-42376r180"></a><span class="ecrm-0500">180</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.read&nbsp;=&nbsp;module_output,</span> 
<a id="x1-42378r181"></a><span class="ecrm-0500">181</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.write&nbsp;=&nbsp;module_input,</span> 
<a id="x1-42380r182"></a><span class="ecrm-0500">182</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.open&nbsp;=&nbsp;module_open,</span> 
<a id="x1-42382r183"></a><span class="ecrm-0500">183</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.release&nbsp;=&nbsp;module_close,</span> 
<a id="x1-42384r184"></a><span class="ecrm-0500">184</span><span class="ectt-0800">};</span> 
<a id="x1-42386r185"></a><span class="ecrm-0500">185</span><span id="textcolor1634"><span class="ectt-0800">#endif</span></span> 
<a id="x1-42388r186"></a><span class="ecrm-0500">186</span> 
<a id="x1-42390r187"></a><span class="ecrm-0500">187</span><span id="textcolor1635"><span class="ectt-0800">/*&nbsp;Initialize&nbsp;the&nbsp;module&nbsp;-&nbsp;register&nbsp;the&nbsp;proc&nbsp;file&nbsp;*/</span></span> 
<a id="x1-42392r188"></a><span class="ecrm-0500">188</span><span id="textcolor1636"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1637"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;__init&nbsp;sleep_init(</span><span id="textcolor1638"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-42394r189"></a><span class="ecrm-0500">189</span><span class="ectt-0800">{</span> 
<a id="x1-42396r190"></a><span class="ecrm-0500">190</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;Our_Proc_File&nbsp;=</span> 
<a id="x1-42398r191"></a><span class="ecrm-0500">191</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;proc_create(PROC_ENTRY_FILENAME,&nbsp;0644,&nbsp;NULL,&nbsp;&amp;File_Ops_4_Our_Proc_File);</span> 
<a id="x1-42400r192"></a><span class="ecrm-0500">192</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1639"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(Our_Proc_File&nbsp;==&nbsp;NULL)&nbsp;{</span> 
<a id="x1-42402r193"></a><span class="ecrm-0500">193</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;remove_proc_entry(PROC_ENTRY_FILENAME,&nbsp;NULL);</span> 
<a id="x1-42404r194"></a><span class="ecrm-0500">194</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pr_debug(</span><span id="textcolor1640"><span class="ectt-0800">"Error:&nbsp;Could&nbsp;not&nbsp;initialize&nbsp;/proc/%s</span></span><span id="textcolor1641"><span class="ectt-0800">\n</span></span><span id="textcolor1642"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;PROC_ENTRY_FILENAME);</span> 
<a id="x1-42406r195"></a><span class="ecrm-0500">195</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1643"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;-ENOMEM;</span> 
<a id="x1-42408r196"></a><span class="ecrm-0500">196</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-42410r197"></a><span class="ecrm-0500">197</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;proc_set_size(Our_Proc_File,&nbsp;80);</span> 
<a id="x1-42412r198"></a><span class="ecrm-0500">198</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;proc_set_user(Our_Proc_File,&nbsp;GLOBAL_ROOT_UID,&nbsp;GLOBAL_ROOT_GID);</span> 
<a id="x1-42414r199"></a><span class="ecrm-0500">199</span> 
<a id="x1-42416r200"></a><span class="ecrm-0500">200</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor1644"><span class="ectt-0800">"/proc/%s&nbsp;created</span></span><span id="textcolor1645"><span class="ectt-0800">\n</span></span><span id="textcolor1646"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;PROC_ENTRY_FILENAME);</span> 
<a id="x1-42418r201"></a><span class="ecrm-0500">201</span> 
<a id="x1-42420r202"></a><span class="ecrm-0500">202</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1647"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;0;</span> 
<a id="x1-42422r203"></a><span class="ecrm-0500">203</span><span class="ectt-0800">}</span> 
<a id="x1-42424r204"></a><span class="ecrm-0500">204</span> 
<a id="x1-42426r205"></a><span class="ecrm-0500">205</span><span id="textcolor1648"><span class="ectt-0800">/*&nbsp;Cleanup&nbsp;-&nbsp;unregister&nbsp;our&nbsp;file&nbsp;from&nbsp;/proc.&nbsp;&nbsp;This&nbsp;could&nbsp;get&nbsp;dangerous&nbsp;if</span></span> 
<a id="x1-42428r206"></a><span class="ecrm-0500">206</span><span id="textcolor1649"><span class="ectt-0800">&nbsp;*&nbsp;there&nbsp;are&nbsp;still&nbsp;processes&nbsp;waiting&nbsp;in&nbsp;WaitQ,&nbsp;because&nbsp;they&nbsp;are&nbsp;inside&nbsp;our</span></span> 
<a id="x1-42430r207"></a><span class="ecrm-0500">207</span><span id="textcolor1650"><span class="ectt-0800">&nbsp;*&nbsp;open&nbsp;function,&nbsp;which&nbsp;will&nbsp;get&nbsp;unloaded.&nbsp;I</span><span class="tctt-0800">'</span><span class="ectt-0800">ll&nbsp;explain&nbsp;how&nbsp;to&nbsp;avoid&nbsp;removal</span></span> 
<a id="x1-42432r208"></a><span class="ecrm-0500">208</span><span id="textcolor1651"><span class="ectt-0800">&nbsp;*&nbsp;of&nbsp;a&nbsp;kernel&nbsp;module&nbsp;in&nbsp;such&nbsp;a&nbsp;case&nbsp;in&nbsp;chapter&nbsp;10.</span></span> 
<a id="x1-42434r209"></a><span class="ecrm-0500">209</span><span id="textcolor1652"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-42436r210"></a><span class="ecrm-0500">210</span><span id="textcolor1653"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1654"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;__exit&nbsp;sleep_exit(</span><span id="textcolor1655"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-42438r211"></a><span class="ecrm-0500">211</span><span class="ectt-0800">{</span> 
<a id="x1-42440r212"></a><span class="ecrm-0500">212</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;remove_proc_entry(PROC_ENTRY_FILENAME,&nbsp;NULL);</span> 
<a id="x1-42442r213"></a><span class="ecrm-0500">213</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_debug(</span><span id="textcolor1656"><span class="ectt-0800">"/proc/%s&nbsp;removed</span></span><span id="textcolor1657"><span class="ectt-0800">\n</span></span><span id="textcolor1658"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;PROC_ENTRY_FILENAME);</span> 
<a id="x1-42444r214"></a><span class="ecrm-0500">214</span><span class="ectt-0800">}</span> 
<a id="x1-42446r215"></a><span class="ecrm-0500">215</span> 
<a id="x1-42448r216"></a><span class="ecrm-0500">216</span><span class="ectt-0800">module_init(sleep_init);</span> 
<a id="x1-42450r217"></a><span class="ecrm-0500">217</span><span class="ectt-0800">module_exit(sleep_exit);</span> 
<a id="x1-42452r218"></a><span class="ecrm-0500">218</span> 
<a id="x1-42454r219"></a><span class="ecrm-0500">219</span><span class="ectt-0800">MODULE_LICENSE(</span><span id="textcolor1659"><span class="ectt-0800">"GPL"</span></span><span class="ectt-0800">);</span></pre>

<!-- l. 1 --><p class="indent">
</p>
   <pre class="fancyvrb" id="fancyvrb55"><a id="x1-42456r1"></a><span class="ecrm-0500">1</span><span id="textcolor1660"><span class="ectt-0800">/*</span></span> 
<a id="x1-42458r2"></a><span class="ecrm-0500">2</span><span id="textcolor1661"><span class="ectt-0800">&nbsp;*&nbsp;&nbsp;cat_nonblock.c&nbsp;-&nbsp;open&nbsp;a&nbsp;file&nbsp;and&nbsp;display&nbsp;its&nbsp;contents,&nbsp;but&nbsp;exit&nbsp;rather&nbsp;than</span></span> 
<a id="x1-42460r3"></a><span class="ecrm-0500">3</span><span id="textcolor1662"><span class="ectt-0800">&nbsp;*&nbsp;&nbsp;wait&nbsp;for&nbsp;input.</span></span> 
<a id="x1-42462r4"></a><span class="ecrm-0500">4</span><span id="textcolor1663"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-42464r5"></a><span class="ecrm-0500">5</span><span id="textcolor1664"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1665"><span class="ectt-0800">&lt;errno.h&gt;&nbsp;&nbsp;/*&nbsp;for&nbsp;errno&nbsp;*/</span></span> 
<a id="x1-42466r6"></a><span class="ecrm-0500">6</span><span id="textcolor1666"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1667"><span class="ectt-0800">&lt;fcntl.h&gt;&nbsp;&nbsp;/*&nbsp;for&nbsp;open&nbsp;*/</span></span> 
<a id="x1-42468r7"></a><span class="ecrm-0500">7</span><span id="textcolor1668"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1669"><span class="ectt-0800">&lt;stdio.h&gt;&nbsp;&nbsp;/*&nbsp;standard&nbsp;I/O&nbsp;*/</span></span> 
<a id="x1-42470r8"></a><span class="ecrm-0500">8</span><span id="textcolor1670"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1671"><span class="ectt-0800">&lt;stdlib.h&gt;&nbsp;/*&nbsp;for&nbsp;exit&nbsp;*/</span></span> 
<a id="x1-42472r9"></a><span class="ecrm-0500">9</span><span id="textcolor1672"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1673"><span class="ectt-0800">&lt;unistd.h&gt;&nbsp;/*&nbsp;for&nbsp;read&nbsp;*/</span></span> 
<a id="x1-42474r10"></a><span class="ecrm-0500">10</span> 
<a id="x1-42476r11"></a><span class="ecrm-0500">11</span><span id="textcolor1674"><span class="ectt-0800">#define&nbsp;MAX_BYTES&nbsp;1024&nbsp;*&nbsp;4</span></span> 
<a id="x1-42478r12"></a><span class="ecrm-0500">12</span> 
<a id="x1-42480r13"></a><span class="ecrm-0500">13</span><span id="textcolor1675"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;main(</span><span id="textcolor1676"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;argc,&nbsp;</span><span id="textcolor1677"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;*argv[])</span> 
<a id="x1-42482r14"></a><span class="ecrm-0500">14</span><span class="ectt-0800">{</span> 
<a id="x1-42484r15"></a><span class="ecrm-0500">15</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1678"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;fd;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1679"><span class="ectt-0800">/*&nbsp;The&nbsp;file&nbsp;descriptor&nbsp;for&nbsp;the&nbsp;file&nbsp;to&nbsp;read&nbsp;*/</span></span> 
<a id="x1-42486r16"></a><span class="ecrm-0500">16</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1680"><span class="ectt-0800">size_t</span></span><span class="ectt-0800">&nbsp;bytes;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1681"><span class="ectt-0800">/*&nbsp;The&nbsp;number&nbsp;of&nbsp;bytes&nbsp;read&nbsp;*/</span></span> 
<a id="x1-42488r17"></a><span class="ecrm-0500">17</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1682"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;buffer[MAX_BYTES];&nbsp;</span><span id="textcolor1683"><span class="ectt-0800">/*&nbsp;The&nbsp;buffer&nbsp;for&nbsp;the&nbsp;bytes&nbsp;*/</span></span> 
<a id="x1-42490r18"></a><span class="ecrm-0500">18</span> 
<a id="x1-42492r19"></a><span class="ecrm-0500">19</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1684"><span class="ectt-0800">/*&nbsp;Usage&nbsp;*/</span></span> 
<a id="x1-42494r20"></a><span class="ecrm-0500">20</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1685"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(argc&nbsp;!=&nbsp;2)&nbsp;{</span> 
<a id="x1-42496r21"></a><span class="ecrm-0500">21</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(</span><span id="textcolor1686"><span class="ectt-0800">"Usage:&nbsp;%s&nbsp;&lt;filename&gt;</span></span><span id="textcolor1687"><span class="ectt-0800">\n</span></span><span id="textcolor1688"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;argv[0]);</span> 
<a id="x1-42498r22"></a><span class="ecrm-0500">22</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;puts(</span><span id="textcolor1689"><span class="ectt-0800">"Reads&nbsp;the&nbsp;content&nbsp;of&nbsp;a&nbsp;file,&nbsp;but&nbsp;doesn</span><span class="tctt-0800">'</span><span class="ectt-0800">t&nbsp;wait&nbsp;for&nbsp;input"</span></span><span class="ectt-0800">);</span> 
<a id="x1-42500r23"></a><span class="ecrm-0500">23</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit(-1);</span> 
<a id="x1-42502r24"></a><span class="ecrm-0500">24</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-42504r25"></a><span class="ecrm-0500">25</span> 
<a id="x1-42506r26"></a><span class="ecrm-0500">26</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1690"><span class="ectt-0800">/*&nbsp;Open&nbsp;the&nbsp;file&nbsp;for&nbsp;reading&nbsp;in&nbsp;non&nbsp;blocking&nbsp;mode&nbsp;*/</span></span> 
<a id="x1-42508r27"></a><span class="ecrm-0500">27</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;fd&nbsp;=&nbsp;open(argv[1],&nbsp;O_RDONLY&nbsp;|&nbsp;O_NONBLOCK);</span> 
<a id="x1-42510r28"></a><span class="ecrm-0500">28</span> 
<a id="x1-42512r29"></a><span class="ecrm-0500">29</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1691"><span class="ectt-0800">/*&nbsp;If&nbsp;open&nbsp;failed&nbsp;*/</span></span> 
<a id="x1-42514r30"></a><span class="ecrm-0500">30</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1692"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(fd&nbsp;==&nbsp;-1)&nbsp;{</span> 
<a id="x1-42516r31"></a><span class="ecrm-0500">31</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;puts(errno&nbsp;==&nbsp;EAGAIN&nbsp;?&nbsp;</span><span id="textcolor1693"><span class="ectt-0800">"Open&nbsp;would&nbsp;block"</span></span><span class="ectt-0800">&nbsp;:&nbsp;</span><span id="textcolor1694"><span class="ectt-0800">"Open&nbsp;failed"</span></span><span class="ectt-0800">);</span> 
<a id="x1-42518r32"></a><span class="ecrm-0500">32</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit(-1);</span> 
<a id="x1-42520r33"></a><span class="ecrm-0500">33</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-42522r34"></a><span class="ecrm-0500">34</span> 
<a id="x1-42524r35"></a><span class="ecrm-0500">35</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1695"><span class="ectt-0800">/*&nbsp;Read&nbsp;the&nbsp;file&nbsp;and&nbsp;output&nbsp;its&nbsp;contents&nbsp;*/</span></span> 
<a id="x1-42526r36"></a><span class="ecrm-0500">36</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1696"><span class="ectt-0800">do</span></span><span class="ectt-0800">&nbsp;{</span> 
<a id="x1-42528r37"></a><span class="ecrm-0500">37</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1697"><span class="ectt-0800">/*&nbsp;Read&nbsp;characters&nbsp;from&nbsp;the&nbsp;file&nbsp;*/</span></span> 
<a id="x1-42530r38"></a><span class="ecrm-0500">38</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bytes&nbsp;=&nbsp;read(fd,&nbsp;buffer,&nbsp;MAX_BYTES);</span> 
<a id="x1-42532r39"></a><span class="ecrm-0500">39</span> 
<a id="x1-42534r40"></a><span class="ecrm-0500">40</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1698"><span class="ectt-0800">/*&nbsp;If&nbsp;there</span><span class="tctt-0800">'</span><span class="ectt-0800">s&nbsp;an&nbsp;error,&nbsp;report&nbsp;it&nbsp;and&nbsp;die&nbsp;*/</span></span> 
<a id="x1-42536r41"></a><span class="ecrm-0500">41</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1699"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(bytes&nbsp;==&nbsp;-1)&nbsp;{</span> 
<a id="x1-42538r42"></a><span class="ecrm-0500">42</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1700"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(errno&nbsp;=&nbsp;EAGAIN)</span> 
<a id="x1-42540r43"></a><span class="ecrm-0500">43</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;puts(</span><span id="textcolor1701"><span class="ectt-0800">"Normally&nbsp;I</span><span class="tctt-0800">'</span><span class="ectt-0800">d&nbsp;block,&nbsp;but&nbsp;you&nbsp;told&nbsp;me&nbsp;not&nbsp;to"</span></span><span class="ectt-0800">);</span> 
<a id="x1-42542r44"></a><span class="ecrm-0500">44</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1702"><span class="ectt-0800">else</span></span> 
<a id="x1-42544r45"></a><span class="ecrm-0500">45</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;puts(</span><span id="textcolor1703"><span class="ectt-0800">"Another&nbsp;read&nbsp;error"</span></span><span class="ectt-0800">);</span> 
<a id="x1-42546r46"></a><span class="ecrm-0500">46</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit(-1);</span> 
<a id="x1-42548r47"></a><span class="ecrm-0500">47</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-42550r48"></a><span class="ecrm-0500">48</span> 
<a id="x1-42552r49"></a><span class="ecrm-0500">49</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1704"><span class="ectt-0800">/*&nbsp;Print&nbsp;the&nbsp;characters&nbsp;*/</span></span> 
<a id="x1-42554r50"></a><span class="ecrm-0500">50</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1705"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(bytes&nbsp;&gt;&nbsp;0)&nbsp;{</span> 
<a id="x1-42556r51"></a><span class="ecrm-0500">51</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1706"><span class="ectt-0800">for</span></span><span class="ectt-0800">&nbsp;(</span><span id="textcolor1707"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;bytes;&nbsp;i++)</span> 
<a id="x1-42558r52"></a><span class="ecrm-0500">52</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;putchar(buffer[i]);</span> 
<a id="x1-42560r53"></a><span class="ecrm-0500">53</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-42562r54"></a><span class="ecrm-0500">54</span> 
<a id="x1-42564r55"></a><span class="ecrm-0500">55</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1708"><span class="ectt-0800">/*&nbsp;While&nbsp;there&nbsp;are&nbsp;no&nbsp;errors&nbsp;and&nbsp;the&nbsp;file&nbsp;isn</span><span class="tctt-0800">'</span><span class="ectt-0800">t&nbsp;over&nbsp;*/</span></span> 
<a id="x1-42566r56"></a><span class="ecrm-0500">56</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;</span><span id="textcolor1709"><span class="ectt-0800">while</span></span><span class="ectt-0800">&nbsp;(bytes&nbsp;&gt;&nbsp;0);</span> 
<a id="x1-42568r57"></a><span class="ecrm-0500">57</span> 
<a id="x1-42570r58"></a><span class="ecrm-0500">58</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1710"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;0;</span> 
<a id="x1-42572r59"></a><span class="ecrm-0500">59</span><span class="ectt-0800">}</span></pre>
<!-- l. 1309 --><p class="noindent">
</p>
   <h4 class="subsectionHead" id="completions"><span class="titlemark">0.11.2   </span> <a id="x1-430000.11.2"></a>Completions</h4>
<!-- l. 1311 --><p class="noindent">Sometimes one thing should happen before another within a module having multiple threads.
Rather than using <code>  <span class="ectt-1000">/bin/sleep</span>
</code> commands, the kernel has another way to do this which allows timeouts or
interrupts to also happen.
</p><!-- l. 1314 --><p class="indent">   In the following example two threads are started, but one needs to start before
another.
</p><!-- l. 1 --><p class="indent">
                                                                  

                                                                  
</p>
   <pre class="fancyvrb" id="fancyvrb56"><a id="x1-43003r1"></a><span class="ecrm-0500">1</span><span id="textcolor1711"><span class="ectt-0800">/*</span></span> 
<a id="x1-43005r2"></a><span class="ecrm-0500">2</span><span id="textcolor1712"><span class="ectt-0800">&nbsp;*&nbsp;completions.c</span></span> 
<a id="x1-43007r3"></a><span class="ecrm-0500">3</span><span id="textcolor1713"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-43009r4"></a><span class="ecrm-0500">4</span><span id="textcolor1714"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1715"><span class="ectt-0800">&lt;linux/completion.h&gt;</span></span> 
<a id="x1-43011r5"></a><span class="ecrm-0500">5</span><span id="textcolor1716"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1717"><span class="ectt-0800">&lt;linux/init.h&gt;</span></span> 
<a id="x1-43013r6"></a><span class="ecrm-0500">6</span><span id="textcolor1718"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1719"><span class="ectt-0800">&lt;linux/kernel.h&gt;</span></span> 
<a id="x1-43015r7"></a><span class="ecrm-0500">7</span><span id="textcolor1720"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1721"><span class="ectt-0800">&lt;linux/kthread.h&gt;</span></span> 
<a id="x1-43017r8"></a><span class="ecrm-0500">8</span><span id="textcolor1722"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1723"><span class="ectt-0800">&lt;linux/module.h&gt;</span></span> 
<a id="x1-43019r9"></a><span class="ecrm-0500">9</span> 
<a id="x1-43021r10"></a><span class="ecrm-0500">10</span><span id="textcolor1724"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1725"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;{</span> 
<a id="x1-43023r11"></a><span class="ecrm-0500">11</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1726"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;completion&nbsp;crank_comp;</span> 
<a id="x1-43025r12"></a><span class="ecrm-0500">12</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1727"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;completion&nbsp;flywheel_comp;</span> 
<a id="x1-43027r13"></a><span class="ecrm-0500">13</span><span class="ectt-0800">}&nbsp;machine;</span> 
<a id="x1-43029r14"></a><span class="ecrm-0500">14</span> 
<a id="x1-43031r15"></a><span class="ecrm-0500">15</span><span id="textcolor1728"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1729"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;machine_crank_thread(</span><span id="textcolor1730"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;*arg)</span> 
<a id="x1-43033r16"></a><span class="ecrm-0500">16</span><span class="ectt-0800">{</span> 
<a id="x1-43035r17"></a><span class="ecrm-0500">17</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor1731"><span class="ectt-0800">"Turn&nbsp;the&nbsp;crank</span></span><span id="textcolor1732"><span class="ectt-0800">\n</span></span><span id="textcolor1733"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-43037r18"></a><span class="ecrm-0500">18</span> 
<a id="x1-43039r19"></a><span class="ecrm-0500">19</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;complete_all(&amp;machine.crank_comp);</span> 
<a id="x1-43041r20"></a><span class="ecrm-0500">20</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;complete_and_exit(&amp;machine.crank_comp,&nbsp;0);</span> 
<a id="x1-43043r21"></a><span class="ecrm-0500">21</span><span class="ectt-0800">}</span> 
<a id="x1-43045r22"></a><span class="ecrm-0500">22</span> 
<a id="x1-43047r23"></a><span class="ecrm-0500">23</span><span id="textcolor1734"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1735"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;machine_flywheel_spinup_thread(</span><span id="textcolor1736"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;*arg)</span> 
<a id="x1-43049r24"></a><span class="ecrm-0500">24</span><span class="ectt-0800">{</span> 
<a id="x1-43051r25"></a><span class="ecrm-0500">25</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;wait_for_completion(&amp;machine.crank_comp);</span> 
<a id="x1-43053r26"></a><span class="ecrm-0500">26</span> 
<a id="x1-43055r27"></a><span class="ecrm-0500">27</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor1737"><span class="ectt-0800">"Flywheel&nbsp;spins&nbsp;up</span></span><span id="textcolor1738"><span class="ectt-0800">\n</span></span><span id="textcolor1739"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-43057r28"></a><span class="ecrm-0500">28</span> 
<a id="x1-43059r29"></a><span class="ecrm-0500">29</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;complete_all(&amp;machine.flywheel_comp);</span> 
<a id="x1-43061r30"></a><span class="ecrm-0500">30</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;complete_and_exit(&amp;machine.flywheel_comp,&nbsp;0);</span> 
<a id="x1-43063r31"></a><span class="ecrm-0500">31</span><span class="ectt-0800">}</span> 
<a id="x1-43065r32"></a><span class="ecrm-0500">32</span> 
<a id="x1-43067r33"></a><span class="ecrm-0500">33</span><span id="textcolor1740"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1741"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;completions_init(</span><span id="textcolor1742"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-43069r34"></a><span class="ecrm-0500">34</span><span class="ectt-0800">{</span> 
<a id="x1-43071r35"></a><span class="ecrm-0500">35</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1743"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;task_struct&nbsp;*crank_thread;</span> 
<a id="x1-43073r36"></a><span class="ecrm-0500">36</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1744"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;task_struct&nbsp;*flywheel_thread;</span> 
<a id="x1-43075r37"></a><span class="ecrm-0500">37</span> 
<a id="x1-43077r38"></a><span class="ecrm-0500">38</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor1745"><span class="ectt-0800">"completions&nbsp;example</span></span><span id="textcolor1746"><span class="ectt-0800">\n</span></span><span id="textcolor1747"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-43079r39"></a><span class="ecrm-0500">39</span> 
<a id="x1-43081r40"></a><span class="ecrm-0500">40</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;init_completion(&amp;machine.crank_comp);</span> 
<a id="x1-43083r41"></a><span class="ecrm-0500">41</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;init_completion(&amp;machine.flywheel_comp);</span> 
<a id="x1-43085r42"></a><span class="ecrm-0500">42</span> 
<a id="x1-43087r43"></a><span class="ecrm-0500">43</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;crank_thread&nbsp;=&nbsp;kthread_create(machine_crank_thread,&nbsp;NULL,&nbsp;</span><span id="textcolor1748"><span class="ectt-0800">"KThread&nbsp;Crank"</span></span><span class="ectt-0800">);</span> 
<a id="x1-43089r44"></a><span class="ecrm-0500">44</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1749"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(IS_ERR(crank_thread))</span> 
<a id="x1-43091r45"></a><span class="ecrm-0500">45</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1750"><span class="ectt-0800">goto</span></span><span class="ectt-0800">&nbsp;ERROR_THREAD_1;</span> 
<a id="x1-43093r46"></a><span class="ecrm-0500">46</span> 
<a id="x1-43095r47"></a><span class="ecrm-0500">47</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;flywheel_thread&nbsp;=&nbsp;kthread_create(machine_flywheel_spinup_thread,&nbsp;NULL,</span> 
<a id="x1-43097r48"></a><span class="ecrm-0500">48</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1751"><span class="ectt-0800">"KThread&nbsp;Flywheel"</span></span><span class="ectt-0800">);</span> 
<a id="x1-43099r49"></a><span class="ecrm-0500">49</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1752"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(IS_ERR(flywheel_thread))</span> 
<a id="x1-43101r50"></a><span class="ecrm-0500">50</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1753"><span class="ectt-0800">goto</span></span><span class="ectt-0800">&nbsp;ERROR_THREAD_2;</span> 
<a id="x1-43103r51"></a><span class="ecrm-0500">51</span> 
<a id="x1-43105r52"></a><span class="ecrm-0500">52</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;wake_up_process(flywheel_thread);</span> 
<a id="x1-43107r53"></a><span class="ecrm-0500">53</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;wake_up_process(crank_thread);</span> 
<a id="x1-43109r54"></a><span class="ecrm-0500">54</span> 
<a id="x1-43111r55"></a><span class="ecrm-0500">55</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1754"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;0;</span> 
<a id="x1-43113r56"></a><span class="ecrm-0500">56</span> 
<a id="x1-43115r57"></a><span class="ecrm-0500">57</span><span class="ectt-0800">ERROR_THREAD_2:</span> 
<a id="x1-43117r58"></a><span class="ecrm-0500">58</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;kthread_stop(crank_thread);</span> 
<a id="x1-43119r59"></a><span class="ecrm-0500">59</span><span class="ectt-0800">ERROR_THREAD_1:</span> 
<a id="x1-43121r60"></a><span class="ecrm-0500">60</span> 
<a id="x1-43123r61"></a><span class="ecrm-0500">61</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1755"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;-1;</span> 
<a id="x1-43125r62"></a><span class="ecrm-0500">62</span><span class="ectt-0800">}</span> 
<a id="x1-43127r63"></a><span class="ecrm-0500">63</span> 
<a id="x1-43129r64"></a><span class="ecrm-0500">64</span><span id="textcolor1756"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;completions_exit(</span><span id="textcolor1757"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-43131r65"></a><span class="ecrm-0500">65</span><span class="ectt-0800">{</span> 
<a id="x1-43133r66"></a><span class="ecrm-0500">66</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;wait_for_completion(&amp;machine.crank_comp);</span> 
<a id="x1-43135r67"></a><span class="ecrm-0500">67</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;wait_for_completion(&amp;machine.flywheel_comp);</span> 
<a id="x1-43137r68"></a><span class="ecrm-0500">68</span> 
<a id="x1-43139r69"></a><span class="ecrm-0500">69</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor1758"><span class="ectt-0800">"completions&nbsp;exit</span></span><span id="textcolor1759"><span class="ectt-0800">\n</span></span><span id="textcolor1760"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-43141r70"></a><span class="ecrm-0500">70</span><span class="ectt-0800">}</span> 
<a id="x1-43143r71"></a><span class="ecrm-0500">71</span> 
<a id="x1-43145r72"></a><span class="ecrm-0500">72</span><span class="ectt-0800">module_init(completions_init);</span> 
<a id="x1-43147r73"></a><span class="ecrm-0500">73</span><span class="ectt-0800">module_exit(completions_exit);</span> 
<a id="x1-43149r74"></a><span class="ecrm-0500">74</span> 
<a id="x1-43151r75"></a><span class="ecrm-0500">75</span><span class="ectt-0800">MODULE_DESCRIPTION(</span><span id="textcolor1761"><span class="ectt-0800">"Completions&nbsp;example"</span></span><span class="ectt-0800">);</span> 
<a id="x1-43153r76"></a><span class="ecrm-0500">76</span><span class="ectt-0800">MODULE_LICENSE(</span><span id="textcolor1762"><span class="ectt-0800">"GPL"</span></span><span class="ectt-0800">);</span></pre>
<!-- l. 1318 --><p class="indent">   The <code>  <span class="ectt-1000">machine</span>
</code> structure stores the completion states for the two threads. At the exit
point of each thread the respective completion state is updated, and
<code> <span class="ectt-1000">wait_for_completion</span>
</code> is used by the flywheel thread to ensure that it does not begin prematurely.
</p><!-- l. 1321 --><p class="indent">   So even though <code>  <span class="ectt-1000">flywheel_thread</span>
</code> is started first you should notice if you load this module and run
<code> <span class="ectt-1000">dmesg</span>
</code> that turning the crank always happens first because the flywheel thread waits for it
to complete.
</p><!-- l. 1323 --><p class="indent">   There are other variations upon the
<code> <span class="ectt-1000">wait_for_completion</span>
</code> function, which include timeouts or being interrupted, but this basic mechanism is
enough for many common situations without adding a lot of complexity.
</p><!-- l. 1325 --><p class="noindent">
</p>
   <h3 class="sectionHead" id="avoiding-collisions-and-deadlocks"><span class="titlemark">0.12   </span> <a id="x1-440000.12"></a>Avoiding Collisions and Deadlocks</h3>
<!-- l. 1327 --><p class="noindent">If processes running on different CPUs or in different threads try to access the same
memory, then it is possible that strange things can happen or your system can lock
up. To avoid this, various types of mutual exclusion kernel functions are available.
These indicate if a section of code is "locked" or "unlocked" so that simultaneous
attempts to run it can not happen.
</p>
   <h4 class="subsectionHead" id="mutex"><span class="titlemark">0.12.1   </span> <a id="x1-450000.12.1"></a>Mutex</h4>
<!-- l. 1332 --><p class="noindent">You can use kernel mutexes (mutual exclusions) in much the same manner that you
might deploy them in userland. This may be all that is needed to avoid collisions in
most cases.
</p><!-- l. 1 --><p class="indent">
</p>
   <pre class="fancyvrb" id="fancyvrb57"><a id="x1-45002r1"></a><span class="ecrm-0500">1</span><span id="textcolor1763"><span class="ectt-0800">/*</span></span> 
<a id="x1-45004r2"></a><span class="ecrm-0500">2</span><span id="textcolor1764"><span class="ectt-0800">&nbsp;*&nbsp;example_mutex.c</span></span> 
<a id="x1-45006r3"></a><span class="ecrm-0500">3</span><span id="textcolor1765"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-45008r4"></a><span class="ecrm-0500">4</span><span id="textcolor1766"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1767"><span class="ectt-0800">&lt;linux/init.h&gt;</span></span> 
<a id="x1-45010r5"></a><span class="ecrm-0500">5</span><span id="textcolor1768"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1769"><span class="ectt-0800">&lt;linux/kernel.h&gt;</span></span> 
<a id="x1-45012r6"></a><span class="ecrm-0500">6</span><span id="textcolor1770"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1771"><span class="ectt-0800">&lt;linux/module.h&gt;</span></span> 
<a id="x1-45014r7"></a><span class="ecrm-0500">7</span><span id="textcolor1772"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1773"><span class="ectt-0800">&lt;linux/mutex.h&gt;</span></span> 
<a id="x1-45016r8"></a><span class="ecrm-0500">8</span> 
<a id="x1-45018r9"></a><span class="ecrm-0500">9</span><span class="ectt-0800">DEFINE_MUTEX(mymutex);</span> 
<a id="x1-45020r10"></a><span class="ecrm-0500">10</span> 
<a id="x1-45022r11"></a><span class="ecrm-0500">11</span><span id="textcolor1774"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1775"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;example_mutex_init(</span><span id="textcolor1776"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-45024r12"></a><span class="ecrm-0500">12</span><span class="ectt-0800">{</span> 
<a id="x1-45026r13"></a><span class="ecrm-0500">13</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1777"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;ret;</span> 
<a id="x1-45028r14"></a><span class="ecrm-0500">14</span> 
<a id="x1-45030r15"></a><span class="ecrm-0500">15</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor1778"><span class="ectt-0800">"example_mutex&nbsp;init</span></span><span id="textcolor1779"><span class="ectt-0800">\n</span></span><span id="textcolor1780"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-45032r16"></a><span class="ecrm-0500">16</span> 
<a id="x1-45034r17"></a><span class="ecrm-0500">17</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;ret&nbsp;=&nbsp;mutex_trylock(&amp;mymutex);</span> 
<a id="x1-45036r18"></a><span class="ecrm-0500">18</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1781"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(ret&nbsp;!=&nbsp;0)&nbsp;{</span> 
<a id="x1-45038r19"></a><span class="ecrm-0500">19</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor1782"><span class="ectt-0800">"mutex&nbsp;is&nbsp;locked</span></span><span id="textcolor1783"><span class="ectt-0800">\n</span></span><span id="textcolor1784"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-45040r20"></a><span class="ecrm-0500">20</span> 
<a id="x1-45042r21"></a><span class="ecrm-0500">21</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1785"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(mutex_is_locked(&amp;mymutex)&nbsp;==&nbsp;0)</span> 
<a id="x1-45044r22"></a><span class="ecrm-0500">22</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor1786"><span class="ectt-0800">"The&nbsp;mutex&nbsp;failed&nbsp;to&nbsp;lock!</span></span><span id="textcolor1787"><span class="ectt-0800">\n</span></span><span id="textcolor1788"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-45046r23"></a><span class="ecrm-0500">23</span> 
<a id="x1-45048r24"></a><span class="ecrm-0500">24</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mutex_unlock(&amp;mymutex);</span> 
<a id="x1-45050r25"></a><span class="ecrm-0500">25</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor1789"><span class="ectt-0800">"mutex&nbsp;is&nbsp;unlocked</span></span><span id="textcolor1790"><span class="ectt-0800">\n</span></span><span id="textcolor1791"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-45052r26"></a><span class="ecrm-0500">26</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;</span><span id="textcolor1792"><span class="ectt-0800">else</span></span> 
<a id="x1-45054r27"></a><span class="ecrm-0500">27</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor1793"><span class="ectt-0800">"Failed&nbsp;to&nbsp;lock</span></span><span id="textcolor1794"><span class="ectt-0800">\n</span></span><span id="textcolor1795"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-45056r28"></a><span class="ecrm-0500">28</span> 
<a id="x1-45058r29"></a><span class="ecrm-0500">29</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1796"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;0;</span> 
<a id="x1-45060r30"></a><span class="ecrm-0500">30</span><span class="ectt-0800">}</span> 
<a id="x1-45062r31"></a><span class="ecrm-0500">31</span> 
<a id="x1-45064r32"></a><span class="ecrm-0500">32</span><span id="textcolor1797"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1798"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;example_mutex_exit(</span><span id="textcolor1799"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-45066r33"></a><span class="ecrm-0500">33</span><span class="ectt-0800">{</span> 
<a id="x1-45068r34"></a><span class="ecrm-0500">34</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor1800"><span class="ectt-0800">"example_mutex&nbsp;exit</span></span><span id="textcolor1801"><span class="ectt-0800">\n</span></span><span id="textcolor1802"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-45070r35"></a><span class="ecrm-0500">35</span><span class="ectt-0800">}</span> 
<a id="x1-45072r36"></a><span class="ecrm-0500">36</span> 
<a id="x1-45074r37"></a><span class="ecrm-0500">37</span><span class="ectt-0800">module_init(example_mutex_init);</span> 
<a id="x1-45076r38"></a><span class="ecrm-0500">38</span><span class="ectt-0800">module_exit(example_mutex_exit);</span> 
<a id="x1-45078r39"></a><span class="ecrm-0500">39</span> 
<a id="x1-45080r40"></a><span class="ecrm-0500">40</span><span class="ectt-0800">MODULE_DESCRIPTION(</span><span id="textcolor1803"><span class="ectt-0800">"Mutex&nbsp;example"</span></span><span class="ectt-0800">);</span> 
<a id="x1-45082r41"></a><span class="ecrm-0500">41</span><span class="ectt-0800">MODULE_LICENSE(</span><span id="textcolor1804"><span class="ectt-0800">"GPL"</span></span><span class="ectt-0800">);</span></pre>
<!-- l. 1337 --><p class="noindent">
</p>
   <h4 class="subsectionHead" id="spinlocks"><span class="titlemark">0.12.2   </span> <a id="x1-460000.12.2"></a>Spinlocks</h4>
<!-- l. 1339 --><p class="noindent">As the name suggests, spinlocks lock up the CPU that the code is running on,
taking 100% of its resources. Because of this you should only use the spinlock
                                                                  

                                                                  
mechanism around code which is likely to take no more than a few milliseconds to
run and so will not noticably slow anything down from the user’s point of
view.
</p><!-- l. 1342 --><p class="indent">   The example here is <span class="obeylines-h"><span class="verb"><span class="ectt-1000">"irq&nbsp;safe"</span></span></span> in that if interrupts happen during the lock then
they will not be forgotten and will activate when the unlock happens, using the
<code> <span class="ectt-1000">flags</span>
</code> variable to retain their state.
</p><!-- l. 1 --><p class="indent">
</p>
   <pre class="fancyvrb" id="fancyvrb58"><a id="x1-46003r1"></a><span class="ecrm-0500">1</span><span id="textcolor1805"><span class="ectt-0800">/*</span></span> 
<a id="x1-46005r2"></a><span class="ecrm-0500">2</span><span id="textcolor1806"><span class="ectt-0800">&nbsp;*&nbsp;example_spinlock.c</span></span> 
<a id="x1-46007r3"></a><span class="ecrm-0500">3</span><span id="textcolor1807"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-46009r4"></a><span class="ecrm-0500">4</span><span id="textcolor1808"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1809"><span class="ectt-0800">&lt;linux/init.h&gt;</span></span> 
<a id="x1-46011r5"></a><span class="ecrm-0500">5</span><span id="textcolor1810"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1811"><span class="ectt-0800">&lt;linux/interrupt.h&gt;</span></span> 
<a id="x1-46013r6"></a><span class="ecrm-0500">6</span><span id="textcolor1812"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1813"><span class="ectt-0800">&lt;linux/kernel.h&gt;</span></span> 
<a id="x1-46015r7"></a><span class="ecrm-0500">7</span><span id="textcolor1814"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1815"><span class="ectt-0800">&lt;linux/module.h&gt;</span></span> 
<a id="x1-46017r8"></a><span class="ecrm-0500">8</span><span id="textcolor1816"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1817"><span class="ectt-0800">&lt;linux/spinlock.h&gt;</span></span> 
<a id="x1-46019r9"></a><span class="ecrm-0500">9</span> 
<a id="x1-46021r10"></a><span class="ecrm-0500">10</span><span class="ectt-0800">DEFINE_SPINLOCK(sl_static);</span> 
<a id="x1-46023r11"></a><span class="ecrm-0500">11</span><span class="ectt-0800">spinlock_t&nbsp;sl_dynamic;</span> 
<a id="x1-46025r12"></a><span class="ecrm-0500">12</span> 
<a id="x1-46027r13"></a><span class="ecrm-0500">13</span><span id="textcolor1818"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1819"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;example_spinlock_static(</span><span id="textcolor1820"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-46029r14"></a><span class="ecrm-0500">14</span><span class="ectt-0800">{</span> 
<a id="x1-46031r15"></a><span class="ecrm-0500">15</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1821"><span class="ectt-0800">unsigned</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1822"><span class="ectt-0800">long</span></span><span class="ectt-0800">&nbsp;flags;</span> 
<a id="x1-46033r16"></a><span class="ecrm-0500">16</span> 
<a id="x1-46035r17"></a><span class="ecrm-0500">17</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;spin_lock_irqsave(&amp;sl_static,&nbsp;flags);</span> 
<a id="x1-46037r18"></a><span class="ecrm-0500">18</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor1823"><span class="ectt-0800">"Locked&nbsp;static&nbsp;spinlock</span></span><span id="textcolor1824"><span class="ectt-0800">\n</span></span><span id="textcolor1825"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-46039r19"></a><span class="ecrm-0500">19</span> 
<a id="x1-46041r20"></a><span class="ecrm-0500">20</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1826"><span class="ectt-0800">/*&nbsp;Do&nbsp;something&nbsp;or&nbsp;other&nbsp;safely.&nbsp;Because&nbsp;this&nbsp;uses&nbsp;100%&nbsp;CPU&nbsp;time,&nbsp;this</span></span> 
<a id="x1-46043r21"></a><span class="ecrm-0500">21</span><span id="textcolor1827"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;code&nbsp;should&nbsp;take&nbsp;no&nbsp;more&nbsp;than&nbsp;a&nbsp;few&nbsp;milliseconds&nbsp;to&nbsp;run.</span></span> 
<a id="x1-46045r22"></a><span class="ecrm-0500">22</span><span id="textcolor1828"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span></span> 
<a id="x1-46047r23"></a><span class="ecrm-0500">23</span> 
<a id="x1-46049r24"></a><span class="ecrm-0500">24</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;spin_unlock_irqrestore(&amp;sl_static,&nbsp;flags);</span> 
<a id="x1-46051r25"></a><span class="ecrm-0500">25</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor1829"><span class="ectt-0800">"Unlocked&nbsp;static&nbsp;spinlock</span></span><span id="textcolor1830"><span class="ectt-0800">\n</span></span><span id="textcolor1831"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-46053r26"></a><span class="ecrm-0500">26</span><span class="ectt-0800">}</span> 
<a id="x1-46055r27"></a><span class="ecrm-0500">27</span> 
<a id="x1-46057r28"></a><span class="ecrm-0500">28</span><span id="textcolor1832"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1833"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;example_spinlock_dynamic(</span><span id="textcolor1834"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-46059r29"></a><span class="ecrm-0500">29</span><span class="ectt-0800">{</span> 
<a id="x1-46061r30"></a><span class="ecrm-0500">30</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1835"><span class="ectt-0800">unsigned</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1836"><span class="ectt-0800">long</span></span><span class="ectt-0800">&nbsp;flags;</span> 
<a id="x1-46063r31"></a><span class="ecrm-0500">31</span> 
<a id="x1-46065r32"></a><span class="ecrm-0500">32</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;spin_lock_init(&amp;sl_dynamic);</span> 
<a id="x1-46067r33"></a><span class="ecrm-0500">33</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;spin_lock_irqsave(&amp;sl_dynamic,&nbsp;flags);</span> 
<a id="x1-46069r34"></a><span class="ecrm-0500">34</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor1837"><span class="ectt-0800">"Locked&nbsp;dynamic&nbsp;spinlock</span></span><span id="textcolor1838"><span class="ectt-0800">\n</span></span><span id="textcolor1839"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-46071r35"></a><span class="ecrm-0500">35</span> 
<a id="x1-46073r36"></a><span class="ecrm-0500">36</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1840"><span class="ectt-0800">/*&nbsp;Do&nbsp;something&nbsp;or&nbsp;other&nbsp;safely.&nbsp;Because&nbsp;this&nbsp;uses&nbsp;100%&nbsp;CPU&nbsp;time,&nbsp;this</span></span> 
<a id="x1-46075r37"></a><span class="ecrm-0500">37</span><span id="textcolor1841"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;code&nbsp;should&nbsp;take&nbsp;no&nbsp;more&nbsp;than&nbsp;a&nbsp;few&nbsp;milliseconds&nbsp;to&nbsp;run.</span></span> 
<a id="x1-46077r38"></a><span class="ecrm-0500">38</span><span id="textcolor1842"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span></span> 
<a id="x1-46079r39"></a><span class="ecrm-0500">39</span> 
<a id="x1-46081r40"></a><span class="ecrm-0500">40</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;spin_unlock_irqrestore(&amp;sl_dynamic,&nbsp;flags);</span> 
<a id="x1-46083r41"></a><span class="ecrm-0500">41</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor1843"><span class="ectt-0800">"Unlocked&nbsp;dynamic&nbsp;spinlock</span></span><span id="textcolor1844"><span class="ectt-0800">\n</span></span><span id="textcolor1845"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-46085r42"></a><span class="ecrm-0500">42</span><span class="ectt-0800">}</span> 
<a id="x1-46087r43"></a><span class="ecrm-0500">43</span> 
<a id="x1-46089r44"></a><span class="ecrm-0500">44</span><span id="textcolor1846"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1847"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;example_spinlock_init(</span><span id="textcolor1848"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-46091r45"></a><span class="ecrm-0500">45</span><span class="ectt-0800">{</span> 
<a id="x1-46093r46"></a><span class="ecrm-0500">46</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor1849"><span class="ectt-0800">"example&nbsp;spinlock&nbsp;started</span></span><span id="textcolor1850"><span class="ectt-0800">\n</span></span><span id="textcolor1851"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-46095r47"></a><span class="ecrm-0500">47</span> 
<a id="x1-46097r48"></a><span class="ecrm-0500">48</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;example_spinlock_static();</span> 
<a id="x1-46099r49"></a><span class="ecrm-0500">49</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;example_spinlock_dynamic();</span> 
<a id="x1-46101r50"></a><span class="ecrm-0500">50</span> 
<a id="x1-46103r51"></a><span class="ecrm-0500">51</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1852"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;0;</span> 
<a id="x1-46105r52"></a><span class="ecrm-0500">52</span><span class="ectt-0800">}</span> 
<a id="x1-46107r53"></a><span class="ecrm-0500">53</span> 
<a id="x1-46109r54"></a><span class="ecrm-0500">54</span><span id="textcolor1853"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1854"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;example_spinlock_exit(</span><span id="textcolor1855"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-46111r55"></a><span class="ecrm-0500">55</span><span class="ectt-0800">{</span> 
<a id="x1-46113r56"></a><span class="ecrm-0500">56</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor1856"><span class="ectt-0800">"example&nbsp;spinlock&nbsp;exit</span></span><span id="textcolor1857"><span class="ectt-0800">\n</span></span><span id="textcolor1858"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-46115r57"></a><span class="ecrm-0500">57</span><span class="ectt-0800">}</span> 
<a id="x1-46117r58"></a><span class="ecrm-0500">58</span> 
<a id="x1-46119r59"></a><span class="ecrm-0500">59</span><span class="ectt-0800">module_init(example_spinlock_init);</span> 
<a id="x1-46121r60"></a><span class="ecrm-0500">60</span><span class="ectt-0800">module_exit(example_spinlock_exit);</span> 
<a id="x1-46123r61"></a><span class="ecrm-0500">61</span> 
<a id="x1-46125r62"></a><span class="ecrm-0500">62</span><span class="ectt-0800">MODULE_DESCRIPTION(</span><span id="textcolor1859"><span class="ectt-0800">"Spinlock&nbsp;example"</span></span><span class="ectt-0800">);</span> 
<a id="x1-46127r63"></a><span class="ecrm-0500">63</span><span class="ectt-0800">MODULE_LICENSE(</span><span id="textcolor1860"><span class="ectt-0800">"GPL"</span></span><span class="ectt-0800">);</span></pre>
<!-- l. 1346 --><p class="noindent">
</p>
   <h4 class="subsectionHead" id="read-and-write-locks"><span class="titlemark">0.12.3   </span> <a id="x1-470000.12.3"></a>Read and write locks</h4>
<!-- l. 1348 --><p class="noindent">Read and write locks are specialised kinds of spinlocks so that you can exclusively
read from something or write to something. Like the earlier spinlocks example the
one below shows an "irq safe" situation in which if other functions were triggered
from irqs which might also read and write to whatever you are concerned with
then they would not disrupt the logic. As before it is a good idea to keep
anything done within the lock as short as possible so that it does not hang up
the system and cause users to start revolting against the tyranny of your
module.
</p><!-- l. 1 --><p class="indent">
</p>
   <pre class="fancyvrb" id="fancyvrb59"><a id="x1-47002r1"></a><span class="ecrm-0500">1</span><span id="textcolor1861"><span class="ectt-0800">/*</span></span> 
<a id="x1-47004r2"></a><span class="ecrm-0500">2</span><span id="textcolor1862"><span class="ectt-0800">&nbsp;*&nbsp;example_rwlock.c</span></span> 
<a id="x1-47006r3"></a><span class="ecrm-0500">3</span><span id="textcolor1863"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-47008r4"></a><span class="ecrm-0500">4</span><span id="textcolor1864"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1865"><span class="ectt-0800">&lt;linux/interrupt.h&gt;</span></span> 
<a id="x1-47010r5"></a><span class="ecrm-0500">5</span><span id="textcolor1866"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1867"><span class="ectt-0800">&lt;linux/kernel.h&gt;</span></span> 
<a id="x1-47012r6"></a><span class="ecrm-0500">6</span><span id="textcolor1868"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1869"><span class="ectt-0800">&lt;linux/module.h&gt;</span></span> 
<a id="x1-47014r7"></a><span class="ecrm-0500">7</span> 
<a id="x1-47016r8"></a><span class="ecrm-0500">8</span><span class="ectt-0800">DEFINE_RWLOCK(myrwlock);</span> 
<a id="x1-47018r9"></a><span class="ecrm-0500">9</span> 
<a id="x1-47020r10"></a><span class="ecrm-0500">10</span><span id="textcolor1870"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1871"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;example_read_lock(</span><span id="textcolor1872"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-47022r11"></a><span class="ecrm-0500">11</span><span class="ectt-0800">{</span> 
<a id="x1-47024r12"></a><span class="ecrm-0500">12</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1873"><span class="ectt-0800">unsigned</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1874"><span class="ectt-0800">long</span></span><span class="ectt-0800">&nbsp;flags;</span> 
<a id="x1-47026r13"></a><span class="ecrm-0500">13</span> 
<a id="x1-47028r14"></a><span class="ecrm-0500">14</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;read_lock_irqsave(&amp;myrwlock,&nbsp;flags);</span> 
<a id="x1-47030r15"></a><span class="ecrm-0500">15</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor1875"><span class="ectt-0800">"Read&nbsp;Locked</span></span><span id="textcolor1876"><span class="ectt-0800">\n</span></span><span id="textcolor1877"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-47032r16"></a><span class="ecrm-0500">16</span> 
<a id="x1-47034r17"></a><span class="ecrm-0500">17</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1878"><span class="ectt-0800">/*&nbsp;Read&nbsp;from&nbsp;something&nbsp;*/</span></span> 
<a id="x1-47036r18"></a><span class="ecrm-0500">18</span> 
<a id="x1-47038r19"></a><span class="ecrm-0500">19</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;read_unlock_irqrestore(&amp;myrwlock,&nbsp;flags);</span> 
<a id="x1-47040r20"></a><span class="ecrm-0500">20</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor1879"><span class="ectt-0800">"Read&nbsp;Unlocked</span></span><span id="textcolor1880"><span class="ectt-0800">\n</span></span><span id="textcolor1881"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-47042r21"></a><span class="ecrm-0500">21</span><span class="ectt-0800">}</span> 
<a id="x1-47044r22"></a><span class="ecrm-0500">22</span> 
<a id="x1-47046r23"></a><span class="ecrm-0500">23</span><span id="textcolor1882"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1883"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;example_write_lock(</span><span id="textcolor1884"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-47048r24"></a><span class="ecrm-0500">24</span><span class="ectt-0800">{</span> 
<a id="x1-47050r25"></a><span class="ecrm-0500">25</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1885"><span class="ectt-0800">unsigned</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1886"><span class="ectt-0800">long</span></span><span class="ectt-0800">&nbsp;flags;</span> 
<a id="x1-47052r26"></a><span class="ecrm-0500">26</span> 
<a id="x1-47054r27"></a><span class="ecrm-0500">27</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;write_lock_irqsave(&amp;myrwlock,&nbsp;flags);</span> 
<a id="x1-47056r28"></a><span class="ecrm-0500">28</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor1887"><span class="ectt-0800">"Write&nbsp;Locked</span></span><span id="textcolor1888"><span class="ectt-0800">\n</span></span><span id="textcolor1889"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-47058r29"></a><span class="ecrm-0500">29</span> 
<a id="x1-47060r30"></a><span class="ecrm-0500">30</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1890"><span class="ectt-0800">/*&nbsp;Write&nbsp;to&nbsp;something&nbsp;*/</span></span> 
<a id="x1-47062r31"></a><span class="ecrm-0500">31</span> 
<a id="x1-47064r32"></a><span class="ecrm-0500">32</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;write_unlock_irqrestore(&amp;myrwlock,&nbsp;flags);</span> 
<a id="x1-47066r33"></a><span class="ecrm-0500">33</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor1891"><span class="ectt-0800">"Write&nbsp;Unlocked</span></span><span id="textcolor1892"><span class="ectt-0800">\n</span></span><span id="textcolor1893"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-47068r34"></a><span class="ecrm-0500">34</span><span class="ectt-0800">}</span> 
<a id="x1-47070r35"></a><span class="ecrm-0500">35</span> 
<a id="x1-47072r36"></a><span class="ecrm-0500">36</span><span id="textcolor1894"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1895"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;example_rwlock_init(</span><span id="textcolor1896"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-47074r37"></a><span class="ecrm-0500">37</span><span class="ectt-0800">{</span> 
<a id="x1-47076r38"></a><span class="ecrm-0500">38</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor1897"><span class="ectt-0800">"example_rwlock&nbsp;started</span></span><span id="textcolor1898"><span class="ectt-0800">\n</span></span><span id="textcolor1899"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-47078r39"></a><span class="ecrm-0500">39</span> 
<a id="x1-47080r40"></a><span class="ecrm-0500">40</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;example_read_lock();</span> 
<a id="x1-47082r41"></a><span class="ecrm-0500">41</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;example_write_lock();</span> 
<a id="x1-47084r42"></a><span class="ecrm-0500">42</span> 
<a id="x1-47086r43"></a><span class="ecrm-0500">43</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1900"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;0;</span> 
<a id="x1-47088r44"></a><span class="ecrm-0500">44</span><span class="ectt-0800">}</span> 
<a id="x1-47090r45"></a><span class="ecrm-0500">45</span> 
<a id="x1-47092r46"></a><span class="ecrm-0500">46</span><span id="textcolor1901"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1902"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;example_rwlock_exit(</span><span id="textcolor1903"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-47094r47"></a><span class="ecrm-0500">47</span><span class="ectt-0800">{</span> 
<a id="x1-47096r48"></a><span class="ecrm-0500">48</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor1904"><span class="ectt-0800">"example_rwlock&nbsp;exit</span></span><span id="textcolor1905"><span class="ectt-0800">\n</span></span><span id="textcolor1906"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-47098r49"></a><span class="ecrm-0500">49</span><span class="ectt-0800">}</span> 
<a id="x1-47100r50"></a><span class="ecrm-0500">50</span> 
<a id="x1-47102r51"></a><span class="ecrm-0500">51</span><span class="ectt-0800">module_init(example_rwlock_init);</span> 
<a id="x1-47104r52"></a><span class="ecrm-0500">52</span><span class="ectt-0800">module_exit(example_rwlock_exit);</span> 
<a id="x1-47106r53"></a><span class="ecrm-0500">53</span> 
<a id="x1-47108r54"></a><span class="ecrm-0500">54</span><span class="ectt-0800">MODULE_DESCRIPTION(</span><span id="textcolor1907"><span class="ectt-0800">"Read/Write&nbsp;locks&nbsp;example"</span></span><span class="ectt-0800">);</span> 
<a id="x1-47110r55"></a><span class="ecrm-0500">55</span><span class="ectt-0800">MODULE_LICENSE(</span><span id="textcolor1908"><span class="ectt-0800">"GPL"</span></span><span class="ectt-0800">);</span></pre>
<!-- l. 1354 --><p class="indent">   Of course, if you know for sure that there are no functions triggered by irqs
which could possibly interfere with your logic then you can use the simpler
<code> <span class="ectt-1000">read_lock(&amp;myrwlock)</span>
</code> and <code>  <span class="ectt-1000">read_unlock(&amp;myrwlock)</span>
</code> or the corresponding write functions.
</p>
   <h4 class="subsectionHead" id="atomic-operations"><span class="titlemark">0.12.4   </span> <a id="x1-480000.12.4"></a>Atomic operations</h4>
<!-- l. 1357 --><p class="noindent">If you are doing simple arithmetic: adding, subtracting or bitwise operations then
there is another way in the multi-CPU and multi-hyperthreaded world to stop other
parts of the system from messing with your mojo. By using atomic operations you
can be confident that your addition, subtraction or bit flip did actually happen
and was not overwritten by some other shenanigans. An example is shown
below.
</p><!-- l. 1 --><p class="indent">
</p>
   <pre class="fancyvrb" id="fancyvrb60"><a id="x1-48002r1"></a><span class="ecrm-0500">1</span><span id="textcolor1909"><span class="ectt-0800">/*</span></span> 
<a id="x1-48004r2"></a><span class="ecrm-0500">2</span><span id="textcolor1910"><span class="ectt-0800">&nbsp;*&nbsp;example_atomic.c</span></span> 
<a id="x1-48006r3"></a><span class="ecrm-0500">3</span><span id="textcolor1911"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-48008r4"></a><span class="ecrm-0500">4</span><span id="textcolor1912"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1913"><span class="ectt-0800">&lt;linux/interrupt.h&gt;</span></span> 
<a id="x1-48010r5"></a><span class="ecrm-0500">5</span><span id="textcolor1914"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1915"><span class="ectt-0800">&lt;linux/kernel.h&gt;</span></span> 
<a id="x1-48012r6"></a><span class="ecrm-0500">6</span><span id="textcolor1916"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1917"><span class="ectt-0800">&lt;linux/module.h&gt;</span></span> 
<a id="x1-48014r7"></a><span class="ecrm-0500">7</span> 
<a id="x1-48016r8"></a><span class="ecrm-0500">8</span><span id="textcolor1918"><span class="ectt-0800">#define&nbsp;BYTE_TO_BINARY_PATTERN&nbsp;"%c%c%c%c%c%c%c%c"</span></span> 
<a id="x1-48018r9"></a><span class="ecrm-0500">9</span><span id="textcolor1919"><span class="ectt-0800">#define&nbsp;BYTE_TO_BINARY(byte)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\</span></span> 
<a id="x1-48020r10"></a><span class="ecrm-0500">10</span><span id="textcolor1920"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;(byte&nbsp;&amp;&nbsp;0x80&nbsp;?&nbsp;</span><span class="tctt-0800">'</span><span class="ectt-0800">1</span><span class="tctt-0800">'</span><span class="ectt-0800">&nbsp;:&nbsp;</span><span class="tctt-0800">'</span><span class="ectt-0800">0</span><span class="tctt-0800">'</span><span class="ectt-0800">),&nbsp;(byte&nbsp;&amp;&nbsp;0x40&nbsp;?&nbsp;</span><span class="tctt-0800">'</span><span class="ectt-0800">1</span><span class="tctt-0800">'</span><span class="ectt-0800">&nbsp;:&nbsp;</span><span class="tctt-0800">'</span><span class="ectt-0800">0</span><span class="tctt-0800">'</span><span class="ectt-0800">),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\</span></span> 
<a id="x1-48022r11"></a><span class="ecrm-0500">11</span><span id="textcolor1921"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(byte&nbsp;&amp;&nbsp;0x20&nbsp;?&nbsp;</span><span class="tctt-0800">'</span><span class="ectt-0800">1</span><span class="tctt-0800">'</span><span class="ectt-0800">&nbsp;:&nbsp;</span><span class="tctt-0800">'</span><span class="ectt-0800">0</span><span class="tctt-0800">'</span><span class="ectt-0800">),&nbsp;(byte&nbsp;&amp;&nbsp;0x10&nbsp;?&nbsp;</span><span class="tctt-0800">'</span><span class="ectt-0800">1</span><span class="tctt-0800">'</span><span class="ectt-0800">&nbsp;:&nbsp;</span><span class="tctt-0800">'</span><span class="ectt-0800">0</span><span class="tctt-0800">'</span><span class="ectt-0800">),&nbsp;\</span></span> 
<a id="x1-48024r12"></a><span class="ecrm-0500">12</span><span id="textcolor1922"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(byte&nbsp;&amp;&nbsp;0x08&nbsp;?&nbsp;</span><span class="tctt-0800">'</span><span class="ectt-0800">1</span><span class="tctt-0800">'</span><span class="ectt-0800">&nbsp;:&nbsp;</span><span class="tctt-0800">'</span><span class="ectt-0800">0</span><span class="tctt-0800">'</span><span class="ectt-0800">),&nbsp;(byte&nbsp;&amp;&nbsp;0x04&nbsp;?&nbsp;</span><span class="tctt-0800">'</span><span class="ectt-0800">1</span><span class="tctt-0800">'</span><span class="ectt-0800">&nbsp;:&nbsp;</span><span class="tctt-0800">'</span><span class="ectt-0800">0</span><span class="tctt-0800">'</span><span class="ectt-0800">),&nbsp;\</span></span> 
<a id="x1-48026r13"></a><span class="ecrm-0500">13</span><span id="textcolor1923"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(byte&nbsp;&amp;&nbsp;0x02&nbsp;?&nbsp;</span><span class="tctt-0800">'</span><span class="ectt-0800">1</span><span class="tctt-0800">'</span><span class="ectt-0800">&nbsp;:&nbsp;</span><span class="tctt-0800">'</span><span class="ectt-0800">0</span><span class="tctt-0800">'</span><span class="ectt-0800">),&nbsp;(byte&nbsp;&amp;&nbsp;0x01&nbsp;?&nbsp;</span><span class="tctt-0800">'</span><span class="ectt-0800">1</span><span class="tctt-0800">'</span><span class="ectt-0800">&nbsp;:&nbsp;</span><span class="tctt-0800">'</span><span class="ectt-0800">0</span><span class="tctt-0800">'</span><span class="ectt-0800">)</span></span> 
<a id="x1-48028r14"></a><span class="ecrm-0500">14</span> 
<a id="x1-48030r15"></a><span class="ecrm-0500">15</span><span id="textcolor1924"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1925"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;atomic_add_subtract(</span><span id="textcolor1926"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-48032r16"></a><span class="ecrm-0500">16</span><span class="ectt-0800">{</span> 
<a id="x1-48034r17"></a><span class="ecrm-0500">17</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;atomic_t&nbsp;debbie;</span> 
<a id="x1-48036r18"></a><span class="ecrm-0500">18</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;atomic_t&nbsp;chris&nbsp;=&nbsp;ATOMIC_INIT(50);</span> 
<a id="x1-48038r19"></a><span class="ecrm-0500">19</span> 
<a id="x1-48040r20"></a><span class="ecrm-0500">20</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;atomic_set(&amp;debbie,&nbsp;45);</span> 
<a id="x1-48042r21"></a><span class="ecrm-0500">21</span> 
<a id="x1-48044r22"></a><span class="ecrm-0500">22</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1927"><span class="ectt-0800">/*&nbsp;subtract&nbsp;one&nbsp;*/</span></span> 
<a id="x1-48046r23"></a><span class="ecrm-0500">23</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;atomic_dec(&amp;debbie);</span> 
<a id="x1-48048r24"></a><span class="ecrm-0500">24</span> 
<a id="x1-48050r25"></a><span class="ecrm-0500">25</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;atomic_add(7,&nbsp;&amp;debbie);</span> 
<a id="x1-48052r26"></a><span class="ecrm-0500">26</span> 
<a id="x1-48054r27"></a><span class="ecrm-0500">27</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1928"><span class="ectt-0800">/*&nbsp;add&nbsp;one&nbsp;*/</span></span> 
<a id="x1-48056r28"></a><span class="ecrm-0500">28</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;atomic_inc(&amp;debbie);</span> 
<a id="x1-48058r29"></a><span class="ecrm-0500">29</span> 
<a id="x1-48060r30"></a><span class="ecrm-0500">30</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor1929"><span class="ectt-0800">"chris:&nbsp;%d,&nbsp;debbie:&nbsp;%d</span></span><span id="textcolor1930"><span class="ectt-0800">\n</span></span><span id="textcolor1931"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;atomic_read(&amp;chris),</span> 
<a id="x1-48062r31"></a><span class="ecrm-0500">31</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;atomic_read(&amp;debbie));</span> 
<a id="x1-48064r32"></a><span class="ecrm-0500">32</span><span class="ectt-0800">}</span> 
<a id="x1-48066r33"></a><span class="ecrm-0500">33</span> 
<a id="x1-48068r34"></a><span class="ecrm-0500">34</span><span id="textcolor1932"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1933"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;atomic_bitwise(</span><span id="textcolor1934"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-48070r35"></a><span class="ecrm-0500">35</span><span class="ectt-0800">{</span> 
<a id="x1-48072r36"></a><span class="ecrm-0500">36</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1935"><span class="ectt-0800">unsigned</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1936"><span class="ectt-0800">long</span></span><span class="ectt-0800">&nbsp;word&nbsp;=&nbsp;0;</span> 
<a id="x1-48074r37"></a><span class="ecrm-0500">37</span> 
<a id="x1-48076r38"></a><span class="ecrm-0500">38</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor1937"><span class="ectt-0800">"Bits&nbsp;0:&nbsp;"</span></span><span class="ectt-0800">&nbsp;BYTE_TO_BINARY_PATTERN,&nbsp;BYTE_TO_BINARY(word));</span> 
<a id="x1-48078r39"></a><span class="ecrm-0500">39</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;set_bit(3,&nbsp;&amp;word);</span> 
<a id="x1-48080r40"></a><span class="ecrm-0500">40</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;set_bit(5,&nbsp;&amp;word);</span> 
<a id="x1-48082r41"></a><span class="ecrm-0500">41</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor1938"><span class="ectt-0800">"Bits&nbsp;1:&nbsp;"</span></span><span class="ectt-0800">&nbsp;BYTE_TO_BINARY_PATTERN,&nbsp;BYTE_TO_BINARY(word));</span> 
<a id="x1-48084r42"></a><span class="ecrm-0500">42</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;clear_bit(5,&nbsp;&amp;word);</span> 
<a id="x1-48086r43"></a><span class="ecrm-0500">43</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor1939"><span class="ectt-0800">"Bits&nbsp;2:&nbsp;"</span></span><span class="ectt-0800">&nbsp;BYTE_TO_BINARY_PATTERN,&nbsp;BYTE_TO_BINARY(word));</span> 
<a id="x1-48088r44"></a><span class="ecrm-0500">44</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;change_bit(3,&nbsp;&amp;word);</span> 
<a id="x1-48090r45"></a><span class="ecrm-0500">45</span> 
<a id="x1-48092r46"></a><span class="ecrm-0500">46</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor1940"><span class="ectt-0800">"Bits&nbsp;3:&nbsp;"</span></span><span class="ectt-0800">&nbsp;BYTE_TO_BINARY_PATTERN,&nbsp;BYTE_TO_BINARY(word));</span> 
<a id="x1-48094r47"></a><span class="ecrm-0500">47</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1941"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(test_and_set_bit(3,&nbsp;&amp;word))</span> 
<a id="x1-48096r48"></a><span class="ecrm-0500">48</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor1942"><span class="ectt-0800">"wrong</span></span><span id="textcolor1943"><span class="ectt-0800">\n</span></span><span id="textcolor1944"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-48098r49"></a><span class="ecrm-0500">49</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor1945"><span class="ectt-0800">"Bits&nbsp;4:&nbsp;"</span></span><span class="ectt-0800">&nbsp;BYTE_TO_BINARY_PATTERN,&nbsp;BYTE_TO_BINARY(word));</span> 
<a id="x1-48100r50"></a><span class="ecrm-0500">50</span> 
<a id="x1-48102r51"></a><span class="ecrm-0500">51</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;word&nbsp;=&nbsp;255;</span> 
<a id="x1-48104r52"></a><span class="ecrm-0500">52</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor1946"><span class="ectt-0800">"Bits&nbsp;5:&nbsp;"</span></span><span class="ectt-0800">&nbsp;BYTE_TO_BINARY_PATTERN,&nbsp;BYTE_TO_BINARY(word));</span> 
<a id="x1-48106r53"></a><span class="ecrm-0500">53</span><span class="ectt-0800">}</span> 
<a id="x1-48108r54"></a><span class="ecrm-0500">54</span> 
<a id="x1-48110r55"></a><span class="ecrm-0500">55</span><span id="textcolor1947"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1948"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;example_atomic_init(</span><span id="textcolor1949"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-48112r56"></a><span class="ecrm-0500">56</span><span class="ectt-0800">{</span> 
<a id="x1-48114r57"></a><span class="ecrm-0500">57</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor1950"><span class="ectt-0800">"example_atomic&nbsp;started</span></span><span id="textcolor1951"><span class="ectt-0800">\n</span></span><span id="textcolor1952"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-48116r58"></a><span class="ecrm-0500">58</span> 
<a id="x1-48118r59"></a><span class="ecrm-0500">59</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;atomic_add_subtract();</span> 
<a id="x1-48120r60"></a><span class="ecrm-0500">60</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;atomic_bitwise();</span> 
<a id="x1-48122r61"></a><span class="ecrm-0500">61</span> 
<a id="x1-48124r62"></a><span class="ecrm-0500">62</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1953"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;0;</span> 
<a id="x1-48126r63"></a><span class="ecrm-0500">63</span><span class="ectt-0800">}</span> 
<a id="x1-48128r64"></a><span class="ecrm-0500">64</span> 
<a id="x1-48130r65"></a><span class="ecrm-0500">65</span><span id="textcolor1954"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1955"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;example_atomic_exit(</span><span id="textcolor1956"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-48132r66"></a><span class="ecrm-0500">66</span><span class="ectt-0800">{</span> 
<a id="x1-48134r67"></a><span class="ecrm-0500">67</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor1957"><span class="ectt-0800">"example_atomic&nbsp;exit</span></span><span id="textcolor1958"><span class="ectt-0800">\n</span></span><span id="textcolor1959"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-48136r68"></a><span class="ecrm-0500">68</span><span class="ectt-0800">}</span> 
<a id="x1-48138r69"></a><span class="ecrm-0500">69</span> 
<a id="x1-48140r70"></a><span class="ecrm-0500">70</span><span class="ectt-0800">module_init(example_atomic_init);</span> 
<a id="x1-48142r71"></a><span class="ecrm-0500">71</span><span class="ectt-0800">module_exit(example_atomic_exit);</span> 
<a id="x1-48144r72"></a><span class="ecrm-0500">72</span> 
<a id="x1-48146r73"></a><span class="ecrm-0500">73</span><span class="ectt-0800">MODULE_DESCRIPTION(</span><span id="textcolor1960"><span class="ectt-0800">"Atomic&nbsp;operations&nbsp;example"</span></span><span class="ectt-0800">);</span> 
<a id="x1-48148r74"></a><span class="ecrm-0500">74</span><span class="ectt-0800">MODULE_LICENSE(</span><span id="textcolor1961"><span class="ectt-0800">"GPL"</span></span><span class="ectt-0800">);</span></pre>
                                                                  

                                                                  
<!-- l. 1364 --><p class="noindent">
</p>
   <h3 class="sectionHead" id="replacing-print-macros"><span class="titlemark">0.13   </span> <a id="x1-490000.13"></a>Replacing Print Macros</h3>
<!-- l. 1366 --><p class="noindent">
</p>
   <h4 class="subsectionHead" id="replacement"><span class="titlemark">0.13.1   </span> <a id="x1-500000.13.1"></a>Replacement</h4>
<!-- l. 1368 --><p class="noindent">In Section <a href="https://sysprog21.github.io/lkmpg/#x1-80042">2<!-- tex4ht:ref: sec:using_x  --></a>, I said that X Window System and kernel module programming do not
mix. That is true for developing kernel modules, but in actual use, you want to be
able to send messages to whichever tty the command to load the module came
from.
</p><!-- l. 1371 --><p class="indent">   "tty" is an abbreviation of <span class="ecti-1000">teletype</span>: originally a combination keyboard-printer
used to communicate with a Unix system, and today an abstraction for the text
stream used for a Unix program, whether it is a physical terminal, an xterm on an X
display, a network connection used with ssh, etc.
</p><!-- l. 1373 --><p class="indent">   The way this is done is by using current, a pointer to the currently running task,
to get the current task’s tty structure. Then, we look inside that tty structure to find
a pointer to a string write function, which we use to write a string to the
tty.
</p><!-- l. 1 --><p class="indent">
</p>
   <pre class="fancyvrb" id="fancyvrb61"><a id="x1-50002r1"></a><span class="ecrm-0500">1</span><span id="textcolor1962"><span class="ectt-0800">/*</span></span> 
<a id="x1-50004r2"></a><span class="ecrm-0500">2</span><span id="textcolor1963"><span class="ectt-0800">&nbsp;*&nbsp;print_string.c&nbsp;-&nbsp;Send&nbsp;output&nbsp;to&nbsp;the&nbsp;tty&nbsp;we</span><span class="tctt-0800">'</span><span class="ectt-0800">re&nbsp;running&nbsp;on,&nbsp;regardless&nbsp;if</span></span> 
<a id="x1-50006r3"></a><span class="ecrm-0500">3</span><span id="textcolor1964"><span class="ectt-0800">&nbsp;*&nbsp;it&nbsp;is&nbsp;through&nbsp;X11,&nbsp;telnet,&nbsp;etc.&nbsp;&nbsp;We&nbsp;do&nbsp;this&nbsp;by&nbsp;printing&nbsp;the&nbsp;string&nbsp;to&nbsp;the</span></span> 
<a id="x1-50008r4"></a><span class="ecrm-0500">4</span><span id="textcolor1965"><span class="ectt-0800">&nbsp;*&nbsp;tty&nbsp;associated&nbsp;with&nbsp;the&nbsp;current&nbsp;task.</span></span> 
<a id="x1-50010r5"></a><span class="ecrm-0500">5</span><span id="textcolor1966"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-50012r6"></a><span class="ecrm-0500">6</span><span id="textcolor1967"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1968"><span class="ectt-0800">&lt;linux/init.h&gt;</span></span> 
<a id="x1-50014r7"></a><span class="ecrm-0500">7</span><span id="textcolor1969"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1970"><span class="ectt-0800">&lt;linux/kernel.h&gt;</span></span> 
<a id="x1-50016r8"></a><span class="ecrm-0500">8</span><span id="textcolor1971"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1972"><span class="ectt-0800">&lt;linux/module.h&gt;</span></span> 
<a id="x1-50018r9"></a><span class="ecrm-0500">9</span><span id="textcolor1973"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1974"><span class="ectt-0800">&lt;linux/sched.h&gt;&nbsp;/*&nbsp;For&nbsp;current&nbsp;*/</span></span> 
<a id="x1-50020r10"></a><span class="ecrm-0500">10</span><span id="textcolor1975"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1976"><span class="ectt-0800">&lt;linux/tty.h&gt;&nbsp;&nbsp;&nbsp;/*&nbsp;For&nbsp;the&nbsp;tty&nbsp;declarations&nbsp;*/</span></span> 
<a id="x1-50022r11"></a><span class="ecrm-0500">11</span> 
<a id="x1-50024r12"></a><span class="ecrm-0500">12</span><span id="textcolor1977"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1978"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;print_string(</span><span id="textcolor1979"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;*str)</span> 
<a id="x1-50026r13"></a><span class="ecrm-0500">13</span><span class="ectt-0800">{</span> 
<a id="x1-50028r14"></a><span class="ecrm-0500">14</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1980"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;tty_struct&nbsp;*my_tty;</span> 
<a id="x1-50030r15"></a><span class="ecrm-0500">15</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1981"><span class="ectt-0800">const</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor1982"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;tty_operations&nbsp;*ttyops;</span> 
<a id="x1-50032r16"></a><span class="ecrm-0500">16</span> 
<a id="x1-50034r17"></a><span class="ecrm-0500">17</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1983"><span class="ectt-0800">/*&nbsp;The&nbsp;tty&nbsp;for&nbsp;the&nbsp;current&nbsp;task,&nbsp;for&nbsp;2.6.6+&nbsp;kernels&nbsp;*/</span></span> 
<a id="x1-50036r18"></a><span class="ecrm-0500">18</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;my_tty&nbsp;=&nbsp;get_current_tty();</span> 
<a id="x1-50038r19"></a><span class="ecrm-0500">19</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;ttyops&nbsp;=&nbsp;my_tty-&gt;driver-&gt;ops;</span> 
<a id="x1-50040r20"></a><span class="ecrm-0500">20</span> 
<a id="x1-50042r21"></a><span class="ecrm-0500">21</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1984"><span class="ectt-0800">/*&nbsp;If&nbsp;my_tty&nbsp;is&nbsp;NULL,&nbsp;the&nbsp;current&nbsp;task&nbsp;has&nbsp;no&nbsp;tty&nbsp;you&nbsp;can&nbsp;print&nbsp;to&nbsp;(i.e.,</span></span> 
<a id="x1-50044r22"></a><span class="ecrm-0500">22</span><span id="textcolor1985"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;if&nbsp;it&nbsp;is&nbsp;a&nbsp;daemon).&nbsp;If&nbsp;so,&nbsp;there&nbsp;is&nbsp;nothing&nbsp;we&nbsp;can&nbsp;do.</span></span> 
<a id="x1-50046r23"></a><span class="ecrm-0500">23</span><span id="textcolor1986"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span></span> 
<a id="x1-50048r24"></a><span class="ecrm-0500">24</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1987"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(my_tty)&nbsp;{</span> 
<a id="x1-50050r25"></a><span class="ecrm-0500">25</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor1988"><span class="ectt-0800">/*&nbsp;my_tty-&gt;driver&nbsp;is&nbsp;a&nbsp;struct&nbsp;which&nbsp;holds&nbsp;the&nbsp;tty</span><span class="tctt-0800">'</span><span class="ectt-0800">s&nbsp;functions,</span></span> 
<a id="x1-50052r26"></a><span class="ecrm-0500">26</span><span id="textcolor1989"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;one&nbsp;of&nbsp;which&nbsp;(write)&nbsp;is&nbsp;used&nbsp;to&nbsp;write&nbsp;strings&nbsp;to&nbsp;the&nbsp;tty.</span></span> 
<a id="x1-50054r27"></a><span class="ecrm-0500">27</span><span id="textcolor1990"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;It&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;take&nbsp;a&nbsp;string&nbsp;either&nbsp;from&nbsp;the&nbsp;user</span><span class="tctt-0800">'</span><span class="ectt-0800">s&nbsp;or</span></span> 
<a id="x1-50056r28"></a><span class="ecrm-0500">28</span><span id="textcolor1991"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;kernel</span><span class="tctt-0800">'</span><span class="ectt-0800">s&nbsp;memory&nbsp;segment.</span></span> 
<a id="x1-50058r29"></a><span class="ecrm-0500">29</span><span id="textcolor1992"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*</span></span> 
<a id="x1-50060r30"></a><span class="ecrm-0500">30</span><span id="textcolor1993"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;function</span><span class="tctt-0800">'</span><span class="ectt-0800">s&nbsp;1st&nbsp;parameter&nbsp;is&nbsp;the&nbsp;tty&nbsp;to&nbsp;write&nbsp;to,&nbsp;because&nbsp;the</span></span> 
<a id="x1-50062r31"></a><span class="ecrm-0500">31</span><span id="textcolor1994"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;same&nbsp;function&nbsp;would&nbsp;normally&nbsp;be&nbsp;used&nbsp;for&nbsp;all&nbsp;tty</span><span class="tctt-0800">'</span><span class="ectt-0800">s&nbsp;of&nbsp;a&nbsp;certain</span></span> 
<a id="x1-50064r32"></a><span class="ecrm-0500">32</span><span id="textcolor1995"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;type.</span></span> 
<a id="x1-50066r33"></a><span class="ecrm-0500">33</span><span id="textcolor1996"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;2nd&nbsp;parameter&nbsp;is&nbsp;a&nbsp;pointer&nbsp;to&nbsp;a&nbsp;string.</span></span> 
<a id="x1-50068r34"></a><span class="ecrm-0500">34</span><span id="textcolor1997"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;3rd&nbsp;parameter&nbsp;is&nbsp;the&nbsp;length&nbsp;of&nbsp;the&nbsp;string.</span></span> 
<a id="x1-50070r35"></a><span class="ecrm-0500">35</span><span id="textcolor1998"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*</span></span> 
<a id="x1-50072r36"></a><span class="ecrm-0500">36</span><span id="textcolor1999"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;As&nbsp;you&nbsp;will&nbsp;see&nbsp;below,&nbsp;sometimes&nbsp;it</span><span class="tctt-0800">'</span><span class="ectt-0800">s&nbsp;necessary&nbsp;to&nbsp;use</span></span> 
<a id="x1-50074r37"></a><span class="ecrm-0500">37</span><span id="textcolor2000"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;preprocessor&nbsp;stuff&nbsp;to&nbsp;create&nbsp;code&nbsp;that&nbsp;works&nbsp;for&nbsp;different</span></span> 
<a id="x1-50076r38"></a><span class="ecrm-0500">38</span><span id="textcolor2001"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;kernel&nbsp;versions.&nbsp;The&nbsp;(naive)&nbsp;approach&nbsp;we</span><span class="tctt-0800">'</span><span class="ectt-0800">ve&nbsp;taken&nbsp;here&nbsp;does&nbsp;not</span></span> 
<a id="x1-50078r39"></a><span class="ecrm-0500">39</span><span id="textcolor2002"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;scale&nbsp;well.&nbsp;The&nbsp;right&nbsp;way&nbsp;to&nbsp;deal&nbsp;with&nbsp;this&nbsp;is&nbsp;described&nbsp;in</span></span> 
<a id="x1-50080r40"></a><span class="ecrm-0500">40</span><span id="textcolor2003"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;section&nbsp;2&nbsp;of</span></span> 
<a id="x1-50082r41"></a><span class="ecrm-0500">41</span><span id="textcolor2004"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;linux/Documentation/SubmittingPatches</span></span> 
<a id="x1-50084r42"></a><span class="ecrm-0500">42</span><span id="textcolor2005"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span></span> 
<a id="x1-50086r43"></a><span class="ecrm-0500">43</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(ttyops-&gt;write)(my_tty,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2006"><span class="ectt-0800">/*&nbsp;The&nbsp;tty&nbsp;itself&nbsp;*/</span></span> 
<a id="x1-50088r44"></a><span class="ecrm-0500">44</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;str,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2007"><span class="ectt-0800">/*&nbsp;String&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span></span> 
<a id="x1-50090r45"></a><span class="ecrm-0500">45</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;strlen(str));&nbsp;</span><span id="textcolor2008"><span class="ectt-0800">/*&nbsp;Length&nbsp;*/</span></span> 
<a id="x1-50092r46"></a><span class="ecrm-0500">46</span> 
<a id="x1-50094r47"></a><span class="ecrm-0500">47</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2009"><span class="ectt-0800">/*&nbsp;ttys&nbsp;were&nbsp;originally&nbsp;hardware&nbsp;devices,&nbsp;which&nbsp;(usually)&nbsp;strictly</span></span> 
<a id="x1-50096r48"></a><span class="ecrm-0500">48</span><span id="textcolor2010"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;followed&nbsp;the&nbsp;ASCII&nbsp;standard.&nbsp;In&nbsp;ASCII,&nbsp;to&nbsp;move&nbsp;to&nbsp;a&nbsp;new&nbsp;line&nbsp;you</span></span> 
<a id="x1-50098r49"></a><span class="ecrm-0500">49</span><span id="textcolor2011"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;need&nbsp;two&nbsp;characters,&nbsp;a&nbsp;carriage&nbsp;return&nbsp;and&nbsp;a&nbsp;line&nbsp;feed.&nbsp;On&nbsp;Unix,</span></span> 
<a id="x1-50100r50"></a><span class="ecrm-0500">50</span><span id="textcolor2012"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;the&nbsp;ASCII&nbsp;line&nbsp;feed&nbsp;is&nbsp;used&nbsp;for&nbsp;both&nbsp;purposes&nbsp;-&nbsp;so&nbsp;we&nbsp;can&nbsp;not</span></span> 
<a id="x1-50102r51"></a><span class="ecrm-0500">51</span><span id="textcolor2013"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;just&nbsp;use&nbsp;\n,&nbsp;because&nbsp;it&nbsp;would&nbsp;not&nbsp;have&nbsp;a&nbsp;carriage&nbsp;return&nbsp;and&nbsp;the</span></span> 
<a id="x1-50104r52"></a><span class="ecrm-0500">52</span><span id="textcolor2014"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;next&nbsp;line&nbsp;will&nbsp;start&nbsp;at&nbsp;the&nbsp;column&nbsp;right&nbsp;after&nbsp;the&nbsp;line&nbsp;feed.</span></span> 
<a id="x1-50106r53"></a><span class="ecrm-0500">53</span><span id="textcolor2015"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*</span></span> 
<a id="x1-50108r54"></a><span class="ecrm-0500">54</span><span id="textcolor2016"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;This&nbsp;is&nbsp;why&nbsp;text&nbsp;files&nbsp;are&nbsp;different&nbsp;between&nbsp;Unix&nbsp;and&nbsp;MS&nbsp;Windows.</span></span> 
<a id="x1-50110r55"></a><span class="ecrm-0500">55</span><span id="textcolor2017"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;In&nbsp;CP/M&nbsp;and&nbsp;derivatives,&nbsp;like&nbsp;MS-DOS&nbsp;and&nbsp;MS&nbsp;Windows,&nbsp;the&nbsp;ASCII</span></span> 
<a id="x1-50112r56"></a><span class="ecrm-0500">56</span><span id="textcolor2018"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;standard&nbsp;was&nbsp;strictly&nbsp;adhered&nbsp;to,&nbsp;and&nbsp;therefore&nbsp;a&nbsp;newline&nbsp;requirs</span></span> 
<a id="x1-50114r57"></a><span class="ecrm-0500">57</span><span id="textcolor2019"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;both&nbsp;a&nbsp;LF&nbsp;and&nbsp;a&nbsp;CR.</span></span> 
<a id="x1-50116r58"></a><span class="ecrm-0500">58</span><span id="textcolor2020"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span></span> 
<a id="x1-50118r59"></a><span class="ecrm-0500">59</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(ttyops-&gt;write)(my_tty,&nbsp;</span><span id="textcolor2021"><span class="ectt-0800">"</span></span><span id="textcolor2022"><span class="ectt-0800">\015\012</span></span><span id="textcolor2023"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;2);</span> 
<a id="x1-50120r60"></a><span class="ecrm-0500">60</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-50122r61"></a><span class="ecrm-0500">61</span><span class="ectt-0800">}</span> 
<a id="x1-50124r62"></a><span class="ecrm-0500">62</span> 
<a id="x1-50126r63"></a><span class="ecrm-0500">63</span><span id="textcolor2024"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2025"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;__init&nbsp;print_string_init(</span><span id="textcolor2026"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-50128r64"></a><span class="ecrm-0500">64</span><span class="ectt-0800">{</span> 
<a id="x1-50130r65"></a><span class="ecrm-0500">65</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;print_string(</span><span id="textcolor2027"><span class="ectt-0800">"The&nbsp;module&nbsp;has&nbsp;been&nbsp;inserted.&nbsp;&nbsp;Hello&nbsp;world!"</span></span><span class="ectt-0800">);</span> 
<a id="x1-50132r66"></a><span class="ecrm-0500">66</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2028"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;0;</span> 
<a id="x1-50134r67"></a><span class="ecrm-0500">67</span><span class="ectt-0800">}</span> 
<a id="x1-50136r68"></a><span class="ecrm-0500">68</span> 
<a id="x1-50138r69"></a><span class="ecrm-0500">69</span><span id="textcolor2029"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2030"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;__exit&nbsp;print_string_exit(</span><span id="textcolor2031"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-50140r70"></a><span class="ecrm-0500">70</span><span class="ectt-0800">{</span> 
<a id="x1-50142r71"></a><span class="ecrm-0500">71</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;print_string(</span><span id="textcolor2032"><span class="ectt-0800">"The&nbsp;module&nbsp;has&nbsp;been&nbsp;removed.&nbsp;&nbsp;Farewell&nbsp;world!"</span></span><span class="ectt-0800">);</span> 
<a id="x1-50144r72"></a><span class="ecrm-0500">72</span><span class="ectt-0800">}</span> 
<a id="x1-50146r73"></a><span class="ecrm-0500">73</span> 
<a id="x1-50148r74"></a><span class="ecrm-0500">74</span><span class="ectt-0800">module_init(print_string_init);</span> 
<a id="x1-50150r75"></a><span class="ecrm-0500">75</span><span class="ectt-0800">module_exit(print_string_exit);</span> 
<a id="x1-50152r76"></a><span class="ecrm-0500">76</span> 
<a id="x1-50154r77"></a><span class="ecrm-0500">77</span><span class="ectt-0800">MODULE_LICENSE(</span><span id="textcolor2033"><span class="ectt-0800">"GPL"</span></span><span class="ectt-0800">);</span></pre>
<!-- l. 1378 --><p class="noindent">
</p>
   <h4 class="subsectionHead" id="flashing-keyboard-leds"><span class="titlemark">0.13.2   </span> <a id="x1-510000.13.2"></a>Flashing keyboard LEDs</h4>
<!-- l. 1380 --><p class="noindent">In certain conditions, you may desire a simpler and more direct way to communicate
to the external world. Flashing keyboard LEDs can be such a solution: It is an
immediate way to attract attention or to display a status condition. Keyboard LEDs
are present on every hardware, they are always visible, they do not need any setup,
and their use is rather simple and non-intrusive, compared to writing to a tty or a
file.
</p><!-- l. 1384 --><p class="indent">   The following source code illustrates a minimal kernel module which, when
loaded, starts blinking the keyboard LEDs until it is unloaded.
</p><!-- l. 1 --><p class="indent">
</p>
   <pre class="fancyvrb" id="fancyvrb62"><a id="x1-51002r1"></a><span class="ecrm-0500">1</span><span id="textcolor2034"><span class="ectt-0800">/*</span></span> 
<a id="x1-51004r2"></a><span class="ecrm-0500">2</span><span id="textcolor2035"><span class="ectt-0800">&nbsp;*&nbsp;kbleds.c&nbsp;-&nbsp;Blink&nbsp;keyboard&nbsp;leds&nbsp;until&nbsp;the&nbsp;module&nbsp;is&nbsp;unloaded.</span></span> 
<a id="x1-51006r3"></a><span class="ecrm-0500">3</span><span id="textcolor2036"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-51008r4"></a><span class="ecrm-0500">4</span> 
<a id="x1-51010r5"></a><span class="ecrm-0500">5</span><span id="textcolor2037"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2038"><span class="ectt-0800">&lt;linux/init.h&gt;</span></span> 
<a id="x1-51012r6"></a><span class="ecrm-0500">6</span><span id="textcolor2039"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2040"><span class="ectt-0800">&lt;linux/kd.h&gt;&nbsp;/*&nbsp;For&nbsp;KDSETLED&nbsp;*/</span></span> 
<a id="x1-51014r7"></a><span class="ecrm-0500">7</span><span id="textcolor2041"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2042"><span class="ectt-0800">&lt;linux/module.h&gt;</span></span> 
<a id="x1-51016r8"></a><span class="ecrm-0500">8</span><span id="textcolor2043"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2044"><span class="ectt-0800">&lt;linux/tty.h&gt;&nbsp;/*&nbsp;For&nbsp;fg_console,&nbsp;MAX_NR_CONSOLES&nbsp;*/</span></span> 
<a id="x1-51018r9"></a><span class="ecrm-0500">9</span><span id="textcolor2045"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2046"><span class="ectt-0800">&lt;linux/vt.h&gt;</span></span> 
<a id="x1-51020r10"></a><span class="ecrm-0500">10</span><span id="textcolor2047"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2048"><span class="ectt-0800">&lt;linux/vt_kern.h&gt;&nbsp;/*&nbsp;for&nbsp;fg_console&nbsp;*/</span></span> 
<a id="x1-51022r11"></a><span class="ecrm-0500">11</span> 
<a id="x1-51024r12"></a><span class="ecrm-0500">12</span><span id="textcolor2049"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2050"><span class="ectt-0800">&lt;linux/console_struct.h&gt;&nbsp;/*&nbsp;For&nbsp;vc_cons&nbsp;*/</span></span> 
<a id="x1-51026r13"></a><span class="ecrm-0500">13</span> 
<a id="x1-51028r14"></a><span class="ecrm-0500">14</span><span class="ectt-0800">MODULE_DESCRIPTION(</span><span id="textcolor2051"><span class="ectt-0800">"Example&nbsp;module&nbsp;illustrating&nbsp;the&nbsp;use&nbsp;of&nbsp;Keyboard&nbsp;LEDs."</span></span><span class="ectt-0800">);</span> 
<a id="x1-51030r15"></a><span class="ecrm-0500">15</span> 
<a id="x1-51032r16"></a><span class="ecrm-0500">16</span><span id="textcolor2052"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;timer_list&nbsp;my_timer;</span> 
<a id="x1-51034r17"></a><span class="ecrm-0500">17</span><span id="textcolor2053"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;tty_driver&nbsp;*my_driver;</span> 
<a id="x1-51036r18"></a><span class="ecrm-0500">18</span><span id="textcolor2054"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;kbledstatus&nbsp;=&nbsp;0;</span> 
<a id="x1-51038r19"></a><span class="ecrm-0500">19</span> 
<a id="x1-51040r20"></a><span class="ecrm-0500">20</span><span id="textcolor2055"><span class="ectt-0800">#define&nbsp;BLINK_DELAY&nbsp;HZ&nbsp;/&nbsp;5</span></span> 
<a id="x1-51042r21"></a><span class="ecrm-0500">21</span><span id="textcolor2056"><span class="ectt-0800">#define&nbsp;ALL_LEDS_ON&nbsp;0x07</span></span> 
<a id="x1-51044r22"></a><span class="ecrm-0500">22</span><span id="textcolor2057"><span class="ectt-0800">#define&nbsp;RESTORE_LEDS&nbsp;0xFF</span></span> 
<a id="x1-51046r23"></a><span class="ecrm-0500">23</span> 
<a id="x1-51048r24"></a><span class="ecrm-0500">24</span><span id="textcolor2058"><span class="ectt-0800">/*&nbsp;Function&nbsp;my_timer_func&nbsp;blinks&nbsp;the&nbsp;keyboard&nbsp;LEDs&nbsp;periodically&nbsp;by&nbsp;invoking</span></span> 
<a id="x1-51050r25"></a><span class="ecrm-0500">25</span><span id="textcolor2059"><span class="ectt-0800">&nbsp;*&nbsp;command&nbsp;KDSETLED&nbsp;of&nbsp;ioctl()&nbsp;on&nbsp;the&nbsp;keyboard&nbsp;driver.&nbsp;To&nbsp;learn&nbsp;more&nbsp;on&nbsp;virtual</span></span> 
<a id="x1-51052r26"></a><span class="ecrm-0500">26</span><span id="textcolor2060"><span class="ectt-0800">&nbsp;*&nbsp;terminal&nbsp;ioctl&nbsp;operations,&nbsp;please&nbsp;see&nbsp;file:</span></span> 
<a id="x1-51054r27"></a><span class="ecrm-0500">27</span><span id="textcolor2061"><span class="ectt-0800">&nbsp;*&nbsp;&nbsp;&nbsp;drivers/char/vt_ioctl.c,&nbsp;function&nbsp;vt_ioctl().</span></span> 
<a id="x1-51056r28"></a><span class="ecrm-0500">28</span><span id="textcolor2062"><span class="ectt-0800">&nbsp;*</span></span> 
<a id="x1-51058r29"></a><span class="ecrm-0500">29</span><span id="textcolor2063"><span class="ectt-0800">&nbsp;*&nbsp;The&nbsp;argument&nbsp;to&nbsp;KDSETLED&nbsp;is&nbsp;alternatively&nbsp;set&nbsp;to&nbsp;7&nbsp;(thus&nbsp;causing&nbsp;the&nbsp;led</span></span> 
<a id="x1-51060r30"></a><span class="ecrm-0500">30</span><span id="textcolor2064"><span class="ectt-0800">&nbsp;*&nbsp;mode&nbsp;to&nbsp;be&nbsp;set&nbsp;to&nbsp;LED_SHOW_IOCTL,&nbsp;and&nbsp;all&nbsp;the&nbsp;leds&nbsp;are&nbsp;lit)&nbsp;and&nbsp;to&nbsp;0xFF</span></span> 
<a id="x1-51062r31"></a><span class="ecrm-0500">31</span><span id="textcolor2065"><span class="ectt-0800">&nbsp;*&nbsp;(any&nbsp;value&nbsp;above&nbsp;7&nbsp;switches&nbsp;back&nbsp;the&nbsp;led&nbsp;mode&nbsp;to&nbsp;LED_SHOW_FLAGS,&nbsp;thus</span></span> 
<a id="x1-51064r32"></a><span class="ecrm-0500">32</span><span id="textcolor2066"><span class="ectt-0800">&nbsp;*&nbsp;the&nbsp;LEDs&nbsp;reflect&nbsp;the&nbsp;actual&nbsp;keyboard&nbsp;status).&nbsp;&nbsp;To&nbsp;learn&nbsp;more&nbsp;on&nbsp;this,</span></span> 
<a id="x1-51066r33"></a><span class="ecrm-0500">33</span><span id="textcolor2067"><span class="ectt-0800">&nbsp;*&nbsp;please&nbsp;see&nbsp;file:&nbsp;drivers/char/keyboard.c,&nbsp;function&nbsp;setledstate().</span></span> 
<a id="x1-51068r34"></a><span class="ecrm-0500">34</span><span id="textcolor2068"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-51070r35"></a><span class="ecrm-0500">35</span> 
<a id="x1-51072r36"></a><span class="ecrm-0500">36</span><span id="textcolor2069"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2070"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;my_timer_func(</span><span id="textcolor2071"><span class="ectt-0800">unsigned</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2072"><span class="ectt-0800">long</span></span><span class="ectt-0800">&nbsp;ptr)</span> 
<a id="x1-51074r37"></a><span class="ecrm-0500">37</span><span class="ectt-0800">{</span> 
<a id="x1-51076r38"></a><span class="ecrm-0500">38</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2073"><span class="ectt-0800">unsigned</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2074"><span class="ectt-0800">long</span></span><span class="ectt-0800">&nbsp;*pstatus&nbsp;=&nbsp;(</span><span id="textcolor2075"><span class="ectt-0800">unsigned</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2076"><span class="ectt-0800">long</span></span><span class="ectt-0800">&nbsp;*)&nbsp;ptr;</span> 
<a id="x1-51078r39"></a><span class="ecrm-0500">39</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2077"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;tty_struct&nbsp;*t&nbsp;=&nbsp;vc_cons[fg_console].d-&gt;port.tty;</span> 
<a id="x1-51080r40"></a><span class="ecrm-0500">40</span> 
<a id="x1-51082r41"></a><span class="ecrm-0500">41</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2078"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(*pstatus&nbsp;==&nbsp;ALL_LEDS_ON)</span> 
<a id="x1-51084r42"></a><span class="ecrm-0500">42</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*pstatus&nbsp;=&nbsp;RESTORE_LEDS;</span> 
<a id="x1-51086r43"></a><span class="ecrm-0500">43</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2079"><span class="ectt-0800">else</span></span> 
<a id="x1-51088r44"></a><span class="ecrm-0500">44</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*pstatus&nbsp;=&nbsp;ALL_LEDS_ON;</span> 
<a id="x1-51090r45"></a><span class="ecrm-0500">45</span> 
<a id="x1-51092r46"></a><span class="ecrm-0500">46</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;(my_driver-&gt;ops-&gt;ioctl)(t,&nbsp;KDSETLED,&nbsp;*pstatus);</span> 
<a id="x1-51094r47"></a><span class="ecrm-0500">47</span> 
<a id="x1-51096r48"></a><span class="ecrm-0500">48</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;my_timer.expires&nbsp;=&nbsp;jiffies&nbsp;+&nbsp;BLINK_DELAY;</span> 
<a id="x1-51098r49"></a><span class="ecrm-0500">49</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;add_timer(&amp;my_timer);</span> 
<a id="x1-51100r50"></a><span class="ecrm-0500">50</span><span class="ectt-0800">}</span> 
<a id="x1-51102r51"></a><span class="ecrm-0500">51</span> 
<a id="x1-51104r52"></a><span class="ecrm-0500">52</span><span id="textcolor2080"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2081"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;__init&nbsp;kbleds_init(</span><span id="textcolor2082"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-51106r53"></a><span class="ecrm-0500">53</span><span class="ectt-0800">{</span> 
<a id="x1-51108r54"></a><span class="ecrm-0500">54</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2083"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;i;</span> 
<a id="x1-51110r55"></a><span class="ecrm-0500">55</span> 
<a id="x1-51112r56"></a><span class="ecrm-0500">56</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor2084"><span class="ectt-0800">"kbleds:&nbsp;loading</span></span><span id="textcolor2085"><span class="ectt-0800">\n</span></span><span id="textcolor2086"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-51114r57"></a><span class="ecrm-0500">57</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor2087"><span class="ectt-0800">"kbleds:&nbsp;fgconsole&nbsp;is&nbsp;%x</span></span><span id="textcolor2088"><span class="ectt-0800">\n</span></span><span id="textcolor2089"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;fg_console);</span> 
<a id="x1-51116r58"></a><span class="ecrm-0500">58</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2090"><span class="ectt-0800">for</span></span><span class="ectt-0800">&nbsp;(i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;MAX_NR_CONSOLES;&nbsp;i++)&nbsp;{</span> 
<a id="x1-51118r59"></a><span class="ecrm-0500">59</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2091"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(!vc_cons[i].d)</span> 
<a id="x1-51120r60"></a><span class="ecrm-0500">60</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2092"><span class="ectt-0800">break</span></span><span class="ectt-0800">;</span> 
<a id="x1-51122r61"></a><span class="ecrm-0500">61</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor2093"><span class="ectt-0800">"poet_atkm:&nbsp;console[%i/%i]&nbsp;#%i,&nbsp;tty&nbsp;%lx</span></span><span id="textcolor2094"><span class="ectt-0800">\n</span></span><span id="textcolor2095"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;i,&nbsp;MAX_NR_CONSOLES,</span> 
<a id="x1-51124r62"></a><span class="ecrm-0500">62</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vc_cons[i].d-&gt;vc_num,&nbsp;(</span><span id="textcolor2096"><span class="ectt-0800">unsigned</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2097"><span class="ectt-0800">long</span></span><span class="ectt-0800">)&nbsp;vc_cons[i].d-&gt;port.tty);</span> 
<a id="x1-51126r63"></a><span class="ecrm-0500">63</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-51128r64"></a><span class="ecrm-0500">64</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor2098"><span class="ectt-0800">"kbleds:&nbsp;finished&nbsp;scanning&nbsp;consoles</span></span><span id="textcolor2099"><span class="ectt-0800">\n</span></span><span id="textcolor2100"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-51130r65"></a><span class="ecrm-0500">65</span> 
<a id="x1-51132r66"></a><span class="ecrm-0500">66</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;my_driver&nbsp;=&nbsp;vc_cons[fg_console].d-&gt;port.tty-&gt;driver;</span> 
<a id="x1-51134r67"></a><span class="ecrm-0500">67</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor2101"><span class="ectt-0800">"kbleds:&nbsp;tty&nbsp;driver&nbsp;magic&nbsp;%x</span></span><span id="textcolor2102"><span class="ectt-0800">\n</span></span><span id="textcolor2103"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;my_driver-&gt;magic);</span> 
<a id="x1-51136r68"></a><span class="ecrm-0500">68</span> 
<a id="x1-51138r69"></a><span class="ecrm-0500">69</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2104"><span class="ectt-0800">/*&nbsp;Set&nbsp;up&nbsp;the&nbsp;LED&nbsp;blink&nbsp;timer&nbsp;the&nbsp;first&nbsp;time.&nbsp;*/</span></span> 
<a id="x1-51140r70"></a><span class="ecrm-0500">70</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;timer_setup(&amp;my_timer,&nbsp;(</span><span id="textcolor2105"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;*)&nbsp;&amp;my_timer_func,</span> 
<a id="x1-51142r71"></a><span class="ecrm-0500">71</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(</span><span id="textcolor2106"><span class="ectt-0800">unsigned</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2107"><span class="ectt-0800">long</span></span><span class="ectt-0800">)&nbsp;&amp;kbledstatus);</span> 
<a id="x1-51144r72"></a><span class="ecrm-0500">72</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;my_timer.expires&nbsp;=&nbsp;jiffies&nbsp;+&nbsp;BLINK_DELAY;</span> 
<a id="x1-51146r73"></a><span class="ecrm-0500">73</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;add_timer(&amp;my_timer);</span> 
<a id="x1-51148r74"></a><span class="ecrm-0500">74</span> 
<a id="x1-51150r75"></a><span class="ecrm-0500">75</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2108"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;0;</span> 
<a id="x1-51152r76"></a><span class="ecrm-0500">76</span><span class="ectt-0800">}</span> 
<a id="x1-51154r77"></a><span class="ecrm-0500">77</span> 
<a id="x1-51156r78"></a><span class="ecrm-0500">78</span><span id="textcolor2109"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2110"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;__exit&nbsp;kbleds_cleanup(</span><span id="textcolor2111"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-51158r79"></a><span class="ecrm-0500">79</span><span class="ectt-0800">{</span> 
<a id="x1-51160r80"></a><span class="ecrm-0500">80</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor2112"><span class="ectt-0800">"kbleds:&nbsp;unloading...</span></span><span id="textcolor2113"><span class="ectt-0800">\n</span></span><span id="textcolor2114"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-51162r81"></a><span class="ecrm-0500">81</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;del_timer(&amp;my_timer);</span> 
<a id="x1-51164r82"></a><span class="ecrm-0500">82</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;(my_driver-&gt;ops-&gt;ioctl)(vc_cons[fg_console].d-&gt;port.tty,&nbsp;KDSETLED,</span> 
<a id="x1-51166r83"></a><span class="ecrm-0500">83</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RESTORE_LEDS);</span> 
<a id="x1-51168r84"></a><span class="ecrm-0500">84</span><span class="ectt-0800">}</span> 
<a id="x1-51170r85"></a><span class="ecrm-0500">85</span> 
<a id="x1-51172r86"></a><span class="ecrm-0500">86</span><span class="ectt-0800">module_init(kbleds_init);</span> 
<a id="x1-51174r87"></a><span class="ecrm-0500">87</span><span class="ectt-0800">module_exit(kbleds_cleanup);</span> 
<a id="x1-51176r88"></a><span class="ecrm-0500">88</span> 
<a id="x1-51178r89"></a><span class="ecrm-0500">89</span><span class="ectt-0800">MODULE_LICENSE(</span><span id="textcolor2115"><span class="ectt-0800">"GPL"</span></span><span class="ectt-0800">);</span></pre>
                                                                  

                                                                  
<!-- l. 1388 --><p class="indent">   If none of the examples in this chapter fit your debugging needs
there might yet be some other tricks to try. Ever wondered what
<code> <span class="ectt-1000">CONFIG_LL_DEBUG</span>
</code> in <code>  <span class="ectt-1000">make&nbsp;menuconfig</span>
</code> is good for? If you activate that you get low level access to the serial port. While this
might not sound very powerful by itself, you can patch <a href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/printk.c">kernel/printk.c</a> or any other
essential syscall to print ASCII characters, thus makeing it possible to trace virtually
everything what your code does over a serial line. If you find yourself porting the
kernel to some new and former unsupported architecture, this is usually amongst the
first things that should be implemented. Logging over a netconsole might also be
worth a try.
</p><!-- l. 1395 --><p class="indent">   While you have seen lots of stuff that can be used to aid debugging here, there are
some things to be aware of. Debugging is almost always intrusive. Adding debug code
can change the situation enough to make the bug seem to dissappear. Thus you
should try to keep debug code to a minimum and make sure it does not show up in
production code.
</p><!-- l. 1399 --><p class="noindent">
</p>
   <h3 class="sectionHead" id="scheduling-tasks"><span class="titlemark">0.14   </span> <a id="x1-520000.14"></a>Scheduling Tasks</h3>
<!-- l. 1401 --><p class="noindent">There are two main ways of running tasks: tasklets and work queues. Tasklets are a
quick and easy way of scheduling a single function to be run, for example when
triggered from an interrupt, whereas work queues are more complicated but also
better suited to running multiple things in a sequence.
</p><!-- l. 1404 --><p class="noindent">
</p>
   <h4 class="subsectionHead" id="tasklets"><span class="titlemark">0.14.1   </span> <a id="x1-530000.14.1"></a>Tasklets</h4>
<!-- l. 1406 --><p class="noindent">Here is an example tasklet module. The
<code> <span class="ectt-1000">tasklet_fn</span>
</code> function runs for a few seconds and in the mean time execution of the
<code> <span class="ectt-1000">example_tasklet_init</span>
</code> function continues to the exit point.
</p><!-- l. 1 --><p class="indent">
</p>
   <pre class="fancyvrb" id="fancyvrb63"><a id="x1-53004r1"></a><span class="ecrm-0500">1</span><span id="textcolor2116"><span class="ectt-0800">/*</span></span> 
<a id="x1-53006r2"></a><span class="ecrm-0500">2</span><span id="textcolor2117"><span class="ectt-0800">&nbsp;*&nbsp;example_tasklet.c</span></span> 
<a id="x1-53008r3"></a><span class="ecrm-0500">3</span><span id="textcolor2118"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-53010r4"></a><span class="ecrm-0500">4</span><span id="textcolor2119"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2120"><span class="ectt-0800">&lt;linux/delay.h&gt;</span></span> 
<a id="x1-53012r5"></a><span class="ecrm-0500">5</span><span id="textcolor2121"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2122"><span class="ectt-0800">&lt;linux/interrupt.h&gt;</span></span> 
<a id="x1-53014r6"></a><span class="ecrm-0500">6</span><span id="textcolor2123"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2124"><span class="ectt-0800">&lt;linux/kernel.h&gt;</span></span> 
<a id="x1-53016r7"></a><span class="ecrm-0500">7</span><span id="textcolor2125"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2126"><span class="ectt-0800">&lt;linux/module.h&gt;</span></span> 
<a id="x1-53018r8"></a><span class="ecrm-0500">8</span> 
<a id="x1-53020r9"></a><span class="ecrm-0500">9</span><span id="textcolor2127"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2128"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;tasklet_fn(</span><span id="textcolor2129"><span class="ectt-0800">unsigned</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2130"><span class="ectt-0800">long</span></span><span class="ectt-0800">&nbsp;data)</span> 
<a id="x1-53022r10"></a><span class="ecrm-0500">10</span><span class="ectt-0800">{</span> 
<a id="x1-53024r11"></a><span class="ecrm-0500">11</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor2131"><span class="ectt-0800">"Example&nbsp;tasklet&nbsp;starts</span></span><span id="textcolor2132"><span class="ectt-0800">\n</span></span><span id="textcolor2133"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-53026r12"></a><span class="ecrm-0500">12</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;mdelay(5000);</span> 
<a id="x1-53028r13"></a><span class="ecrm-0500">13</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor2134"><span class="ectt-0800">"Example&nbsp;tasklet&nbsp;ends</span></span><span id="textcolor2135"><span class="ectt-0800">\n</span></span><span id="textcolor2136"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-53030r14"></a><span class="ecrm-0500">14</span><span class="ectt-0800">}</span> 
<a id="x1-53032r15"></a><span class="ecrm-0500">15</span> 
<a id="x1-53034r16"></a><span class="ecrm-0500">16</span><span class="ectt-0800">DECLARE_TASKLET(mytask,&nbsp;tasklet_fn,&nbsp;0L);</span> 
<a id="x1-53036r17"></a><span class="ecrm-0500">17</span> 
<a id="x1-53038r18"></a><span class="ecrm-0500">18</span><span id="textcolor2137"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2138"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;example_tasklet_init(</span><span id="textcolor2139"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-53040r19"></a><span class="ecrm-0500">19</span><span class="ectt-0800">{</span> 
<a id="x1-53042r20"></a><span class="ecrm-0500">20</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor2140"><span class="ectt-0800">"tasklet&nbsp;example&nbsp;init</span></span><span id="textcolor2141"><span class="ectt-0800">\n</span></span><span id="textcolor2142"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-53044r21"></a><span class="ecrm-0500">21</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;tasklet_schedule(&amp;mytask);</span> 
<a id="x1-53046r22"></a><span class="ecrm-0500">22</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;mdelay(200);</span> 
<a id="x1-53048r23"></a><span class="ecrm-0500">23</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor2143"><span class="ectt-0800">"Example&nbsp;tasklet&nbsp;init&nbsp;continues...</span></span><span id="textcolor2144"><span class="ectt-0800">\n</span></span><span id="textcolor2145"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-53050r24"></a><span class="ecrm-0500">24</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2146"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;0;</span> 
<a id="x1-53052r25"></a><span class="ecrm-0500">25</span><span class="ectt-0800">}</span> 
<a id="x1-53054r26"></a><span class="ecrm-0500">26</span> 
<a id="x1-53056r27"></a><span class="ecrm-0500">27</span><span id="textcolor2147"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2148"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;example_tasklet_exit(</span><span id="textcolor2149"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-53058r28"></a><span class="ecrm-0500">28</span><span class="ectt-0800">{</span> 
<a id="x1-53060r29"></a><span class="ecrm-0500">29</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor2150"><span class="ectt-0800">"tasklet&nbsp;example&nbsp;exit</span></span><span id="textcolor2151"><span class="ectt-0800">\n</span></span><span id="textcolor2152"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-53062r30"></a><span class="ecrm-0500">30</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;tasklet_kill(&amp;mytask);</span> 
<a id="x1-53064r31"></a><span class="ecrm-0500">31</span><span class="ectt-0800">}</span> 
<a id="x1-53066r32"></a><span class="ecrm-0500">32</span> 
<a id="x1-53068r33"></a><span class="ecrm-0500">33</span><span class="ectt-0800">module_init(example_tasklet_init);</span> 
<a id="x1-53070r34"></a><span class="ecrm-0500">34</span><span class="ectt-0800">module_exit(example_tasklet_exit);</span> 
<a id="x1-53072r35"></a><span class="ecrm-0500">35</span> 
<a id="x1-53074r36"></a><span class="ecrm-0500">36</span><span class="ectt-0800">MODULE_DESCRIPTION(</span><span id="textcolor2153"><span class="ectt-0800">"Tasklet&nbsp;example"</span></span><span class="ectt-0800">);</span> 
<a id="x1-53076r37"></a><span class="ecrm-0500">37</span><span class="ectt-0800">MODULE_LICENSE(</span><span id="textcolor2154"><span class="ectt-0800">"GPL"</span></span><span class="ectt-0800">);</span></pre>
<!-- l. 1411 --><p class="indent">   So with this example loaded <code>  <span class="ectt-1000">dmesg</span>
</code> should show:
                                                                  

                                                                  
</p>
   <pre class="verbatim" id="verbatim-12">tasklet&nbsp;example&nbsp;init
Example&nbsp;tasklet&nbsp;starts
Example&nbsp;tasklet&nbsp;init&nbsp;continues...
Example&nbsp;tasklet&nbsp;ends
</pre>
<!-- l. 1418 --><p class="nopar">
</p><!-- l. 1420 --><p class="noindent">
</p>
   <h4 class="subsectionHead" id="work-queues"><span class="titlemark">0.14.2   </span> <a id="x1-540000.14.2"></a>Work queues</h4>
<!-- l. 1422 --><p class="noindent">To add a task to the scheduler we can use a workqueue. The kernel then uses the
Completely Fair Scheduler (CFS) to execute work within the queue.
</p><!-- l. 1 --><p class="indent">
</p>
   <pre class="fancyvrb" id="fancyvrb64"><a id="x1-54002r1"></a><span class="ecrm-0500">1</span><span id="textcolor2155"><span class="ectt-0800">/*</span></span> 
<a id="x1-54004r2"></a><span class="ecrm-0500">2</span><span id="textcolor2156"><span class="ectt-0800">&nbsp;*&nbsp;sched.c</span></span> 
<a id="x1-54006r3"></a><span class="ecrm-0500">3</span><span id="textcolor2157"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-54008r4"></a><span class="ecrm-0500">4</span><span id="textcolor2158"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2159"><span class="ectt-0800">&lt;linux/init.h&gt;</span></span> 
<a id="x1-54010r5"></a><span class="ecrm-0500">5</span><span id="textcolor2160"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2161"><span class="ectt-0800">&lt;linux/module.h&gt;</span></span> 
<a id="x1-54012r6"></a><span class="ecrm-0500">6</span><span id="textcolor2162"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2163"><span class="ectt-0800">&lt;linux/workqueue.h&gt;</span></span> 
<a id="x1-54014r7"></a><span class="ecrm-0500">7</span> 
<a id="x1-54016r8"></a><span class="ecrm-0500">8</span><span id="textcolor2164"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2165"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;workqueue_struct&nbsp;*queue&nbsp;=&nbsp;NULL;</span> 
<a id="x1-54018r9"></a><span class="ecrm-0500">9</span><span id="textcolor2166"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2167"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;work_struct&nbsp;work;</span> 
<a id="x1-54020r10"></a><span class="ecrm-0500">10</span> 
<a id="x1-54022r11"></a><span class="ecrm-0500">11</span><span id="textcolor2168"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2169"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;work_handler(</span><span id="textcolor2170"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;work_struct&nbsp;*data)</span> 
<a id="x1-54024r12"></a><span class="ecrm-0500">12</span><span class="ectt-0800">{</span> 
<a id="x1-54026r13"></a><span class="ecrm-0500">13</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor2171"><span class="ectt-0800">"work&nbsp;handler&nbsp;function.</span></span><span id="textcolor2172"><span class="ectt-0800">\n</span></span><span id="textcolor2173"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-54028r14"></a><span class="ecrm-0500">14</span><span class="ectt-0800">}</span> 
<a id="x1-54030r15"></a><span class="ecrm-0500">15</span> 
<a id="x1-54032r16"></a><span class="ecrm-0500">16</span><span id="textcolor2174"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2175"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;__init&nbsp;sched_init(</span><span id="textcolor2176"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-54034r17"></a><span class="ecrm-0500">17</span><span class="ectt-0800">{</span> 
<a id="x1-54036r18"></a><span class="ecrm-0500">18</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;queue&nbsp;=&nbsp;alloc_workqueue(</span><span id="textcolor2177"><span class="ectt-0800">"HELLOWORLD"</span></span><span class="ectt-0800">,&nbsp;WQ_UNBOUND,&nbsp;1);</span> 
<a id="x1-54038r19"></a><span class="ecrm-0500">19</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;INIT_WORK(&amp;work,&nbsp;work_handler);</span> 
<a id="x1-54040r20"></a><span class="ecrm-0500">20</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;schedule_work(&amp;work);</span> 
<a id="x1-54042r21"></a><span class="ecrm-0500">21</span> 
<a id="x1-54044r22"></a><span class="ecrm-0500">22</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2178"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;0;</span> 
<a id="x1-54046r23"></a><span class="ecrm-0500">23</span><span class="ectt-0800">}</span> 
<a id="x1-54048r24"></a><span class="ecrm-0500">24</span> 
<a id="x1-54050r25"></a><span class="ecrm-0500">25</span><span id="textcolor2179"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2180"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;__exit&nbsp;sched_exit(</span><span id="textcolor2181"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-54052r26"></a><span class="ecrm-0500">26</span><span class="ectt-0800">{</span> 
<a id="x1-54054r27"></a><span class="ecrm-0500">27</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;destroy_workqueue(queue);</span> 
<a id="x1-54056r28"></a><span class="ecrm-0500">28</span><span class="ectt-0800">}</span> 
<a id="x1-54058r29"></a><span class="ecrm-0500">29</span> 
<a id="x1-54060r30"></a><span class="ecrm-0500">30</span><span class="ectt-0800">module_init(sched_init);</span> 
<a id="x1-54062r31"></a><span class="ecrm-0500">31</span><span class="ectt-0800">module_exit(sched_exit);</span> 
<a id="x1-54064r32"></a><span class="ecrm-0500">32</span> 
<a id="x1-54066r33"></a><span class="ecrm-0500">33</span><span class="ectt-0800">MODULE_LICENSE(</span><span id="textcolor2182"><span class="ectt-0800">"GPL"</span></span><span class="ectt-0800">);</span> 
<a id="x1-54068r34"></a><span class="ecrm-0500">34</span><span class="ectt-0800">MODULE_DESCRIPTION(</span><span id="textcolor2183"><span class="ectt-0800">"Workqueue&nbsp;example"</span></span><span class="ectt-0800">);</span></pre>
<!-- l. 1427 --><p class="noindent">
</p>
   <h3 class="sectionHead" id="interrupt-handlers"><span class="titlemark">0.15   </span> <a id="x1-550000.15"></a>Interrupt Handlers</h3>
<!-- l. 1429 --><p class="noindent">
</p>
   <h4 class="subsectionHead" id="interrupt-handlers1"><span class="titlemark">0.15.1   </span> <a id="x1-560000.15.1"></a>Interrupt Handlers</h4>
<!-- l. 1431 --><p class="noindent">Except for the last chapter, everything we did in the kernel so far we have done as a
response to a process asking for it, either by dealing with a special file, sending an
<code> <span class="ectt-1000">ioctl()</span>
</code>, or issuing a system call. But the job of the kernel is not just to respond to process
requests. Another job, which is every bit as important, is to speak to the hardware
connected to the machine.
</p><!-- l. 1435 --><p class="indent">   There are two types of interaction between the CPU and the rest of the
computer’s hardware. The first type is when the CPU gives orders to the hardware,
the other is when the hardware needs to tell the CPU something. The second, called
interrupts, is much harder to implement because it has to be dealt with when
convenient for the hardware, not the CPU. Hardware devices typically have a very
small amount of RAM, and if you do not read their information when available, it is
lost.
                                                                  

                                                                  
</p><!-- l. 1440 --><p class="indent">   Under Linux, hardware interrupts are called IRQ’s (Interrupt ReQuests). There
are two types of IRQ’s, short and long. A short IRQ is one which is expected to take
a very short period of time, during which the rest of the machine will be blocked and
no other interrupts will be handled. A long IRQ is one which can take longer, and
during which other interrupts may occur (but not interrupts from the same
device). If at all possible, it is better to declare an interrupt handler to be
long.
</p><!-- l. 1446 --><p class="indent">   When the CPU receives an interrupt, it stops whatever it is doing (unless it is
processing a more important interrupt, in which case it will deal with this one
only when the more important one is done), saves certain parameters on
the stack and calls the interrupt handler. This means that certain things
are not allowed in the interrupt handler itself, because the system is in an
unknown state. The solution to this problem is for the interrupt handler to
do what needs to be done immediately, usually read something from the
hardware or send something to the hardware, and then schedule the handling of
the new information at a later time (this is called the "bottom half") and
return. The kernel is then guaranteed to call the bottom half as soon as
possible – and when it does, everything allowed in kernel modules will be
allowed.
</p><!-- l. 1452 --><p class="indent">   The way to implement this is to call
<code> <span class="ectt-1000">request_irq()</span>
</code> to get your interrupt handler called when the relevant IRQ is received.
</p><!-- l. 1454 --><p class="indent">   In practice IRQ handling can be a bit more complex. Hardware is often
designed in a way that chains two interrupt controllers, so that all the IRQs
from interrupt controller B are cascaded to a certain IRQ from interrupt
controller A. Of course, that requires that the kernel finds out which IRQ it
really was afterwards and that adds overhead. Other architectures offer some
special, very low overhead, so called "fast IRQ" or FIQs. To take advantage of
them requires handlers to be written in assembler, so they do not really
fit into the kernel. They can be made to work similar to the others, but
after that procedure, they are no longer any faster than "common" IRQs.
SMP enabled kernels running on systems with more than one processor
need to solve another truckload of problems. It is not enough to know if
a certain IRQs has happend, it’s also important for what CPU(s) it was
for. People still interested in more details, might want to refer to "APIC"
now.
</p><!-- l. 1463 --><p class="indent">   This function receives the IRQ number, the name of the function,
flags, a name for <span class="obeylines-h"><span class="verb"><span class="ectt-1000">/proc/interrupts</span></span></span> and a parameter to pass to the
interrupt handler. Usually there is a certain number of IRQs available.
How many IRQs there are is hardware-dependent. The flags can include
<code> <span class="ectt-1000">SA_SHIRQ</span>
</code> to indicate you are willing to share the IRQ with other interrupt handlers
(usually because a number of hardware devices sit on the same IRQ) and
<code> <span class="ectt-1000">SA_INTERRUPT</span>
</code> to indicate this is a fast interrupt. This function will only succeed if there is not
already a handler on this IRQ, or if you are both willing to share.
                                                                  

                                                                  
</p><!-- l. 1469 --><p class="noindent">
</p>
   <h4 class="subsectionHead" id="detecting-button-presses"><span class="titlemark">0.15.2   </span> <a id="x1-570000.15.2"></a>Detecting button presses</h4>
<!-- l. 1471 --><p class="noindent">Many popular single board computers, such as Raspberry Pi or Beagleboards, have a
bunch of GPIO pins. Attaching buttons to those and then having a button press do
something is a classic case in which you might need to use interrupts, so that instead
of having the CPU waste time and battery power polling for a change in input state
it is better for the input to trigger the CPU to then run a particular handling
function.
</p><!-- l. 1475 --><p class="indent">   Here is an example where buttons are connected to GPIO numbers 17 and 18 and
an LED is connected to GPIO 4. You can change those numbers to whatever is
appropriate for your board.
</p><!-- l. 1 --><p class="indent">
</p>
   <pre class="fancyvrb" id="fancyvrb65"><a id="x1-57002r1"></a><span class="ecrm-0500">1</span><span id="textcolor2184"><span class="ectt-0800">/*</span></span> 
<a id="x1-57004r2"></a><span class="ecrm-0500">2</span><span id="textcolor2185"><span class="ectt-0800">&nbsp;*&nbsp;intrpt.c&nbsp;-&nbsp;Handling&nbsp;GPIO&nbsp;with&nbsp;interrupts</span></span> 
<a id="x1-57006r3"></a><span class="ecrm-0500">3</span><span id="textcolor2186"><span class="ectt-0800">&nbsp;*</span></span> 
<a id="x1-57008r4"></a><span class="ecrm-0500">4</span><span id="textcolor2187"><span class="ectt-0800">&nbsp;*&nbsp;Based&nbsp;upon&nbsp;the&nbsp;RPi&nbsp;example&nbsp;by&nbsp;Stefan&nbsp;Wendler&nbsp;(devnull@kaltpost.de)</span></span> 
<a id="x1-57010r5"></a><span class="ecrm-0500">5</span><span id="textcolor2188"><span class="ectt-0800">&nbsp;*&nbsp;from:</span></span> 
<a id="x1-57012r6"></a><span class="ecrm-0500">6</span><span id="textcolor2189"><span class="ectt-0800">&nbsp;*&nbsp;&nbsp;&nbsp;https://github.com/wendlers/rpi-kmod-samples</span></span> 
<a id="x1-57014r7"></a><span class="ecrm-0500">7</span><span id="textcolor2190"><span class="ectt-0800">&nbsp;*</span></span> 
<a id="x1-57016r8"></a><span class="ecrm-0500">8</span><span id="textcolor2191"><span class="ectt-0800">&nbsp;*&nbsp;Press&nbsp;one&nbsp;button&nbsp;to&nbsp;turn&nbsp;on&nbsp;a&nbsp;LED&nbsp;and&nbsp;another&nbsp;to&nbsp;turn&nbsp;it&nbsp;off.</span></span> 
<a id="x1-57018r9"></a><span class="ecrm-0500">9</span><span id="textcolor2192"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-57020r10"></a><span class="ecrm-0500">10</span> 
<a id="x1-57022r11"></a><span class="ecrm-0500">11</span><span id="textcolor2193"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2194"><span class="ectt-0800">&lt;linux/gpio.h&gt;</span></span> 
<a id="x1-57024r12"></a><span class="ecrm-0500">12</span><span id="textcolor2195"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2196"><span class="ectt-0800">&lt;linux/interrupt.h&gt;</span></span> 
<a id="x1-57026r13"></a><span class="ecrm-0500">13</span><span id="textcolor2197"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2198"><span class="ectt-0800">&lt;linux/kernel.h&gt;</span></span> 
<a id="x1-57028r14"></a><span class="ecrm-0500">14</span><span id="textcolor2199"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2200"><span class="ectt-0800">&lt;linux/module.h&gt;</span></span> 
<a id="x1-57030r15"></a><span class="ecrm-0500">15</span> 
<a id="x1-57032r16"></a><span class="ecrm-0500">16</span><span id="textcolor2201"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2202"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;button_irqs[]&nbsp;=&nbsp;{-1,&nbsp;-1};</span> 
<a id="x1-57034r17"></a><span class="ecrm-0500">17</span> 
<a id="x1-57036r18"></a><span class="ecrm-0500">18</span><span id="textcolor2203"><span class="ectt-0800">/*&nbsp;Define&nbsp;GPIOs&nbsp;for&nbsp;LEDs.</span></span> 
<a id="x1-57038r19"></a><span class="ecrm-0500">19</span><span id="textcolor2204"><span class="ectt-0800">&nbsp;*&nbsp;TODO:&nbsp;Change&nbsp;the&nbsp;numbers&nbsp;for&nbsp;the&nbsp;GPIO&nbsp;on&nbsp;your&nbsp;board.</span></span> 
<a id="x1-57040r20"></a><span class="ecrm-0500">20</span><span id="textcolor2205"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-57042r21"></a><span class="ecrm-0500">21</span><span id="textcolor2206"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2207"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;gpio&nbsp;leds[]&nbsp;=&nbsp;{{4,&nbsp;GPIOF_OUT_INIT_LOW,&nbsp;</span><span id="textcolor2208"><span class="ectt-0800">"LED&nbsp;1"</span></span><span class="ectt-0800">}};</span> 
<a id="x1-57044r22"></a><span class="ecrm-0500">22</span> 
<a id="x1-57046r23"></a><span class="ecrm-0500">23</span><span id="textcolor2209"><span class="ectt-0800">/*&nbsp;Define&nbsp;GPIOs&nbsp;for&nbsp;BUTTONS</span></span> 
<a id="x1-57048r24"></a><span class="ecrm-0500">24</span><span id="textcolor2210"><span class="ectt-0800">&nbsp;*&nbsp;TODO:&nbsp;Change&nbsp;the&nbsp;numbers&nbsp;for&nbsp;the&nbsp;GPIO&nbsp;on&nbsp;your&nbsp;board.</span></span> 
<a id="x1-57050r25"></a><span class="ecrm-0500">25</span><span id="textcolor2211"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-57052r26"></a><span class="ecrm-0500">26</span><span id="textcolor2212"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2213"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;gpio&nbsp;buttons[]&nbsp;=&nbsp;{{17,&nbsp;GPIOF_IN,&nbsp;</span><span id="textcolor2214"><span class="ectt-0800">"LED&nbsp;1&nbsp;ON&nbsp;BUTTON"</span></span><span class="ectt-0800">},</span> 
<a id="x1-57054r27"></a><span class="ecrm-0500">27</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{18,&nbsp;GPIOF_IN,&nbsp;</span><span id="textcolor2215"><span class="ectt-0800">"LED&nbsp;1&nbsp;OFF&nbsp;BUTTON"</span></span><span class="ectt-0800">}};</span> 
<a id="x1-57056r28"></a><span class="ecrm-0500">28</span> 
<a id="x1-57058r29"></a><span class="ecrm-0500">29</span><span id="textcolor2216"><span class="ectt-0800">/*&nbsp;interrupt&nbsp;function&nbsp;triggered&nbsp;when&nbsp;a&nbsp;button&nbsp;is&nbsp;pressed.&nbsp;*/</span></span> 
<a id="x1-57060r30"></a><span class="ecrm-0500">30</span><span id="textcolor2217"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;irqreturn_t&nbsp;button_isr(</span><span id="textcolor2218"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;irq,&nbsp;</span><span id="textcolor2219"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;*data)</span> 
<a id="x1-57062r31"></a><span class="ecrm-0500">31</span><span class="ectt-0800">{</span> 
<a id="x1-57064r32"></a><span class="ecrm-0500">32</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2220"><span class="ectt-0800">/*&nbsp;first&nbsp;button&nbsp;*/</span></span> 
<a id="x1-57066r33"></a><span class="ecrm-0500">33</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2221"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(irq&nbsp;==&nbsp;button_irqs[0]&nbsp;&amp;&amp;&nbsp;!gpio_get_value(leds[0].gpio))</span> 
<a id="x1-57068r34"></a><span class="ecrm-0500">34</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gpio_set_value(leds[0].gpio,&nbsp;1);</span> 
<a id="x1-57070r35"></a><span class="ecrm-0500">35</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2222"><span class="ectt-0800">/*&nbsp;second&nbsp;button&nbsp;*/</span></span> 
<a id="x1-57072r36"></a><span class="ecrm-0500">36</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2223"><span class="ectt-0800">else</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2224"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(irq&nbsp;==&nbsp;button_irqs[1]&nbsp;&amp;&amp;&nbsp;gpio_get_value(leds[0].gpio))</span> 
<a id="x1-57074r37"></a><span class="ecrm-0500">37</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gpio_set_value(leds[0].gpio,&nbsp;0);</span> 
<a id="x1-57076r38"></a><span class="ecrm-0500">38</span> 
<a id="x1-57078r39"></a><span class="ecrm-0500">39</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2225"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;IRQ_HANDLED;</span> 
<a id="x1-57080r40"></a><span class="ecrm-0500">40</span><span class="ectt-0800">}</span> 
<a id="x1-57082r41"></a><span class="ecrm-0500">41</span> 
<a id="x1-57084r42"></a><span class="ecrm-0500">42</span><span id="textcolor2226"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2227"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;__init&nbsp;intrpt_init(</span><span id="textcolor2228"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-57086r43"></a><span class="ecrm-0500">43</span><span class="ectt-0800">{</span> 
<a id="x1-57088r44"></a><span class="ecrm-0500">44</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2229"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;ret&nbsp;=&nbsp;0;</span> 
<a id="x1-57090r45"></a><span class="ecrm-0500">45</span> 
<a id="x1-57092r46"></a><span class="ecrm-0500">46</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor2230"><span class="ectt-0800">"%s</span></span><span id="textcolor2231"><span class="ectt-0800">\n</span></span><span id="textcolor2232"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;__func__);</span> 
<a id="x1-57094r47"></a><span class="ecrm-0500">47</span> 
<a id="x1-57096r48"></a><span class="ecrm-0500">48</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2233"><span class="ectt-0800">/*&nbsp;register&nbsp;LED&nbsp;gpios&nbsp;*/</span></span> 
<a id="x1-57098r49"></a><span class="ecrm-0500">49</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;ret&nbsp;=&nbsp;gpio_request_array(leds,&nbsp;ARRAY_SIZE(leds));</span> 
<a id="x1-57100r50"></a><span class="ecrm-0500">50</span> 
<a id="x1-57102r51"></a><span class="ecrm-0500">51</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2234"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(ret)&nbsp;{</span> 
<a id="x1-57104r52"></a><span class="ecrm-0500">52</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pr_err(</span><span id="textcolor2235"><span class="ectt-0800">"Unable&nbsp;to&nbsp;request&nbsp;GPIOs&nbsp;for&nbsp;LEDs:&nbsp;%d</span></span><span id="textcolor2236"><span class="ectt-0800">\n</span></span><span id="textcolor2237"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;ret);</span> 
<a id="x1-57106r53"></a><span class="ecrm-0500">53</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2238"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;ret;</span> 
<a id="x1-57108r54"></a><span class="ecrm-0500">54</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-57110r55"></a><span class="ecrm-0500">55</span> 
<a id="x1-57112r56"></a><span class="ecrm-0500">56</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2239"><span class="ectt-0800">/*&nbsp;register&nbsp;BUTTON&nbsp;gpios&nbsp;*/</span></span> 
<a id="x1-57114r57"></a><span class="ecrm-0500">57</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;ret&nbsp;=&nbsp;gpio_request_array(buttons,&nbsp;ARRAY_SIZE(buttons));</span> 
<a id="x1-57116r58"></a><span class="ecrm-0500">58</span> 
<a id="x1-57118r59"></a><span class="ecrm-0500">59</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2240"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(ret)&nbsp;{</span> 
<a id="x1-57120r60"></a><span class="ecrm-0500">60</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pr_err(</span><span id="textcolor2241"><span class="ectt-0800">"Unable&nbsp;to&nbsp;request&nbsp;GPIOs&nbsp;for&nbsp;BUTTONs:&nbsp;%d</span></span><span id="textcolor2242"><span class="ectt-0800">\n</span></span><span id="textcolor2243"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;ret);</span> 
<a id="x1-57122r61"></a><span class="ecrm-0500">61</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2244"><span class="ectt-0800">goto</span></span><span class="ectt-0800">&nbsp;fail1;</span> 
<a id="x1-57124r62"></a><span class="ecrm-0500">62</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-57126r63"></a><span class="ecrm-0500">63</span> 
<a id="x1-57128r64"></a><span class="ecrm-0500">64</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor2245"><span class="ectt-0800">"Current&nbsp;button1&nbsp;value:&nbsp;%d</span></span><span id="textcolor2246"><span class="ectt-0800">\n</span></span><span id="textcolor2247"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;gpio_get_value(buttons[0].gpio));</span> 
<a id="x1-57130r65"></a><span class="ecrm-0500">65</span> 
<a id="x1-57132r66"></a><span class="ecrm-0500">66</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;ret&nbsp;=&nbsp;gpio_to_irq(buttons[0].gpio);</span> 
<a id="x1-57134r67"></a><span class="ecrm-0500">67</span> 
<a id="x1-57136r68"></a><span class="ecrm-0500">68</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2248"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(ret&nbsp;&lt;&nbsp;0)&nbsp;{</span> 
<a id="x1-57138r69"></a><span class="ecrm-0500">69</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pr_err(</span><span id="textcolor2249"><span class="ectt-0800">"Unable&nbsp;to&nbsp;request&nbsp;IRQ:&nbsp;%d</span></span><span id="textcolor2250"><span class="ectt-0800">\n</span></span><span id="textcolor2251"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;ret);</span> 
<a id="x1-57140r70"></a><span class="ecrm-0500">70</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2252"><span class="ectt-0800">goto</span></span><span class="ectt-0800">&nbsp;fail2;</span> 
<a id="x1-57142r71"></a><span class="ecrm-0500">71</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-57144r72"></a><span class="ecrm-0500">72</span> 
<a id="x1-57146r73"></a><span class="ecrm-0500">73</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;button_irqs[0]&nbsp;=&nbsp;ret;</span> 
<a id="x1-57148r74"></a><span class="ecrm-0500">74</span> 
<a id="x1-57150r75"></a><span class="ecrm-0500">75</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor2253"><span class="ectt-0800">"Successfully&nbsp;requested&nbsp;BUTTON1&nbsp;IRQ&nbsp;#&nbsp;%d</span></span><span id="textcolor2254"><span class="ectt-0800">\n</span></span><span id="textcolor2255"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;button_irqs[0]);</span> 
<a id="x1-57152r76"></a><span class="ecrm-0500">76</span> 
<a id="x1-57154r77"></a><span class="ecrm-0500">77</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;ret&nbsp;=&nbsp;request_irq(button_irqs[0],&nbsp;button_isr,</span> 
<a id="x1-57156r78"></a><span class="ecrm-0500">78</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IRQF_TRIGGER_RISING&nbsp;|&nbsp;IRQF_TRIGGER_FALLING,</span> 
<a id="x1-57158r79"></a><span class="ecrm-0500">79</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2256"><span class="ectt-0800">"gpiomod#button1"</span></span><span class="ectt-0800">,&nbsp;NULL);</span> 
<a id="x1-57160r80"></a><span class="ecrm-0500">80</span> 
<a id="x1-57162r81"></a><span class="ecrm-0500">81</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2257"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(ret)&nbsp;{</span> 
<a id="x1-57164r82"></a><span class="ecrm-0500">82</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pr_err(</span><span id="textcolor2258"><span class="ectt-0800">"Unable&nbsp;to&nbsp;request&nbsp;IRQ:&nbsp;%d</span></span><span id="textcolor2259"><span class="ectt-0800">\n</span></span><span id="textcolor2260"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;ret);</span> 
<a id="x1-57166r83"></a><span class="ecrm-0500">83</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2261"><span class="ectt-0800">goto</span></span><span class="ectt-0800">&nbsp;fail2;</span> 
<a id="x1-57168r84"></a><span class="ecrm-0500">84</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-57170r85"></a><span class="ecrm-0500">85</span> 
<a id="x1-57172r86"></a><span class="ecrm-0500">86</span> 
<a id="x1-57174r87"></a><span class="ecrm-0500">87</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;ret&nbsp;=&nbsp;gpio_to_irq(buttons[1].gpio);</span> 
<a id="x1-57176r88"></a><span class="ecrm-0500">88</span> 
<a id="x1-57178r89"></a><span class="ecrm-0500">89</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2262"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(ret&nbsp;&lt;&nbsp;0)&nbsp;{</span> 
<a id="x1-57180r90"></a><span class="ecrm-0500">90</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pr_err(</span><span id="textcolor2263"><span class="ectt-0800">"Unable&nbsp;to&nbsp;request&nbsp;IRQ:&nbsp;%d</span></span><span id="textcolor2264"><span class="ectt-0800">\n</span></span><span id="textcolor2265"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;ret);</span> 
<a id="x1-57182r91"></a><span class="ecrm-0500">91</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2266"><span class="ectt-0800">goto</span></span><span class="ectt-0800">&nbsp;fail2;</span> 
<a id="x1-57184r92"></a><span class="ecrm-0500">92</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-57186r93"></a><span class="ecrm-0500">93</span> 
<a id="x1-57188r94"></a><span class="ecrm-0500">94</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;button_irqs[1]&nbsp;=&nbsp;ret;</span> 
<a id="x1-57190r95"></a><span class="ecrm-0500">95</span> 
<a id="x1-57192r96"></a><span class="ecrm-0500">96</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor2267"><span class="ectt-0800">"Successfully&nbsp;requested&nbsp;BUTTON2&nbsp;IRQ&nbsp;#&nbsp;%d</span></span><span id="textcolor2268"><span class="ectt-0800">\n</span></span><span id="textcolor2269"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;button_irqs[1]);</span> 
<a id="x1-57194r97"></a><span class="ecrm-0500">97</span> 
<a id="x1-57196r98"></a><span class="ecrm-0500">98</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;ret&nbsp;=&nbsp;request_irq(button_irqs[1],&nbsp;button_isr,</span> 
<a id="x1-57198r99"></a><span class="ecrm-0500">99</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IRQF_TRIGGER_RISING&nbsp;|&nbsp;IRQF_TRIGGER_FALLING,</span> 
<a id="x1-57200r100"></a><span class="ecrm-0500">100</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2270"><span class="ectt-0800">"gpiomod#button2"</span></span><span class="ectt-0800">,&nbsp;NULL);</span> 
<a id="x1-57202r101"></a><span class="ecrm-0500">101</span> 
<a id="x1-57204r102"></a><span class="ecrm-0500">102</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2271"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(ret)&nbsp;{</span> 
<a id="x1-57206r103"></a><span class="ecrm-0500">103</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pr_err(</span><span id="textcolor2272"><span class="ectt-0800">"Unable&nbsp;to&nbsp;request&nbsp;IRQ:&nbsp;%d</span></span><span id="textcolor2273"><span class="ectt-0800">\n</span></span><span id="textcolor2274"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;ret);</span> 
<a id="x1-57208r104"></a><span class="ecrm-0500">104</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2275"><span class="ectt-0800">goto</span></span><span class="ectt-0800">&nbsp;fail3;</span> 
<a id="x1-57210r105"></a><span class="ecrm-0500">105</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-57212r106"></a><span class="ecrm-0500">106</span> 
<a id="x1-57214r107"></a><span class="ecrm-0500">107</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2276"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;0;</span> 
<a id="x1-57216r108"></a><span class="ecrm-0500">108</span> 
<a id="x1-57218r109"></a><span class="ecrm-0500">109</span><span id="textcolor2277"><span class="ectt-0800">/*&nbsp;cleanup&nbsp;what&nbsp;has&nbsp;been&nbsp;setup&nbsp;so&nbsp;far&nbsp;*/</span></span> 
<a id="x1-57220r110"></a><span class="ecrm-0500">110</span><span class="ectt-0800">fail3:</span> 
<a id="x1-57222r111"></a><span class="ecrm-0500">111</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;free_irq(button_irqs[0],&nbsp;NULL);</span> 
<a id="x1-57224r112"></a><span class="ecrm-0500">112</span> 
<a id="x1-57226r113"></a><span class="ecrm-0500">113</span><span class="ectt-0800">fail2:</span> 
<a id="x1-57228r114"></a><span class="ecrm-0500">114</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;gpio_free_array(buttons,&nbsp;ARRAY_SIZE(leds));</span> 
<a id="x1-57230r115"></a><span class="ecrm-0500">115</span> 
<a id="x1-57232r116"></a><span class="ecrm-0500">116</span><span class="ectt-0800">fail1:</span> 
<a id="x1-57234r117"></a><span class="ecrm-0500">117</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;gpio_free_array(leds,&nbsp;ARRAY_SIZE(leds));</span> 
<a id="x1-57236r118"></a><span class="ecrm-0500">118</span> 
<a id="x1-57238r119"></a><span class="ecrm-0500">119</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2278"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;ret;</span> 
<a id="x1-57240r120"></a><span class="ecrm-0500">120</span><span class="ectt-0800">}</span> 
<a id="x1-57242r121"></a><span class="ecrm-0500">121</span> 
<a id="x1-57244r122"></a><span class="ecrm-0500">122</span><span id="textcolor2279"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2280"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;__exit&nbsp;intrpt_exit(</span><span id="textcolor2281"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-57246r123"></a><span class="ecrm-0500">123</span><span class="ectt-0800">{</span> 
<a id="x1-57248r124"></a><span class="ecrm-0500">124</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2282"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;i;</span> 
<a id="x1-57250r125"></a><span class="ecrm-0500">125</span> 
<a id="x1-57252r126"></a><span class="ecrm-0500">126</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor2283"><span class="ectt-0800">"%s</span></span><span id="textcolor2284"><span class="ectt-0800">\n</span></span><span id="textcolor2285"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;__func__);</span> 
<a id="x1-57254r127"></a><span class="ecrm-0500">127</span> 
<a id="x1-57256r128"></a><span class="ecrm-0500">128</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2286"><span class="ectt-0800">/*&nbsp;free&nbsp;irqs&nbsp;*/</span></span> 
<a id="x1-57258r129"></a><span class="ecrm-0500">129</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;free_irq(button_irqs[0],&nbsp;NULL);</span> 
<a id="x1-57260r130"></a><span class="ecrm-0500">130</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;free_irq(button_irqs[1],&nbsp;NULL);</span> 
<a id="x1-57262r131"></a><span class="ecrm-0500">131</span> 
<a id="x1-57264r132"></a><span class="ecrm-0500">132</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2287"><span class="ectt-0800">/*&nbsp;turn&nbsp;all&nbsp;LEDs&nbsp;off&nbsp;*/</span></span> 
<a id="x1-57266r133"></a><span class="ecrm-0500">133</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2288"><span class="ectt-0800">for</span></span><span class="ectt-0800">&nbsp;(i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;ARRAY_SIZE(leds);&nbsp;i++)</span> 
<a id="x1-57268r134"></a><span class="ecrm-0500">134</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gpio_set_value(leds[i].gpio,&nbsp;0);</span> 
<a id="x1-57270r135"></a><span class="ecrm-0500">135</span> 
<a id="x1-57272r136"></a><span class="ecrm-0500">136</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2289"><span class="ectt-0800">/*&nbsp;unregister&nbsp;*/</span></span> 
<a id="x1-57274r137"></a><span class="ecrm-0500">137</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;gpio_free_array(leds,&nbsp;ARRAY_SIZE(leds));</span> 
<a id="x1-57276r138"></a><span class="ecrm-0500">138</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;gpio_free_array(buttons,&nbsp;ARRAY_SIZE(buttons));</span> 
<a id="x1-57278r139"></a><span class="ecrm-0500">139</span><span class="ectt-0800">}</span> 
<a id="x1-57280r140"></a><span class="ecrm-0500">140</span> 
<a id="x1-57282r141"></a><span class="ecrm-0500">141</span><span class="ectt-0800">module_init(intrpt_init);</span> 
<a id="x1-57284r142"></a><span class="ecrm-0500">142</span><span class="ectt-0800">module_exit(intrpt_exit);</span> 
<a id="x1-57286r143"></a><span class="ecrm-0500">143</span> 
<a id="x1-57288r144"></a><span class="ecrm-0500">144</span><span class="ectt-0800">MODULE_LICENSE(</span><span id="textcolor2290"><span class="ectt-0800">"GPL"</span></span><span class="ectt-0800">);</span> 
<a id="x1-57290r145"></a><span class="ecrm-0500">145</span><span class="ectt-0800">MODULE_DESCRIPTION(</span><span id="textcolor2291"><span class="ectt-0800">"Handle&nbsp;some&nbsp;GPIO&nbsp;interrupts"</span></span><span class="ectt-0800">);</span></pre>
<!-- l. 1480 --><p class="noindent">
</p>
   <h4 class="subsectionHead" id="bottom-half"><span class="titlemark">0.15.3   </span> <a id="x1-580000.15.3"></a>Bottom Half</h4>
<!-- l. 1482 --><p class="noindent">Suppose you want to do a bunch of stuff inside of an interrupt routine. A common
way to do that without rendering the interrupt unavailable for a significant duration
is to combine it with a tasklet. This pushes the bulk of the work off into the
scheduler.
</p><!-- l. 1486 --><p class="indent">   The example below modifies the previous example to also run an additional task
when an interrupt is triggered.
</p><!-- l. 1 --><p class="indent">
</p>
   <pre class="fancyvrb" id="fancyvrb66"><a id="x1-58002r1"></a><span class="ecrm-0500">1</span><span id="textcolor2292"><span class="ectt-0800">/*</span></span> 
<a id="x1-58004r2"></a><span class="ecrm-0500">2</span><span id="textcolor2293"><span class="ectt-0800">&nbsp;*&nbsp;bottomhalf.c&nbsp;-&nbsp;Top&nbsp;and&nbsp;bottom&nbsp;half&nbsp;interrupt&nbsp;handling</span></span> 
<a id="x1-58006r3"></a><span class="ecrm-0500">3</span><span id="textcolor2294"><span class="ectt-0800">&nbsp;*</span></span> 
<a id="x1-58008r4"></a><span class="ecrm-0500">4</span><span id="textcolor2295"><span class="ectt-0800">&nbsp;*&nbsp;Based&nbsp;upon&nbsp;the&nbsp;RPi&nbsp;example&nbsp;by&nbsp;Stefan&nbsp;Wendler&nbsp;(devnull@kaltpost.de)</span></span> 
<a id="x1-58010r5"></a><span class="ecrm-0500">5</span><span id="textcolor2296"><span class="ectt-0800">&nbsp;*&nbsp;from:</span></span> 
<a id="x1-58012r6"></a><span class="ecrm-0500">6</span><span id="textcolor2297"><span class="ectt-0800">&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;https://github.com/wendlers/rpi-kmod-samples</span></span> 
<a id="x1-58014r7"></a><span class="ecrm-0500">7</span><span id="textcolor2298"><span class="ectt-0800">&nbsp;*</span></span> 
<a id="x1-58016r8"></a><span class="ecrm-0500">8</span><span id="textcolor2299"><span class="ectt-0800">&nbsp;*&nbsp;Press&nbsp;one&nbsp;button&nbsp;to&nbsp;turn&nbsp;on&nbsp;a&nbsp;LED&nbsp;and&nbsp;another&nbsp;to&nbsp;turn&nbsp;it&nbsp;off</span></span> 
<a id="x1-58018r9"></a><span class="ecrm-0500">9</span><span id="textcolor2300"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-58020r10"></a><span class="ecrm-0500">10</span> 
<a id="x1-58022r11"></a><span class="ecrm-0500">11</span><span id="textcolor2301"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2302"><span class="ectt-0800">&lt;linux/delay.h&gt;</span></span> 
<a id="x1-58024r12"></a><span class="ecrm-0500">12</span><span id="textcolor2303"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2304"><span class="ectt-0800">&lt;linux/gpio.h&gt;</span></span> 
<a id="x1-58026r13"></a><span class="ecrm-0500">13</span><span id="textcolor2305"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2306"><span class="ectt-0800">&lt;linux/interrupt.h&gt;</span></span> 
<a id="x1-58028r14"></a><span class="ecrm-0500">14</span><span id="textcolor2307"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2308"><span class="ectt-0800">&lt;linux/kernel.h&gt;</span></span> 
<a id="x1-58030r15"></a><span class="ecrm-0500">15</span><span id="textcolor2309"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2310"><span class="ectt-0800">&lt;linux/module.h&gt;</span></span> 
<a id="x1-58032r16"></a><span class="ecrm-0500">16</span> 
<a id="x1-58034r17"></a><span class="ecrm-0500">17</span><span id="textcolor2311"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2312"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;button_irqs[]&nbsp;=&nbsp;{-1,&nbsp;-1};</span> 
<a id="x1-58036r18"></a><span class="ecrm-0500">18</span> 
<a id="x1-58038r19"></a><span class="ecrm-0500">19</span><span id="textcolor2313"><span class="ectt-0800">/*&nbsp;Define&nbsp;GPIOs&nbsp;for&nbsp;LEDs.</span></span> 
<a id="x1-58040r20"></a><span class="ecrm-0500">20</span><span id="textcolor2314"><span class="ectt-0800">&nbsp;*&nbsp;TODO:&nbsp;Change&nbsp;the&nbsp;numbers&nbsp;for&nbsp;the&nbsp;GPIO&nbsp;on&nbsp;your&nbsp;board.</span></span> 
<a id="x1-58042r21"></a><span class="ecrm-0500">21</span><span id="textcolor2315"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-58044r22"></a><span class="ecrm-0500">22</span><span id="textcolor2316"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2317"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;gpio&nbsp;leds[]&nbsp;=&nbsp;{{4,&nbsp;GPIOF_OUT_INIT_LOW,&nbsp;</span><span id="textcolor2318"><span class="ectt-0800">"LED&nbsp;1"</span></span><span class="ectt-0800">}};</span> 
<a id="x1-58046r23"></a><span class="ecrm-0500">23</span> 
<a id="x1-58048r24"></a><span class="ecrm-0500">24</span><span id="textcolor2319"><span class="ectt-0800">/*&nbsp;Define&nbsp;GPIOs&nbsp;for&nbsp;BUTTONS</span></span> 
<a id="x1-58050r25"></a><span class="ecrm-0500">25</span><span id="textcolor2320"><span class="ectt-0800">&nbsp;*&nbsp;TODO:&nbsp;Change&nbsp;the&nbsp;numbers&nbsp;for&nbsp;the&nbsp;GPIO&nbsp;on&nbsp;your&nbsp;board.</span></span> 
<a id="x1-58052r26"></a><span class="ecrm-0500">26</span><span id="textcolor2321"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-58054r27"></a><span class="ecrm-0500">27</span><span id="textcolor2322"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2323"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;gpio&nbsp;buttons[]&nbsp;=&nbsp;{</span> 
<a id="x1-58056r28"></a><span class="ecrm-0500">28</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;{17,&nbsp;GPIOF_IN,&nbsp;</span><span id="textcolor2324"><span class="ectt-0800">"LED&nbsp;1&nbsp;ON&nbsp;BUTTON"</span></span><span class="ectt-0800">},</span> 
<a id="x1-58058r29"></a><span class="ecrm-0500">29</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;{18,&nbsp;GPIOF_IN,&nbsp;</span><span id="textcolor2325"><span class="ectt-0800">"LED&nbsp;1&nbsp;OFF&nbsp;BUTTON"</span></span><span class="ectt-0800">},</span> 
<a id="x1-58060r30"></a><span class="ecrm-0500">30</span><span class="ectt-0800">};</span> 
<a id="x1-58062r31"></a><span class="ecrm-0500">31</span> 
<a id="x1-58064r32"></a><span class="ecrm-0500">32</span><span id="textcolor2326"><span class="ectt-0800">/*&nbsp;Tasklet&nbsp;containing&nbsp;some&nbsp;non-trivial&nbsp;amount&nbsp;of&nbsp;processing&nbsp;*/</span></span> 
<a id="x1-58066r33"></a><span class="ecrm-0500">33</span><span id="textcolor2327"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2328"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;bottomhalf_tasklet_fn(</span><span id="textcolor2329"><span class="ectt-0800">unsigned</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2330"><span class="ectt-0800">long</span></span><span class="ectt-0800">&nbsp;data)</span> 
<a id="x1-58068r34"></a><span class="ecrm-0500">34</span><span class="ectt-0800">{</span> 
<a id="x1-58070r35"></a><span class="ecrm-0500">35</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor2331"><span class="ectt-0800">"Bottom&nbsp;half&nbsp;tasklet&nbsp;starts</span></span><span id="textcolor2332"><span class="ectt-0800">\n</span></span><span id="textcolor2333"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-58072r36"></a><span class="ecrm-0500">36</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2334"><span class="ectt-0800">/*&nbsp;do&nbsp;something&nbsp;which&nbsp;takes&nbsp;a&nbsp;while&nbsp;*/</span></span> 
<a id="x1-58074r37"></a><span class="ecrm-0500">37</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;mdelay(500);</span> 
<a id="x1-58076r38"></a><span class="ecrm-0500">38</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor2335"><span class="ectt-0800">"Bottom&nbsp;half&nbsp;tasklet&nbsp;ends</span></span><span id="textcolor2336"><span class="ectt-0800">\n</span></span><span id="textcolor2337"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-58078r39"></a><span class="ecrm-0500">39</span><span class="ectt-0800">}</span> 
<a id="x1-58080r40"></a><span class="ecrm-0500">40</span> 
<a id="x1-58082r41"></a><span class="ecrm-0500">41</span><span class="ectt-0800">DECLARE_TASKLET(buttontask,&nbsp;bottomhalf_tasklet_fn,&nbsp;0L);</span> 
<a id="x1-58084r42"></a><span class="ecrm-0500">42</span> 
<a id="x1-58086r43"></a><span class="ecrm-0500">43</span><span id="textcolor2338"><span class="ectt-0800">/*&nbsp;interrupt&nbsp;function&nbsp;triggered&nbsp;when&nbsp;a&nbsp;button&nbsp;is&nbsp;pressed&nbsp;*/</span></span> 
<a id="x1-58088r44"></a><span class="ecrm-0500">44</span><span id="textcolor2339"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;irqreturn_t&nbsp;button_isr(</span><span id="textcolor2340"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;irq,&nbsp;</span><span id="textcolor2341"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;*data)</span> 
<a id="x1-58090r45"></a><span class="ecrm-0500">45</span><span class="ectt-0800">{</span> 
<a id="x1-58092r46"></a><span class="ecrm-0500">46</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2342"><span class="ectt-0800">/*&nbsp;Do&nbsp;something&nbsp;quickly&nbsp;right&nbsp;now&nbsp;*/</span></span> 
<a id="x1-58094r47"></a><span class="ecrm-0500">47</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2343"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(irq&nbsp;==&nbsp;button_irqs[0]&nbsp;&amp;&amp;&nbsp;!gpio_get_value(leds[0].gpio))</span> 
<a id="x1-58096r48"></a><span class="ecrm-0500">48</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gpio_set_value(leds[0].gpio,&nbsp;1);</span> 
<a id="x1-58098r49"></a><span class="ecrm-0500">49</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2344"><span class="ectt-0800">else</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2345"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(irq&nbsp;==&nbsp;button_irqs[1]&nbsp;&amp;&amp;&nbsp;gpio_get_value(leds[0].gpio))</span> 
<a id="x1-58100r50"></a><span class="ecrm-0500">50</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gpio_set_value(leds[0].gpio,&nbsp;0);</span> 
<a id="x1-58102r51"></a><span class="ecrm-0500">51</span> 
<a id="x1-58104r52"></a><span class="ecrm-0500">52</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2346"><span class="ectt-0800">/*&nbsp;Do&nbsp;the&nbsp;rest&nbsp;at&nbsp;leisure&nbsp;via&nbsp;the&nbsp;scheduler&nbsp;*/</span></span> 
<a id="x1-58106r53"></a><span class="ecrm-0500">53</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;tasklet_schedule(&amp;buttontask);</span> 
<a id="x1-58108r54"></a><span class="ecrm-0500">54</span> 
<a id="x1-58110r55"></a><span class="ecrm-0500">55</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2347"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;IRQ_HANDLED;</span> 
<a id="x1-58112r56"></a><span class="ecrm-0500">56</span><span class="ectt-0800">}</span> 
<a id="x1-58114r57"></a><span class="ecrm-0500">57</span> 
<a id="x1-58116r58"></a><span class="ecrm-0500">58</span><span id="textcolor2348"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2349"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;__init&nbsp;bottomhalf_init(</span><span id="textcolor2350"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-58118r59"></a><span class="ecrm-0500">59</span><span class="ectt-0800">{</span> 
<a id="x1-58120r60"></a><span class="ecrm-0500">60</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2351"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;ret&nbsp;=&nbsp;0;</span> 
<a id="x1-58122r61"></a><span class="ecrm-0500">61</span> 
<a id="x1-58124r62"></a><span class="ecrm-0500">62</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor2352"><span class="ectt-0800">"%s</span></span><span id="textcolor2353"><span class="ectt-0800">\n</span></span><span id="textcolor2354"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;__func__);</span> 
<a id="x1-58126r63"></a><span class="ecrm-0500">63</span> 
<a id="x1-58128r64"></a><span class="ecrm-0500">64</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2355"><span class="ectt-0800">/*&nbsp;register&nbsp;LED&nbsp;gpios&nbsp;*/</span></span> 
<a id="x1-58130r65"></a><span class="ecrm-0500">65</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;ret&nbsp;=&nbsp;gpio_request_array(leds,&nbsp;ARRAY_SIZE(leds));</span> 
<a id="x1-58132r66"></a><span class="ecrm-0500">66</span> 
<a id="x1-58134r67"></a><span class="ecrm-0500">67</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2356"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(ret)&nbsp;{</span> 
<a id="x1-58136r68"></a><span class="ecrm-0500">68</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pr_err(</span><span id="textcolor2357"><span class="ectt-0800">"Unable&nbsp;to&nbsp;request&nbsp;GPIOs&nbsp;for&nbsp;LEDs:&nbsp;%d</span></span><span id="textcolor2358"><span class="ectt-0800">\n</span></span><span id="textcolor2359"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;ret);</span> 
<a id="x1-58138r69"></a><span class="ecrm-0500">69</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2360"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;ret;</span> 
<a id="x1-58140r70"></a><span class="ecrm-0500">70</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-58142r71"></a><span class="ecrm-0500">71</span> 
<a id="x1-58144r72"></a><span class="ecrm-0500">72</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2361"><span class="ectt-0800">/*&nbsp;register&nbsp;BUTTON&nbsp;gpios&nbsp;*/</span></span> 
<a id="x1-58146r73"></a><span class="ecrm-0500">73</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;ret&nbsp;=&nbsp;gpio_request_array(buttons,&nbsp;ARRAY_SIZE(buttons));</span> 
<a id="x1-58148r74"></a><span class="ecrm-0500">74</span> 
<a id="x1-58150r75"></a><span class="ecrm-0500">75</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2362"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(ret)&nbsp;{</span> 
<a id="x1-58152r76"></a><span class="ecrm-0500">76</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pr_err(</span><span id="textcolor2363"><span class="ectt-0800">"Unable&nbsp;to&nbsp;request&nbsp;GPIOs&nbsp;for&nbsp;BUTTONs:&nbsp;%d</span></span><span id="textcolor2364"><span class="ectt-0800">\n</span></span><span id="textcolor2365"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;ret);</span> 
<a id="x1-58154r77"></a><span class="ecrm-0500">77</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2366"><span class="ectt-0800">goto</span></span><span class="ectt-0800">&nbsp;fail1;</span> 
<a id="x1-58156r78"></a><span class="ecrm-0500">78</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-58158r79"></a><span class="ecrm-0500">79</span> 
<a id="x1-58160r80"></a><span class="ecrm-0500">80</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor2367"><span class="ectt-0800">"Current&nbsp;button1&nbsp;value:&nbsp;%d</span></span><span id="textcolor2368"><span class="ectt-0800">\n</span></span><span id="textcolor2369"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;gpio_get_value(buttons[0].gpio));</span> 
<a id="x1-58162r81"></a><span class="ecrm-0500">81</span> 
<a id="x1-58164r82"></a><span class="ecrm-0500">82</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;ret&nbsp;=&nbsp;gpio_to_irq(buttons[0].gpio);</span> 
<a id="x1-58166r83"></a><span class="ecrm-0500">83</span> 
<a id="x1-58168r84"></a><span class="ecrm-0500">84</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2370"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(ret&nbsp;&lt;&nbsp;0)&nbsp;{</span> 
<a id="x1-58170r85"></a><span class="ecrm-0500">85</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pr_err(</span><span id="textcolor2371"><span class="ectt-0800">"Unable&nbsp;to&nbsp;request&nbsp;IRQ:&nbsp;%d</span></span><span id="textcolor2372"><span class="ectt-0800">\n</span></span><span id="textcolor2373"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;ret);</span> 
<a id="x1-58172r86"></a><span class="ecrm-0500">86</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2374"><span class="ectt-0800">goto</span></span><span class="ectt-0800">&nbsp;fail2;</span> 
<a id="x1-58174r87"></a><span class="ecrm-0500">87</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-58176r88"></a><span class="ecrm-0500">88</span> 
<a id="x1-58178r89"></a><span class="ecrm-0500">89</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;button_irqs[0]&nbsp;=&nbsp;ret;</span> 
<a id="x1-58180r90"></a><span class="ecrm-0500">90</span> 
<a id="x1-58182r91"></a><span class="ecrm-0500">91</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor2375"><span class="ectt-0800">"Successfully&nbsp;requested&nbsp;BUTTON1&nbsp;IRQ&nbsp;#&nbsp;%d</span></span><span id="textcolor2376"><span class="ectt-0800">\n</span></span><span id="textcolor2377"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;button_irqs[0]);</span> 
<a id="x1-58184r92"></a><span class="ecrm-0500">92</span> 
<a id="x1-58186r93"></a><span class="ecrm-0500">93</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;ret&nbsp;=&nbsp;request_irq(button_irqs[0],&nbsp;button_isr,</span> 
<a id="x1-58188r94"></a><span class="ecrm-0500">94</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IRQF_TRIGGER_RISING&nbsp;|&nbsp;IRQF_TRIGGER_FALLING,</span> 
<a id="x1-58190r95"></a><span class="ecrm-0500">95</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2378"><span class="ectt-0800">"gpiomod#button1"</span></span><span class="ectt-0800">,&nbsp;NULL);</span> 
<a id="x1-58192r96"></a><span class="ecrm-0500">96</span> 
<a id="x1-58194r97"></a><span class="ecrm-0500">97</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2379"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(ret)&nbsp;{</span> 
<a id="x1-58196r98"></a><span class="ecrm-0500">98</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pr_err(</span><span id="textcolor2380"><span class="ectt-0800">"Unable&nbsp;to&nbsp;request&nbsp;IRQ:&nbsp;%d</span></span><span id="textcolor2381"><span class="ectt-0800">\n</span></span><span id="textcolor2382"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;ret);</span> 
<a id="x1-58198r99"></a><span class="ecrm-0500">99</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2383"><span class="ectt-0800">goto</span></span><span class="ectt-0800">&nbsp;fail2;</span> 
<a id="x1-58200r100"></a><span class="ecrm-0500">100</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-58202r101"></a><span class="ecrm-0500">101</span> 
<a id="x1-58204r102"></a><span class="ecrm-0500">102</span> 
<a id="x1-58206r103"></a><span class="ecrm-0500">103</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;ret&nbsp;=&nbsp;gpio_to_irq(buttons[1].gpio);</span> 
<a id="x1-58208r104"></a><span class="ecrm-0500">104</span> 
<a id="x1-58210r105"></a><span class="ecrm-0500">105</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2384"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(ret&nbsp;&lt;&nbsp;0)&nbsp;{</span> 
<a id="x1-58212r106"></a><span class="ecrm-0500">106</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pr_err(</span><span id="textcolor2385"><span class="ectt-0800">"Unable&nbsp;to&nbsp;request&nbsp;IRQ:&nbsp;%d</span></span><span id="textcolor2386"><span class="ectt-0800">\n</span></span><span id="textcolor2387"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;ret);</span> 
<a id="x1-58214r107"></a><span class="ecrm-0500">107</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2388"><span class="ectt-0800">goto</span></span><span class="ectt-0800">&nbsp;fail2;</span> 
<a id="x1-58216r108"></a><span class="ecrm-0500">108</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-58218r109"></a><span class="ecrm-0500">109</span> 
<a id="x1-58220r110"></a><span class="ecrm-0500">110</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;button_irqs[1]&nbsp;=&nbsp;ret;</span> 
<a id="x1-58222r111"></a><span class="ecrm-0500">111</span> 
<a id="x1-58224r112"></a><span class="ecrm-0500">112</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor2389"><span class="ectt-0800">"Successfully&nbsp;requested&nbsp;BUTTON2&nbsp;IRQ&nbsp;#&nbsp;%d</span></span><span id="textcolor2390"><span class="ectt-0800">\n</span></span><span id="textcolor2391"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;button_irqs[1]);</span> 
<a id="x1-58226r113"></a><span class="ecrm-0500">113</span> 
<a id="x1-58228r114"></a><span class="ecrm-0500">114</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;ret&nbsp;=&nbsp;request_irq(button_irqs[1],&nbsp;button_isr,</span> 
<a id="x1-58230r115"></a><span class="ecrm-0500">115</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IRQF_TRIGGER_RISING&nbsp;|&nbsp;IRQF_TRIGGER_FALLING,</span> 
<a id="x1-58232r116"></a><span class="ecrm-0500">116</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2392"><span class="ectt-0800">"gpiomod#button2"</span></span><span class="ectt-0800">,&nbsp;NULL);</span> 
<a id="x1-58234r117"></a><span class="ecrm-0500">117</span> 
<a id="x1-58236r118"></a><span class="ecrm-0500">118</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2393"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(ret)&nbsp;{</span> 
<a id="x1-58238r119"></a><span class="ecrm-0500">119</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pr_err(</span><span id="textcolor2394"><span class="ectt-0800">"Unable&nbsp;to&nbsp;request&nbsp;IRQ:&nbsp;%d</span></span><span id="textcolor2395"><span class="ectt-0800">\n</span></span><span id="textcolor2396"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;ret);</span> 
<a id="x1-58240r120"></a><span class="ecrm-0500">120</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2397"><span class="ectt-0800">goto</span></span><span class="ectt-0800">&nbsp;fail3;</span> 
<a id="x1-58242r121"></a><span class="ecrm-0500">121</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-58244r122"></a><span class="ecrm-0500">122</span> 
<a id="x1-58246r123"></a><span class="ecrm-0500">123</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2398"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;0;</span> 
<a id="x1-58248r124"></a><span class="ecrm-0500">124</span> 
<a id="x1-58250r125"></a><span class="ecrm-0500">125</span><span id="textcolor2399"><span class="ectt-0800">/*&nbsp;cleanup&nbsp;what&nbsp;has&nbsp;been&nbsp;setup&nbsp;so&nbsp;far&nbsp;*/</span></span> 
<a id="x1-58252r126"></a><span class="ecrm-0500">126</span><span class="ectt-0800">fail3:</span> 
<a id="x1-58254r127"></a><span class="ecrm-0500">127</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;free_irq(button_irqs[0],&nbsp;NULL);</span> 
<a id="x1-58256r128"></a><span class="ecrm-0500">128</span> 
<a id="x1-58258r129"></a><span class="ecrm-0500">129</span><span class="ectt-0800">fail2:</span> 
<a id="x1-58260r130"></a><span class="ecrm-0500">130</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;gpio_free_array(buttons,&nbsp;ARRAY_SIZE(leds));</span> 
<a id="x1-58262r131"></a><span class="ecrm-0500">131</span> 
<a id="x1-58264r132"></a><span class="ecrm-0500">132</span><span class="ectt-0800">fail1:</span> 
<a id="x1-58266r133"></a><span class="ecrm-0500">133</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;gpio_free_array(leds,&nbsp;ARRAY_SIZE(leds));</span> 
<a id="x1-58268r134"></a><span class="ecrm-0500">134</span> 
<a id="x1-58270r135"></a><span class="ecrm-0500">135</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2400"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;ret;</span> 
<a id="x1-58272r136"></a><span class="ecrm-0500">136</span><span class="ectt-0800">}</span> 
<a id="x1-58274r137"></a><span class="ecrm-0500">137</span> 
<a id="x1-58276r138"></a><span class="ecrm-0500">138</span><span id="textcolor2401"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2402"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;__exit&nbsp;bottomhalf_exit(</span><span id="textcolor2403"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-58278r139"></a><span class="ecrm-0500">139</span><span class="ectt-0800">{</span> 
<a id="x1-58280r140"></a><span class="ecrm-0500">140</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2404"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;i;</span> 
<a id="x1-58282r141"></a><span class="ecrm-0500">141</span> 
<a id="x1-58284r142"></a><span class="ecrm-0500">142</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor2405"><span class="ectt-0800">"%s</span></span><span id="textcolor2406"><span class="ectt-0800">\n</span></span><span id="textcolor2407"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;__func__);</span> 
<a id="x1-58286r143"></a><span class="ecrm-0500">143</span> 
<a id="x1-58288r144"></a><span class="ecrm-0500">144</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2408"><span class="ectt-0800">/*&nbsp;free&nbsp;irqs&nbsp;*/</span></span> 
<a id="x1-58290r145"></a><span class="ecrm-0500">145</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;free_irq(button_irqs[0],&nbsp;NULL);</span> 
<a id="x1-58292r146"></a><span class="ecrm-0500">146</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;free_irq(button_irqs[1],&nbsp;NULL);</span> 
<a id="x1-58294r147"></a><span class="ecrm-0500">147</span> 
<a id="x1-58296r148"></a><span class="ecrm-0500">148</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2409"><span class="ectt-0800">/*&nbsp;turn&nbsp;all&nbsp;LEDs&nbsp;off&nbsp;*/</span></span> 
<a id="x1-58298r149"></a><span class="ecrm-0500">149</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2410"><span class="ectt-0800">for</span></span><span class="ectt-0800">&nbsp;(i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;ARRAY_SIZE(leds);&nbsp;i++)</span> 
<a id="x1-58300r150"></a><span class="ecrm-0500">150</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gpio_set_value(leds[i].gpio,&nbsp;0);</span> 
<a id="x1-58302r151"></a><span class="ecrm-0500">151</span> 
<a id="x1-58304r152"></a><span class="ecrm-0500">152</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2411"><span class="ectt-0800">/*&nbsp;unregister&nbsp;*/</span></span> 
<a id="x1-58306r153"></a><span class="ecrm-0500">153</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;gpio_free_array(leds,&nbsp;ARRAY_SIZE(leds));</span> 
<a id="x1-58308r154"></a><span class="ecrm-0500">154</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;gpio_free_array(buttons,&nbsp;ARRAY_SIZE(buttons));</span> 
<a id="x1-58310r155"></a><span class="ecrm-0500">155</span><span class="ectt-0800">}</span> 
<a id="x1-58312r156"></a><span class="ecrm-0500">156</span> 
<a id="x1-58314r157"></a><span class="ecrm-0500">157</span><span class="ectt-0800">module_init(bottomhalf_init);</span> 
<a id="x1-58316r158"></a><span class="ecrm-0500">158</span><span class="ectt-0800">module_exit(bottomhalf_exit);</span> 
<a id="x1-58318r159"></a><span class="ecrm-0500">159</span> 
<a id="x1-58320r160"></a><span class="ecrm-0500">160</span><span class="ectt-0800">MODULE_LICENSE(</span><span id="textcolor2412"><span class="ectt-0800">"GPL"</span></span><span class="ectt-0800">);</span> 
<a id="x1-58322r161"></a><span class="ecrm-0500">161</span><span class="ectt-0800">MODULE_DESCRIPTION(</span><span id="textcolor2413"><span class="ectt-0800">"Interrupt&nbsp;with&nbsp;top&nbsp;and&nbsp;bottom&nbsp;half"</span></span><span class="ectt-0800">);</span></pre>
<!-- l. 1490 --><p class="noindent">
</p>
   <h3 class="sectionHead" id="crypto"><span class="titlemark">0.16   </span> <a id="x1-590000.16"></a>Crypto</h3>
<!-- l. 1492 --><p class="noindent">At the dawn of the internet everybody trusted everybody completely…but that did
not work out so well. When this guide was originally written it was a more innocent
era in which almost nobody actually gave a damn about crypto - least of all kernel
developers. That is certainly no longer the case now. To handle crypto stuff the
kernel has its own API enabling common methods of encryption, decryption and your
favourite hash functions.
                                                                  

                                                                  
</p><!-- l. 1497 --><p class="noindent">
</p>
   <h4 class="subsectionHead" id="hash-functions"><span class="titlemark">0.16.1   </span> <a id="x1-600000.16.1"></a>Hash functions</h4>
<!-- l. 1500 --><p class="noindent">Calculating and checking the hashes of things is a common operation. Here is a
demonstration of how to calculate a sha256 hash within a kernel module.
</p><!-- l. 1 --><p class="indent">
</p>
   <pre class="fancyvrb" id="fancyvrb67"><a id="x1-60002r1"></a><span class="ecrm-0500">1</span><span id="textcolor2414"><span class="ectt-0800">/*</span></span> 
<a id="x1-60004r2"></a><span class="ecrm-0500">2</span><span id="textcolor2415"><span class="ectt-0800">&nbsp;*&nbsp;cryptosha256.c</span></span> 
<a id="x1-60006r3"></a><span class="ecrm-0500">3</span><span id="textcolor2416"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-60008r4"></a><span class="ecrm-0500">4</span><span id="textcolor2417"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2418"><span class="ectt-0800">&lt;crypto/internal/hash.h&gt;</span></span> 
<a id="x1-60010r5"></a><span class="ecrm-0500">5</span><span id="textcolor2419"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2420"><span class="ectt-0800">&lt;linux/module.h&gt;</span></span> 
<a id="x1-60012r6"></a><span class="ecrm-0500">6</span> 
<a id="x1-60014r7"></a><span class="ecrm-0500">7</span><span id="textcolor2421"><span class="ectt-0800">#define&nbsp;SHA256_LENGTH&nbsp;32</span></span> 
<a id="x1-60016r8"></a><span class="ecrm-0500">8</span> 
<a id="x1-60018r9"></a><span class="ecrm-0500">9</span><span id="textcolor2422"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2423"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;show_hash_result(</span><span id="textcolor2424"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;*plaintext,&nbsp;</span><span id="textcolor2425"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;*hash_sha256)</span> 
<a id="x1-60020r10"></a><span class="ecrm-0500">10</span><span class="ectt-0800">{</span> 
<a id="x1-60022r11"></a><span class="ecrm-0500">11</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2426"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;i;</span> 
<a id="x1-60024r12"></a><span class="ecrm-0500">12</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2427"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;str[SHA256_LENGTH&nbsp;*&nbsp;2&nbsp;+&nbsp;1];</span> 
<a id="x1-60026r13"></a><span class="ecrm-0500">13</span> 
<a id="x1-60028r14"></a><span class="ecrm-0500">14</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor2428"><span class="ectt-0800">"sha256&nbsp;test&nbsp;for&nbsp;string:&nbsp;</span></span><span id="textcolor2429"><span class="ectt-0800">\"</span></span><span id="textcolor2430"><span class="ectt-0800">%s</span></span><span id="textcolor2431"><span class="ectt-0800">\"\n</span></span><span id="textcolor2432"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;plaintext);</span> 
<a id="x1-60030r15"></a><span class="ecrm-0500">15</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2433"><span class="ectt-0800">for</span></span><span class="ectt-0800">&nbsp;(i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;SHA256_LENGTH;&nbsp;i++)</span> 
<a id="x1-60032r16"></a><span class="ecrm-0500">16</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf(&amp;str[i&nbsp;*&nbsp;2],&nbsp;</span><span id="textcolor2434"><span class="ectt-0800">"%02x"</span></span><span class="ectt-0800">,&nbsp;(</span><span id="textcolor2435"><span class="ectt-0800">unsigned</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2436"><span class="ectt-0800">char</span></span><span class="ectt-0800">)&nbsp;hash_sha256[i]);</span> 
<a id="x1-60034r17"></a><span class="ecrm-0500">17</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;str[i&nbsp;*&nbsp;2]&nbsp;=&nbsp;0;</span> 
<a id="x1-60036r18"></a><span class="ecrm-0500">18</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor2437"><span class="ectt-0800">"%s</span></span><span id="textcolor2438"><span class="ectt-0800">\n</span></span><span id="textcolor2439"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;str);</span> 
<a id="x1-60038r19"></a><span class="ecrm-0500">19</span><span class="ectt-0800">}</span> 
<a id="x1-60040r20"></a><span class="ecrm-0500">20</span> 
<a id="x1-60042r21"></a><span class="ecrm-0500">21</span><span id="textcolor2440"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;cryptosha256_init(</span><span id="textcolor2441"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-60044r22"></a><span class="ecrm-0500">22</span><span class="ectt-0800">{</span> 
<a id="x1-60046r23"></a><span class="ecrm-0500">23</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2442"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;*plaintext&nbsp;=&nbsp;</span><span id="textcolor2443"><span class="ectt-0800">"This&nbsp;is&nbsp;a&nbsp;test"</span></span><span class="ectt-0800">;</span> 
<a id="x1-60048r24"></a><span class="ecrm-0500">24</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2444"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;hash_sha256[SHA256_LENGTH];</span> 
<a id="x1-60050r25"></a><span class="ecrm-0500">25</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2445"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;crypto_shash&nbsp;*sha256;</span> 
<a id="x1-60052r26"></a><span class="ecrm-0500">26</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2446"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;shash_desc&nbsp;*shash;</span> 
<a id="x1-60054r27"></a><span class="ecrm-0500">27</span> 
<a id="x1-60056r28"></a><span class="ecrm-0500">28</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;sha256&nbsp;=&nbsp;crypto_alloc_shash(</span><span id="textcolor2447"><span class="ectt-0800">"sha256"</span></span><span class="ectt-0800">,&nbsp;0,&nbsp;0);</span> 
<a id="x1-60058r29"></a><span class="ecrm-0500">29</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2448"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(IS_ERR(sha256))</span> 
<a id="x1-60060r30"></a><span class="ecrm-0500">30</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2449"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;-1;</span> 
<a id="x1-60062r31"></a><span class="ecrm-0500">31</span> 
<a id="x1-60064r32"></a><span class="ecrm-0500">32</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;shash&nbsp;=&nbsp;kmalloc(</span><span id="textcolor2450"><span class="ectt-0800">sizeof</span></span><span class="ectt-0800">(</span><span id="textcolor2451"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;shash_desc)&nbsp;+&nbsp;crypto_shash_descsize(sha256),</span> 
<a id="x1-60066r33"></a><span class="ecrm-0500">33</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GFP_KERNEL);</span> 
<a id="x1-60068r34"></a><span class="ecrm-0500">34</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2452"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(!shash)</span> 
<a id="x1-60070r35"></a><span class="ecrm-0500">35</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2453"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;-ENOMEM;</span> 
<a id="x1-60072r36"></a><span class="ecrm-0500">36</span> 
<a id="x1-60074r37"></a><span class="ecrm-0500">37</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;shash-&gt;tfm&nbsp;=&nbsp;sha256;</span> 
<a id="x1-60076r38"></a><span class="ecrm-0500">38</span> 
<a id="x1-60078r39"></a><span class="ecrm-0500">39</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2454"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(crypto_shash_init(shash))</span> 
<a id="x1-60080r40"></a><span class="ecrm-0500">40</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2455"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;-1;</span> 
<a id="x1-60082r41"></a><span class="ecrm-0500">41</span> 
<a id="x1-60084r42"></a><span class="ecrm-0500">42</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2456"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(crypto_shash_update(shash,&nbsp;plaintext,&nbsp;strlen(plaintext)))</span> 
<a id="x1-60086r43"></a><span class="ecrm-0500">43</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2457"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;-1;</span> 
<a id="x1-60088r44"></a><span class="ecrm-0500">44</span> 
<a id="x1-60090r45"></a><span class="ecrm-0500">45</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2458"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(crypto_shash_final(shash,&nbsp;hash_sha256))</span> 
<a id="x1-60092r46"></a><span class="ecrm-0500">46</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2459"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;-1;</span> 
<a id="x1-60094r47"></a><span class="ecrm-0500">47</span> 
<a id="x1-60096r48"></a><span class="ecrm-0500">48</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;kfree(shash);</span> 
<a id="x1-60098r49"></a><span class="ecrm-0500">49</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;crypto_free_shash(sha256);</span> 
<a id="x1-60100r50"></a><span class="ecrm-0500">50</span> 
<a id="x1-60102r51"></a><span class="ecrm-0500">51</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;show_hash_result(plaintext,&nbsp;hash_sha256);</span> 
<a id="x1-60104r52"></a><span class="ecrm-0500">52</span> 
<a id="x1-60106r53"></a><span class="ecrm-0500">53</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2460"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;0;</span> 
<a id="x1-60108r54"></a><span class="ecrm-0500">54</span><span class="ectt-0800">}</span> 
<a id="x1-60110r55"></a><span class="ecrm-0500">55</span> 
<a id="x1-60112r56"></a><span class="ecrm-0500">56</span><span id="textcolor2461"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;cryptosha256_exit(</span><span id="textcolor2462"><span class="ectt-0800">void</span></span><span class="ectt-0800">)&nbsp;{}</span> 
<a id="x1-60114r57"></a><span class="ecrm-0500">57</span> 
<a id="x1-60116r58"></a><span class="ecrm-0500">58</span><span class="ectt-0800">module_init(cryptosha256_init);</span> 
<a id="x1-60118r59"></a><span class="ecrm-0500">59</span><span class="ectt-0800">module_exit(cryptosha256_exit);</span> 
<a id="x1-60120r60"></a><span class="ecrm-0500">60</span> 
<a id="x1-60122r61"></a><span class="ecrm-0500">61</span><span class="ectt-0800">MODULE_DESCRIPTION(</span><span id="textcolor2463"><span class="ectt-0800">"sha256&nbsp;hash&nbsp;test"</span></span><span class="ectt-0800">);</span> 
<a id="x1-60124r62"></a><span class="ecrm-0500">62</span><span class="ectt-0800">MODULE_LICENSE(</span><span id="textcolor2464"><span class="ectt-0800">"GPL"</span></span><span class="ectt-0800">);</span></pre>
<!-- l. 1505 --><p class="indent">   Make and install the module:
</p><!-- l. 1 --><p class="indent">
</p>
   <pre class="fancyvrb" id="fancyvrb68"><a id="x1-60129r1"></a><span class="ecrm-0500">1</span><span class="ectt-1000">make</span> 
<a id="x1-60131r2"></a><span class="ecrm-0500">2</span><span class="ectt-1000">sudo&nbsp;insmod&nbsp;cryptosha256.ko</span> 
<a id="x1-60133r3"></a><span class="ecrm-0500">3</span><span class="ectt-1000">dmesg</span></pre>
<!-- l. 1513 --><p class="indent">   And you should see that the hash was calculated for the test string.
</p><!-- l. 1515 --><p class="indent">   Finally, remove the test module:
</p><!-- l. 1 --><p class="indent">
</p>
   <pre class="fancyvrb" id="fancyvrb69"><a id="x1-60136r1"></a><span class="ecrm-0500">1</span><span class="ectt-1000">sudo&nbsp;rmmod&nbsp;cryptosha256</span></pre>
<!-- l. 1521 --><p class="noindent">
</p>
   <h4 class="subsectionHead" id="symmetric-key-encryption"><span class="titlemark">0.16.2   </span> <a id="x1-610000.16.2"></a>Symmetric key encryption</h4>
<!-- l. 1523 --><p class="noindent">Here is an example of symmetrically encrypting a string using the AES algorithm
and a password.
</p><!-- l. 1 --><p class="indent">
</p>
   <pre class="fancyvrb" id="fancyvrb70"><a id="x1-61002r1"></a><span class="ecrm-0500">1</span><span id="textcolor2465"><span class="ectt-0800">/*</span></span> 
<a id="x1-61004r2"></a><span class="ecrm-0500">2</span><span id="textcolor2466"><span class="ectt-0800">&nbsp;*&nbsp;cryptosk.c</span></span> 
<a id="x1-61006r3"></a><span class="ecrm-0500">3</span><span id="textcolor2467"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-61008r4"></a><span class="ecrm-0500">4</span><span id="textcolor2468"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2469"><span class="ectt-0800">&lt;crypto/internal/skcipher.h&gt;</span></span> 
<a id="x1-61010r5"></a><span class="ecrm-0500">5</span><span id="textcolor2470"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2471"><span class="ectt-0800">&lt;linux/crypto.h&gt;</span></span> 
<a id="x1-61012r6"></a><span class="ecrm-0500">6</span><span id="textcolor2472"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2473"><span class="ectt-0800">&lt;linux/module.h&gt;</span></span> 
<a id="x1-61014r7"></a><span class="ecrm-0500">7</span> 
<a id="x1-61016r8"></a><span class="ecrm-0500">8</span><span id="textcolor2474"><span class="ectt-0800">#define&nbsp;SYMMETRIC_KEY_LENGTH&nbsp;32</span></span> 
<a id="x1-61018r9"></a><span class="ecrm-0500">9</span><span id="textcolor2475"><span class="ectt-0800">#define&nbsp;CIPHER_BLOCK_SIZE&nbsp;16</span></span> 
<a id="x1-61020r10"></a><span class="ecrm-0500">10</span> 
<a id="x1-61022r11"></a><span class="ecrm-0500">11</span><span id="textcolor2476"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;tcrypt_result&nbsp;{</span> 
<a id="x1-61024r12"></a><span class="ecrm-0500">12</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2477"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;completion&nbsp;completion;</span> 
<a id="x1-61026r13"></a><span class="ecrm-0500">13</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2478"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;err;</span> 
<a id="x1-61028r14"></a><span class="ecrm-0500">14</span><span class="ectt-0800">};</span> 
<a id="x1-61030r15"></a><span class="ecrm-0500">15</span> 
<a id="x1-61032r16"></a><span class="ecrm-0500">16</span><span id="textcolor2479"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;skcipher_def&nbsp;{</span> 
<a id="x1-61034r17"></a><span class="ecrm-0500">17</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2480"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;scatterlist&nbsp;sg;</span> 
<a id="x1-61036r18"></a><span class="ecrm-0500">18</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2481"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;crypto_skcipher&nbsp;*tfm;</span> 
<a id="x1-61038r19"></a><span class="ecrm-0500">19</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2482"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;skcipher_request&nbsp;*req;</span> 
<a id="x1-61040r20"></a><span class="ecrm-0500">20</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2483"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;tcrypt_result&nbsp;result;</span> 
<a id="x1-61042r21"></a><span class="ecrm-0500">21</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2484"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;*scratchpad;</span> 
<a id="x1-61044r22"></a><span class="ecrm-0500">22</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2485"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;*ciphertext;</span> 
<a id="x1-61046r23"></a><span class="ecrm-0500">23</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2486"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;*ivdata;</span> 
<a id="x1-61048r24"></a><span class="ecrm-0500">24</span><span class="ectt-0800">};</span> 
<a id="x1-61050r25"></a><span class="ecrm-0500">25</span> 
<a id="x1-61052r26"></a><span class="ecrm-0500">26</span><span id="textcolor2487"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2488"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;skcipher_def&nbsp;sk;</span> 
<a id="x1-61054r27"></a><span class="ecrm-0500">27</span> 
<a id="x1-61056r28"></a><span class="ecrm-0500">28</span><span id="textcolor2489"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2490"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;test_skcipher_finish(</span><span id="textcolor2491"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;skcipher_def&nbsp;*sk)</span> 
<a id="x1-61058r29"></a><span class="ecrm-0500">29</span><span class="ectt-0800">{</span> 
<a id="x1-61060r30"></a><span class="ecrm-0500">30</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2492"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(sk-&gt;tfm)</span> 
<a id="x1-61062r31"></a><span class="ecrm-0500">31</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;crypto_free_skcipher(sk-&gt;tfm);</span> 
<a id="x1-61064r32"></a><span class="ecrm-0500">32</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2493"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(sk-&gt;req)</span> 
<a id="x1-61066r33"></a><span class="ecrm-0500">33</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;skcipher_request_free(sk-&gt;req);</span> 
<a id="x1-61068r34"></a><span class="ecrm-0500">34</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2494"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(sk-&gt;ivdata)</span> 
<a id="x1-61070r35"></a><span class="ecrm-0500">35</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kfree(sk-&gt;ivdata);</span> 
<a id="x1-61072r36"></a><span class="ecrm-0500">36</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2495"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(sk-&gt;scratchpad)</span> 
<a id="x1-61074r37"></a><span class="ecrm-0500">37</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kfree(sk-&gt;scratchpad);</span> 
<a id="x1-61076r38"></a><span class="ecrm-0500">38</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2496"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(sk-&gt;ciphertext)</span> 
<a id="x1-61078r39"></a><span class="ecrm-0500">39</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kfree(sk-&gt;ciphertext);</span> 
<a id="x1-61080r40"></a><span class="ecrm-0500">40</span><span class="ectt-0800">}</span> 
<a id="x1-61082r41"></a><span class="ecrm-0500">41</span> 
<a id="x1-61084r42"></a><span class="ecrm-0500">42</span><span id="textcolor2497"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2498"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;test_skcipher_result(</span><span id="textcolor2499"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;skcipher_def&nbsp;*sk,&nbsp;</span><span id="textcolor2500"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;rc)</span> 
<a id="x1-61086r43"></a><span class="ecrm-0500">43</span><span class="ectt-0800">{</span> 
<a id="x1-61088r44"></a><span class="ecrm-0500">44</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2501"><span class="ectt-0800">switch</span></span><span class="ectt-0800">&nbsp;(rc)&nbsp;{</span> 
<a id="x1-61090r45"></a><span class="ecrm-0500">45</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2502"><span class="ectt-0800">case</span></span><span class="ectt-0800">&nbsp;0:</span> 
<a id="x1-61092r46"></a><span class="ecrm-0500">46</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2503"><span class="ectt-0800">break</span></span><span class="ectt-0800">;</span> 
<a id="x1-61094r47"></a><span class="ecrm-0500">47</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2504"><span class="ectt-0800">case</span></span><span class="ectt-0800">&nbsp;-EINPROGRESS&nbsp;||&nbsp;-EBUSY:</span> 
<a id="x1-61096r48"></a><span class="ecrm-0500">48</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rc&nbsp;=&nbsp;wait_for_completion_interruptible(&amp;sk-&gt;result.completion);</span> 
<a id="x1-61098r49"></a><span class="ecrm-0500">49</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2505"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(!rc&nbsp;&amp;&amp;&nbsp;!sk-&gt;result.err)&nbsp;{</span> 
<a id="x1-61100r50"></a><span class="ecrm-0500">50</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;reinit_completion(&amp;sk-&gt;result.completion);</span> 
<a id="x1-61102r51"></a><span class="ecrm-0500">51</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2506"><span class="ectt-0800">break</span></span><span class="ectt-0800">;</span> 
<a id="x1-61104r52"></a><span class="ecrm-0500">52</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-61106r53"></a><span class="ecrm-0500">53</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor2507"><span class="ectt-0800">"skcipher&nbsp;encrypt&nbsp;returned&nbsp;with&nbsp;%d&nbsp;result&nbsp;%d</span></span><span id="textcolor2508"><span class="ectt-0800">\n</span></span><span id="textcolor2509"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;rc,</span> 
<a id="x1-61108r54"></a><span class="ecrm-0500">54</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sk-&gt;result.err);</span> 
<a id="x1-61110r55"></a><span class="ecrm-0500">55</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2510"><span class="ectt-0800">break</span></span><span class="ectt-0800">;</span> 
<a id="x1-61112r56"></a><span class="ecrm-0500">56</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2511"><span class="ectt-0800">default</span></span><span class="ectt-0800">:</span> 
<a id="x1-61114r57"></a><span class="ecrm-0500">57</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor2512"><span class="ectt-0800">"skcipher&nbsp;encrypt&nbsp;returned&nbsp;with&nbsp;%d&nbsp;result&nbsp;%d</span></span><span id="textcolor2513"><span class="ectt-0800">\n</span></span><span id="textcolor2514"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;rc,</span> 
<a id="x1-61116r58"></a><span class="ecrm-0500">58</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sk-&gt;result.err);</span> 
<a id="x1-61118r59"></a><span class="ecrm-0500">59</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2515"><span class="ectt-0800">break</span></span><span class="ectt-0800">;</span> 
<a id="x1-61120r60"></a><span class="ecrm-0500">60</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-61122r61"></a><span class="ecrm-0500">61</span> 
<a id="x1-61124r62"></a><span class="ecrm-0500">62</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;init_completion(&amp;sk-&gt;result.completion);</span> 
<a id="x1-61126r63"></a><span class="ecrm-0500">63</span> 
<a id="x1-61128r64"></a><span class="ecrm-0500">64</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2516"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;rc;</span> 
<a id="x1-61130r65"></a><span class="ecrm-0500">65</span><span class="ectt-0800">}</span> 
<a id="x1-61132r66"></a><span class="ecrm-0500">66</span> 
<a id="x1-61134r67"></a><span class="ecrm-0500">67</span><span id="textcolor2517"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2518"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;test_skcipher_callback(</span><span id="textcolor2519"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;crypto_async_request&nbsp;*req,&nbsp;</span><span id="textcolor2520"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;error)</span> 
<a id="x1-61136r68"></a><span class="ecrm-0500">68</span><span class="ectt-0800">{</span> 
<a id="x1-61138r69"></a><span class="ecrm-0500">69</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2521"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;tcrypt_result&nbsp;*result&nbsp;=&nbsp;req-&gt;data;</span> 
<a id="x1-61140r70"></a><span class="ecrm-0500">70</span> 
<a id="x1-61142r71"></a><span class="ecrm-0500">71</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2522"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(error&nbsp;==&nbsp;-EINPROGRESS)</span> 
<a id="x1-61144r72"></a><span class="ecrm-0500">72</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2523"><span class="ectt-0800">return</span></span><span class="ectt-0800">;</span> 
<a id="x1-61146r73"></a><span class="ecrm-0500">73</span> 
<a id="x1-61148r74"></a><span class="ecrm-0500">74</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;result-&gt;err&nbsp;=&nbsp;error;</span> 
<a id="x1-61150r75"></a><span class="ecrm-0500">75</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;complete(&amp;result-&gt;completion);</span> 
<a id="x1-61152r76"></a><span class="ecrm-0500">76</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor2524"><span class="ectt-0800">"Encryption&nbsp;finished&nbsp;successfully</span></span><span id="textcolor2525"><span class="ectt-0800">\n</span></span><span id="textcolor2526"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-61154r77"></a><span class="ecrm-0500">77</span> 
<a id="x1-61156r78"></a><span class="ecrm-0500">78</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2527"><span class="ectt-0800">/*&nbsp;decrypt&nbsp;data&nbsp;*/</span></span> 
<a id="x1-61158r79"></a><span class="ecrm-0500">79</span><span id="textcolor2528"><span class="ectt-0800">#if&nbsp;0</span></span> 
<a id="x1-61160r80"></a><span class="ecrm-0500">80</span><span id="textcolor2529"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;memset((void*)sk.scratchpad,&nbsp;</span><span class="tctt-0800">'</span><span class="ectt-0800">-</span><span class="tctt-0800">'</span><span class="ectt-0800">,&nbsp;CIPHER_BLOCK_SIZE);</span></span> 
<a id="x1-61162r81"></a><span class="ecrm-0500">81</span><span id="textcolor2530"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;ret&nbsp;=&nbsp;crypto_skcipher_decrypt(sk.req);</span></span> 
<a id="x1-61164r82"></a><span class="ecrm-0500">82</span><span id="textcolor2531"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;ret&nbsp;=&nbsp;test_skcipher_result(&amp;sk,&nbsp;ret);</span></span> 
<a id="x1-61166r83"></a><span class="ecrm-0500">83</span><span id="textcolor2532"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(ret)</span></span> 
<a id="x1-61168r84"></a><span class="ecrm-0500">84</span><span id="textcolor2533"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;</span></span> 
<a id="x1-61170r85"></a><span class="ecrm-0500">85</span> 
<a id="x1-61172r86"></a><span class="ecrm-0500">86</span><span id="textcolor2534"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;sg_copy_from_buffer(&amp;sk.sg,&nbsp;1,&nbsp;sk.scratchpad,&nbsp;CIPHER_BLOCK_SIZE);</span></span> 
<a id="x1-61174r87"></a><span class="ecrm-0500">87</span><span id="textcolor2535"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;sk.scratchpad[CIPHER_BLOCK_SIZE-1]&nbsp;=&nbsp;0;</span></span> 
<a id="x1-61176r88"></a><span class="ecrm-0500">88</span> 
<a id="x1-61178r89"></a><span class="ecrm-0500">89</span><span id="textcolor2536"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info("Decryption&nbsp;request&nbsp;successful\n");</span></span> 
<a id="x1-61180r90"></a><span class="ecrm-0500">90</span><span id="textcolor2537"><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info("Decrypted:&nbsp;%s\n",&nbsp;sk.scratchpad);</span></span> 
<a id="x1-61182r91"></a><span class="ecrm-0500">91</span><span id="textcolor2538"><span class="ectt-0800">#endif</span></span> 
<a id="x1-61184r92"></a><span class="ecrm-0500">92</span><span class="ectt-0800">}</span> 
<a id="x1-61186r93"></a><span class="ecrm-0500">93</span> 
<a id="x1-61188r94"></a><span class="ecrm-0500">94</span><span id="textcolor2539"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2540"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;test_skcipher_encrypt(</span><span id="textcolor2541"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;*plaintext,</span> 
<a id="x1-61190r95"></a><span class="ecrm-0500">95</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2542"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;*password,</span> 
<a id="x1-61192r96"></a><span class="ecrm-0500">96</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2543"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;skcipher_def&nbsp;*sk)</span> 
<a id="x1-61194r97"></a><span class="ecrm-0500">97</span><span class="ectt-0800">{</span> 
<a id="x1-61196r98"></a><span class="ecrm-0500">98</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2544"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;ret&nbsp;=&nbsp;-EFAULT;</span> 
<a id="x1-61198r99"></a><span class="ecrm-0500">99</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2545"><span class="ectt-0800">unsigned</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2546"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;key[SYMMETRIC_KEY_LENGTH];</span> 
<a id="x1-61200r100"></a><span class="ecrm-0500">100</span> 
<a id="x1-61202r101"></a><span class="ecrm-0500">101</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2547"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(!sk-&gt;tfm)&nbsp;{</span> 
<a id="x1-61204r102"></a><span class="ecrm-0500">102</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sk-&gt;tfm&nbsp;=&nbsp;crypto_alloc_skcipher(</span><span id="textcolor2548"><span class="ectt-0800">"cbc-aes-aesni"</span></span><span class="ectt-0800">,&nbsp;0,&nbsp;0);</span> 
<a id="x1-61206r103"></a><span class="ecrm-0500">103</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2549"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(IS_ERR(sk-&gt;tfm))&nbsp;{</span> 
<a id="x1-61208r104"></a><span class="ecrm-0500">104</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor2550"><span class="ectt-0800">"could&nbsp;not&nbsp;allocate&nbsp;skcipher&nbsp;handle</span></span><span id="textcolor2551"><span class="ectt-0800">\n</span></span><span id="textcolor2552"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-61210r105"></a><span class="ecrm-0500">105</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2553"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;PTR_ERR(sk-&gt;tfm);</span> 
<a id="x1-61212r106"></a><span class="ecrm-0500">106</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-61214r107"></a><span class="ecrm-0500">107</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-61216r108"></a><span class="ecrm-0500">108</span> 
<a id="x1-61218r109"></a><span class="ecrm-0500">109</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2554"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(!sk-&gt;req)&nbsp;{</span> 
<a id="x1-61220r110"></a><span class="ecrm-0500">110</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sk-&gt;req&nbsp;=&nbsp;skcipher_request_alloc(sk-&gt;tfm,&nbsp;GFP_KERNEL);</span> 
<a id="x1-61222r111"></a><span class="ecrm-0500">111</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2555"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(!sk-&gt;req)&nbsp;{</span> 
<a id="x1-61224r112"></a><span class="ecrm-0500">112</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor2556"><span class="ectt-0800">"could&nbsp;not&nbsp;allocate&nbsp;skcipher&nbsp;request</span></span><span id="textcolor2557"><span class="ectt-0800">\n</span></span><span id="textcolor2558"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-61226r113"></a><span class="ecrm-0500">113</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret&nbsp;=&nbsp;-ENOMEM;</span> 
<a id="x1-61228r114"></a><span class="ecrm-0500">114</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2559"><span class="ectt-0800">goto</span></span><span class="ectt-0800">&nbsp;out;</span> 
<a id="x1-61230r115"></a><span class="ecrm-0500">115</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-61232r116"></a><span class="ecrm-0500">116</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-61234r117"></a><span class="ecrm-0500">117</span> 
<a id="x1-61236r118"></a><span class="ecrm-0500">118</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;skcipher_request_set_callback(sk-&gt;req,&nbsp;CRYPTO_TFM_REQ_MAY_BACKLOG,</span> 
<a id="x1-61238r119"></a><span class="ecrm-0500">119</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;test_skcipher_callback,&nbsp;&amp;sk-&gt;result);</span> 
<a id="x1-61240r120"></a><span class="ecrm-0500">120</span> 
<a id="x1-61242r121"></a><span class="ecrm-0500">121</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2560"><span class="ectt-0800">/*&nbsp;clear&nbsp;the&nbsp;key&nbsp;*/</span></span> 
<a id="x1-61244r122"></a><span class="ecrm-0500">122</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;memset((</span><span id="textcolor2561"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;*)&nbsp;key,&nbsp;</span><span id="textcolor2562"><span class="tctt-0800">'</span><span class="ectt-0800">\0</span><span class="tctt-0800">'</span></span><span class="ectt-0800">,&nbsp;SYMMETRIC_KEY_LENGTH);</span> 
<a id="x1-61246r123"></a><span class="ecrm-0500">123</span> 
<a id="x1-61248r124"></a><span class="ecrm-0500">124</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2563"><span class="ectt-0800">/*&nbsp;Use&nbsp;the&nbsp;world</span><span class="tctt-0800">'</span><span class="ectt-0800">s&nbsp;favourite&nbsp;password&nbsp;*/</span></span> 
<a id="x1-61250r125"></a><span class="ecrm-0500">125</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;sprintf((</span><span id="textcolor2564"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;*)&nbsp;key,&nbsp;</span><span id="textcolor2565"><span class="ectt-0800">"%s"</span></span><span class="ectt-0800">,&nbsp;password);</span> 
<a id="x1-61252r126"></a><span class="ecrm-0500">126</span> 
<a id="x1-61254r127"></a><span class="ecrm-0500">127</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2566"><span class="ectt-0800">/*&nbsp;AES&nbsp;256&nbsp;with&nbsp;given&nbsp;symmetric&nbsp;key&nbsp;*/</span></span> 
<a id="x1-61256r128"></a><span class="ecrm-0500">128</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2567"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(crypto_skcipher_setkey(sk-&gt;tfm,&nbsp;key,&nbsp;SYMMETRIC_KEY_LENGTH))&nbsp;{</span> 
<a id="x1-61258r129"></a><span class="ecrm-0500">129</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor2568"><span class="ectt-0800">"key&nbsp;could&nbsp;not&nbsp;be&nbsp;set</span></span><span id="textcolor2569"><span class="ectt-0800">\n</span></span><span id="textcolor2570"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-61260r130"></a><span class="ecrm-0500">130</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret&nbsp;=&nbsp;-EAGAIN;</span> 
<a id="x1-61262r131"></a><span class="ecrm-0500">131</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2571"><span class="ectt-0800">goto</span></span><span class="ectt-0800">&nbsp;out;</span> 
<a id="x1-61264r132"></a><span class="ecrm-0500">132</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-61266r133"></a><span class="ecrm-0500">133</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor2572"><span class="ectt-0800">"Symmetric&nbsp;key:&nbsp;%s</span></span><span id="textcolor2573"><span class="ectt-0800">\n</span></span><span id="textcolor2574"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;key);</span> 
<a id="x1-61268r134"></a><span class="ecrm-0500">134</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor2575"><span class="ectt-0800">"Plaintext:&nbsp;%s</span></span><span id="textcolor2576"><span class="ectt-0800">\n</span></span><span id="textcolor2577"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;plaintext);</span> 
<a id="x1-61270r135"></a><span class="ecrm-0500">135</span> 
<a id="x1-61272r136"></a><span class="ecrm-0500">136</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2578"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(!sk-&gt;ivdata)&nbsp;{</span> 
<a id="x1-61274r137"></a><span class="ecrm-0500">137</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2579"><span class="ectt-0800">/*&nbsp;see&nbsp;https://en.wikipedia.org/wiki/Initialization_vector&nbsp;*/</span></span> 
<a id="x1-61276r138"></a><span class="ecrm-0500">138</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sk-&gt;ivdata&nbsp;=&nbsp;kmalloc(CIPHER_BLOCK_SIZE,&nbsp;GFP_KERNEL);</span> 
<a id="x1-61278r139"></a><span class="ecrm-0500">139</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2580"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(!sk-&gt;ivdata)&nbsp;{</span> 
<a id="x1-61280r140"></a><span class="ecrm-0500">140</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor2581"><span class="ectt-0800">"could&nbsp;not&nbsp;allocate&nbsp;ivdata</span></span><span id="textcolor2582"><span class="ectt-0800">\n</span></span><span id="textcolor2583"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-61282r141"></a><span class="ecrm-0500">141</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2584"><span class="ectt-0800">goto</span></span><span class="ectt-0800">&nbsp;out;</span> 
<a id="x1-61284r142"></a><span class="ecrm-0500">142</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-61286r143"></a><span class="ecrm-0500">143</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;get_random_bytes(sk-&gt;ivdata,&nbsp;CIPHER_BLOCK_SIZE);</span> 
<a id="x1-61288r144"></a><span class="ecrm-0500">144</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-61290r145"></a><span class="ecrm-0500">145</span> 
<a id="x1-61292r146"></a><span class="ecrm-0500">146</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2585"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(!sk-&gt;scratchpad)&nbsp;{</span> 
<a id="x1-61294r147"></a><span class="ecrm-0500">147</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2586"><span class="ectt-0800">/*&nbsp;The&nbsp;text&nbsp;to&nbsp;be&nbsp;encrypted&nbsp;*/</span></span> 
<a id="x1-61296r148"></a><span class="ecrm-0500">148</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sk-&gt;scratchpad&nbsp;=&nbsp;kmalloc(CIPHER_BLOCK_SIZE,&nbsp;GFP_KERNEL);</span> 
<a id="x1-61298r149"></a><span class="ecrm-0500">149</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2587"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(!sk-&gt;scratchpad)&nbsp;{</span> 
<a id="x1-61300r150"></a><span class="ecrm-0500">150</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor2588"><span class="ectt-0800">"could&nbsp;not&nbsp;allocate&nbsp;scratchpad</span></span><span id="textcolor2589"><span class="ectt-0800">\n</span></span><span id="textcolor2590"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-61302r151"></a><span class="ecrm-0500">151</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2591"><span class="ectt-0800">goto</span></span><span class="ectt-0800">&nbsp;out;</span> 
<a id="x1-61304r152"></a><span class="ecrm-0500">152</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-61306r153"></a><span class="ecrm-0500">153</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-61308r154"></a><span class="ecrm-0500">154</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;sprintf((</span><span id="textcolor2592"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;*)&nbsp;sk-&gt;scratchpad,&nbsp;</span><span id="textcolor2593"><span class="ectt-0800">"%s"</span></span><span class="ectt-0800">,&nbsp;plaintext);</span> 
<a id="x1-61310r155"></a><span class="ecrm-0500">155</span> 
<a id="x1-61312r156"></a><span class="ecrm-0500">156</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;sg_init_one(&amp;sk-&gt;sg,&nbsp;sk-&gt;scratchpad,&nbsp;CIPHER_BLOCK_SIZE);</span> 
<a id="x1-61314r157"></a><span class="ecrm-0500">157</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;skcipher_request_set_crypt(sk-&gt;req,&nbsp;&amp;sk-&gt;sg,&nbsp;&amp;sk-&gt;sg,&nbsp;CIPHER_BLOCK_SIZE,</span> 
<a id="x1-61316r158"></a><span class="ecrm-0500">158</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sk-&gt;ivdata);</span> 
<a id="x1-61318r159"></a><span class="ecrm-0500">159</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;init_completion(&amp;sk-&gt;result.completion);</span> 
<a id="x1-61320r160"></a><span class="ecrm-0500">160</span> 
<a id="x1-61322r161"></a><span class="ecrm-0500">161</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2594"><span class="ectt-0800">/*&nbsp;encrypt&nbsp;data&nbsp;*/</span></span> 
<a id="x1-61324r162"></a><span class="ecrm-0500">162</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;ret&nbsp;=&nbsp;crypto_skcipher_encrypt(sk-&gt;req);</span> 
<a id="x1-61326r163"></a><span class="ecrm-0500">163</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;ret&nbsp;=&nbsp;test_skcipher_result(sk,&nbsp;ret);</span> 
<a id="x1-61328r164"></a><span class="ecrm-0500">164</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2595"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(ret)</span> 
<a id="x1-61330r165"></a><span class="ecrm-0500">165</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2596"><span class="ectt-0800">goto</span></span><span class="ectt-0800">&nbsp;out;</span> 
<a id="x1-61332r166"></a><span class="ecrm-0500">166</span> 
<a id="x1-61334r167"></a><span class="ecrm-0500">167</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor2597"><span class="ectt-0800">"Encryption&nbsp;request&nbsp;successful</span></span><span id="textcolor2598"><span class="ectt-0800">\n</span></span><span id="textcolor2599"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-61336r168"></a><span class="ecrm-0500">168</span> 
<a id="x1-61338r169"></a><span class="ecrm-0500">169</span><span class="ectt-0800">out:</span> 
<a id="x1-61340r170"></a><span class="ecrm-0500">170</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2600"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;ret;</span> 
<a id="x1-61342r171"></a><span class="ecrm-0500">171</span><span class="ectt-0800">}</span> 
<a id="x1-61344r172"></a><span class="ecrm-0500">172</span> 
<a id="x1-61346r173"></a><span class="ecrm-0500">173</span><span id="textcolor2601"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;cryptoapi_init(</span><span id="textcolor2602"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-61348r174"></a><span class="ecrm-0500">174</span><span class="ectt-0800">{</span> 
<a id="x1-61350r175"></a><span class="ecrm-0500">175</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2603"><span class="ectt-0800">/*&nbsp;The&nbsp;world</span><span class="tctt-0800">'</span><span class="ectt-0800">s&nbsp;favorite&nbsp;password&nbsp;*/</span></span> 
<a id="x1-61352r176"></a><span class="ecrm-0500">176</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2604"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;*password&nbsp;=&nbsp;</span><span id="textcolor2605"><span class="ectt-0800">"password123"</span></span><span class="ectt-0800">;</span> 
<a id="x1-61354r177"></a><span class="ecrm-0500">177</span> 
<a id="x1-61356r178"></a><span class="ecrm-0500">178</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;sk.tfm&nbsp;=&nbsp;NULL;</span> 
<a id="x1-61358r179"></a><span class="ecrm-0500">179</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;sk.req&nbsp;=&nbsp;NULL;</span> 
<a id="x1-61360r180"></a><span class="ecrm-0500">180</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;sk.scratchpad&nbsp;=&nbsp;NULL;</span> 
<a id="x1-61362r181"></a><span class="ecrm-0500">181</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;sk.ciphertext&nbsp;=&nbsp;NULL;</span> 
<a id="x1-61364r182"></a><span class="ecrm-0500">182</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;sk.ivdata&nbsp;=&nbsp;NULL;</span> 
<a id="x1-61366r183"></a><span class="ecrm-0500">183</span> 
<a id="x1-61368r184"></a><span class="ecrm-0500">184</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;test_skcipher_encrypt(</span><span id="textcolor2606"><span class="ectt-0800">"Testing"</span></span><span class="ectt-0800">,&nbsp;password,&nbsp;&amp;sk);</span> 
<a id="x1-61370r185"></a><span class="ecrm-0500">185</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2607"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;0;</span> 
<a id="x1-61372r186"></a><span class="ecrm-0500">186</span><span class="ectt-0800">}</span> 
<a id="x1-61374r187"></a><span class="ecrm-0500">187</span> 
<a id="x1-61376r188"></a><span class="ecrm-0500">188</span><span id="textcolor2608"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;cryptoapi_exit(</span><span id="textcolor2609"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-61378r189"></a><span class="ecrm-0500">189</span><span class="ectt-0800">{</span> 
<a id="x1-61380r190"></a><span class="ecrm-0500">190</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;test_skcipher_finish(&amp;sk);</span> 
<a id="x1-61382r191"></a><span class="ecrm-0500">191</span><span class="ectt-0800">}</span> 
<a id="x1-61384r192"></a><span class="ecrm-0500">192</span> 
<a id="x1-61386r193"></a><span class="ecrm-0500">193</span><span class="ectt-0800">module_init(cryptoapi_init);</span> 
<a id="x1-61388r194"></a><span class="ecrm-0500">194</span><span class="ectt-0800">module_exit(cryptoapi_exit);</span> 
<a id="x1-61390r195"></a><span class="ecrm-0500">195</span> 
<a id="x1-61392r196"></a><span class="ecrm-0500">196</span><span class="ectt-0800">MODULE_DESCRIPTION(</span><span id="textcolor2610"><span class="ectt-0800">"Symmetric&nbsp;key&nbsp;encryption&nbsp;example"</span></span><span class="ectt-0800">);</span> 
<a id="x1-61394r197"></a><span class="ecrm-0500">197</span><span class="ectt-0800">MODULE_LICENSE(</span><span id="textcolor2611"><span class="ectt-0800">"GPL"</span></span><span class="ectt-0800">);</span></pre>
<!-- l. 1527 --><p class="noindent">
</p>
   <h3 class="sectionHead" id="standardizing-the-interfaces-the-device-model"><span class="titlemark">0.17   </span> <a id="x1-620000.17"></a>Standardizing the interfaces: The Device Model</h3>
<!-- l. 1529 --><p class="noindent">Up to this point we have seen all kinds of modules doing all kinds of things, but there
was no consistency in their interfaces with the rest of the kernel. To impose some
consistency such that there is at minimum a standardized way to start, suspend and
resume a device a device model was added. An example is show below, and you can
use this as a template to add your own suspend, resume or other interface
functions.
</p><!-- l. 1 --><p class="indent">
</p>
   <pre class="fancyvrb" id="fancyvrb71"><a id="x1-62002r1"></a><span class="ecrm-0500">1</span><span id="textcolor2612"><span class="ectt-0800">/*</span></span> 
<a id="x1-62004r2"></a><span class="ecrm-0500">2</span><span id="textcolor2613"><span class="ectt-0800">&nbsp;*&nbsp;devicemodel.c</span></span> 
<a id="x1-62006r3"></a><span class="ecrm-0500">3</span><span id="textcolor2614"><span class="ectt-0800">&nbsp;*/</span></span> 
<a id="x1-62008r4"></a><span class="ecrm-0500">4</span><span id="textcolor2615"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2616"><span class="ectt-0800">&lt;linux/kernel.h&gt;</span></span> 
<a id="x1-62010r5"></a><span class="ecrm-0500">5</span><span id="textcolor2617"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2618"><span class="ectt-0800">&lt;linux/module.h&gt;</span></span> 
<a id="x1-62012r6"></a><span class="ecrm-0500">6</span><span id="textcolor2619"><span class="ectt-0800">#include</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2620"><span class="ectt-0800">&lt;linux/platform_device.h&gt;</span></span> 
<a id="x1-62014r7"></a><span class="ecrm-0500">7</span> 
<a id="x1-62016r8"></a><span class="ecrm-0500">8</span><span id="textcolor2621"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;devicemodel_data&nbsp;{</span> 
<a id="x1-62018r9"></a><span class="ecrm-0500">9</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2622"><span class="ectt-0800">char</span></span><span class="ectt-0800">&nbsp;*greeting;</span> 
<a id="x1-62020r10"></a><span class="ecrm-0500">10</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2623"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;number;</span> 
<a id="x1-62022r11"></a><span class="ecrm-0500">11</span><span class="ectt-0800">};</span> 
<a id="x1-62024r12"></a><span class="ecrm-0500">12</span> 
<a id="x1-62026r13"></a><span class="ecrm-0500">13</span><span id="textcolor2624"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2625"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;devicemodel_probe(</span><span id="textcolor2626"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;platform_device&nbsp;*dev)</span> 
<a id="x1-62028r14"></a><span class="ecrm-0500">14</span><span class="ectt-0800">{</span> 
<a id="x1-62030r15"></a><span class="ecrm-0500">15</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2627"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;devicemodel_data&nbsp;*pd&nbsp;=</span> 
<a id="x1-62032r16"></a><span class="ecrm-0500">16</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(</span><span id="textcolor2628"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;devicemodel_data&nbsp;*)&nbsp;(dev-&gt;dev.platform_data);</span> 
<a id="x1-62034r17"></a><span class="ecrm-0500">17</span> 
<a id="x1-62036r18"></a><span class="ecrm-0500">18</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor2629"><span class="ectt-0800">"devicemodel&nbsp;probe</span></span><span id="textcolor2630"><span class="ectt-0800">\n</span></span><span id="textcolor2631"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-62038r19"></a><span class="ecrm-0500">19</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor2632"><span class="ectt-0800">"devicemodel&nbsp;greeting:&nbsp;%s;&nbsp;%d</span></span><span id="textcolor2633"><span class="ectt-0800">\n</span></span><span id="textcolor2634"><span class="ectt-0800">"</span></span><span class="ectt-0800">,&nbsp;pd-&gt;greeting,&nbsp;pd-&gt;number);</span> 
<a id="x1-62040r20"></a><span class="ecrm-0500">20</span> 
<a id="x1-62042r21"></a><span class="ecrm-0500">21</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2635"><span class="ectt-0800">/*&nbsp;Your&nbsp;device&nbsp;initialization&nbsp;code&nbsp;*/</span></span> 
<a id="x1-62044r22"></a><span class="ecrm-0500">22</span> 
<a id="x1-62046r23"></a><span class="ecrm-0500">23</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2636"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;0;</span> 
<a id="x1-62048r24"></a><span class="ecrm-0500">24</span><span class="ectt-0800">}</span> 
<a id="x1-62050r25"></a><span class="ecrm-0500">25</span> 
<a id="x1-62052r26"></a><span class="ecrm-0500">26</span><span id="textcolor2637"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2638"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;devicemodel_remove(</span><span id="textcolor2639"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;platform_device&nbsp;*dev)</span> 
<a id="x1-62054r27"></a><span class="ecrm-0500">27</span><span class="ectt-0800">{</span> 
<a id="x1-62056r28"></a><span class="ecrm-0500">28</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor2640"><span class="ectt-0800">"devicemodel&nbsp;example&nbsp;removed</span></span><span id="textcolor2641"><span class="ectt-0800">\n</span></span><span id="textcolor2642"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-62058r29"></a><span class="ecrm-0500">29</span> 
<a id="x1-62060r30"></a><span class="ecrm-0500">30</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2643"><span class="ectt-0800">/*&nbsp;Your&nbsp;device&nbsp;removal&nbsp;code&nbsp;*/</span></span> 
<a id="x1-62062r31"></a><span class="ecrm-0500">31</span> 
<a id="x1-62064r32"></a><span class="ecrm-0500">32</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2644"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;0;</span> 
<a id="x1-62066r33"></a><span class="ecrm-0500">33</span><span class="ectt-0800">}</span> 
<a id="x1-62068r34"></a><span class="ecrm-0500">34</span> 
<a id="x1-62070r35"></a><span class="ecrm-0500">35</span><span id="textcolor2645"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2646"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;devicemodel_suspend(</span><span id="textcolor2647"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;device&nbsp;*dev)</span> 
<a id="x1-62072r36"></a><span class="ecrm-0500">36</span><span class="ectt-0800">{</span> 
<a id="x1-62074r37"></a><span class="ecrm-0500">37</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor2648"><span class="ectt-0800">"devicemodel&nbsp;example&nbsp;suspend</span></span><span id="textcolor2649"><span class="ectt-0800">\n</span></span><span id="textcolor2650"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-62076r38"></a><span class="ecrm-0500">38</span> 
<a id="x1-62078r39"></a><span class="ecrm-0500">39</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2651"><span class="ectt-0800">/*&nbsp;Your&nbsp;device&nbsp;suspend&nbsp;code&nbsp;*/</span></span> 
<a id="x1-62080r40"></a><span class="ecrm-0500">40</span> 
<a id="x1-62082r41"></a><span class="ecrm-0500">41</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2652"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;0;</span> 
<a id="x1-62084r42"></a><span class="ecrm-0500">42</span><span class="ectt-0800">}</span> 
<a id="x1-62086r43"></a><span class="ecrm-0500">43</span> 
<a id="x1-62088r44"></a><span class="ecrm-0500">44</span><span id="textcolor2653"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2654"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;devicemodel_resume(</span><span id="textcolor2655"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;device&nbsp;*dev)</span> 
<a id="x1-62090r45"></a><span class="ecrm-0500">45</span><span class="ectt-0800">{</span> 
<a id="x1-62092r46"></a><span class="ecrm-0500">46</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor2656"><span class="ectt-0800">"devicemodel&nbsp;example&nbsp;resume</span></span><span id="textcolor2657"><span class="ectt-0800">\n</span></span><span id="textcolor2658"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-62094r47"></a><span class="ecrm-0500">47</span> 
<a id="x1-62096r48"></a><span class="ecrm-0500">48</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2659"><span class="ectt-0800">/*&nbsp;Your&nbsp;device&nbsp;resume&nbsp;code&nbsp;*/</span></span> 
<a id="x1-62098r49"></a><span class="ecrm-0500">49</span> 
<a id="x1-62100r50"></a><span class="ecrm-0500">50</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2660"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;0;</span> 
<a id="x1-62102r51"></a><span class="ecrm-0500">51</span><span class="ectt-0800">}</span> 
<a id="x1-62104r52"></a><span class="ecrm-0500">52</span> 
<a id="x1-62106r53"></a><span class="ecrm-0500">53</span><span id="textcolor2661"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2662"><span class="ectt-0800">const</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2663"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;dev_pm_ops&nbsp;devicemodel_pm_ops&nbsp;=&nbsp;{</span> 
<a id="x1-62108r54"></a><span class="ecrm-0500">54</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.suspend&nbsp;=&nbsp;devicemodel_suspend,</span> 
<a id="x1-62110r55"></a><span class="ecrm-0500">55</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.resume&nbsp;=&nbsp;devicemodel_resume,</span> 
<a id="x1-62112r56"></a><span class="ecrm-0500">56</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.poweroff&nbsp;=&nbsp;devicemodel_suspend,</span> 
<a id="x1-62114r57"></a><span class="ecrm-0500">57</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.freeze&nbsp;=&nbsp;devicemodel_suspend,</span> 
<a id="x1-62116r58"></a><span class="ecrm-0500">58</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.thaw&nbsp;=&nbsp;devicemodel_resume,</span> 
<a id="x1-62118r59"></a><span class="ecrm-0500">59</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.restore&nbsp;=&nbsp;devicemodel_resume,</span> 
<a id="x1-62120r60"></a><span class="ecrm-0500">60</span><span class="ectt-0800">};</span> 
<a id="x1-62122r61"></a><span class="ecrm-0500">61</span> 
<a id="x1-62124r62"></a><span class="ecrm-0500">62</span><span id="textcolor2664"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2665"><span class="ectt-0800">struct</span></span><span class="ectt-0800">&nbsp;platform_driver&nbsp;devicemodel_driver&nbsp;=&nbsp;{</span> 
<a id="x1-62126r63"></a><span class="ecrm-0500">63</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.driver&nbsp;=</span> 
<a id="x1-62128r64"></a><span class="ecrm-0500">64</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span> 
<a id="x1-62130r65"></a><span class="ecrm-0500">65</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.name&nbsp;=&nbsp;</span><span id="textcolor2666"><span class="ectt-0800">"devicemodel_example"</span></span><span class="ectt-0800">,</span> 
<a id="x1-62132r66"></a><span class="ecrm-0500">66</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.owner&nbsp;=&nbsp;THIS_MODULE,</span> 
<a id="x1-62134r67"></a><span class="ecrm-0500">67</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.pm&nbsp;=&nbsp;&amp;devicemodel_pm_ops,</span> 
<a id="x1-62136r68"></a><span class="ecrm-0500">68</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},</span> 
<a id="x1-62138r69"></a><span class="ecrm-0500">69</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.probe&nbsp;=&nbsp;devicemodel_probe,</span> 
<a id="x1-62140r70"></a><span class="ecrm-0500">70</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;.remove&nbsp;=&nbsp;devicemodel_remove,</span> 
<a id="x1-62142r71"></a><span class="ecrm-0500">71</span><span class="ectt-0800">};</span> 
<a id="x1-62144r72"></a><span class="ecrm-0500">72</span> 
<a id="x1-62146r73"></a><span class="ecrm-0500">73</span><span id="textcolor2667"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2668"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;devicemodel_init(</span><span id="textcolor2669"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-62148r74"></a><span class="ecrm-0500">74</span><span class="ectt-0800">{</span> 
<a id="x1-62150r75"></a><span class="ecrm-0500">75</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2670"><span class="ectt-0800">int</span></span><span class="ectt-0800">&nbsp;ret;</span> 
<a id="x1-62152r76"></a><span class="ecrm-0500">76</span> 
<a id="x1-62154r77"></a><span class="ecrm-0500">77</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor2671"><span class="ectt-0800">"devicemodel&nbsp;init</span></span><span id="textcolor2672"><span class="ectt-0800">\n</span></span><span id="textcolor2673"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-62156r78"></a><span class="ecrm-0500">78</span> 
<a id="x1-62158r79"></a><span class="ecrm-0500">79</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;ret&nbsp;=&nbsp;platform_driver_register(&amp;devicemodel_driver);</span> 
<a id="x1-62160r80"></a><span class="ecrm-0500">80</span> 
<a id="x1-62162r81"></a><span class="ecrm-0500">81</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2674"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(ret)&nbsp;{</span> 
<a id="x1-62164r82"></a><span class="ecrm-0500">82</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pr_err(</span><span id="textcolor2675"><span class="ectt-0800">"Unable&nbsp;to&nbsp;register&nbsp;driver</span></span><span id="textcolor2676"><span class="ectt-0800">\n</span></span><span id="textcolor2677"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-62166r83"></a><span class="ecrm-0500">83</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2678"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;ret;</span> 
<a id="x1-62168r84"></a><span class="ecrm-0500">84</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;}</span> 
<a id="x1-62170r85"></a><span class="ecrm-0500">85</span> 
<a id="x1-62172r86"></a><span class="ecrm-0500">86</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2679"><span class="ectt-0800">return</span></span><span class="ectt-0800">&nbsp;0;</span> 
<a id="x1-62174r87"></a><span class="ecrm-0500">87</span><span class="ectt-0800">}</span> 
<a id="x1-62176r88"></a><span class="ecrm-0500">88</span> 
<a id="x1-62178r89"></a><span class="ecrm-0500">89</span><span id="textcolor2680"><span class="ectt-0800">static</span></span><span class="ectt-0800">&nbsp;</span><span id="textcolor2681"><span class="ectt-0800">void</span></span><span class="ectt-0800">&nbsp;devicemodel_exit(</span><span id="textcolor2682"><span class="ectt-0800">void</span></span><span class="ectt-0800">)</span> 
<a id="x1-62180r90"></a><span class="ecrm-0500">90</span><span class="ectt-0800">{</span> 
<a id="x1-62182r91"></a><span class="ecrm-0500">91</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;pr_info(</span><span id="textcolor2683"><span class="ectt-0800">"devicemodel&nbsp;exit</span></span><span id="textcolor2684"><span class="ectt-0800">\n</span></span><span id="textcolor2685"><span class="ectt-0800">"</span></span><span class="ectt-0800">);</span> 
<a id="x1-62184r92"></a><span class="ecrm-0500">92</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;platform_driver_unregister(&amp;devicemodel_driver);</span> 
<a id="x1-62186r93"></a><span class="ecrm-0500">93</span><span class="ectt-0800">}</span> 
<a id="x1-62188r94"></a><span class="ecrm-0500">94</span> 
<a id="x1-62190r95"></a><span class="ecrm-0500">95</span><span class="ectt-0800">module_init(devicemodel_init);</span> 
<a id="x1-62192r96"></a><span class="ecrm-0500">96</span><span class="ectt-0800">module_exit(devicemodel_exit);</span> 
<a id="x1-62194r97"></a><span class="ecrm-0500">97</span> 
<a id="x1-62196r98"></a><span class="ecrm-0500">98</span><span class="ectt-0800">MODULE_LICENSE(</span><span id="textcolor2686"><span class="ectt-0800">"GPL"</span></span><span class="ectt-0800">);</span> 
<a id="x1-62198r99"></a><span class="ecrm-0500">99</span><span class="ectt-0800">MODULE_DESCRIPTION(</span><span id="textcolor2687"><span class="ectt-0800">"Linux&nbsp;Device&nbsp;Model&nbsp;example"</span></span><span class="ectt-0800">);</span></pre>
                                                                  

                                                                  
<!-- l. 1535 --><p class="noindent">
</p>
   <h3 class="sectionHead" id="optimizations"><span class="titlemark">0.18   </span> <a id="x1-630000.18"></a>Optimizations</h3>
<!-- l. 1537 --><p class="noindent">
</p>
   <h4 class="subsectionHead" id="likely-and-unlikely-conditions"><span class="titlemark">0.18.1   </span> <a id="x1-640000.18.1"></a>Likely and Unlikely conditions</h4>
<!-- l. 1539 --><p class="noindent">Sometimes you might want your code to run as quickly as possible,
especially if it is handling an interrupt or doing something which might
cause noticible latency. If your code contains boolean conditions and if you
know that the conditions are almost always likely to evaluate as either
<code> <span class="ectt-1000">true</span>
</code> or <code>  <span class="ectt-1000">false</span>
</code>, then you can allow the compiler to optimize for this using the
<code> <span class="ectt-1000">likely</span>
</code> and <code>  <span class="ectt-1000">unlikely</span>
</code> macros.
</p><!-- l. 1543 --><p class="indent">   For example, when allocating memory you are almost always expecting this to
succeed.
</p><!-- l. 1 --><p class="indent">
</p>
   <pre class="fancyvrb" id="fancyvrb72"><a id="x1-64012r1"></a><span class="ecrm-0500">1</span><span class="ectt-0800">bvl&nbsp;=&nbsp;bvec_alloc(gfp_mask,&nbsp;nr_iovecs,&nbsp;&amp;idx);</span> 
<a id="x1-64014r2"></a><span class="ecrm-0500">2</span><span id="textcolor2688"><span class="ectt-0800">if</span></span><span class="ectt-0800">&nbsp;(unlikely(!bvl))&nbsp;{</span> 
<a id="x1-64016r3"></a><span class="ecrm-0500">3</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;mempool_free(bio,&nbsp;bio_pool);</span> 
<a id="x1-64018r4"></a><span class="ecrm-0500">4</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;bio&nbsp;=&nbsp;NULL;</span> 
<a id="x1-64020r5"></a><span class="ecrm-0500">5</span><span class="ectt-0800">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="textcolor2689"><span class="ectt-0800">goto</span></span><span class="ectt-0800">&nbsp;out;</span> 
<a id="x1-64022r6"></a><span class="ecrm-0500">6</span><span class="ectt-0800">}</span></pre>
<!-- l. 1554 --><p class="indent">   When the <code>  <span class="ectt-1000">unlikely</span>
</code> macro is used, the compiler alters its machine instruction output, so that it
continues along the false branch and only jumps if the condition is true. That
avoids flushing the processor pipeline. The opposite happens if you use the
<code> <span class="ectt-1000">likely</span>
</code> macro.
</p><!-- l. 1558 --><p class="noindent">
</p>
   <h3 class="sectionHead" id="common-pitfalls"><span class="titlemark">0.19   </span> <a id="x1-650000.19"></a>Common Pitfalls</h3>
<!-- l. 1561 --><p class="noindent">
</p>
   <h4 class="subsectionHead" id="using-standard-libraries"><span class="titlemark">0.19.1   </span> <a id="x1-660000.19.1"></a>Using standard libraries</h4>
<!-- l. 1563 --><p class="noindent">You can not do that. In a kernel module you can only use kernel functions, which are
the functions you can see in <span class="obeylines-h"><span class="verb"><span class="ectt-1000">/proc/kallsyms</span></span></span>.
                                                                  

                                                                  
</p><!-- l. 1566 --><p class="noindent">
</p>
   <h4 class="subsectionHead" id="disabling-interrupts"><span class="titlemark">0.19.2   </span> <a id="x1-670000.19.2"></a>Disabling interrupts</h4>
<!-- l. 1568 --><p class="noindent">You might need to do this for a short time and that is OK, but if you do not enable
them afterwards, your system will be stuck and you will have to power it
off.
</p><!-- l. 1570 --><p class="noindent">
</p>
   <h3 class="sectionHead" id="where-to-go-from-here"><span class="titlemark">0.20   </span> <a id="x1-680000.20"></a>Where To Go From Here?</h3>
<!-- l. 1572 --><p class="noindent">For people seriously interested in kernel programming, I recommend <a href="https://kernelnewbies.org/">kernelnewbies.org</a>
and the <a href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/tree/Documentation">Documentation</a> subdirectory within the kernel source code which is not
always easy to understand but can be a starting point for further investigation. Also,
as Linus Torvalds said, the best way to learn the kernel is to read the source code
yourself.
</p><!-- l. 1575 --><p class="indent">   If you are interested in more examples of short kernel modules then searching on
sites such as Github and Gitlab is a good way to start, although there is a lot of
duplication of older LKMPG examples which may not compile with newer kernel
versions. You will also be able to find examples of the use of kernel modules to attack
or compromise systems or exfiltrate data and those can be useful for thinking about
how to defend systems and learning about existing security mechanisms within the
kernel.
</p><!-- l. 1578 --><p class="indent">   I hope I have helped you in your quest to become a better programmer, or at
least to have fun through technology. And, if you do write useful kernel modules, I
hope you publish them under the GPL, so I can use them too.
</p><!-- l. 1581 --><p class="indent">   If you would like to contribute to this guide or notice anything glaringly wrong,
please create an issue at <a class="url" href="https://github.com/sysprog21/lkmpg"><span class="ectt-1000">https://github.com/sysprog21/lkmpg</span></a>.
</p><!-- l. 1583 --><p class="indent">   Happy hacking!
</p>
    
 
<!----></body></html>